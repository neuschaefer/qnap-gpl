<chapter id='cables'><title>Cables</title>

<para>You can either use the cable that came with your UPS
(the easiest if we support it) or you can make your own cable. We
recommend that you obtain a supported cable directly from APC.</para>
<para>If you already have an APC cable, you can determine what kind it
is by examining the flat sides of the two connectors where you will
find the cable number embossed into the plastic. It is generally on
one side of the male connector.</para>

<para>To make your own cable you must first know whether you have a
UPS that speaks the apcsmart protocol or a &quot;dumb&quot; UPS that
uses serial port line voltage signalling.</para>

<para>If you have an apcmart UPS, and you build your
own cable, build a <emphasis>Smart-Custom</emphasis> cable. If you
have a voltage-Signalling or dumb UPS, build a
<emphasis>Simple-Custom</emphasis> cable. If you have a BackUPS CS
with a RJ45 connector, you can build your own
<emphasis>Custom-RJ45</emphasis> cable.</para>

<sect1 id='custom_smart'><title>Smart-Custom Cable for SmartUPSes</title>

<programlisting>
  SMART-CUSTOM CABLE

Signal Computer                  UPS
       DB9F                     DB9M
 RxD    2   --------------------  2  TxD  Send
 TxD    3   --------------------  1  RxD  Receive
 GND    5   --------------------  9  Ground
</programlisting>

<para>When using this cable with <application>apcupsd</application>
specify the following in <filename>apcupsd.conf</filename>:</para>
<para>
If you have an OS that requires DCD or RTS to be set before
you can receive input, you might try building the standard
APC Smart 940-0024C cable listed below.
</para>
<programlisting>
UPSCABLE smart
UPSTYPE apcsmart
DEVICE /dev/ttyS0 (or whatever your serial port is)
</programlisting>
<para>
If you wish to build the standard cable furnished by
APC (940-0024C), use the following diagram. </para>
<programlisting>
  APC Smart Cable 940-0024C

Signal Computer                  UPS
       DB9F                     DB9M
 RxD    2   --------------------  2  TxD  Send
 TxD    3   --------------------  1  RxD  Receive
 DCD    1   --*
              |
 DTR    4   --*
 GND    5   --------------------  9  Ground
 RTS    7   --*
              |
 CTS    8   --*

</programlisting>
</sect1>

<sect1><title>Smart Signalling Cable for BackUPS CS Models</title>

<para>If you have a BackUPS CS, you are probably either using it with
the USB cable that is supplied or with the 940-0128A supplied by APC,
which permits running the UPS in dumb mode. By building your own
cable, you can now run the BackUPS CS models (and perhaps also the ES
models) using smart signalling and have all the same information that
is available as running it in USB mode.</para>

<para>The jack in the UPS is actually a 10 pin RJ45. However, you can
just as easily use a 8 pin RJ45 connector, which is more standard
(ethernet TX, and ISDN connector). It is easy to construct the cable
by cutting off one end of a standard RJ45-8 ethernet cable and wiring
the other end (three wires) into a standard DB9F female serial port
connector.</para>

<para>Below, you will find a diagram for the CUSTOM-RJ45 cable:</para>

<programlisting>
  CUSTOM-RJ45 CABLE

Signal Computer              UPS     UPS
       DB9F                 RJ45-8  RJ45-10
 RxD    2   ----------------  1      2     TxD  Send
 TxD    3   ----------------  7      8     RxD  Receive
 GND    5   ----------------  6      7     Ground
 FG  Shield ----------------  3      4     Frame Ground

The RJ45-8 pins are: looking at the end of the connector:

 8 7 6 5 4 3 2 1
___________________
| . . . . . . . . |
|                 |
-------------------
       |____|

The RJ45-10  pins are: looking at the end of the connector:

10 9 8 7 6 5 4 3 2 1
_______________________
| . . . . . . . . . . |
|                     |
-----------------------
       |____|

</programlisting>

<para>For the serial port DB9F connector, the pin numbers are stamped
in the plastic near each pin. In addition, there is a diagram near the
end of this chapter.</para>

<para>Note, one user, Martin, has found that if the shield is not
connected to the Frame Ground in the above diagram (not in          
our original schematic), the UPS (a BackUPS CS 500 EI) will be
unstable and likely to rapidly switch from power to batteries (i.e. 
chatter).</para>

<para>When using this cable with <application>apcupsd</application>
specify the following in <filename>apcupsd.conf</filename>:</para>

<programlisting>
UPSCABLE smart
UPSTYPE apcsmart
DEVICE /dev/ttyS0 (or whatever your serial port is)
</programlisting>

<para>The information for constructing this cable was discovered and
transmitted to us by slither_man. Many thanks!</para>

</sect1>
<sect1 id='custom_simple'><title>Voltage-Signalling Cable for &quot;dumb&quot; UPSes</title>

<para><emphasis role="bold">NOTE. YOU DO NOT HAVE THIS CABLE UNLESS
YOU BUILT IT YOURSELF.  THE SIMPLE-CUSTOM CABLE IS NOT AN APC
PRODUCT.</emphasis></para>

<para>For &quot;dumb&quot; UPSes using voltage signalling, if you are going to
build your own cable, we recommend to make the cable designed by
the <application>apcupsd</application> team as follows:</para>

<programlisting>
       SIMPLE-CUSTOM CABLE

Signal Computer                  UPS
       DB9F   4.7K ohm          DB9M
 DTR    4   --[####]--*              DTR set to +5V by Apcupsd
                      |
 CTS    8   ----------*---------  5  Low Battery
 GND    5   --------------------  4  Ground
 DCD    1   --------------------  2  On Battery
 RTS    7   --------------------  1  Kill UPS Power

</programlisting>

<para>List of components one needs to make the Simple cable:</para>

<orderedlist>
  <listitem>
    <para>One (1) male DB9 connector, use solder type connector only.</para>
  </listitem>
  <listitem>
    <para>One (1) female DB9/25F connector, use solder type connector only.</para>
  </listitem>
  <listitem>
    <para>One (1) 4.7K ohm 1/4 watt 5% resistor.</para>
  </listitem>
  <listitem>
    <para>resin core solder.</para>
  </listitem>
  <listitem>
    <para>three (3) to five (5) feet of 22AWG multi-stranded four or more
conductor cable.</para>
  </listitem>
</orderedlist>

<procedure>
<step><para> Solder the resistor into pin 4 of the female DB9
connector.</para></step>
<step><para> Next bend the resistor so that it connects to pin 8 of the
female DB9 connector.</para></step>
<step><para> Pin 8 on the female connector is also wired to pin 5 on the
male DB9 connector. Solder both ends.</para></step>
<step><para> Solder the other pins, pin 5 on the female DB9 to pin 4 on the
male connector; pin 1 on the female connector to pin 2 on the male
connector; and pin 7 on the female connector to pin 1 on the male
connector.</para></step>
<step><para>Double check your work. </para></step>
</procedure>

<para>We use the DTR (pin 4 on the female connector) as our +5 volts
power for the circuit. It is used as the Vcc pull-up voltage for
testing the outputs on any &quot;UPS by APC&quot; in voltage-signalling
mode.  This cable may not work on a BackUPS Pro if the default
communications are in apcsmart mode. This cable is also valid for
&quot;ShareUPS&quot; BASIC Port mode and is also reported to work on
SmartUPSes. However, the Smart Cable described above is much
simpler. To have a better idea of what is going on inside
<application>apcupsd</application>, for the SIMPLE cable
<application>apcupsd</application> reads three signals and sets
three:</para>

<programlisting>
Reads:
CD, which apcupsd uses for the On Battery signal when high.

CTS, which apcupsd uses for the Battery Low signal when high.

RxD (SR), which apcupsd uses for the Line Down 
    signal when high. This signal isn't used for much.

Sets:
DTR, which apcupsd sets when it detects a power failure (generally
     5 to 10 seconds after the CD signal goes high). It
     clears this signal if the CD signal subsequently goes low
     -- i.e. power is restored.

TxD (ST), which apcupsd clears when it detects that the CD signal
     has gone low after having gone high - i.e. power is restored.

RTS, which apcupsd sets for the killpower signal -- to cause the UPS
     to shut off the power.
</programlisting>

<para>Please note that these actions apply only to the SIMPLE cable,
the signals used on the other cables are different.</para>
<para>Finally, here is another way of looking at the CUSTOM-SIMPLE
cable:</para> 

<programlisting>
APCUPSD SIMPLE-CUSTOM CABLE

Computer Side  |  Description of Cable           |     UPS Side  
DB9f  |  DB25f |                                 |   DB9m  | DB25m
4     |   20   |  DTR (5vcc)             *below  |    n/c  |
8     |    5   |  CTS (low battery)      *below  | &lt;-  5   |   7
2     |    3   |  RxD (no line voltage)  *below  | &lt;-  3   |   2
5     |    7   |  Ground (Signal)                |     4   |  20
1     |    8   |  CD (on battery from UPS)       | &lt;-  2   |   3
7     |    4   |  RTS (kill UPS power)           | -&gt;  1   |   8
n/c   |    1   |  Frame/Case Gnd (optional)      |     9   |  22

Note: the &lt;- and -&gt; indicate the signal direction.

Optional connections of original SIMPLE-CUSTOM specification
that are not used.

              4.7K ohm
 DTR    4   --[####]--*              Note needed
                      |
 RxD    2   ----------*---------  3  Not used by Apcupsd

</programlisting>

<para>When using this cable with <application>apcupsd</application>
specify the following in <filename>apcupsd.conf</filename>:</para>

<programlisting>
UPSCABLE simple
UPSTYPE dumb
DEVICE /dev/ttyS0 (or whatever your serial port is)
</programlisting>

</sect1>
<sect1><title>Other APC Cables that <application>apcupsd</application>
Supports</title>

<para><application>apcupsd</application> will also support the
following off the shelf cables that are supplied by APC</para>

<itemizedlist>
  <listitem>
    <para>940-0020B/C Simple Signal Only, all models.</para>
  </listitem>
  <listitem>
    <para>940-0023A Simple Signal Only, all models.</para>
  </listitem>
  <listitem>
    <para>940-0119A Simple Signal Only, Back-UPS Office, and BackUPS ES.</para>
  </listitem>
  <listitem>
    <para>940-0024[B/C/G] SmartMode Only, SU and BKPro only.</para>
  </listitem>
  <listitem>
    <para>940-0095[A/B/C] PnP (Plug and Play), all models.</para>
  </listitem>
  <listitem>
    <para>940-1524C SmartMode Only</para>
  </listitem>
  <listitem>
    <para>940-0127A/B USB Cables</para>
  </listitem>
  <listitem>
    <para>940-0128A Simple Signal Only, Back-UPS CS in serial mode.</para>
  </listitem>
</itemizedlist>

</sect1>
<sect1 id="CableModes"><title>Voltage Signalling
Features Supported by Apcupsd for Various Cables</title>

<para>The following table shows the features supported by the current
version of <application>apcupsd</application> (3.8.5 or later) for
various cables running the UPS in voltage-signalling mode.</para>

<informaltable>
  <tgroup cols="5">
    <colspec colnum="1" colname="col1"/>
    <colspec colnum="2" colname="col2"/>
    <colspec colnum="3" colname="col3"/>
    <colspec colnum="4" colname="col4"/>
    <colspec colnum="5" colname="col5"/>
    <thead>
      <row>
        <entry>Cable</entry>
        <entry>Power Loss</entry>
        <entry>Low Battery</entry>
        <entry>Kill Power</entry>
        <entry>Cable Disconnected</entry>
      </row>
    </thead>
    <tbody>
      <row>
        <entry>940-0020B</entry>
        <entry>Yes</entry>
        <entry>No</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0020C</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0023A</entry>
        <entry>Yes</entry>
        <entry>No</entry>
        <entry>No</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0119A</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0127A</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0128A</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>940-0095A/B/C</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
      <row>
        <entry>simple</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>Yes</entry>
        <entry>No</entry>
      </row>
    </tbody>
  </tgroup>
</informaltable>

</sect1>
<sect1><title>Voltage Signalling</title>

<para>Apparently, all APC voltage-signalling UPSes have the same
signals on the output pins of the UPS. The difference at the computer
end is due to different cable configurations. Thus, by measuring the
connectivity of a cable, one can determine how to program the UPS.
This is to be verified.</para>

<para>The signals presented or accepted by the UPS on its DB9
connector using the numbering scheme listed above is:</para>

<programlisting>
UPS Pin         Signal meaning
 1     &lt;-     Shutdown when set by computer for 1-5 seconds.
 2     -&gt;     On battery power (this signal is normally low but
                    goes high when the UPS switches to batteries).
 3     -&gt;     Mains down (line fail) See Note 1 below.
 5     -&gt;     Low battery. See Note 1 below.
 6     -&gt;     Inverse of mains down signal. See Note 2 below.
 7     &lt;-     Turn on/off power (only on advanced UPSes only)

 Note 1: these two lines are normally open, but close when the
     appropriate signal is triggered. In fact, they are open collector
     outputs which are rated for a maximum of +40VDC and 25 mA. Thus
     the 4.7K ohm resistor used in the Custom Simple cable works 
     quite well.

 Note 2: the same as note 1 except that the line is normally closed,
     and opens when the line voltage fails.
</programlisting>

</sect1>
<sect1><title>The Back-UPS Office 500 signals</title>

<para>The Back-UPS Office UPS has a telephone type jack as output,
which looks like the following:</para>

<programlisting>
Looking at the end of the connector:

   6 5 4 3 2 1
  _____________
 | . . . . . . |
 |             |
 |  |----------|
 |__|

</programlisting>

<para>It appears that the signals work as follows:</para>

<programlisting>
  UPS            Signal meaning
1 (brown)    &lt;-   Shutdown when set by computer for 1-5 seconds.
2 (black)    -&gt;   On battery power
3 (blue)     -&gt;   Low battery
4 (red)           Signal ground 
5 (yellow)   &lt;-   Begin signalling on other pins
6 (none)          none
</programlisting>

</sect1>
<sect1><title>Analyses of APC Cables</title>

<sect2><title>940-0020B Cable Wiring</title>

<para>This diagram is for informational purposes and is not complete.
Although we do not know what the black box semi-conductor contains,
we believe that we understand its operation (many thanks to Lazar
M. Fleysher for working this out).</para>

<para>This cable can only be used on voltage-signalling UPSes, and
provides the On Battery signal as well as kill UPS power. Most recent
evidence (Lazar's analysis) indicates that this cable under the right
conditions may provide the Low Battery signal. This is to be
confirmed.</para>

<programlisting>
APC Part# - 940-0020B

Signal Computer                  UPS
       DB9F                     DB9M
 CTS    8   --------------------  2  On Battery
 DTR    4   --------------------  1  Kill power
 GND    5   ---------------*----  4  Ground
                           |
                ---        *----  9  Common
 DCD    1  ----|///|-----------   5  Low Battery
               |\\\|
 RTS    7  ----|///| (probably a
                ---   semi-conductor)
</programlisting>

<para>Thanks to Lazar M. Fleysher.</para>

</sect2>
<sect2><title>940-0020C Cable Wiring</title>

<para>This diagram is for informational purposes and may not be
complete, we don't recommend that use it to build you build one
yourself.  This cable can only be used on voltage-signalling UPSes, and
provides the On Battery signal, the Low Battery signal as well as kill
UPS power. In <application>apcupsd</application> versions 3.8.2 and
prior, please set your UPSCABLE to 940-0020B. In version 3.8.3 and
later, you may specify the cable as 940-0020C. Please note that this
diagram may not be accurate.</para>

<programlisting>
APC Part# - 940-0020C

Signal Computer                  UPS
       DB9F                     DB9M
 CTS    8   --------------------  2  On Battery
 DTR    4   --------------------  1  Kill power
 GND    5   ---------------*----  4  Ground
                           |
                           *----  9  Common
 RTS    7 -----[ 93.5K ohm ]----- 5  Low Battery
               or semi-conductor
</programlisting>

</sect2>
<sect2><title>940-0023A Cable Wiring</title>

<para>This diagram is for informational purposes and may not be
complete, we don't recommend that use it to build you build one
yourself.  This cable can only be used on voltage-signalling UPSes, and
apparently only provides the On Battery signal. As a consequence, this
cable is pretty much useless, and we recommend that you find a better
cable because all APC UPSes support more than just On Battery. Please
note that we are not sure the following diagram is correct.</para>

<programlisting>
APC Part# - 940-0023A

Signal Computer                  UPS
       DB9F                     DB9M
 DCD    1   --------------------  2  On Battery

              3.3K ohm
 TxD    3   --[####]-*
                     |
 DTR    4   ---------*
 GND    5   ---------------*----  4  Ground
                           |
                           *----  9  Common

</programlisting>

</sect2>
<sect2><title>940-0095A Cable Wiring</title>

<para>This is the definitive wiring diagram for the 940-0095A cable
submitted by Chris Hanson &lt;cph at zurich.ai.mit.edu&gt;, who
disassembled the original cable, destroying it in the process. He then
built one from his diagram and it works perfectly.</para>

<programlisting>
Construction and operation of the APC #940-0095A cable.
This cable is included with the APC Back-UPS Pro PNP series.


UPS end                                      Computer end
-------                                      ------------
                  47k        47k
BATTERY-LOW (5) &gt;----R1----*----R2----*----&lt; DTR,DSR,CTS (4,6,8)
                         |          |
                         |          |
                         |         /  E
                         |       |/
                         |    B  |
                         *-------|  2N3906 PNP
                                 |
                                 |\
                                   \  C
                                    |
                                    |
                                    *----&lt; DCD (1)     Low Batt
                                    |
                                    |
                                    R 4.7k
                                    3
                                    |
                             4.7k   |
SHUTDOWN (1)    &gt;----------*----R4----*----&lt; TxD (3)            
                         |
                         |  1N4148
                         *----K|---------&lt; RTS (7)      Shutdown

POWER-FAIL (2)  &gt;--------------------------&lt; RxD,RI (2,9) On Batt

GROUND (4,9)    &gt;--------------------------&lt; GND (5)


Operation:

* DTR is &quot;cable power&quot; and must be held at SPACE.  DSR or CTS may be
used as a loopback input to determine if the cable is plugged in.

* DCD is the &quot;battery low&quot; signal to the computer.  A SPACE on this
line means the battery is low.  This is signalled by BATTERY-LOW
being pulled down (it is probably open circuit normally).

Normally, the transistor is turned off, and DCD is held at the MARK
voltage by TxD.  When BATTERY-LOW is pulled down, the voltage
divider R2/R1 biases the transistor so that it is turned on, causing
DCD to be pulled up to the SPACE voltage.

* TxD must be held at MARK; this is the default state when no data is
being transmitted.  This sets the default bias for both DCD and
SHUTDOWN.  If this line is an open circuit, then when BATTERY-LOW is
signalled, SHUTDOWN will be automatically signalled; this would be
true if the cable were plugged in to the UPS and not the computer,
or if the computer were turned off.

* RTS is the &quot;shutdown&quot; signal from the computer.  A SPACE on this
line tells the UPS to shut down.

* RxD and RI are both the &quot;power-fail&quot; signals to the computer.  A
MARK on this line means the power has failed.

* SPACE is a positive voltage, typically +12V.  MARK is a negative
voltage, typically -12V.  Linux appears to translate SPACE to a 1
and MARK to a 0.
</programlisting>

</sect2>
<sect2><title>940-0095B Cable Wiring</title>

<para>This diagram is for informational purposes and may not be complete,
we don't recommend that use it to build one yourself.</para>

<programlisting>
APC Part# - 940-0095B

Signal Computer                  UPS
       DB9F                     DB9M
 DTR    4   ----*
 CTS    8   ----|
 DSR    6   ----|
 DCD    1   ----*
 GND    5   ---------------*----  4  Ground
                           |
                           *----  9  Common
 RI     9   ----*
                |
 RxD    2   ----*---------------  2  On Battery
 TxD    3   ----------[####]----  1  Kill UPS Power
                      4.7K ohm
</programlisting>

</sect2>
<sect2><title>940-0119A Cable Wiring</title>

<para>This diagram is for informational purposes and may not be complete,
we don't recommend that use it to build you build one yourself.
This cable is used with the BackUPS Office UPSes.</para>

<programlisting>
APC Part# - 940-0119A

  UPS      Computer
  pins     pins      Signal             Signal meaning
1 (brown)    4,6      DSR DTR     &lt;-   Shutdown when set by computer for 1-5 seconds.
2 (black)    8,9      RI  CTS     -&gt;   On battery power
3 (blue)     1,2      CD  RxD     -&gt;   Low battery 
4 (red)       5       Ground
5 (yellow)    7       RTS         &lt;-   Begin signalling on other pins 
6 (none)     none

</programlisting>

</sect2>
<sect2><title>BackOffice ES</title>

<para>The BackUPS ES has a straight through serial cable with no
identification on the plugs. To make it work with
<application>apcupsd</application>, specify the <emphasis
role="bold">UPSCABLE 940-0119A</emphasis> and <emphasis
role="bold">UPSTYPE backups</emphasis>.  The equivalent of cable
940-0119A is done on a PCB inside the unit.  Thanks to William Stock
for supplying us with the information about the straight through
cable, the PCB, and the following diagram:</para>

<programlisting>
computer           ----------- BackUPS-ES -----------------
DB9-M              DB-9F
pin    signal      pin

 4      DSR   -&gt;    4 --+
                        |  diode   resistor
 6      DTR   -&gt;    6 --+----&gt;|----/\/\/\---o kill power

 1      DCD   &lt;-    1 --+
                        |
 2      RxD   &lt;-    2 --+----------------+--o low battery
                                         |
 7      RTS   -&gt;    7 --------+--/\/\/\--+
                              |
                              +--/\/\/\--+
                                         |
 8      RI    &lt;-    8 --+----------------+--o on battery
                        |
 9      CTS   &lt;-    9 --+

 5      GND   ---   5 ----------------------o ground

 3      TxD         3 nc

</programlisting>

</sect2>
<sect2><title>BackUPS ES and CS in Serial mode with Cable 940-0128A</title>

<para>Though these UPSes are USB UPSes, APC supplies a serial cable
(typically with a green DB9 F connector) that has 940-0128A stamped
into one side of the plastic serial port connector. The other end of
the cable is a 10 pin RJ45 connector that plugs into the UPS (thanks
to Dean Waldow for sending me a cable!). Apcupsd version 3.8.5 and
later supports this cable when specified as <emphasis
role="bold">UPSCABLE 940-0128A</emphasis> and <emphasis
role="bold">UPSTYPE backups</emphasis>. However, running in this mode
much of the information that would be available in USB mode is
lost. In addition, when <application>apcupsd</application> attempts to
instruct the UPS to kill the power, it begins cycling about 4 times a
second between battery and line. The solution to the problem (thanks
to Tom Suzda) is to unplug the UPS and while it is still chattering,
press the power button (on the front of the unit) until the unit beeps
and the chattering stops. After that the UPS should behave normally
and power down 1-2 minutes after requested to do so.</para>

<para>An amazing discovery by slither_man allows one to build a
CUSTOM-RJ45 cable (documented above) and run the BackUPS CS (and
probably also the ES) in Smart mode. Running it this way provides
all the same information that you would get by running it in USB
mode. As a consequence, we recommend that you either purchase
(where I don't know) or build your own CUSTOM-RJ45 cable rather
than use the 940-0128A cable.</para>

<para>Thanks to all the people who have helped test this and have
provided information on the cable wiring, our best guess for the
cable schematic is the following:</para>

<programlisting>
computer      --------- Inside the Connector---------  UPS
DB9-F         |                                     |  RJ45
pin - signal  |                                     |  Pin - Color
              |                                     |
 4     DSR  -&gt;|---+                                 |
              |   |  diode   resistor               |
 6     DTR  -&gt;|---+----&gt;|----/\/\/\---o kill power  |  8  Orange
              |                                     |
 1     DCD  &lt;-|----+                                |
              |    |                                |
 2     RxD  &lt;-|----+----------------+--o low battery|  3  Brown
              |                     |               |
 7     RTS  -&gt;|----------+--/\/\/\--+               |
              |          |                          |   
              |          +--/\/\/\--+               |
              |                     |               |
 8     RI   &lt;-|----+----------------+--o on battery |  2  Black
              |    |                                |
 9     CTS  &lt;-|----+                                |
              |                         signal      |
 5     GND  --|-----------------------o ground      |  7  Red
              |                                     |
 3     TxD    |                                     |
              |                         chassis     |
 Chassis/GND  |-----------------------o ground      |  4  Black
              |                                     |
              |          Not connected              |  1, 5, 6, 9, 10
              -------------------------------------- 

The RJ45 pins are: looking at the end of the connector:

10 9 8 7 6 5 4 3 2 1
_______________________
| . . . . . . . . . . |
|                     |
-----------------------
       |____|

</programlisting>

</sect2>
</sect1>
<sect1><title>Win32 Implementation Restrictions for Simple UPSes</title>

<para>Due to inadequacies in the Win32 API, it is not possible to
set/clear/get all the serial port line
signals. <application>apcupsd</application> can detect: CTS, DSR, RNG,
and CD. It can set and clear: RTS and DTR.</para> <para>This imposes a
few minor restrictions on the functionality of some of the cables. In
particular, LineDown on the Custom Simple cable, and Low Battery on
the 0023A cable are not implemented.</para>

</sect1>
<sect1><title>Internal Apcupsd Actions for Simple Cables</title>

<programlisting>
This section describes how apcupsd 3.8.5 (March 2002)
treats the serial port line signals for simple cables.

apcaction.c: 
 condition = power failure detected
 cable = CUSTOM_SIMPLE
 action = ioctl(TIOCMBIS, DTR)      set DTR (enable power bit?)

apcaction.c: 
 condition = power back
 cable = CUSTOM_SIMPLE
 action = ioctl(TIOCMBIC, DTR)      clear DTR (clear power bit)
 action = ioctl(TIOCMBIC, ST)       clear ST (TxD)

apcserial.c: 
 condition = serial port initialization
 cable = 0095A, 0095B, 0095C
 action = ioctl(TIOMBIC, RTS)       clear RTS (set PnP mode)

 cable = 0119A, 0127A, 0128A
 action = ioctl(TIOMBIC, DTR)       clear DTR (killpower)
 action = ioctl(TIOMBIS, RTS)       set   RTS (ready to receive)

apcserial.c: 
 condition = save_dumb_status
 cable = CUSTOM_SIMPLE
 action = ioctl(TIOMBIC, DTR)       clear DTR (power bit?)
 action = ioctl(TIOMBIC, RTS)       clear RTS (killpower)

 cable = 0020B, 0020C, 0119A, 0127A, 0128A
 action = ioctl(TIOMBIC, DTR)       clear DTR (killpower)

 cable = 0095A, 0095B, 0095C
 action = ioctl(TIOMBIC, RTS)       clear RTS (killpower)
 action = ioctl(TIOMBIC, CD)        clear DCD (low batt)
 action = ioctl(TIOMBIC, RTS)       clear RTS (killpower) a second time!

apcserial.c:
 condition = check_serial

 cable = CUSTOM_SIMPLE
 action = OnBatt = CD
 action = BattLow = CTS
 action = LineDown = SR

 cable = 0020B, 0020C, 0119A, 0127A, 0128A
 action = OnBatt = CTS
 action = BattLow = CD
 action = LineDown = 0

 cable = 0023A
 action = Onbatt = CD
 action = BattLow = SR
 action = LineDown = 0

 cable = 0095A, 0095B, 0095C
 action = OnBatt = RNG
 action = BattLow = CD
 action = LineDown = 0


apcserial.c
 condition = killpower

 cable = CUSTOM_SIMPLE, 0095A, 0095B, 0095C
 action = ioctl(TIOMCBIS, RTS)      set RTS (kills power)
 action = ioctl(TIOMCBIS, ST)       set TxD       

 cable = 0020B, 020C, 0119A, 0127A, 0128A
 action = ioctl(TIOMCBIS, DTR)      set DTR (kills power)

</programlisting>

</sect1>
<sect1><title>RS232 Wiring and Signal Conventions</title>

<informaltable>
  <tgroup cols="4">
    <colspec colnum="1" colname="col1"/>
    <colspec colnum="2" colname="col2"/>
    <colspec colnum="3" colname="col3"/>
    <colspec colnum="4" colname="col4"/>
    <thead>
      <row>
        <entry>DB-25
Pin #</entry>
        <entry>DB-9
Pin #</entry>
        <entry>Name</entry>
        <entry>DTE-DCE Description</entry>
      </row>
    </thead>
    <tbody>
      <row>
        <entry>1</entry>
        <entry>--</entry>
        <entry>FG</entry>
        <entry>--- Frame Ground/Chassis GND</entry>
      </row>
      <row>
        <entry>2</entry>
        <entry>3</entry>
        <entry>TD</entry>
        <entry>---&gt; Transmitted Data, TxD</entry>
      </row>
      <row>
        <entry>3</entry>
        <entry>2</entry>
        <entry>RD</entry>
        <entry>&lt;--- Received Data, RxD</entry>
      </row>
      <row>
        <entry>4</entry>
        <entry>7</entry>
        <entry>RTS</entry>
        <entry>---&gt; Request To Send</entry>
      </row>
      <row>
        <entry>5</entry>
        <entry>8</entry>
        <entry>CTS</entry>
        <entry>&lt;--- Clear To Send</entry>
      </row>
      <row>
        <entry>6</entry>
        <entry>6</entry>
        <entry>DSR</entry>
        <entry>&lt;--- Data Set Ready</entry>
      </row>
      <row>
        <entry>7</entry>
        <entry>5</entry>
        <entry>SG</entry>
        <entry>---- Signal Ground, GND</entry>
      </row>
      <row>
        <entry>8</entry>
        <entry>1</entry>
        <entry>DCD</entry>
        <entry>&lt;--- Data Carrier Detect</entry>
      </row>
      <row>
        <entry>9</entry>
        <entry>--</entry>
        <entry>--</entry>
        <entry>--- Positive DC test voltage</entry>
      </row>
      <row>
        <entry>10</entry>
        <entry>--</entry>
        <entry>--</entry>
        <entry>--- Negative DC test voltage</entry>
      </row>
      <row>
        <entry>11</entry>
        <entry>--</entry>
        <entry>QM</entry>
        <entry>&lt;--- Equalizer mode</entry>
      </row>
      <row>
        <entry>12</entry>
        <entry>--</entry>
        <entry>SDCD</entry>
        <entry>&lt;--- Secondary Data Carrier Detect</entry>
      </row>
      <row>
        <entry>13</entry>
        <entry>--</entry>
        <entry>SCTS</entry>
        <entry>&lt;--- Secondary Clear To Send</entry>
      </row>
      <row>
        <entry>14</entry>
        <entry>--</entry>
        <entry>STD</entry>
        <entry>---&gt; Secondary Transmitted Data</entry>
      </row>
      <row>
        <entry>15</entry>
        <entry>--</entry>
        <entry>TC</entry>
        <entry>&lt;--- Transmitter (signal) Clock</entry>
      </row>
      <row>
        <entry>16</entry>
        <entry>--</entry>
        <entry>SRD</entry>
        <entry>&lt;--- Secondary Receiver Clock</entry>
      </row>
      <row>
        <entry>17</entry>
        <entry>--</entry>
        <entry>RC</entry>
        <entry>---&gt; Receiver (signal) Clock</entry>
      </row>
      <row>
        <entry>18</entry>
        <entry>--</entry>
        <entry>DCR</entry>
        <entry>&lt;--- Divided Clock Receiver</entry>
      </row>
      <row>
        <entry>19</entry>
        <entry>--</entry>
        <entry>SRTS</entry>
        <entry>---&gt; Secondary Request To Send</entry>
      </row>
      <row>
        <entry>20</entry>
        <entry>4</entry>
        <entry>DTR</entry>
        <entry>---&gt; Data Terminal Ready</entry>
      </row>
      <row>
        <entry>21</entry>
        <entry>--</entry>
        <entry>SQ</entry>
        <entry>&lt;--- Signal Quality Detect</entry>
      </row>
      <row>
        <entry>22</entry>
        <entry>9</entry>
        <entry>RI</entry>
        <entry>&lt;--- Ring Indicator</entry>
      </row>
      <row>
        <entry>23</entry>
        <entry>--</entry>
        <entry>--</entry>
        <entry>---&gt; Data rate selector</entry>
      </row>
      <row>
        <entry>24</entry>
        <entry>--</entry>
        <entry>--</entry>
        <entry>&lt;--- Data rate selector</entry>
      </row>
      <row>
        <entry>25</entry>
        <entry>--</entry>
        <entry>TC</entry>
        <entry>&lt;--- Transmitted Clock</entry>
      </row>
    </tbody>
  </tgroup>
</informaltable>

</sect1>
<sect1><title>Pin Assignment for the Serial Port (RS-232C), 25-pin and 9-pin,
Female End</title>

<programlisting>
   13                         1         5         1
 _______________________________      _______________
 \  . . . . . . . . . . . . .  /      \  . . . . .  /    RS232-connectors
  \  . . . . . . . . . . . .  /        \  . . . .  /     looking into the
   ---------------------------          -----------      end of the cable.
   25                      14            9       6

The diagram above represents the Female end of the cable. The
male end is the same, but looking from inside the cable.

 DTE : Data Terminal Equipment (i.e. computer)
 DCE : Data Communications Equipment (i.e. UPS)
 RxD : Data received; 1 is transmitted &quot;low&quot;, 0 as &quot;high&quot;
 TxD : Data sent; 1 is transmitted &quot;low&quot;, 0 as &quot;high&quot;
 DTR : DTE announces that it is powered up and ready to communicate
 DSR : DCE announces that it is ready to communicate; low=modem hang-up
 RTS : DTE asks DCE for permission to send data
 CTS : DCE agrees on RTS
 RI  : DCE signals the DTE that an establishment of a connection is attempted
 DCD : DCE announces that a connection is established
</programlisting>

</sect1>
<sect1><title id="ioctl">Ioctl to RS232 Correspondence</title>

<programlisting>
#define TIOCM_LE        0x001
#define TIOCM_DTR       0x002
#define TIOCM_RTS       0x004
#define TIOCM_ST        0x008
#define TIOCM_SR        0x010
#define TIOCM_CTS       0x020
#define TIOCM_CAR       0x040
#define TIOCM_RNG       0x080
#define TIOCM_DSR       0x100
#define TIOCM_CD        TIOCM_CAR
#define TIOCM_RI        TIOCM_RNG
#define TIOCM_OUT1      0x2000
#define TIOCM_OUT2      0x4000
</programlisting>
</sect1>
</chapter>
