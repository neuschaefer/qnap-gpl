diff -Npur samba-4.7.0/VERSION samba-4.7.1/VERSION
--- samba-4.7.0/VERSION	2017-09-21 08:30:20.000000000 +0200
+++ samba-4.7.1/VERSION	2017-11-02 12:38:36.000000000 +0100
@@ -25,7 +25,7 @@
 ########################################################
 SAMBA_VERSION_MAJOR=4
 SAMBA_VERSION_MINOR=7
-SAMBA_VERSION_RELEASE=0
+SAMBA_VERSION_RELEASE=1
 
 ########################################################
 # If a official release has a serious bug              #
diff -Npur samba-4.7.0/WHATSNEW.txt samba-4.7.1/WHATSNEW.txt
--- samba-4.7.0/WHATSNEW.txt	2017-09-21 08:28:20.000000000 +0200
+++ samba-4.7.1/WHATSNEW.txt	2017-11-02 12:38:36.000000000 +0100
@@ -1,4 +1,115 @@
                    =============================
+                   Release Notes for Samba 4.7.1
+                         November 02, 2017
+                   =============================
+
+
+This is the latest stable release of the Samba 4.7 release series.
+
+
+Changes since 4.7.0:
+--------------------
+
+o  Michael Adam <obnox@samba.org>
+   * BUG 13091: vfs_glusterfs: Fix exporting subdirs with shadow_copy2.
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13027: s3: smbd: Currently if getwd() fails after a chdir(), we panic.
+   * BUG 13068: s3: VFS: Ensure default SMB_VFS_GETWD() call can't return a
+     partially completed struct smb_filename.
+   * BUG 13069: sys_getwd() can leak memory or possibly return the wrong errno
+     on older systems.
+   * BUG 13093: 'smbclient' doesn't correctly canonicalize all local names
+     before use.
+
+o  Douglas Bagnall <douglas.bagnall@catalyst.net.nz>
+   * BUG 13095: Fix broken linked attribute handling.
+
+o  Andrew Bartlett <abartlet@samba.org>
+   * BUG 12994: Missing LDAP query escapes in DNS rpc server.
+   * BUG 13087: replace: Link to -lbsd when building replace.c by hand.
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 6133: Cannot delete non-ACL files on Solaris/ZFS/NFSv4 ACL filesystem.
+   * BUG 7909: Map SYNCHRONIZE acl permission statically in zfs_acl vfs module.
+   * BUG 7933: Samba fails to honor SEC_STD_WRITE_OWNER bit with the
+     acl_xattr module.
+   * BUG 12991: s3/mdssvc: Missing assignment in sl_pack_float.
+   * BUG 12995: Wrong Samba access checks when changing DOS attributes.
+   * BUG 13062: samba_runcmd_send() leaves zombie processes on timeout
+   * BUG 13065: net: groupmap cleanup should not delete BUILTIN mappings.
+   * BUG 13076: Enabling vfs_fruit results in loss of Finder tags and other
+     xattrs.
+
+o  Alexander Bokovoy <ab@samba.org>
+   * BUG 9613: man pages: Properly ident lists.
+   * BUG 13081: smb.conf.5: Sort parameters alphabetically.
+
+o  Samuel Cabrero <scabrero@suse.de>
+   * BUG 12993: s3: spoolss: Fix GUID string format on GetPrinter info.
+
+o  Amitay Isaacs <amitay@gmail.com>
+   * BUG 13042: Remote serverid check doesn't check for the unique id.
+   * BUG 13056: CTDB starts consuming memory if there are dead nodes in the
+     cluster.
+   * BUG 13070: ctdb-common: Ignore event scripts with multiple '.'s.
+
+o  Lutz Justen <ljusten@google.com>
+   * BUG 13046: libgpo doesn't sort the GPOs in the correct order.
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13042: Remote serverid check doesn't check for the unique id.
+   * BUG 13090: vfs_catia: Fix a potential memleak.
+   * BUG 12903: Fix file change notification for renames.
+
+o  Gary Lockyer <gary@catalyst.net.nz>
+   * BUG 12952: Samba DNS server does not honour wildcards.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13079:  Can't change password in samba from a Windows client if Samba
+     runs on IPv6 only interface.
+
+o  Anoop C S <anoopcs@redhat.com>
+   * BUG 13086: vfs_fruit: Replace closedir() by SMB_VFS_CLOSEDIR.
+
+o  Christof Schmitt <cs@samba.org>
+   * BUG 13047: Apple client can't cope with SMB2 async replies when creating
+     symlinks.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 12959: s4:rpc_server:backupkey: Move variable into scope.
+   * BUG 13099: s4:scripting: Fix ntstatus_gen.h generation on 32bit.
+   * BUG 13100: s3:vfs_glusterfs: Fix a double free in vfs_gluster_getwd().
+   * BUG 13101: Fix resouce leaks and pointer issues.
+
+o  Jorge Schrauwen
+   * BUG 13049: vfs_solarisacl: Fix build for samba 4.7 and up.
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
+                   =============================
                    Release Notes for Samba 4.7.0
                         September 20, 2017
                    =============================
diff -Npur samba-4.7.0/ctdb/client/client_control_sync.c samba-4.7.1/ctdb/client/client_control_sync.c
--- samba-4.7.0/ctdb/client/client_control_sync.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/client/client_control_sync.c	2017-11-02 12:38:36.000000000 +0100
@@ -2758,3 +2758,32 @@ int ctdb_ctrl_db_attach_replicated(TALLO
 
 	return 0;
 }
+
+int ctdb_ctrl_check_pid_srvid(TALLOC_CTX *mem_ctx, struct tevent_context *ev,
+			      struct ctdb_client_context *client,
+			      int destnode, struct timeval timeout,
+			      struct ctdb_pid_srvid *pid_srvid, int *status)
+{
+	struct ctdb_req_control request;
+	struct ctdb_reply_control *reply;
+	int ret;
+
+	ctdb_req_control_check_pid_srvid(&request, pid_srvid);
+	ret = ctdb_client_control(mem_ctx, ev, client, destnode, timeout,
+				  &request, &reply);
+	if (ret != 0) {
+		DEBUG(DEBUG_ERR,
+		      ("Control CHECK_PID_SRVID failed to node %u, ret=%d\n",
+		       destnode, ret));
+		return ret;
+	}
+
+	ret = ctdb_reply_control_check_pid_srvid(reply, status);
+	if (ret != 0) {
+		DEBUG(DEBUG_ERR,
+		      ("Control CHECK_PID_SRVID failed, ret=%d\n", ret));
+		return ret;
+	}
+
+	return 0;
+}
diff -Npur samba-4.7.0/ctdb/client/client_sync.h samba-4.7.1/ctdb/client/client_sync.h
--- samba-4.7.0/ctdb/client/client_sync.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/client/client_sync.h	2017-11-02 12:38:36.000000000 +0100
@@ -494,6 +494,11 @@ int ctdb_ctrl_db_attach_replicated(TALLO
 				   int destnode, struct timeval timeout,
 				   const char *db_name, uint32_t *db_id);
 
+int ctdb_ctrl_check_pid_srvid(TALLOC_CTX *mem_ctx, struct tevent_context *ev,
+			      struct ctdb_client_context *client,
+			      int destnode, struct timeval timeout,
+			      struct ctdb_pid_srvid *pid_srvid, int *status);
+
 /* from client/client_message_sync.c */
 
 int ctdb_message_recd_update_ip(TALLOC_CTX *mem_ctx, struct tevent_context *ev,
diff -Npur samba-4.7.0/ctdb/common/ctdb_io.c samba-4.7.1/ctdb/common/ctdb_io.c
--- samba-4.7.0/ctdb/common/ctdb_io.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/common/ctdb_io.c	2017-11-02 12:38:36.000000000 +0100
@@ -300,6 +300,11 @@ int ctdb_queue_send(struct ctdb_queue *q
 	struct ctdb_queue_pkt *pkt;
 	uint32_t length2, full_length;
 
+	/* If the queue does not have valid fd, no point queueing a packet */
+	if (queue->fd == -1) {
+		return 0;
+	}
+
 	if (queue->alignment) {
 		/* enforce the length and alignment rules from the tcp packet allocator */
 		length2 = (length+(queue->alignment-1)) & ~(queue->alignment-1);
diff -Npur samba-4.7.0/ctdb/common/run_event.c samba-4.7.1/ctdb/common/run_event.c
--- samba-4.7.0/ctdb/common/run_event.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/common/run_event.c	2017-11-02 12:38:36.000000000 +0100
@@ -60,6 +60,12 @@ static int script_filter(const struct di
 		return 0;
 	}
 
+	/* Ignore filenames with multiple '.'s */
+	ptr = index(&de->d_name[3], '.');
+	if (ptr != NULL) {
+		return 0;
+	}
+
 	return 1;
 }
 
diff -Npur samba-4.7.0/ctdb/common/srvid.c samba-4.7.1/ctdb/common/srvid.c
--- samba-4.7.0/ctdb/common/srvid.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/common/srvid.c	2017-11-02 12:38:36.000000000 +0100
@@ -221,9 +221,10 @@ int srvid_deregister(struct srvid_contex
 /*
  * Check if a message handler exists
  */
-int srvid_exists(struct srvid_context *srv, uint64_t srvid)
+int srvid_exists(struct srvid_context *srv, uint64_t srvid, void *private_data)
 {
 	struct srvid_handler_list *list;
+	struct srvid_handler *h;
 	int ret;
 
 	ret = srvid_fetch(srv, srvid, &list);
@@ -234,6 +235,16 @@ int srvid_exists(struct srvid_context *s
 		return ENOENT;
 	}
 
+	if (private_data != NULL) {
+		for (h = list->h; h != NULL; h = h->next) {
+			if (h->private_data == private_data) {
+				return 0;
+			}
+		}
+
+		return ENOENT;
+	}
+
 	return 0;
 }
 
diff -Npur samba-4.7.0/ctdb/common/srvid.h samba-4.7.1/ctdb/common/srvid.h
--- samba-4.7.0/ctdb/common/srvid.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/common/srvid.h	2017-11-02 12:38:36.000000000 +0100
@@ -91,11 +91,17 @@ int srvid_deregister(struct srvid_contex
 /**
  * @brief Check if any message handler is registered for srvid
  *
+ * If private_data is NULL, then check if there is any registration
+ * for * specified srvid.  If private_data is not NULL, then check for
+ * registration that matches the specified private data.
+ *
  * @param[in] srv The srvid message handler database context
  * @param[in] srvid The srvid
+ * @param[in] private_data Private data
  * @return 0 on success, errno on failure
  */
-int srvid_exists(struct srvid_context *srv, uint64_t srvid);
+int srvid_exists(struct srvid_context *srv, uint64_t srvid,
+		 void *private_data);
 
 /**
  * @brief Call message handlers for given srvid
diff -Npur samba-4.7.0/ctdb/config/events.d/README samba-4.7.1/ctdb/config/events.d/README
--- samba-4.7.0/ctdb/config/events.d/README	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/config/events.d/README	2017-11-02 12:38:36.000000000 +0100
@@ -11,7 +11,9 @@ alphanumeric sort order.
 
 As a special case, any eventscript that ends with a '~' character will be
 ignored since this is a common postfix that some editors will append to
-older versions of a file.
+older versions of a file.  Similarly, any eventscript with multiple '.'s
+will be ignored as package managers can create copies with additional
+suffix starting with '.' (e.g. .rpmnew, .dpkg-dist).
 
 Only executable event scripts are run by CTDB.  Any event script that
 does not have execute permission is ignored.
diff -Npur samba-4.7.0/ctdb/doc/ctdb-etcd.7 samba-4.7.1/ctdb/doc/ctdb-etcd.7
--- samba-4.7.0/ctdb/doc/ctdb-etcd.7	2017-09-21 08:33:08.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb-etcd.7	2017-11-02 12:44:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdb-statistics.7 samba-4.7.1/ctdb/doc/ctdb-statistics.7
--- samba-4.7.0/ctdb/doc/ctdb-statistics.7	2017-09-21 08:33:07.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb-statistics.7	2017-11-02 12:44:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdb-tunables.7 samba-4.7.1/ctdb/doc/ctdb-tunables.7
--- samba-4.7.0/ctdb/doc/ctdb-tunables.7	2017-09-21 08:33:08.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb-tunables.7	2017-11-02 12:44:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdb.1 samba-4.7.1/ctdb/doc/ctdb.1
--- samba-4.7.0/ctdb/doc/ctdb.1	2017-09-21 08:33:04.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb.1	2017-11-02 12:44:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -1425,9 +1425,9 @@ This lets database dumps (catdb, cattdb,
 .RS 4
 This lets catdb and dumpdbbackup print the record flags for each record\&. Note that cattdb always prints the flags\&.
 .RE
-.SS "process\-exists \fIPID\fR"
+.SS "process\-exists \fIPID\fR \fI[SRVID]\fR"
 .PP
-This command checks if a specific process exists on the CTDB host\&. This is mainly used by Samba to check if remote instances of samba are still running or not\&.
+This command checks if a specific process exists on the CTDB host\&. This is mainly used by Samba to check if remote instances of samba are still running or not\&. When the optional SRVID argument is specified, the command check if a specific process exists on the CTDB host and has registered for specified SRVID\&.
 .SS "getdbstatus \fIDB\fR"
 .PP
 This command displays more details about a database\&.
diff -Npur samba-4.7.0/ctdb/doc/ctdb.1.html samba-4.7.1/ctdb/doc/ctdb.1.html
--- samba-4.7.0/ctdb/doc/ctdb.1.html	2017-09-21 08:33:04.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb.1.html	2017-11-02 12:44:32.000000000 +0100
@@ -898,11 +898,15 @@ RUNNING
 	    This lets catdb and dumpdbbackup print the
 	    record flags for each record. Note that cattdb always
 	    prints the flags.
-	  </p></dd></dl></div></div><div class="refsect2"><a name="idm591"></a><h3>process-exists <em class="parameter"><code>PID</code></em></h3><p>
-	This command checks if a specific process exists on the CTDB host. This is mainly used by Samba to check if remote instances of samba are still running or not.
-      </p></div><div class="refsect2"><a name="idm595"></a><h3>getdbstatus <em class="parameter"><code>DB</code></em></h3><p>
+	  </p></dd></dl></div></div><div class="refsect2"><a name="idm591"></a><h3>process-exists <em class="parameter"><code>PID</code></em> <em class="parameter"><code>[SRVID]</code></em></h3><p>
+	This command checks if a specific process exists on the CTDB
+	host. This is mainly used by Samba to check if remote instances
+	of samba are still running or not.  When the optional SRVID
+	argument is specified, the command check if a specific process
+	exists on the CTDB host and has registered for specified SRVID.
+      </p></div><div class="refsect2"><a name="idm596"></a><h3>getdbstatus <em class="parameter"><code>DB</code></em></h3><p>
 	This command displays more details about a database.
-      </p><div class="refsect3"><a name="idm599"></a><h4>Example</h4><pre class="screen">
+      </p><div class="refsect3"><a name="idm600"></a><h4>Example</h4><pre class="screen">
 # ctdb getdbstatus test.tdb.0
 dbid: 0x122224da
 name: test.tdb
@@ -916,28 +920,28 @@ name: registry.tdb
 path: /usr/local/var/lib/ctdb/persistent/registry.tdb.0
 PERSISTENT: yes
 HEALTH: NO-HEALTHY-NODES - ERROR - Backup of corrupted TDB in '/usr/local/var/lib/ctdb/persistent/registry.tdb.0.corrupted.20091208091949.0Z'
-	</pre></div></div><div class="refsect2"><a name="idm602"></a><h3>catdb <em class="parameter"><code>DB</code></em></h3><p>
+	</pre></div></div><div class="refsect2"><a name="idm603"></a><h3>catdb <em class="parameter"><code>DB</code></em></h3><p>
 	Print a dump of the clustered TDB database DB.
-      </p></div><div class="refsect2"><a name="idm606"></a><h3>cattdb <em class="parameter"><code>DB</code></em></h3><p>
+      </p></div><div class="refsect2"><a name="idm607"></a><h3>cattdb <em class="parameter"><code>DB</code></em></h3><p>
 	Print a dump of the contents of the local TDB database DB.
-      </p></div><div class="refsect2"><a name="idm610"></a><h3>dumpdbbackup <em class="parameter"><code>FILE</code></em></h3><p>
+      </p></div><div class="refsect2"><a name="idm611"></a><h3>dumpdbbackup <em class="parameter"><code>FILE</code></em></h3><p>
 	Print a dump of the contents from database backup FILE,
 	similar to <span class="command"><strong>catdb</strong></span>.
-      </p></div><div class="refsect2"><a name="idm615"></a><h3>wipedb <em class="parameter"><code>DB</code></em></h3><p>
+      </p></div><div class="refsect2"><a name="idm616"></a><h3>wipedb <em class="parameter"><code>DB</code></em></h3><p>
 	Remove all contents of database DB.
-      </p></div><div class="refsect2"><a name="idm619"></a><h3>recover</h3><p>
+      </p></div><div class="refsect2"><a name="idm620"></a><h3>recover</h3><p>
 	This command will trigger the recovery daemon to do a cluster
 	recovery.
-      </p></div><div class="refsect2"><a name="idm622"></a><h3>ipreallocate, sync</h3><p>
+      </p></div><div class="refsect2"><a name="idm623"></a><h3>ipreallocate, sync</h3><p>
 	This command will force the recovery master to perform a full ip reallocation process and redistribute all ip addresses. This is useful to "reset" the allocations back to its default state if they have been changed using the "moveip" command. While a "recover" will also perform this reallocation, a recovery is much more hevyweight since it will also rebuild all the databases.
-      </p></div><div class="refsect2"><a name="idm625"></a><h3>getmonmode</h3><p>
+      </p></div><div class="refsect2"><a name="idm626"></a><h3>getmonmode</h3><p>
 	This command prints the monitoring mode of a node.  This
 	indicates when CTDB is monitoring services on the node. The
 	monitoring mode is either ENABLED or DISABLED.
-      </p></div><div class="refsect2"><a name="idm628"></a><h3>attach <em class="parameter"><code>DBNAME</code></em> [persistent|replicated]</h3><p>
+      </p></div><div class="refsect2"><a name="idm629"></a><h3>attach <em class="parameter"><code>DBNAME</code></em> [persistent|replicated]</h3><p>
 	Create a new CTDB database called DBNAME and attach to it on
 	all nodes.
-      </p></div><div class="refsect2"><a name="idm632"></a><h3>detach <em class="parameter"><code>DB-LIST</code></em></h3><p>
+      </p></div><div class="refsect2"><a name="idm633"></a><h3>detach <em class="parameter"><code>DB-LIST</code></em></h3><p>
 	Detach specified non-persistent database(s) from the cluster. This
 	command will disconnect specified database(s) on all nodes in
 	the cluster.  This command should only be used when none of the
@@ -945,13 +949,13 @@ HEALTH: NO-HEALTHY-NODES - ERROR - Backu
       </p><p>
 	All nodes should be active and tunable AllowClientDBAccess should
 	be disabled on all nodes before detaching databases.
-      </p></div><div class="refsect2"><a name="idm637"></a><h3>dumpmemory</h3><p>
+      </p></div><div class="refsect2"><a name="idm638"></a><h3>dumpmemory</h3><p>
 	This is a debugging command. This command will make the ctdb
 	daemon to write a fill memory allocation map to standard output.
-      </p></div><div class="refsect2"><a name="idm640"></a><h3>rddumpmemory</h3><p>
+      </p></div><div class="refsect2"><a name="idm641"></a><h3>rddumpmemory</h3><p>
 	This is a debugging command. This command will dump the talloc memory
 	allocation tree for the recovery daemon to standard output.
-      </p></div><div class="refsect2"><a name="idm643"></a><h3>ban <em class="parameter"><code>BANTIME</code></em></h3><p>
+      </p></div><div class="refsect2"><a name="idm644"></a><h3>ban <em class="parameter"><code>BANTIME</code></em></h3><p>
 	Administratively ban a node for BANTIME seconds.  The node
 	will be unbanned after BANTIME seconds have elapsed.
       </p><p>
@@ -965,21 +969,21 @@ HEALTH: NO-HEALTHY-NODES - ERROR - Backu
       </p><p>
 	To administratively exclude a node from a cluster use the
 	<span class="command"><strong>stop</strong></span> command.
-      </p></div><div class="refsect2"><a name="idm651"></a><h3>unban</h3><p>
+      </p></div><div class="refsect2"><a name="idm652"></a><h3>unban</h3><p>
 	This command is used to unban a node that has either been
 	administratively banned using the ban command or has been
 	automatically banned.
-      </p></div><div class="refsect2"><a name="idm654"></a><h3>check_srvids <em class="parameter"><code>SRVID</code></em> ...</h3><p>
+      </p></div><div class="refsect2"><a name="idm655"></a><h3>check_srvids <em class="parameter"><code>SRVID</code></em> ...</h3><p>
 	This command checks whether a set of srvid message ports are
 	registered on the node or not. The command takes a list of
 	values to check.
-      </p><div class="refsect3"><a name="idm658"></a><h4>Example</h4><pre class="screen">
+      </p><div class="refsect3"><a name="idm659"></a><h4>Example</h4><pre class="screen">
 # ctdb check_srvids 1 2 3 14765
 Server id 0:1 does not exist
 Server id 0:2 does not exist
 Server id 0:3 does not exist
 Server id 0:14765 exists
-	</pre></div></div></div><div class="refsect1"><a name="idm661"></a><h2>SEE ALSO</h2><p>
+	</pre></div></div></div><div class="refsect1"><a name="idm662"></a><h2>SEE ALSO</h2><p>
       <span class="citerefentry"><span class="refentrytitle">ctdbd</span>(1)</span>,
 
       <span class="citerefentry"><span class="refentrytitle">onnode</span>(1)</span>,
diff -Npur samba-4.7.0/ctdb/doc/ctdb.1.xml samba-4.7.1/ctdb/doc/ctdb.1.xml
--- samba-4.7.0/ctdb/doc/ctdb.1.xml	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb.1.xml	2017-11-02 12:38:36.000000000 +0100
@@ -1681,9 +1681,13 @@ RUNNING
     </refsect2>
 
     <refsect2>
-      <title>process-exists <parameter>PID</parameter></title>
+      <title>process-exists <parameter>PID</parameter> <parameter>[SRVID]</parameter></title>
       <para>
-	This command checks if a specific process exists on the CTDB host. This is mainly used by Samba to check if remote instances of samba are still running or not.
+	This command checks if a specific process exists on the CTDB
+	host. This is mainly used by Samba to check if remote instances
+	of samba are still running or not.  When the optional SRVID
+	argument is specified, the command check if a specific process
+	exists on the CTDB host and has registered for specified SRVID.
       </para>
     </refsect2>
 
diff -Npur samba-4.7.0/ctdb/doc/ctdb.7 samba-4.7.1/ctdb/doc/ctdb.7
--- samba-4.7.0/ctdb/doc/ctdb.7	2017-09-21 08:33:07.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb.7	2017-11-02 12:44:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdb_diagnostics.1 samba-4.7.1/ctdb/doc/ctdb_diagnostics.1
--- samba-4.7.0/ctdb/doc/ctdb_diagnostics.1	2017-09-21 08:33:05.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb_diagnostics.1	2017-11-02 12:44:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.7.1/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.7.0/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2017-09-21 08:33:08.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2017-11-02 12:44:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdbd.1 samba-4.7.1/ctdb/doc/ctdbd.1
--- samba-4.7.0/ctdb/doc/ctdbd.1	2017-09-21 08:33:04.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdbd.1	2017-11-02 12:44:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdbd.conf.5 samba-4.7.1/ctdb/doc/ctdbd.conf.5
--- samba-4.7.0/ctdb/doc/ctdbd.conf.5	2017-09-21 08:33:06.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdbd.conf.5	2017-11-02 12:44:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ctdbd_wrapper.1 samba-4.7.1/ctdb/doc/ctdbd_wrapper.1
--- samba-4.7.0/ctdb/doc/ctdbd_wrapper.1	2017-09-21 08:33:06.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ctdbd_wrapper.1	2017-11-02 12:44:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ltdbtool.1 samba-4.7.1/ctdb/doc/ltdbtool.1
--- samba-4.7.0/ctdb/doc/ltdbtool.1	2017-09-21 08:33:05.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ltdbtool.1	2017-11-02 12:44:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/onnode.1 samba-4.7.1/ctdb/doc/onnode.1
--- samba-4.7.0/ctdb/doc/onnode.1	2017-09-21 08:33:06.000000000 +0200
+++ samba-4.7.1/ctdb/doc/onnode.1	2017-11-02 12:44:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/doc/ping_pong.1 samba-4.7.1/ctdb/doc/ping_pong.1
--- samba-4.7.0/ctdb/doc/ping_pong.1	2017-09-21 08:33:05.000000000 +0200
+++ samba-4.7.1/ctdb/doc/ping_pong.1	2017-11-02 12:44:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "09/21/2017" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "11/02/2017" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/ctdb/include/common/srvid.h samba-4.7.1/ctdb/include/common/srvid.h
--- samba-4.7.0/ctdb/include/common/srvid.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/include/common/srvid.h	2017-11-02 12:38:36.000000000 +0100
@@ -91,11 +91,17 @@ int srvid_deregister(struct srvid_contex
 /**
  * @brief Check if any message handler is registered for srvid
  *
+ * If private_data is NULL, then check if there is any registration
+ * for * specified srvid.  If private_data is not NULL, then check for
+ * registration that matches the specified private data.
+ *
  * @param[in] srv The srvid message handler database context
  * @param[in] srvid The srvid
+ * @param[in] private_data Private data
  * @return 0 on success, errno on failure
  */
-int srvid_exists(struct srvid_context *srv, uint64_t srvid);
+int srvid_exists(struct srvid_context *srv, uint64_t srvid,
+		 void *private_data);
 
 /**
  * @brief Call message handlers for given srvid
diff -Npur samba-4.7.0/ctdb/include/ctdb_private.h samba-4.7.1/ctdb/include/ctdb_private.h
--- samba-4.7.0/ctdb/include/ctdb_private.h	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/include/ctdb_private.h	2017-11-02 12:38:36.000000000 +0100
@@ -584,6 +584,8 @@ struct ctdb_client *ctdb_find_client_by_
 					    pid_t pid);
 
 int32_t ctdb_control_process_exists(struct ctdb_context *ctdb, pid_t pid);
+int32_t ctdb_control_check_pid_srvid(struct ctdb_context *ctdb,
+				     TDB_DATA indata);
 
 int ctdb_control_getnodesfile(struct ctdb_context *ctdb, uint32_t opcode,
 			      TDB_DATA indata, TDB_DATA *outdata);
diff -Npur samba-4.7.0/ctdb/protocol/protocol.h samba-4.7.1/ctdb/protocol/protocol.h
--- samba-4.7.0/ctdb/protocol/protocol.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol.h	2017-11-02 12:38:36.000000000 +0100
@@ -369,6 +369,7 @@ enum ctdb_controls {CTDB_CONTROL_PROCESS
 		    CTDB_CONTROL_DB_PUSH_CONFIRM         = 148,
 		    CTDB_CONTROL_DB_OPEN_FLAGS           = 149,
 		    CTDB_CONTROL_DB_ATTACH_REPLICATED    = 150,
+		    CTDB_CONTROL_CHECK_PID_SRVID         = 151,
 };
 
 #define CTDB_MONITORING_ENABLED		0
@@ -842,6 +843,11 @@ enum ctdb_runstate {
 	CTDB_RUNSTATE_SHUTDOWN,
 };
 
+struct ctdb_pid_srvid {
+	pid_t pid;
+	uint64_t srvid;
+};
+
 struct ctdb_req_control_data {
 	uint32_t opcode;
 	union {
@@ -879,6 +885,7 @@ struct ctdb_req_control_data {
 		struct ctdb_uint64_array *u64_array;
 		struct ctdb_traverse_start_ext *traverse_start_ext;
 		struct ctdb_traverse_all_ext *traverse_all_ext;
+		struct ctdb_pid_srvid *pid_srvid;
 	} data;
 };
 
diff -Npur samba-4.7.0/ctdb/protocol/protocol_api.h samba-4.7.1/ctdb/protocol/protocol_api.h
--- samba-4.7.0/ctdb/protocol/protocol_api.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_api.h	2017-11-02 12:38:36.000000000 +0100
@@ -606,6 +606,11 @@ void ctdb_req_control_db_attach_replicat
 int ctdb_reply_control_db_attach_replicated(struct ctdb_reply_control *reply,
 					    uint32_t *db_id);
 
+void ctdb_req_control_check_pid_srvid(struct ctdb_req_control *request,
+				      struct ctdb_pid_srvid *pid_srvid);
+int ctdb_reply_control_check_pid_srvid(struct ctdb_reply_control *reply,
+				       int *status);
+
 /* From protocol/protocol_debug.c */
 
 void ctdb_packet_print(uint8_t *buf, size_t buflen, FILE *fp);
diff -Npur samba-4.7.0/ctdb/protocol/protocol_client.c samba-4.7.1/ctdb/protocol/protocol_client.c
--- samba-4.7.0/ctdb/protocol/protocol_client.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_client.c	2017-11-02 12:38:36.000000000 +0100
@@ -2386,3 +2386,31 @@ int ctdb_reply_control_db_attach_replica
 	}
 	return reply->status;
 }
+
+/* CTDB_CONTROL_CHECK_PID_SRVID */
+
+void ctdb_req_control_check_pid_srvid(struct ctdb_req_control *request,
+				      struct ctdb_pid_srvid *pid_srvid)
+{
+	request->opcode = CTDB_CONTROL_CHECK_PID_SRVID;
+	request->pad = 0;
+	request->srvid = 0;
+	request->client_id = 0;
+	request->flags = 0;
+
+	request->rdata.opcode = CTDB_CONTROL_CHECK_PID_SRVID;
+	request->rdata.data.pid_srvid = pid_srvid;
+}
+
+int ctdb_reply_control_check_pid_srvid(struct ctdb_reply_control *reply,
+				       int *status)
+{
+	if (reply->rdata.opcode != CTDB_CONTROL_CHECK_PID_SRVID) {
+		return EPROTO;
+	}
+
+	*status = reply->status;
+	reply->status = 0;
+
+	return reply->status;
+}
diff -Npur samba-4.7.0/ctdb/protocol/protocol_control.c samba-4.7.1/ctdb/protocol/protocol_control.c
--- samba-4.7.0/ctdb/protocol/protocol_control.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_control.c	2017-11-02 12:38:36.000000000 +0100
@@ -434,6 +434,10 @@ static size_t ctdb_req_control_data_len(
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
 		len = ctdb_string_len(cd->data.db_name);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		len = ctdb_pid_srvid_len(cd->data.pid_srvid);
+		break;
 	}
 
 	return len;
@@ -705,6 +709,10 @@ static void ctdb_req_control_data_push(s
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
 		ctdb_string_push(cd->data.db_name, buf);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		ctdb_pid_srvid_push(cd->data.pid_srvid, buf);
+		break;
 	}
 }
 
@@ -1045,6 +1053,11 @@ static int ctdb_req_control_data_pull(ui
 		ret = ctdb_string_pull(buf, buflen, mem_ctx,
 				       &cd->data.db_name);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		ret = ctdb_pid_srvid_pull(buf, buflen, mem_ctx,
+					  &cd->data.pid_srvid);
+		break;
 	}
 
 	return ret;
@@ -1414,6 +1427,9 @@ static size_t ctdb_reply_control_data_le
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
 		len = ctdb_uint32_len(cd->data.db_id);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		break;
 	}
 
 	return len;
@@ -1574,6 +1590,9 @@ static void ctdb_reply_control_data_push
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
 		ctdb_uint32_push(cd->data.db_id, buf);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		break;
 	}
 }
 
@@ -1771,6 +1790,9 @@ static int ctdb_reply_control_data_pull(
 		ret = ctdb_uint32_pull(buf, buflen, mem_ctx,
 				       &cd->data.db_id);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		break;
 	}
 
 	return ret;
diff -Npur samba-4.7.0/ctdb/protocol/protocol_debug.c samba-4.7.1/ctdb/protocol/protocol_debug.c
--- samba-4.7.0/ctdb/protocol/protocol_debug.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_debug.c	2017-11-02 12:38:36.000000000 +0100
@@ -239,6 +239,7 @@ static void ctdb_opcode_print(uint32_t o
 		{ CTDB_CONTROL_DB_PUSH_CONFIRM, "DB_PUSH_CONFIRM" },
 		{ CTDB_CONTROL_DB_OPEN_FLAGS, "DB_OPEN_FLAGS" },
 		{ CTDB_CONTROL_DB_ATTACH_REPLICATED, "DB_ATTACH_REPLICATED" },
+		{ CTDB_CONTROL_CHECK_PID_SRVID, "CHECK_PID_SRVID" },
 		{ MAP_END, "" },
 	};
 
diff -Npur samba-4.7.0/ctdb/protocol/protocol_private.h samba-4.7.1/ctdb/protocol/protocol_private.h
--- samba-4.7.0/ctdb/protocol/protocol_private.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_private.h	2017-11-02 12:38:36.000000000 +0100
@@ -240,6 +240,11 @@ void ctdb_db_statistics_push(struct ctdb
 int ctdb_db_statistics_pull(uint8_t *buf, size_t buflen, TALLOC_CTX *mem_ctx,
 			    struct ctdb_db_statistics **out);
 
+size_t ctdb_pid_srvid_len(struct ctdb_pid_srvid *in);
+void ctdb_pid_srvid_push(struct ctdb_pid_srvid *in, uint8_t *buf);
+int ctdb_pid_srvid_pull(uint8_t *buf, size_t buflen, TALLOC_CTX *mem_ctx,
+			struct ctdb_pid_srvid **out);
+
 size_t ctdb_election_message_len(struct ctdb_election_message *election);
 void ctdb_election_message_push(struct ctdb_election_message *election,
 				uint8_t *buf);
diff -Npur samba-4.7.0/ctdb/protocol/protocol_types.c samba-4.7.1/ctdb/protocol/protocol_types.c
--- samba-4.7.0/ctdb/protocol/protocol_types.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/protocol/protocol_types.c	2017-11-02 12:38:36.000000000 +0100
@@ -2394,6 +2394,53 @@ int ctdb_db_statistics_pull(uint8_t *buf
 	return 0;
 }
 
+size_t ctdb_pid_srvid_len(struct ctdb_pid_srvid *in)
+{
+	return ctdb_pid_len(in->pid) +
+		ctdb_uint64_len(in->srvid);
+}
+
+void ctdb_pid_srvid_push(struct ctdb_pid_srvid *in, uint8_t *buf)
+{
+	size_t offset = 0;
+
+	ctdb_pid_push(in->pid, buf+offset);
+	offset += ctdb_pid_len(in->pid);
+
+	ctdb_uint64_push(in->srvid, buf+offset);
+}
+
+int ctdb_pid_srvid_pull(uint8_t *buf, size_t buflen, TALLOC_CTX *mem_ctx,
+			struct ctdb_pid_srvid **out)
+{
+	struct ctdb_pid_srvid *val;
+	size_t offset = 0;
+	int ret;
+
+	val = talloc(mem_ctx, struct ctdb_pid_srvid);
+	if (val == NULL) {
+		return ENOMEM;
+	}
+
+	ret = ctdb_pid_pull(buf+offset, buflen-offset, val, &val->pid);
+	if (ret != 0) {
+		goto fail;
+	}
+	offset += ctdb_pid_len(val->pid);
+
+	ret = ctdb_uint64_pull(buf+offset, buflen-offset, val, &val->srvid);
+	if (ret != 0) {
+		goto fail;
+	}
+
+	*out = val;
+	return 0;
+
+fail:
+	talloc_free(val);
+	return ret;
+}
+
 size_t ctdb_election_message_len(struct ctdb_election_message *election)
 {
 	return sizeof(struct ctdb_election_message);
diff -Npur samba-4.7.0/ctdb/server/ctdb_control.c samba-4.7.1/ctdb/server/ctdb_control.c
--- samba-4.7.0/ctdb/server/ctdb_control.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/server/ctdb_control.c	2017-11-02 12:38:36.000000000 +0100
@@ -701,6 +701,10 @@ static int32_t ctdb_control_dispatch(str
 		return 0;
 	}
 
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		CHECK_CONTROL_DATA_SIZE((sizeof(pid_t) + sizeof(uint64_t)));
+		return ctdb_control_check_pid_srvid(ctdb, indata);
+
 	default:
 		DEBUG(DEBUG_CRIT,(__location__ " Unknown CTDB control opcode %u\n", opcode));
 		return -1;
diff -Npur samba-4.7.0/ctdb/server/ctdb_daemon.c samba-4.7.1/ctdb/server/ctdb_daemon.c
--- samba-4.7.0/ctdb/server/ctdb_daemon.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/server/ctdb_daemon.c	2017-11-02 12:38:36.000000000 +0100
@@ -230,7 +230,7 @@ int daemon_check_srvids(struct ctdb_cont
 		return -1;
 	}
 	for (i=0; i<num_ids; i++) {
-		if (srvid_exists(ctdb->srv, ids[i]) == 0) {
+		if (srvid_exists(ctdb->srv, ids[i], NULL) == 0) {
 			results[i/8] |= (1 << (i%8));
 		}
 	}
@@ -1813,6 +1813,32 @@ int32_t ctdb_control_process_exists(stru
 	return kill(pid, 0);
 }
 
+int32_t ctdb_control_check_pid_srvid(struct ctdb_context *ctdb,
+				     TDB_DATA indata)
+{
+	struct ctdb_client_pid_list *client_pid;
+	pid_t pid;
+	uint64_t srvid;
+	int ret;
+
+	pid = *(pid_t *)indata.dptr;
+	srvid = *(uint64_t *)(indata.dptr + sizeof(pid_t));
+
+	for (client_pid = ctdb->client_pids;
+	     client_pid != NULL;
+	     client_pid = client_pid->next) {
+		if (client_pid->pid == pid) {
+			ret = srvid_exists(ctdb->srv, srvid,
+					   client_pid->client);
+			if (ret == 0) {
+				return 0;
+			}
+		}
+	}
+
+	return -1;
+}
+
 int ctdb_control_getnodesfile(struct ctdb_context *ctdb, uint32_t opcode, TDB_DATA indata, TDB_DATA *outdata)
 {
 	struct ctdb_node_map_old *node_map = NULL;
diff -Npur samba-4.7.0/ctdb/server/ctdb_ltdb_server.c samba-4.7.1/ctdb/server/ctdb_ltdb_server.c
--- samba-4.7.0/ctdb/server/ctdb_ltdb_server.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/server/ctdb_ltdb_server.c	2017-11-02 12:38:36.000000000 +0100
@@ -1206,7 +1206,7 @@ int32_t ctdb_control_db_attach(struct ct
 	}
 
 	/* tell all the other nodes about this database */
-	ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_ALL, 0, opcode,
+	ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_CONNECTED, 0, opcode,
 				 0, CTDB_CTRL_FLAG_NOREPLY,
 				 indata, NULL, NULL);
 
@@ -1260,7 +1260,8 @@ int32_t ctdb_control_db_detach(struct ct
 		client = reqid_find(ctdb->idr, client_id, struct ctdb_client);
 		if (client != NULL) {
 			/* forward the control to all the nodes */
-			ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_ALL, 0,
+			ctdb_daemon_send_control(ctdb,
+						 CTDB_BROADCAST_CONNECTED, 0,
 						 CTDB_CONTROL_DB_DETACH, 0,
 						 CTDB_CTRL_FLAG_NOREPLY,
 						 indata, NULL, NULL);
diff -Npur samba-4.7.0/ctdb/tests/cunit/protocol_test_002.sh samba-4.7.1/ctdb/tests/cunit/protocol_test_002.sh
--- samba-4.7.0/ctdb/tests/cunit/protocol_test_002.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/cunit/protocol_test_002.sh	2017-11-02 12:38:36.000000000 +0100
@@ -2,7 +2,7 @@
 
 . "${TEST_SCRIPTS_DIR}/unit.sh"
 
-last_control=150
+last_control=151
 
 control_output=$(
     for i in $(seq 0 $last_control) ; do
diff -Npur samba-4.7.0/ctdb/tests/cunit/run_event_001.sh samba-4.7.1/ctdb/tests/cunit/run_event_001.sh
--- samba-4.7.0/ctdb/tests/cunit/run_event_001.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/cunit/run_event_001.sh	2017-11-02 12:38:36.000000000 +0100
@@ -37,6 +37,27 @@ required_result 1 <<EOF
 EOF
 unit_test test -x "${scriptdir}/prog"
 
+cat > "$scriptdir/10.test.rpmnew" <<EOF
+#!/bin/sh
+
+echo hello
+EOF
+chmod +x "$scriptdir/10.test.rpmnew"
+
+# Invalid script with multiple '.'s
+ok <<EOF
+No event scripts found
+EOF
+unit_test run_event_test "$scriptdir" list
+
+ok <<EOF
+Script disable 10.test.rpmnew completed with result=22
+EOF
+unit_test run_event_test "$scriptdir" disable 10.test.rpmnew
+
+ok_null
+unit_test test -x "${scriptdir}/10.test.rpmnew"
+
 cat > "$scriptdir/11.foo" <<EOF
 #!/bin/sh
 
diff -Npur samba-4.7.0/ctdb/tests/eventd/scripts/local.sh samba-4.7.1/ctdb/tests/eventd/scripts/local.sh
--- samba-4.7.0/ctdb/tests/eventd/scripts/local.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/eventd/scripts/local.sh	2017-11-02 12:38:36.000000000 +0100
@@ -42,7 +42,7 @@ cleanup_eventd ()
 
 setup_eventd ()
 {
-	debug "Setting up eventd"
+	echo "Setting up eventd"
 
 	if [ -n "$1" ]; then
 		extra_args="-D $1"
@@ -53,9 +53,8 @@ setup_eventd ()
 		-e "$eventd_scriptdir" \
 		-l "file:" -d "DEBUG" $extra_args 2>&1 | tee "$eventd_logfile" &
 	# Wait till eventd is running
-	while [ ! -S "$eventd_socket" ] ; do
-		sleep 1
-	done
+	wait_until 10 test -S "$eventd_socket" || \
+		die "ctdb_eventd failed to start"
 
 	test_cleanup cleanup_eventd
 }
diff -Npur samba-4.7.0/ctdb/tests/scripts/common.sh samba-4.7.1/ctdb/tests/scripts/common.sh
--- samba-4.7.0/ctdb/tests/scripts/common.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/scripts/common.sh	2017-11-02 12:38:36.000000000 +0100
@@ -43,3 +43,47 @@ die ()
 {
     echo "$1" >&2 ; exit ${2:-1}
 }
+
+# Wait until either timeout expires or command succeeds.  The command
+# will be tried once per second, unless timeout has format T/I, where
+# I is the recheck interval.
+wait_until ()
+{
+    local timeout="$1" ; shift # "$@" is the command...
+
+    local interval=1
+    case "$timeout" in
+	*/*)
+	    interval="${timeout#*/}"
+	    timeout="${timeout%/*}"
+    esac
+
+    local negate=false
+    if [ "$1" = "!" ] ; then
+	negate=true
+	shift
+    fi
+
+    echo -n "<${timeout}|"
+    local t=$timeout
+    while [ $t -gt 0 ] ; do
+	local rc=0
+	"$@" || rc=$?
+	if { ! $negate && [ $rc -eq 0 ] ; } || \
+	    { $negate && [ $rc -ne 0 ] ; } ; then
+	    echo "|$(($timeout - $t))|"
+	    echo "OK"
+	    return 0
+	fi
+	local i
+	for i in $(seq 1 $interval) ; do
+	    echo -n .
+	done
+	t=$(($t - $interval))
+	sleep $interval
+    done
+
+    echo "*TIMEOUT*"
+
+    return 1
+}
diff -Npur samba-4.7.0/ctdb/tests/scripts/integration.bash samba-4.7.1/ctdb/tests/scripts/integration.bash
--- samba-4.7.0/ctdb/tests/scripts/integration.bash	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.1/ctdb/tests/scripts/integration.bash	2017-11-02 12:38:36.000000000 +0100
@@ -259,50 +259,6 @@ delete_ip_from_all_nodes ()
 
 #######################################
 
-# Wait until either timeout expires or command succeeds.  The command
-# will be tried once per second, unless timeout has format T/I, where
-# I is the recheck interval.
-wait_until ()
-{
-    local timeout="$1" ; shift # "$@" is the command...
-
-    local interval=1
-    case "$timeout" in
-	*/*)
-	    interval="${timeout#*/}"
-	    timeout="${timeout%/*}"
-    esac
-
-    local negate=false
-    if [ "$1" = "!" ] ; then
-	negate=true
-	shift
-    fi
-
-    echo -n "<${timeout}|"
-    local t=$timeout
-    while [ $t -gt 0 ] ; do
-	local rc=0
-	"$@" || rc=$?
-	if { ! $negate && [ $rc -eq 0 ] ; } || \
-	    { $negate && [ $rc -ne 0 ] ; } ; then
-	    echo "|$(($timeout - $t))|"
-	    echo "OK"
-	    return 0
-	fi
-	local i
-	for i in $(seq 1 $interval) ; do
-	    echo -n .
-	done
-	t=$(($t - $interval))
-	sleep $interval
-    done
-
-    echo "*TIMEOUT*"
-
-    return 1
-}
-
 sleep_for ()
 {
     echo -n "=${1}|"
diff -Npur samba-4.7.0/ctdb/tests/simple/07_ctdb_process_exists.sh samba-4.7.1/ctdb/tests/simple/07_ctdb_process_exists.sh
--- samba-4.7.0/ctdb/tests/simple/07_ctdb_process_exists.sh	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/tests/simple/07_ctdb_process_exists.sh	2017-11-02 12:38:36.000000000 +0100
@@ -36,11 +36,12 @@ set -e
 cluster_is_healthy
 
 test_node=1
+srvid=0xAE00000012345678
 
 # Execute a ctdb client on $test_node that will last for 60 seconds.
 # It should still be there when we check.
 try_command_on_node -v $test_node \
-	"$CTDB_TEST_WRAPPER exec dummy_client >/dev/null 2>&1 & echo \$!"
+	"$CTDB_TEST_WRAPPER exec dummy_client -n 10 -S ${srvid} >/dev/null 2>&1 & echo \$!"
 client_pid="$out"
 
 cleanup ()
@@ -65,6 +66,23 @@ else
     testfailures=1
 fi
 
+echo "Checking for PID $client_pid with SRVID $srvid on node $test_node"
+status=0
+try_command_on_node $test_node \
+	"$CTDB process-exists ${client_pid} ${srvid}" || status=$?
+echo "$out"
+
+if [ $status -eq 0 ] ; then
+    echo "OK"
+else
+    echo "BAD"
+    testfailures=1
+fi
+
+echo "Checking for PID $client_pid with SRVID $client_pid on node $test_node"
+try_command_on_node -v $test_node \
+	"! $CTDB process-exists ${client_pid} ${client_pid}"
+
 # Now just echo the PID of the ctdb daemon on test node.
 # This is not a ctdb client and process-exists should return error.
 try_command_on_node $test_node "ctdb getpid"
diff -Npur samba-4.7.0/ctdb/tests/src/cluster_wait.c samba-4.7.1/ctdb/tests/src/cluster_wait.c
--- samba-4.7.0/ctdb/tests/src/cluster_wait.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/cluster_wait.c	2017-11-02 12:38:36.000000000 +0100
@@ -264,7 +264,7 @@ static void cluster_wait_join_unregister
 	msg.data.data = tdb_null;
 
 	subreq = ctdb_client_message_send(state, state->ev, state->client,
-					  CTDB_BROADCAST_ALL, &msg);
+					  CTDB_BROADCAST_CONNECTED, &msg);
 	if (tevent_req_nomem(subreq, req)) {
 		return;
 	}
diff -Npur samba-4.7.0/ctdb/tests/src/dummy_client.c samba-4.7.1/ctdb/tests/src/dummy_client.c
--- samba-4.7.0/ctdb/tests/src/dummy_client.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/dummy_client.c	2017-11-02 12:38:36.000000000 +0100
@@ -31,6 +31,7 @@
 static struct {
 	const char *sockpath;
 	const char *debuglevel;
+	int num_connections;
 	int timelimit;
 	const char *srvidstr;
 } options;
@@ -41,6 +42,8 @@ static struct poptOption cmdline_options
 		"Unix domain socket path", "filename" },
 	{ "debug", 'd', POPT_ARG_STRING, &options.debuglevel, 0,
 		"debug level", "ERR|WARNING|NOTICE|INFO|DEBUG" } ,
+	{ "nconn", 'n', POPT_ARG_INT, &options.num_connections, 0,
+		"number of connections", "" },
 	{ "timelimit", 't', POPT_ARG_INT, &options.timelimit, 0,
 		"time limit", "seconds" },
 	{ "srvid", 'S', POPT_ARG_STRING, &options.srvidstr, 0,
@@ -59,16 +62,18 @@ int main(int argc, const char *argv[])
 {
 	TALLOC_CTX *mem_ctx;
 	struct tevent_context *ev;
-	struct ctdb_client_context *client;
+	struct ctdb_client_context **client;
+	struct ctdb_client_context *last_client;
 	const char *ctdb_socket;
 	poptContext pc;
-	int opt, ret;
+	int opt, ret, i;
 	int log_level;
 	bool status, done;
 
 	/* Set default options */
 	options.sockpath = CTDB_SOCKET;
 	options.debuglevel = "ERR";
+	options.num_connections = 1;
 	options.timelimit = 60;
 	options.srvidstr = NULL;
 
@@ -112,19 +117,32 @@ int main(int argc, const char *argv[])
 	setup_logging("dummy_client", DEBUG_STDERR);
 	DEBUGLEVEL = log_level;
 
-	ret = ctdb_client_init(mem_ctx, ev, options.sockpath, &client);
-	if (ret != 0) {
-		D_ERR("Failed to initialize client, ret=%d\n", ret);
+	client = talloc_array(mem_ctx, struct ctdb_client_context *,
+			      options.num_connections);
+	if (client == NULL) {
+		fprintf(stderr, "Memory allocation error\n");
 		exit(1);
 	}
 
+	for (i=0; i<options.num_connections; i++) {
+		ret = ctdb_client_init(client, ev, options.sockpath,
+				       &client[i]);
+		if (ret != 0) {
+			D_ERR("Failed to initialize client %d, ret=%d\n",
+			      i, ret);
+			exit(1);
+		}
+	}
+
+	last_client = client[options.num_connections-1];
+
 	done = false;
 	if (options.srvidstr != NULL) {
 		uint64_t srvid;
 
 		srvid = strtoull(options.srvidstr, NULL, 0);
 
-		ret = ctdb_client_set_message_handler(ev, client, srvid,
+		ret = ctdb_client_set_message_handler(ev, last_client, srvid,
 						      dummy_handler, &done);
 		if (ret != 0) {
 			D_ERR("Failed to register srvid, ret=%d\n", ret);
@@ -143,6 +161,6 @@ int main(int argc, const char *argv[])
 		exit(1);
 	}
 
-	talloc_free(client);
+	talloc_free(mem_ctx);
 	exit(0);
 }
diff -Npur samba-4.7.0/ctdb/tests/src/fake_ctdbd.c samba-4.7.1/ctdb/tests/src/fake_ctdbd.c
--- samba-4.7.0/ctdb/tests/src/fake_ctdbd.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/fake_ctdbd.c	2017-11-02 12:38:36.000000000 +0100
@@ -39,6 +39,7 @@
 #include "common/system.h"
 #include "common/logging.h"
 #include "common/tunable.h"
+#include "common/srvid.h"
 
 #include "ipalloc_read_known_ips.h"
 
@@ -94,12 +95,6 @@ struct database_map {
 	struct database *db;
 };
 
-struct srvid_register_state {
-	struct srvid_register_state *prev, *next;
-	struct ctdbd_context *ctdb;
-	uint64_t srvid;
-};
-
 struct fake_control_failure {
 	struct fake_control_failure  *prev, *next;
 	enum ctdb_controls opcode;
@@ -120,7 +115,7 @@ struct ctdbd_context {
 	struct interface_map *iface_map;
 	struct vnn_map *vnn_map;
 	struct database_map *db_map;
-	struct srvid_register_state *rstate;
+	struct srvid_context *srv;
 	int num_clients;
 	struct timeval start_time;
 	struct timeval recovery_start_time;
@@ -898,6 +893,7 @@ static struct ctdbd_context *ctdbd_setup
 	struct ctdbd_context *ctdb;
 	char line[1024];
 	bool status;
+	int ret;
 
 	ctdb = talloc_zero(mem_ctx, struct ctdbd_context);
 	if (ctdb == NULL) {
@@ -924,6 +920,11 @@ static struct ctdbd_context *ctdbd_setup
 		goto fail;
 	}
 
+	ret = srvid_init(ctdb, &ctdb->srv);
+	if (ret != 0) {
+		goto fail;
+	}
+
 	while (fgets(line, sizeof(line), stdin) != NULL) {
 		char *t;
 
@@ -1592,10 +1593,9 @@ fail:
 
 }
 
-static int srvid_register_state_destructor(struct srvid_register_state *rstate)
+static void srvid_handler(uint64_t srvid, TDB_DATA data, void *private_data)
 {
-	DLIST_REMOVE(rstate->ctdb->rstate, rstate);
-	return 0;
+	printf("Received a message for SRVID 0x%"PRIx64"\n", srvid);
 }
 
 static void control_register_srvid(TALLOC_CTX *mem_ctx,
@@ -1607,24 +1607,19 @@ static void control_register_srvid(TALLO
 		req, struct client_state);
 	struct ctdbd_context *ctdb = state->ctdb;
 	struct ctdb_reply_control reply;
-	struct srvid_register_state *rstate;
+	int ret;
 
 	reply.rdata.opcode = request->opcode;
 
-	rstate = talloc_zero(ctdb, struct srvid_register_state);
-	if (rstate == NULL) {
+	ret = srvid_register(ctdb->srv, state, request->srvid,
+			     srvid_handler, state);
+	if (ret != 0) {
 		reply.status = -1;
 		reply.errmsg = "Memory error";
 		goto fail;
 	}
-	rstate->ctdb = ctdb;
-	rstate->srvid = request->srvid;
 
-	talloc_set_destructor(rstate, srvid_register_state_destructor);
-
-	DLIST_ADD_END(ctdb->rstate, rstate);
-
-	DEBUG(DEBUG_INFO, ("Register srvid 0x%"PRIx64"\n", rstate->srvid));
+	DEBUG(DEBUG_INFO, ("Register srvid 0x%"PRIx64"\n", request->srvid));
 
 	reply.status = 0;
 	reply.errmsg = NULL;
@@ -1642,33 +1637,23 @@ static void control_deregister_srvid(TAL
 		req, struct client_state);
 	struct ctdbd_context *ctdb = state->ctdb;
 	struct ctdb_reply_control reply;
-	struct srvid_register_state *rstate = NULL;
+	int ret;
 
 	reply.rdata.opcode = request->opcode;
 
-	for (rstate = ctdb->rstate; rstate != NULL; rstate = rstate->next) {
-		if (rstate->srvid == request->srvid) {
-			break;
-		}
-	}
-
-	if (rstate == NULL) {
+	ret = srvid_deregister(ctdb->srv, request->srvid, state);
+	if (ret != 0) {
 		reply.status = -1;
 		reply.errmsg = "srvid not registered";
 		goto fail;
 	}
 
-	DEBUG(DEBUG_INFO, ("Deregister srvid 0x%"PRIx64"\n", rstate->srvid));
-	talloc_free(rstate);
+	DEBUG(DEBUG_INFO, ("Deregister srvid 0x%"PRIx64"\n", request->srvid));
 
 	reply.status = 0;
 	reply.errmsg = NULL;
 
-	client_send_control(req, header, &reply);
-	return;
-
 fail:
-	TALLOC_FREE(rstate);
 	client_send_control(req, header, &reply);
 }
 
@@ -2854,6 +2839,57 @@ fail:
 	client_send_control(req, header, &reply);
 }
 
+static void control_check_pid_srvid(TALLOC_CTX *mem_ctx,
+				    struct tevent_req *req,
+				    struct ctdb_req_header *header,
+				    struct ctdb_req_control *request)
+{
+	struct client_state *state = tevent_req_data(
+		req, struct client_state);
+	struct ctdbd_context *ctdb = state->ctdb;
+	struct ctdb_client *client;
+	struct client_state *cstate;
+	struct ctdb_reply_control reply;
+	bool pid_found, srvid_found;
+	int ret;
+
+	reply.rdata.opcode = request->opcode;
+
+	pid_found = false;
+	srvid_found = false;
+
+	for (client=ctdb->client_list; client != NULL; client=client->next) {
+		if (client->pid == request->rdata.data.pid_srvid->pid) {
+			pid_found = true;
+			cstate = (struct client_state *)client->state;
+			ret = srvid_exists(ctdb->srv,
+					   request->rdata.data.pid_srvid->srvid,
+					   cstate);
+			if (ret == 0) {
+				srvid_found = true;
+				ret = kill(cstate->pid, 0);
+				if (ret != 0) {
+					reply.status = ret;
+					reply.errmsg = strerror(errno);
+				} else {
+					reply.status = 0;
+					reply.errmsg = NULL;
+				}
+			}
+		}
+	}
+
+	if (! pid_found) {
+		reply.status = -1;
+		reply.errmsg = "No client for PID";
+	} else if (! srvid_found) {
+		reply.status = -1;
+		reply.errmsg = "No client for PID and SRVID";
+	}
+
+	client_send_control(req, header, &reply);
+}
+
 static bool fake_control_failure(TALLOC_CTX *mem_ctx,
 				 struct tevent_req *req,
 				 struct ctdb_req_header *header,
@@ -3453,6 +3489,10 @@ static void client_process_control(struc
 		control_get_nodes_file(mem_ctx, req, &header, &request);
 		break;
 
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		control_check_pid_srvid(mem_ctx, req, &header, &request);
+		break;
+
 	default:
 		if (! (request.flags & CTDB_CTRL_FLAG_NOREPLY)) {
 			control_error(mem_ctx, req, &header, &request);
diff -Npur samba-4.7.0/ctdb/tests/src/protocol_client_test.c samba-4.7.1/ctdb/tests/src/protocol_client_test.c
--- samba-4.7.0/ctdb/tests/src/protocol_client_test.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/protocol_client_test.c	2017-11-02 12:38:36.000000000 +0100
@@ -600,6 +600,12 @@ static void fill_ctdb_req_control_data(T
 		fill_ctdb_string(mem_ctx, &cd->data.db_name);
 		assert(cd->data.db_name != NULL);
 		break;
+
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		cd->data.pid_srvid = talloc(mem_ctx, struct ctdb_pid_srvid);
+		assert(cd->data.pid_srvid != NULL);
+		fill_ctdb_pid_srvid(mem_ctx, cd->data.pid_srvid);
+		break;
 	}
 }
 
@@ -1004,6 +1010,9 @@ static void verify_ctdb_req_control_data
 		verify_ctdb_string(cd->data.db_name, cd2->data.db_name);
 		break;
 
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		verify_ctdb_pid_srvid(cd->data.pid_srvid, cd2->data.pid_srvid);
+		break;
 	}
 }
 
@@ -1420,6 +1429,8 @@ static void fill_ctdb_reply_control_data
 		cd->data.db_id = rand32();
 		break;
 
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		break;
 	}
 }
 
@@ -1766,6 +1777,8 @@ static void verify_ctdb_reply_control_da
 		assert(cd->data.db_id == cd2->data.db_id);
 		break;
 
+	case CTDB_CONTROL_CHECK_PID_SRVID:
+		break;
 	}
 }
 
@@ -2208,7 +2221,7 @@ static void test_ctdb_reply_dmaster(void
 	talloc_free(mem_ctx);
 }
 
-#define NUM_CONTROLS	151
+#define NUM_CONTROLS	152
 
 static void test_ctdb_req_control_data(void)
 {
diff -Npur samba-4.7.0/ctdb/tests/src/protocol_types_test.c samba-4.7.1/ctdb/tests/src/protocol_types_test.c
--- samba-4.7.0/ctdb/tests/src/protocol_types_test.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/protocol_types_test.c	2017-11-02 12:38:36.000000000 +0100
@@ -915,6 +915,19 @@ static void verify_ctdb_db_statistics(st
 	}
 }
 
+static void fill_ctdb_pid_srvid(TALLOC_CTX *mem_ctx, struct ctdb_pid_srvid *p)
+{
+	p->pid = rand32();
+	p->srvid = rand64();
+}
+
+static void verify_ctdb_pid_srvid(struct ctdb_pid_srvid *p1,
+				  struct ctdb_pid_srvid *p2)
+{
+	assert(p1->pid == p2->pid);
+	assert(p1->srvid == p2->srvid);
+}
+
 static void fill_ctdb_event_request_run(TALLOC_CTX *mem_ctx,
 					struct ctdb_event_request_run *p)
 {
@@ -1322,6 +1335,7 @@ DEFINE_TEST(struct ctdb_key_data, ctdb_k
 DEFINE_TEST(struct ctdb_uint8_array, ctdb_uint8_array);
 DEFINE_TEST(struct ctdb_uint64_array, ctdb_uint64_array);
 DEFINE_TEST(struct ctdb_db_statistics, ctdb_db_statistics);
+DEFINE_TEST(struct ctdb_pid_srvid, ctdb_pid_srvid);
 DEFINE_TEST(struct ctdb_election_message, ctdb_election_message);
 DEFINE_TEST(struct ctdb_srvid_message, ctdb_srvid_message);
 DEFINE_TEST(struct ctdb_disable_message, ctdb_disable_message);
@@ -1438,6 +1452,7 @@ int main(int argc, char *argv[])
 	TEST_FUNC(ctdb_uint8_array)();
 	TEST_FUNC(ctdb_uint64_array)();
 	TEST_FUNC(ctdb_db_statistics)();
+	TEST_FUNC(ctdb_pid_srvid)();
 	TEST_FUNC(ctdb_election_message)();
 	TEST_FUNC(ctdb_srvid_message)();
 	TEST_FUNC(ctdb_disable_message)();
diff -Npur samba-4.7.0/ctdb/tests/src/srvid_test.c samba-4.7.1/ctdb/tests/src/srvid_test.c
--- samba-4.7.0/ctdb/tests/src/srvid_test.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/src/srvid_test.c	2017-11-02 12:38:36.000000000 +0100
@@ -52,7 +52,10 @@ int main(void)
 	ret = srvid_register(srv, tmp_ctx, TEST_SRVID, test_handler, &count);
 	assert(ret == 0);
 
-	ret = srvid_exists(srv, TEST_SRVID);
+	ret = srvid_exists(srv, TEST_SRVID, NULL);
+	assert(ret == 0);
+
+	ret = srvid_exists(srv, TEST_SRVID, &count);
 	assert(ret == 0);
 
 	ret = srvid_dispatch(srv, TEST_SRVID, 0, tdb_null);
@@ -73,7 +76,7 @@ int main(void)
 	assert(ret == 0);
 
 	talloc_free(tmp_ctx);
-	ret = srvid_exists(srv, TEST_SRVID);
+	ret = srvid_exists(srv, TEST_SRVID, NULL);
 	assert(ret == ENOENT);
 
 	ret = srvid_dispatch(srv, TEST_SRVID, 0, tdb_null);
@@ -84,8 +87,13 @@ int main(void)
 
 	ret = srvid_register(srv, tmp_ctx, TEST_SRVID, test_handler, NULL);
 	assert(ret == 0);
+	ret = srvid_exists(srv, TEST_SRVID, &count);
+	assert(ret == ENOENT);
+
 	ret = srvid_register(srv, tmp_ctx, TEST_SRVID, test_handler, &count);
 	assert(ret == 0);
+	ret = srvid_exists(srv, TEST_SRVID, &count);
+	assert(ret == 0);
 
 	talloc_free(srv);
 	assert(talloc_get_size(mem_ctx) == 0);
diff -Npur samba-4.7.0/ctdb/tests/tool/ctdb.getcapabilities.003.sh samba-4.7.1/ctdb/tests/tool/ctdb.getcapabilities.003.sh
--- samba-4.7.0/ctdb/tests/tool/ctdb.getcapabilities.003.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/tool/ctdb.getcapabilities.003.sh	2017-11-02 12:38:36.000000000 +0100
@@ -10,12 +10,13 @@ setup_nodes <<EOF
 192.168.20.43
 EOF
 
-setup_ctdbd <<EOF
-NODEMAP
-0       192.168.20.41   0x1     CURRENT RECMASTER
-1       192.168.20.42   0x0
-2       192.168.20.43   0x0
-EOF
+# Don't setup ctdbd - disconnected on current node
+#setup_ctdbd <<EOF
+#NODEMAP
+#0       192.168.20.41   0x1     CURRENT RECMASTER
+#1       192.168.20.42   0x0
+#2       192.168.20.43   0x0
+#EOF
 
 required_result 1 <<EOF
 connect() failed, errno=2
diff -Npur samba-4.7.0/ctdb/tests/tool/ctdb.lvs.008.sh samba-4.7.1/ctdb/tests/tool/ctdb.lvs.008.sh
--- samba-4.7.0/ctdb/tests/tool/ctdb.lvs.008.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/tool/ctdb.lvs.008.sh	2017-11-02 12:38:36.000000000 +0100
@@ -13,12 +13,13 @@ EOF
 setup_lvs <<EOF
 EOF
 
-setup_ctdbd <<EOF
-NODEMAP
-0       192.168.20.41   0x1     CURRENT RECMASTER
-1       192.168.20.42   0x0
-2       192.168.20.43   0x0
-EOF
+# Don't setup ctdbd - disconnected on current node
+#setup_ctdbd <<EOF
+#NODEMAP
+#0       192.168.20.41   0x1     CURRENT RECMASTER
+#1       192.168.20.42   0x0
+#2       192.168.20.43   0x0
+#EOF
 
 #####
 
diff -Npur samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.001.sh samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.001.sh
--- samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.001.sh	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.001.sh	2017-11-02 12:38:36.000000000 +0100
@@ -14,6 +14,8 @@ EOF
 dummy_client -s $ctdbd_socket &
 pid=$!
 
+wait_until 10 $CTDB process-exists "$pid"
+
 ok "PID $pid exists"
 simple_test "$pid"
 
diff -Npur samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.002.sh samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.002.sh
--- samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.002.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.002.sh	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,28 @@
+#!/bin/sh
+
+. "${TEST_SCRIPTS_DIR}/unit.sh"
+
+define_test "ctdbd process on node 0"
+
+setup_ctdbd <<EOF
+NODEMAP
+0       192.168.20.41   0x0     CURRENT RECMASTER
+1       192.168.20.42   0x0
+2       192.168.20.43   0x0
+EOF
+
+srvid="0xaebbccdd12345678"
+
+dummy_client -d INFO -s "$ctdbd_socket" -S "$srvid" &
+pid=$!
+
+wait_until 10 $CTDB process-exists "$pid"
+
+srvid2="0x1234567812345678"
+required_result 1 "PID $pid with SRVID $srvid2 does not exist"
+simple_test "$pid" "$srvid2"
+
+ok "PID $pid with SRVID $srvid exists"
+simple_test "$pid" "$srvid"
+
+kill -9 $pid
diff -Npur samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.003.sh samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.003.sh
--- samba-4.7.0/ctdb/tests/tool/ctdb.process-exists.003.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/ctdb/tests/tool/ctdb.process-exists.003.sh	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,28 @@
+#!/bin/sh
+
+. "${TEST_SCRIPTS_DIR}/unit.sh"
+
+define_test "ctdbd process with multiple connections on node 0"
+
+setup_ctdbd <<EOF
+NODEMAP
+0       192.168.20.41   0x0     CURRENT RECMASTER
+1       192.168.20.42   0x0
+2       192.168.20.43   0x0
+EOF
+
+srvid="0xaebbccdd12345678"
+
+dummy_client -d INFO -s "$ctdbd_socket" -n 10 -S "$srvid" &
+pid=$!
+
+wait_until 10 $CTDB process-exists "$pid"
+
+srvid2="0x1234567812345678"
+required_result 1 "PID $pid with SRVID $srvid2 does not exist"
+simple_test "$pid" "$srvid2"
+
+ok "PID $pid with SRVID $srvid exists"
+simple_test "$pid" "$srvid"
+
+kill -9 $pid
diff -Npur samba-4.7.0/ctdb/tests/tool/scripts/local.sh samba-4.7.1/ctdb/tests/tool/scripts/local.sh
--- samba-4.7.0/ctdb/tests/tool/scripts/local.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tests/tool/scripts/local.sh	2017-11-02 12:38:36.000000000 +0100
@@ -48,10 +48,14 @@ cleanup_ctdbd ()
 
 setup_ctdbd ()
 {
-	debug "Setting up fake ctdbd"
+	echo "Setting up fake ctdbd"
 
 	$VALGRIND fake_ctdbd -d "$FAKE_CTDBD_DEBUGLEVEL" \
 		  -s "$ctdbd_socket" -p "$ctdbd_pidfile"
+	# Wait till fake_ctdbd is running
+	wait_until 10 test -S "$ctdbd_socket" || \
+		die "fake_ctdbd failed to start"
+
 	test_cleanup cleanup_ctdbd
 }
 
diff -Npur samba-4.7.0/ctdb/tools/ctdb.c samba-4.7.1/ctdb/tools/ctdb.c
--- samba-4.7.0/ctdb/tools/ctdb.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/ctdb/tools/ctdb.c	2017-11-02 12:38:36.000000000 +0100
@@ -1864,23 +1864,43 @@ static int control_process_exists(TALLOC
 				  int argc, const char **argv)
 {
 	pid_t pid;
+	uint64_t srvid = 0;
 	int ret, status;
 
-	if (argc != 1) {
+	if (argc != 1 && argc != 2) {
 		usage("process-exists");
 	}
 
 	pid = atoi(argv[0]);
-	ret = ctdb_ctrl_process_exists(mem_ctx, ctdb->ev, ctdb->client,
+	if (argc == 2) {
+		srvid = strtoull(argv[1], NULL, 0);
+	}
+
+	if (srvid == 0) {
+		ret = ctdb_ctrl_process_exists(mem_ctx, ctdb->ev, ctdb->client,
 				       ctdb->cmd_pnn, TIMEOUT(), pid, &status);
+	} else {
+		struct ctdb_pid_srvid pid_srvid;
+
+		pid_srvid.pid = pid;
+		pid_srvid.srvid = srvid;
+
+		ret = ctdb_ctrl_check_pid_srvid(mem_ctx, ctdb->ev,
+						ctdb->client, ctdb->cmd_pnn,
+						TIMEOUT(), &pid_srvid,
+						&status);
+	}
+
 	if (ret != 0) {
 		return ret;
 	}
 
-	if (status == 0) {
-		printf("PID %u exists\n", pid);
+	if (srvid == 0) {
+		printf("PID %d %s\n", pid,
+		       (status == 0 ? "exists" : "does not exist"));
 	} else {
-		printf("PID %u does not exist\n", pid);
+		printf("PID %d with SRVID 0x%"PRIx64" %s\n", pid, srvid,
+		       (status == 0 ? "exists" : "does not exist"));
 	}
 	return status;
 }
@@ -6000,7 +6020,7 @@ static const struct ctdb_cmd {
 	{ "setifacelink", control_setifacelink, false, true,
 		"set interface link status", "<iface> up|down" },
 	{ "process-exists", control_process_exists, false, true,
-		"check if a process exists on a node",  "<pid>" },
+		"check if a process exists on a node",  "<pid> [<srvid>]" },
 	{ "getdbmap", control_getdbmap, false, true,
 		"show attached databases", NULL },
 	{ "getdbstatus", control_getdbstatus, false, true,
diff -Npur samba-4.7.0/docs/manpages/cifsdd.8 samba-4.7.1/docs/manpages/cifsdd.8
--- samba-4.7.0/docs/manpages/cifsdd.8	2017-09-21 08:33:10.000000000 +0200
+++ samba-4.7.1/docs/manpages/cifsdd.8	2017-11-02 12:44:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "CIFSDD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/dbwrap_tool.1 samba-4.7.1/docs/manpages/dbwrap_tool.1
--- samba-4.7.0/docs/manpages/dbwrap_tool.1	2017-09-21 08:33:10.000000000 +0200
+++ samba-4.7.1/docs/manpages/dbwrap_tool.1	2017-11-02 12:44:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -41,6 +41,7 @@ suite\&.
 The dbwrap_tool program is used to read and manipulate TDB/CTDB databases using the dbwrap interface\&.
 .PP
 The following database operations are available:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -122,6 +123,7 @@ listwatchers: list processes, which are
 .RE
 .PP
 The following types are available:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/eventlogadm.8 samba-4.7.1/docs/manpages/eventlogadm.8
--- samba-4.7.0/docs/manpages/eventlogadm.8	2017-09-21 08:33:10.000000000 +0200
+++ samba-4.7.1/docs/manpages/eventlogadm.8	2017-11-02 12:44:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "EVENTLOGADM" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -96,6 +96,7 @@ eventlogadm
 expects to be able to read structured records from standard input\&. These records are a sequence of lines, with the record key and data separated by a colon character\&. Records are separated by at least one or more blank line\&.
 .PP
 The event log record field are:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/findsmb.1 samba-4.7.1/docs/manpages/findsmb.1
--- samba-4.7.0/docs/manpages/findsmb.1	2017-09-21 08:33:11.000000000 +0200
+++ samba-4.7.1/docs/manpages/findsmb.1	2017-11-02 12:44:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "FINDSMB" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_ad.8 samba-4.7.1/docs/manpages/idmap_ad.8
--- samba-4.7.0/docs/manpages/idmap_ad.8	2017-09-21 08:33:11.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_ad.8	2017-11-02 12:44:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_autorid.8 samba-4.7.1/docs/manpages/idmap_autorid.8
--- samba-4.7.0/docs/manpages/idmap_autorid.8	2017-09-21 08:33:11.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_autorid.8	2017-11-02 12:44:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_hash.8 samba-4.7.1/docs/manpages/idmap_hash.8
--- samba-4.7.0/docs/manpages/idmap_hash.8	2017-09-21 08:33:11.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_hash.8	2017-11-02 12:44:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_HASH" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_ldap.8 samba-4.7.1/docs/manpages/idmap_ldap.8
--- samba-4.7.0/docs/manpages/idmap_ldap.8	2017-09-21 08:33:11.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_ldap.8	2017-11-02 12:44:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_nss.8 samba-4.7.1/docs/manpages/idmap_nss.8
--- samba-4.7.0/docs/manpages/idmap_nss.8	2017-09-21 08:33:12.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_nss.8	2017-11-02 12:44:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_NSS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_rfc2307.8 samba-4.7.1/docs/manpages/idmap_rfc2307.8
--- samba-4.7.0/docs/manpages/idmap_rfc2307.8	2017-09-21 08:33:12.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_rfc2307.8	2017-11-02 12:44:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_rid.8 samba-4.7.1/docs/manpages/idmap_rid.8
--- samba-4.7.0/docs/manpages/idmap_rid.8	2017-09-21 08:33:12.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_rid.8	2017-11-02 12:44:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RID" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_script.8 samba-4.7.1/docs/manpages/idmap_script.8
--- samba-4.7.0/docs/manpages/idmap_script.8	2017-09-21 08:33:12.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_script.8	2017-11-02 12:44:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_tdb.8 samba-4.7.1/docs/manpages/idmap_tdb.8
--- samba-4.7.0/docs/manpages/idmap_tdb.8	2017-09-21 08:33:12.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_tdb.8	2017-11-02 12:44:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/idmap_tdb2.8 samba-4.7.1/docs/manpages/idmap_tdb2.8
--- samba-4.7.0/docs/manpages/idmap_tdb2.8	2017-09-21 08:33:13.000000000 +0200
+++ samba-4.7.1/docs/manpages/idmap_tdb2.8	2017-11-02 12:44:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/libsmbclient.7 samba-4.7.1/docs/manpages/libsmbclient.7
--- samba-4.7.0/docs/manpages/libsmbclient.7	2017-09-21 08:33:13.000000000 +0200
+++ samba-4.7.1/docs/manpages/libsmbclient.7	2017-11-02 12:44:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "09/21/2017" "Samba 4\&.7" "7"
+.TH "LIBSMBCLIENT" "7" "11/02/2017" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/lmhosts.5 samba-4.7.1/docs/manpages/lmhosts.5
--- samba-4.7.0/docs/manpages/lmhosts.5	2017-09-21 08:33:13.000000000 +0200
+++ samba-4.7.1/docs/manpages/lmhosts.5	2017-11-02 12:44:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "09/21/2017" "Samba 4\&.7" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "11/02/2017" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -50,6 +50,7 @@ file format, except that the hostname co
 .SH "FILE FORMAT"
 .PP
 It is an ASCII file containing one line for NetBIOS name\&. The two fields on each line are separated from each other by white space\&. Any entry beginning with \*(Aq#\*(Aq is ignored\&. Each line in the lmhosts file contains the following information:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/log2pcap.1 samba-4.7.1/docs/manpages/log2pcap.1
--- samba-4.7.0/docs/manpages/log2pcap.1	2017-09-21 08:33:13.000000000 +0200
+++ samba-4.7.1/docs/manpages/log2pcap.1	2017-11-02 12:44:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "LOG2PCAP" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/mvxattr.1 samba-4.7.1/docs/manpages/mvxattr.1
--- samba-4.7.0/docs/manpages/mvxattr.1	2017-09-21 08:33:13.000000000 +0200
+++ samba-4.7.1/docs/manpages/mvxattr.1	2017-11-02 12:44:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "MVXATTR" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/net.8 samba-4.7.1/docs/manpages/net.8
--- samba-4.7.0/docs/manpages/net.8	2017-09-21 08:33:14.000000000 +0200
+++ samba-4.7.1/docs/manpages/net.8	2017-11-02 12:44:42.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NET" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "NET" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -614,6 +614,7 @@ Sets the SID of the current domain\&.
 .SS "GROUPMAP"
 .PP
 Manage the mappings between Windows group SIDs and UNIX groups\&. Common options include:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1505,6 +1506,7 @@ The following options are available:
 This is a mechanism to check the existence or non\-existence of certain keys or values specified in a precheck file before applying the import file\&. The import file will only be applied if the precheck succeeds\&.
 .sp
 The check\-file follows the normal registry file syntax with the following semantics:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1683,6 +1685,7 @@ net dom renamecomputer \- Renames a remo
 .SS "DOM JOIN	domain=DOMAIN ou=OU account=ACCOUNT password=PASSWORD reboot"
 .PP
 Joins a computer into a domain\&. This command supports the following additional parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1759,6 +1762,7 @@ This example would connect to a computer
 .SS "DOM UNJOIN account=ACCOUNT password=PASSWORD reboot"
 .PP
 Unjoins a computer from a domain\&. This command supports the following additional parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1807,6 +1811,7 @@ This example would connect to a computer
 .SS "DOM RENAMECOMPUTER newname=NEWNAME account=ACCOUNT password=PASSWORD reboot"
 .PP
 Renames a computer that is joined to a domain\&. This command supports the following additional parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1871,6 +1876,7 @@ Manage global locks\&.
 .PP
 Execute a shell command under a global lock\&. This might be useful to define the order in which several shell commands will be executed\&. The locking information is stored in a file called
 g_lock\&.tdb\&. In setups with CTDB running, the locking information will be available on all cluster nodes\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1919,6 +1925,7 @@ Print information from tdb records\&.
 .SS "TDB LOCKING key [DUMP]"
 .PP
 List sharename, filename and number of share modes for a record from locking\&.tdb\&. With the optional DUMP options, dump the complete record\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/nmbd.8 samba-4.7.1/docs/manpages/nmbd.8
--- samba-4.7.0/docs/manpages/nmbd.8	2017-09-21 08:33:14.000000000 +0200
+++ samba-4.7.1/docs/manpages/nmbd.8	2017-11-02 12:44:42.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "NMBD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/nmblookup.1 samba-4.7.1/docs/manpages/nmblookup.1
--- samba-4.7.0/docs/manpages/nmblookup.1	2017-09-21 08:33:14.000000000 +0200
+++ samba-4.7.1/docs/manpages/nmblookup.1	2017-11-02 12:44:42.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "NMBLOOKUP" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/ntlm_auth.1 samba-4.7.1/docs/manpages/ntlm_auth.1
--- samba-4.7.0/docs/manpages/ntlm_auth.1	2017-09-21 08:33:14.000000000 +0200
+++ samba-4.7.1/docs/manpages/ntlm_auth.1	2017-11-02 12:44:42.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "NTLM_AUTH" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/pam_winbind.8 samba-4.7.1/docs/manpages/pam_winbind.8
--- samba-4.7.0/docs/manpages/pam_winbind.8	2017-09-21 08:33:15.000000000 +0200
+++ samba-4.7.1/docs/manpages/pam_winbind.8	2017-11-02 12:44:43.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: 8
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "09/21/2017" "Samba 4\&.7" "8"
+.TH "PAM_WINBIND" "8" "11/02/2017" "Samba 4\&.7" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/pam_winbind.conf.5 samba-4.7.1/docs/manpages/pam_winbind.conf.5
--- samba-4.7.0/docs/manpages/pam_winbind.conf.5	2017-09-21 08:33:15.000000000 +0200
+++ samba-4.7.1/docs/manpages/pam_winbind.conf.5	2017-11-02 12:44:43.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: 5
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "09/21/2017" "Samba 4\&.7" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "11/02/2017" "Samba 4\&.7" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/pdbedit.8 samba-4.7.1/docs/manpages/pdbedit.8
--- samba-4.7.0/docs/manpages/pdbedit.8	2017-09-21 08:33:15.000000000 +0200
+++ samba-4.7.1/docs/manpages/pdbedit.8	2017-11-02 12:44:43.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "PDBEDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -212,6 +212,8 @@ Example:
 .RS 4
 This option can be used while adding or modifying a user account\&. It will specify the users\*(Aq account control property\&. Possible flags are listed below\&.
 .sp
+.RS
+.sp
 .RS 4
 .ie n \{\
 \h'-04'\(bu\h'+03'\c
diff -Npur samba-4.7.0/docs/manpages/profiles.1 samba-4.7.1/docs/manpages/profiles.1
--- samba-4.7.0/docs/manpages/profiles.1	2017-09-21 08:33:15.000000000 +0200
+++ samba-4.7.1/docs/manpages/profiles.1	2017-11-02 12:44:43.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "PROFILES" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/rpcclient.1 samba-4.7.1/docs/manpages/rpcclient.1
--- samba-4.7.0/docs/manpages/rpcclient.1	2017-09-21 08:33:16.000000000 +0200
+++ samba-4.7.1/docs/manpages/rpcclient.1	2017-11-02 12:44:43.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "RPCCLIENT" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/samba-regedit.8 samba-4.7.1/docs/manpages/samba-regedit.8
--- samba-4.7.0/docs/manpages/samba-regedit.8	2017-09-21 08:33:16.000000000 +0200
+++ samba-4.7.1/docs/manpages/samba-regedit.8	2017-11-02 12:44:44.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/samba-tool.8 samba-4.7.1/docs/manpages/samba-tool.8
--- samba-4.7.0/docs/manpages/samba-tool.8	2017-09-21 08:33:16.000000000 +0200
+++ samba-4.7.1/docs/manpages/samba-tool.8	2017-11-02 12:44:44.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/samba.7 samba-4.7.1/docs/manpages/samba.7
--- samba-4.7.0/docs/manpages/samba.7	2017-09-21 08:33:16.000000000 +0200
+++ samba-4.7.1/docs/manpages/samba.7	2017-11-02 12:44:44.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: Miscellanea
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "09/21/2017" "Samba 4\&.7" "Miscellanea"
+.TH "SAMBA" "7" "11/02/2017" "Samba 4\&.7" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/samba.8 samba-4.7.1/docs/manpages/samba.8
--- samba-4.7.0/docs/manpages/samba.8	2017-09-21 08:33:16.000000000 +0200
+++ samba-4.7.1/docs/manpages/samba.8	2017-11-02 12:44:44.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/sharesec.1 samba-4.7.1/docs/manpages/sharesec.1
--- samba-4.7.0/docs/manpages/sharesec.1	2017-09-21 08:33:17.000000000 +0200
+++ samba-4.7.1/docs/manpages/sharesec.1	2017-11-02 12:44:44.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SHARESEC" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -175,6 +175,7 @@ ACLs specify permissions granted to the
 The type can be either ALLOWED or DENIED to allow/deny access to the SID\&. The flags values are generally zero for share ACLs\&.
 .PP
 The mask is a value which expresses the access right granted to the SID\&. It can be given as a decimal or hexadecimal value, or by using one of the following text strings which map to the NT file permissions of the same name\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -251,6 +252,7 @@ The mask is a value which expresses the
 .RE
 .PP
 The following combined permissions can be specified:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smb.conf.5 samba-4.7.1/docs/manpages/smb.conf.5
--- samba-4.7.0/docs/manpages/smb.conf.5	2017-09-21 08:33:18.000000000 +0200
+++ samba-4.7.1/docs/manpages/smb.conf.5	2017-11-02 12:44:46.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "09/21/2017" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "11/02/2017" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -132,6 +132,7 @@ If a section called [homes] is included
 When the connection request is made, the existing sections are scanned\&. If a match is found, it is used\&. If no match is found, the requested section name is treated as a username and looked up in the local password file\&. If the name exists and the correct password has been given, a share is created by cloning the [homes] section\&.
 .PP
 Some modifications are then made to the newly created share:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -209,6 +210,7 @@ If a [printers] section occurs in the co
 When a connection request is made, the existing sections are scanned\&. If a match is found, it is used\&. If no match is found, but a [homes] section exists, it is used as described above\&. Otherwise, the requested section name is treated as a printer name and the appropriate printcap file is scanned to see if the requested section name is a valid printer share name\&. If a match is found, a new printer share is created by cloning the [printers] section\&.
 .PP
 A few modifications are then made to the newly created share:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -597,6 +599,7 @@ By default, Samba 3\&.0 has the same sem
 .PP
 Starting with Samba version 3\&.2\&.0, the capability to store Samba configuration in the registry is available\&. The configuration is stored in the registry key
 \fIHKLM\eSoftware\eSamba\esmbconf\fR\&. There are two levels of registry configuration:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -840,6 +843,7 @@ addport command (G)
 .PP
 .RS 4
 Samba 3\&.0\&.23 introduced support for adding printer ports remotely using the Windows "Add Standard TCP/IP Port Wizard"\&. This option defines an external program to be executed when smbd receives a request to add a new Port to the system\&. The script is passed two parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -888,6 +892,7 @@ file in order that it can be shared by
 The
 \fIaddprinter command\fR
 is automatically invoked with the following parameter (in order):
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1000,6 +1005,7 @@ smbd
 will automatically invoke the
 \fIadd share command\fR
 with five parameters\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1710,6 +1716,7 @@ smbd
 will automatically invoke the
 \fIchange share command\fR
 with six parameters\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -1958,6 +1965,7 @@ client max protocol (G)
 The value of the parameter (a string) is the highest protocol level that will be supported by the client\&.
 .sp
 Possible values are :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -2025,6 +2033,7 @@ version of the protocol\&. Long filename
 .IP \(bu 2.3
 .\}
 \fBSMB2\fR: Re\-implementation of the SMB protocol\&. Used by Windows Vista and later versions of Windows\&. SMB2 has sub protocols available\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -2083,6 +2092,7 @@ By default SMB2 selects the SMB2_10 vari
 .IP \(bu 2.3
 .\}
 \fBSMB3\fR: The same as SMB2\&. Used by Windows 8\&. SMB3 has sub protocols available\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -2856,6 +2866,7 @@ smbd
 will automatically invoke the
 \fIdelete share command\fR
 with two parameters\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -3313,6 +3324,7 @@ ea support (S)
 This boolean parameter controls whether
 \fBsmbd\fR(8)
 will allow clients to attempt to access extended attributes on a share\&. In order to enable this parameter on a setup with default VFS modules:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -3704,6 +3716,7 @@ This option is only available Samba was
 This parameter should specify the path to a script that queries the quota information for the specified user/group for the partition that the specified directory is on\&.
 .sp
 Such a script is being given 3 arguments:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -3742,6 +3755,7 @@ uid of user or gid of group
 The directory is actually mostly just "\&." \- It needs to be treated relatively to the current working directory that the script can also query\&.
 .sp
 The type of query can be one of:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -3789,6 +3803,7 @@ The type of query can be one of:
 .sp
 .RE
 This script should print one line as output with spaces between the columns\&. The printed columns should be:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -4407,6 +4422,7 @@ inherit owner (S)
 The ownership of new files and directories is normally governed by effective uid of the connected user\&. This option allows the Samba administrator to specify that the ownership for new files and directories should be controlled by the ownership of the parent directory\&.
 .sp
 Valid options are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -4531,6 +4547,7 @@ interfaces (G)
 This option allows you to override the default network interfaces list that Samba will use for browsing, name registration and other NetBIOS over TCP/IP (NBT) traffic\&. By default Samba will query the kernel for the list of all active interfaces and use any interfaces except 127\&.0\&.0\&.1 that are broadcast capable\&.
 .sp
 The option takes a list of interface strings\&. Each string can be in any of the following forms:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -4694,6 +4711,7 @@ kerberos method (G)
 Controls how kerberos tickets are verified\&.
 .sp
 Valid options are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -5049,6 +5067,7 @@ This option is used to define whether or
 The
 \m[blue]\fBldap passwd sync\fR\m[]
 can be set to one of three values:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -5261,6 +5280,7 @@ in the URL argument of
 The
 \m[blue]\fBldap ssl\fR\m[]
 can be set to one of two values:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -5569,6 +5589,7 @@ and
 parameters\&.
 .sp
 Some backends are only available when Samba has been compiled with the additional libraries\&. The overall list of logging backends:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -5664,6 +5685,7 @@ smb\&.conf
 file\&.
 .sp
 This parameter has been extended since the 2\&.2\&.x series, now it allows one to specify the debug level for multiple debug classes\&. This is to give greater flexibility in the configuration of the system\&. The following debug classes are currently implemented:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -5968,6 +5990,7 @@ Authentication and authorization audit i
 Support is comprehensive for all authentication and authorisation of user accounts in the Samba Active Directory Domain Controller, as well as the implicit authentication in password changes\&. In the file server, NTLM authentication, SMB and RPC authorization is covered\&.
 .sp
 Log levels for auth_audit and auth_audit_json are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -6498,6 +6521,7 @@ See the section on
 for details on how to control the mangling process\&.
 .sp
 Possible option settings are
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -6537,6 +6561,7 @@ Possible option settings are
 .sp
 .RE
 If mangling is used then the mangling method is as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -6697,6 +6722,7 @@ then this parameter is
 \fIignored\fR\&. This is a new parameter introduced in Samba version 3\&.0\&.21\&.
 .sp
 The three settings are :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -6774,6 +6800,7 @@ This parameter can take four different v
 what to do with user login requests that don\*(Aqt match a valid UNIX user in some way\&.
 .sp
 The four settings are :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -7068,6 +7095,7 @@ won\*(Aqt work (\fI%U\fR
 may be better in this case)\&.
 .sp
 Apart from the standard substitutions, some additional ones apply\&. In particular:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -7263,6 +7291,7 @@ name resolve order (G)
 This option is used by the programs in the Samba suite to determine what naming services to use and in what order to resolve host names to IP addresses\&. Its main purpose to is to control how netbios name resolution is performed\&. The option takes a space separated string of name resolution options\&.
 .sp
 The options are: "lmhosts", "host", "wins" and "bcast"\&. They cause names to be resolved as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -7516,6 +7545,7 @@ only NTLMv2 logins will be permited\&. M
 The primary user of NTLMv1 is MSCHAPv2 for VPNs and 802\&.1x\&.
 .sp
 The available settings are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -7628,6 +7658,7 @@ ntvfs handler (S)
 .PP
 .RS 4
 This specifies the NTVFS handlers for this share\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -7893,6 +7924,7 @@ This option allows the administrator to
 The parameter value is divided into two parts, the backend\*(Aqs name, and a \*(Aqlocation\*(Aq string that has meaning only to that particular backed\&. These are separated by a : character\&.
 .sp
 Available backends can include:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -8151,6 +8183,7 @@ supplementalCredentials
 attribute\&. The value of this option is a hash type\&.
 .sp
 The currently supported hash types are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -9293,6 +9326,7 @@ rpc_server:SERVER (G)
 With this option you can define if a rpc service should be running internal/embedded in smbd or should be redirected to an external daemon like Samba4, the endpoint mapper daemon, the spoolss daemon or the new LSA service daemon\&. The rpc_server prefix must be followed by the pipe name, and a value\&.
 .sp
 This option can be set for each available rpc service in Samba\&. The following list shows all available pipe names services you can modify with this option\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -9701,6 +9735,7 @@ server max protocol (G)
 The value of the parameter (a string) is the highest protocol level that will be supported by the server\&.
 .sp
 Possible values are :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -9746,6 +9781,7 @@ version of the protocol\&. Long filename
 .IP \(bu 2.3
 .\}
 \fBSMB2\fR: Re\-implementation of the SMB protocol\&. Used by Windows Vista and later versions of Windows\&. SMB2 has sub protocols available\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -9804,6 +9840,7 @@ By default SMB2 selects the SMB2_10 vari
 .IP \(bu 2.3
 .\}
 \fBSMB3\fR: The same as SMB2\&. Used by Windows 8\&. SMB3 has sub protocols available\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10102,6 +10139,7 @@ This option is only available if Samba w
 This parameter should specify the path to a script that can set quota for the specified arguments\&.
 .sp
 The specified script should take the following arguments:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10123,6 +10161,7 @@ The specified script should take the fol
 .IP \(bu 2.3
 .\}
 2 \- quota type
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10339,6 +10378,7 @@ If the connected user possesses the
 \fBSeRemoteShutdownPrivilege\fR, right, this command will be run as root\&.
 .sp
 The %z %t %r %f variables are expanded as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10517,6 +10557,7 @@ smb encrypt (S)
 .PP
 .RS 4
 This parameter controls whether a remote client is allowed or required to use SMB encryption\&. It has different effects depending on whether the connection uses SMB1 or SMB2 and newer:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10581,6 +10622,7 @@ is set to
 or newer\&. Clients supporting this type of encryption include Windows 8 and newer, Windows server 2012 and newer, and smbclient of Samba 4\&.1 and newer\&.
 .sp
 The protocol implementation offers various options:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10630,6 +10672,7 @@ Encryption can be enforced\&. This means
 These features can be controlled with settings of
 \fIsmb encrypt\fR
 as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -10812,6 +10855,7 @@ samba\-technical@lists\&.samba\&.org\&.
 Any of the supported socket options may be combined in any way you like, as long as your OS allows it\&.
 .sp
 This is the list of socket options currently settable using this option:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -11149,6 +11193,7 @@ spotlight (S)
 This parameter controls whether Samba allows Spotlight queries on a share\&. For controlling indexing of filesystems you also have to use Tracker\*(Aqs own configuration system\&.
 .sp
 Spotlight has several prerequisites:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -12386,6 +12431,7 @@ winbind nss info (G)
 .PP
 .RS 4
 This parameter is designed to control how Winbind retrieves Name Service Information to construct a user\*(Aqs home directory and login shell\&. Currently the following settings are available:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -12555,6 +12601,7 @@ When Samba is running as a WINS server t
 The wins hook parameter specifies the name of a script or executable that will be called as follows:
 .sp
 wins_hook operation name nametype ttl IP_list
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbcacls.1 samba-4.7.1/docs/manpages/smbcacls.1
--- samba-4.7.0/docs/manpages/smbcacls.1	2017-09-21 08:33:18.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbcacls.1	2017-11-02 12:44:46.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBCACLS" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -315,6 +315,7 @@ The owner and group specify the owner an
 ACEs are specified with an "ACL:" prefix, and define permissions granted to an SID\&. The SID again can be specified in S\-1\-x\-y\-z format or as a name in which case it is resolved against the server on which the file or directory resides\&. The type, flags and mask values determine the type of access granted to the SID\&.
 .PP
 The type can be either ALLOWED or DENIED to allow/deny access to the SID\&. The flags values are generally zero for file ACEs and either 9 or 2 for directory ACEs\&. Some common flags are:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -365,6 +366,7 @@ The type can be either ALLOWED or DENIED
 At present, flags can only be specified as decimal or hexadecimal values\&.
 .PP
 The mask is a value which expresses the access right granted to the SID\&. It can be given as a decimal or hexadecimal value, or by using one of the following text strings which map to the NT file permissions of the same name\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -441,6 +443,7 @@ The mask is a value which expresses the
 .RE
 .PP
 The following combined permissions can be specified:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbclient.1 samba-4.7.1/docs/manpages/smbclient.1
--- samba-4.7.0/docs/manpages/smbclient.1	2017-09-21 08:33:19.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbclient.1	2017-11-02 12:44:46.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBCLIENT" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -89,6 +89,7 @@ Be cautious about including passwords in
 This option is used by the programs in the Samba suite to determine what naming services and in what order to resolve host names to IP addresses\&. The option takes a space\-separated string of different name resolution options\&.
 .sp
 The options are :"lmhosts", "host", "wins" and "bcast"\&. They cause names to be resolved as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -421,6 +422,7 @@ command inside smbclient\&.
 smbclient may be used to create
 tar(1)
 compatible backups of all the files on an SMB/CIFS share\&. The secondary tar flags that can be given to this option are:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbcontrol.1 samba-4.7.1/docs/manpages/smbcontrol.1
--- samba-4.7.0/docs/manpages/smbcontrol.1	2017-09-21 08:33:19.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbcontrol.1	2017-11-02 12:44:47.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBCONTROL" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbcquotas.1 samba-4.7.1/docs/manpages/smbcquotas.1
--- samba-4.7.0/docs/manpages/smbcquotas.1	2017-09-21 08:33:19.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbcquotas.1	2017-11-02 12:44:47.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBCQUOTAS" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbd.8 samba-4.7.1/docs/manpages/smbd.8
--- samba-4.7.0/docs/manpages/smbd.8	2017-09-21 08:33:19.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbd.8	2017-11-02 12:44:47.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SMBD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -227,6 +227,7 @@ Samba uses PAM for authentication (when
 \m[blue]\fBobey pam restrictions\fR\m[]
 \fBsmb.conf\fR(5)
 parameter\&. When this is set, the following restrictions apply:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbget.1 samba-4.7.1/docs/manpages/smbget.1
--- samba-4.7.0/docs/manpages/smbget.1	2017-09-21 08:33:19.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbget.1	2017-11-02 12:44:47.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBGET" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbgetrc.5 samba-4.7.1/docs/manpages/smbgetrc.5
--- samba-4.7.0/docs/manpages/smbgetrc.5	2017-09-21 08:33:20.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbgetrc.5	2017-11-02 12:44:48.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "09/21/2017" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "11/02/2017" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbpasswd.5 samba-4.7.1/docs/manpages/smbpasswd.5
--- samba-4.7.0/docs/manpages/smbpasswd.5	2017-09-21 08:33:20.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbpasswd.5	2017-11-02 12:44:48.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "09/21/2017" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "11/02/2017" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -85,6 +85,7 @@ be made available to anyone but the root
 Account Flags
 .RS 4
 This section contains flags that describe the attributes of the users account\&. This field is bracketed by \*(Aq[\*(Aq and \*(Aq]\*(Aq characters and is always 13 characters in length (including the \*(Aq[\*(Aq and \*(Aq]\*(Aq characters)\&. The contents of this field may be any of the following characters:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbpasswd.8 samba-4.7.1/docs/manpages/smbpasswd.8
--- samba-4.7.0/docs/manpages/smbpasswd.8	2017-09-21 08:33:20.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbpasswd.8	2017-11-02 12:44:48.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SMBPASSWD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -162,6 +162,7 @@ that Windows 95/98 do not have a real pa
 This option allows the user of smbpasswd to determine what name resolution services to use when looking up the NetBIOS name of the host being connected to\&.
 .sp
 The options are :"lmhosts", "host", "wins" and "bcast"\&. They cause names to be resolved as follows:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbspool.8 samba-4.7.1/docs/manpages/smbspool.8
--- samba-4.7.0/docs/manpages/smbspool.8	2017-09-21 08:33:20.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbspool.8	2017-11-02 12:44:48.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -43,6 +43,7 @@ smbspool is a very small print spooling
 \fIDEVICE URI\fR
 .PP
 smbspool specifies the destination using a Uniform Resource Identifier ("URI") with a method of "smb"\&. This string can take a number of forms:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -103,6 +104,7 @@ functions can pass the URI in argv[0], w
 \fBDEVICE_URI\fR
 environment variable prior to running smbspool\&.
 .SH "OPTIONS"
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/smbspool_krb5_wrapper.8 samba-4.7.1/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.7.0/docs/manpages/smbspool_krb5_wrapper.8	2017-09-21 08:33:21.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbspool_krb5_wrapper.8	2017-11-02 12:44:48.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbstatus.1 samba-4.7.1/docs/manpages/smbstatus.1
--- samba-4.7.0/docs/manpages/smbstatus.1	2017-09-21 08:33:21.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbstatus.1	2017-11-02 12:44:49.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBSTATUS" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbtar.1 samba-4.7.1/docs/manpages/smbtar.1
--- samba-4.7.0/docs/manpages/smbtar.1	2017-09-21 08:33:21.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbtar.1	2017-11-02 12:44:49.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBTAR" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/smbtree.1 samba-4.7.1/docs/manpages/smbtree.1
--- samba-4.7.0/docs/manpages/smbtree.1	2017-09-21 08:33:21.000000000 +0200
+++ samba-4.7.1/docs/manpages/smbtree.1	2017-11-02 12:44:49.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "SMBTREE" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/testparm.1 samba-4.7.1/docs/manpages/testparm.1
--- samba-4.7.0/docs/manpages/testparm.1	2017-09-21 08:33:21.000000000 +0200
+++ samba-4.7.1/docs/manpages/testparm.1	2017-11-02 12:44:49.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "TESTPARM" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_acl_tdb.8 samba-4.7.1/docs/manpages/vfs_acl_tdb.8
--- samba-4.7.0/docs/manpages/vfs_acl_tdb.8	2017-09-21 08:33:22.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_acl_tdb.8	2017-11-02 12:44:49.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -46,6 +46,7 @@ The ACL settings are stored in
 $LOCKDIR/file_ntacls\&.tdb\&.
 .PP
 This module forces the following parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -97,6 +98,7 @@ If
 \fIacl_tdb:ignore system acls\fR
 is set to
 \fIyes\fR, the following additional settings will be enforced:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_acl_xattr.8 samba-4.7.1/docs/manpages/vfs_acl_xattr.8
--- samba-4.7.0/docs/manpages/vfs_acl_xattr.8	2017-09-21 08:33:22.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_acl_xattr.8	2017-11-02 12:44:50.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -51,6 +51,7 @@ getfattr \-d filename\&. To show the cur
 getfattr \-n security\&.NTACL filename)\&.
 .PP
 This module forces the following parameters:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -102,6 +103,7 @@ If
 \fIacl_xattr:ignore system acls\fR
 is set to
 \fIyes\fR, the following additional settings will be enforced:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_aio_fork.8 samba-4.7.1/docs/manpages/vfs_aio_fork.8
--- samba-4.7.0/docs/manpages/vfs_aio_fork.8	2017-09-21 08:33:22.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_aio_fork.8	2017-11-02 12:44:50.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_aio_linux.8 samba-4.7.1/docs/manpages/vfs_aio_linux.8
--- samba-4.7.0/docs/manpages/vfs_aio_linux.8	2017-09-21 08:33:22.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_aio_linux.8	2017-11-02 12:44:50.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_linux
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_LINUX" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_LINUX" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_aio_pthread.8 samba-4.7.1/docs/manpages/vfs_aio_pthread.8
--- samba-4.7.0/docs/manpages/vfs_aio_pthread.8	2017-09-21 08:33:22.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_aio_pthread.8	2017-11-02 12:44:50.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_audit.8 samba-4.7.1/docs/manpages/vfs_audit.8
--- samba-4.7.0/docs/manpages/vfs_audit.8	2017-09-21 08:33:23.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_audit.8	2017-11-02 12:44:51.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AUDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_btrfs.8 samba-4.7.1/docs/manpages/vfs_btrfs.8
--- samba-4.7.0/docs/manpages/vfs_btrfs.8	2017-09-21 08:33:23.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_btrfs.8	2017-11-02 12:44:51.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_BTRFS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_cacheprime.8 samba-4.7.1/docs/manpages/vfs_cacheprime.8
--- samba-4.7.0/docs/manpages/vfs_cacheprime.8	2017-09-21 08:33:23.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_cacheprime.8	2017-11-02 12:44:51.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -54,6 +54,7 @@ cacheprime:rsize = BYTES
 The number of bytes with which to prime the kernel data cache\&.
 .sp
 The following suffixes may be applied to BYTES:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_cap.8 samba-4.7.1/docs/manpages/vfs_cap.8
--- samba-4.7.0/docs/manpages/vfs_cap.8	2017-09-21 08:33:23.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_cap.8	2017-11-02 12:44:51.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CAP" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_catia.8 samba-4.7.1/docs/manpages/vfs_catia.8
--- samba-4.7.0/docs/manpages/vfs_catia.8	2017-09-21 08:33:24.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_catia.8	2017-11-02 12:44:51.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CATIA" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_ceph.8 samba-4.7.1/docs/manpages/vfs_ceph.8
--- samba-4.7.0/docs/manpages/vfs_ceph.8	2017-09-21 08:33:24.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_ceph.8	2017-11-02 12:44:52.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CEPH" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_commit.8 samba-4.7.1/docs/manpages/vfs_commit.8
--- samba-4.7.0/docs/manpages/vfs_commit.8	2017-09-21 08:33:24.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_commit.8	2017-11-02 12:44:52.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_COMMIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -53,6 +53,7 @@ commit:dthresh = BYTES
 Synchronize file data each time the specified number of bytes has been written\&.
 .sp
 The following suffixes may be applied to BYTES:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_crossrename.8 samba-4.7.1/docs/manpages/vfs_crossrename.8
--- samba-4.7.0/docs/manpages/vfs_crossrename.8	2017-09-21 08:33:24.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_crossrename.8	2017-11-02 12:44:52.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_default_quota.8 samba-4.7.1/docs/manpages/vfs_default_quota.8
--- samba-4.7.0/docs/manpages/vfs_default_quota.8	2017-09-21 08:33:24.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_default_quota.8	2017-11-02 12:44:52.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_dirsort.8 samba-4.7.1/docs/manpages/vfs_dirsort.8
--- samba-4.7.0/docs/manpages/vfs_dirsort.8	2017-09-21 08:33:25.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_dirsort.8	2017-11-02 12:44:52.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_extd_audit.8 samba-4.7.1/docs/manpages/vfs_extd_audit.8
--- samba-4.7.0/docs/manpages/vfs_extd_audit.8	2017-09-21 08:33:25.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_extd_audit.8	2017-11-02 12:44:53.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_fake_perms.8 samba-4.7.1/docs/manpages/vfs_fake_perms.8
--- samba-4.7.0/docs/manpages/vfs_fake_perms.8	2017-09-21 08:33:25.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_fake_perms.8	2017-11-02 12:44:53.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_fileid.8 samba-4.7.1/docs/manpages/vfs_fileid.8
--- samba-4.7.0/docs/manpages/vfs_fileid.8	2017-09-21 08:33:25.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_fileid.8	2017-11-02 12:44:53.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FILEID" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_fruit.8 samba-4.7.1/docs/manpages/vfs_fruit.8
--- samba-4.7.0/docs/manpages/vfs_fruit.8	2017-09-21 08:33:26.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_fruit.8	2017-11-02 12:44:53.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FRUIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -78,6 +78,7 @@ A
 \fIglobal\fR
 option whether to enable Apple\*(Aqs SMB2+ extension codenamed AAPL\&. Default
 \fIyes\fR\&. This extension enhances several deficiencies when connecting from Macs:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -105,6 +106,7 @@ The ability to query and modify the UNIX
 There\*(Aqs a set of per share options that come into play when
 \fIfruit:aapl\fR
 is enabled\&. These opions, listed below, can be used to disable the computation of specific Mac metadata in the directory enumeration context, all are enabled by default:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -195,6 +197,7 @@ Due to a spelling bug in all Samba versi
 \fIfruit:ressource\fR, ie with two s\&.
 .sp
 Settings:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -242,6 +245,7 @@ module due to the extended attributes si
 fruit:metadata = [ stream | netatalk ]
 .RS 4
 Controls where the OS X metadata stream is stored:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -273,6 +277,7 @@ stream
 fruit:locking = [ netatalk | none ]
 .RS 4
 
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -310,6 +315,7 @@ this is known to not fully work with
 \fIfruit:metadata=stream\fR
 or
 \fIfruit:resource=stream\fR\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_full_audit.8 samba-4.7.1/docs/manpages/vfs_full_audit.8
--- samba-4.7.0/docs/manpages/vfs_full_audit.8	2017-09-21 08:33:26.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_full_audit.8	2017-11-02 12:44:53.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -284,6 +284,7 @@ records operations in fixed format consi
 .\}
 .PP
 The record fields are:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_glusterfs.8 samba-4.7.1/docs/manpages/vfs_glusterfs.8
--- samba-4.7.0/docs/manpages/vfs_glusterfs.8	2017-09-21 08:33:26.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_glusterfs.8	2017-11-02 12:44:54.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_gpfs.8 samba-4.7.1/docs/manpages/vfs_gpfs.8
--- samba-4.7.0/docs/manpages/vfs_gpfs.8	2017-09-21 08:33:26.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_gpfs.8	2017-11-02 12:44:54.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GPFS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -43,6 +43,7 @@ gpfs
 VFS module is the home for all gpfs extensions that Samba requires for proper integration with GPFS\&. It uses the GPL library interfaces provided by GPFS\&.
 .PP
 Currently the gpfs vfs module provides extensions in following areas :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -93,6 +94,7 @@ Since Samba 4\&.0 all options are per sh
 gpfs:sharemodes = [ yes | no ]
 .RS 4
 Enable/Disable cross node sharemode handling for GPFS\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -128,6 +130,7 @@ oplocks
 and
 kernel oplocks
 options to the same value\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -159,6 +162,7 @@ no
 gpfs:hsm = [ yes | no ]
 .RS 4
 Enable/Disable announcing if this FS has HSM enabled\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -190,6 +194,7 @@ yes
 gpfs:recalls = [ yes | no ]
 .RS 4
 When this option is set to no, an attempt to open an offline file will be rejected with access denied\&. This helps preventing recall storms triggered by careless applications like Finder and Explorer\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -223,6 +228,7 @@ gpfs:getrealfilename = [ yes | no ]
 Enable/Disable usage of the
 gpfs_get_realfilename_path()
 function\&. This improves the casesensitive wildcard file name access\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -258,6 +264,7 @@ doesn\*(Aqt work on AIX\&.
 gpfs:winattr = [ yes | no ]
 .RS 4
 Enable/Disable usage of the windows attributes in GPFS\&. GPFS is able to store windows file attributes e\&.g\&. HIDDEN, READONLY, SYSTEM and others natively\&. That means Samba doesn\*(Aqt need to map them to permission bits or extended attributes\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -289,6 +296,7 @@ yes
 gpfs:merge_writeappend = [ yes | no ]
 .RS 4
 GPFS ACLs doesn\*(Aqt know about the \*(AqAPPEND\*(Aq right\&. This option lets Samba map the \*(AqAPPEND\*(Aq right to \*(AqWRITE\*(Aq\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -320,6 +328,7 @@ no
 gpfs:acl = [ yes | no ]
 .RS 4
 This option lets Samba use or ignore GPFS ACLs\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -355,6 +364,7 @@ As GPFS does not support the ACE4_FLAG_N
 To make sure that automatic migration with e\&.g\&. robocopy does not lead to ACLs silently (and unintentionally) changed, you can set
 gpfs:refuse_dacl_protected = yes
 to enable an explicit check for this flag and if set, it will return NT_STATUS_NOT_SUPPORTED so errors are shown up on the Windows side and the Administrator is aware of the ACLs not being settable like intended
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -388,6 +398,7 @@ gpfs:dfreequota = [ yes | no ]
 Adjust reporting of the size and free space of a share according to quotas\&. If this setting is "yes", a request for size and free space will also evaluate the user quota of the user requesting the data and the group quota of the primary group of the user\&. Fileset quotas are not queried, since GPFS already provides the option \-\-dfreequota to reflect the fileset quota in the free space query\&. Please use that option to include fileset quotas in the reported disk space\&.
 .sp
 If any of the soft or hard quota limits has been reached, the free space will be reported as 0\&. If a quota is in place, but the limits have not been reached, the free space will be reported according to the space left in the quota\&. If more than one quota applies the free space will be reported as the smallest space left in those quotas\&. The size of the share will be reported according to the quota usage\&. If more than one quota applies, the smallest size will be reported for the share size according to these quotas\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -419,6 +430,7 @@ no(default)
 gpfs:prealloc = [ yes | no ]
 .RS 4
 If set to yes the gpfs_prealloc function will be used in the fallocate callback when appropriate\&. If set to no gpfs_prealloc will not be used\&. In both cases the system and libc calls are avoided\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -450,6 +462,7 @@ no
 gpfs:settimes = [ yes | no ]
 .RS 4
 Use the gpfs_set_times API when changing the timestamps of a file or directory\&. If the GPFS API is not available the old method of using utime and the GPFS winattr call will be used instead\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -483,6 +496,7 @@ nfs4:mode = [ simple | special ]
 Controls substitution of special IDs (OWNER@ and GROUP@) on GPFS\&. The use of mode simple is recommended\&. In this mode only non inheriting ACL entries for the file owner and group are mapped to special IDs\&.
 .sp
 The following MODEs are understood by the module:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -516,6 +530,7 @@ nfs4:acedup = [dontcare|reject|ignore|me
 This parameter configures how Samba handles duplicate ACEs encountered in GPFS ACLs\&. GPFS allows/creates duplicate ACE for different bits for same ID\&.
 .sp
 Following is the behaviour of Samba for different values :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -575,6 +590,7 @@ This parameter allows enabling or disabl
 Some filesystems allow chown as a) giving b) stealing\&. It is the latter that is considered a risk\&.
 .sp
 Following is the behaviour of Samba for different values :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -608,6 +624,7 @@ gpfs:syncio = [yes|no]
 This parameter makes Samba open all files with O_SYNC\&. This triggers optimizations in GPFS for workloads that heavily share files\&.
 .sp
 Following is the behaviour of Samba for different values:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.7.1/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.7.0/docs/manpages/vfs_linux_xfs_sgid.8	2017-09-21 08:33:26.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_linux_xfs_sgid.8	2017-11-02 12:44:54.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_media_harmony.8 samba-4.7.1/docs/manpages/vfs_media_harmony.8
--- samba-4.7.0/docs/manpages/vfs_media_harmony.8	2017-09-21 08:33:27.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_media_harmony.8	2017-11-02 12:44:54.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -41,6 +41,7 @@ suite\&.
 The
 vfs_media_harmony
 VFS module allows Avid editorial workstations to share a network drive\&. It does this by:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_netatalk.8 samba-4.7.1/docs/manpages/vfs_netatalk.8
--- samba-4.7.0/docs/manpages/vfs_netatalk.8	2017-09-21 08:33:27.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_netatalk.8	2017-11-02 12:44:55.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_NETATALK" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_offline.8 samba-4.7.1/docs/manpages/vfs_offline.8
--- samba-4.7.0/docs/manpages/vfs_offline.8	2017-09-21 08:33:27.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_offline.8	2017-11-02 12:44:55.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_prealloc.8 samba-4.7.1/docs/manpages/vfs_prealloc.8
--- samba-4.7.0/docs/manpages/vfs_prealloc.8	2017-09-21 08:33:27.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_prealloc.8	2017-11-02 12:44:55.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -50,6 +50,7 @@ prealloc:EXT = BYTES
 Preallocate all files with the extension EXT to the size specified by BYTES\&.
 .sp
 The following suffixes may be applied to BYTES:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_preopen.8 samba-4.7.1/docs/manpages/vfs_preopen.8
--- samba-4.7.0/docs/manpages/vfs_preopen.8	2017-09-21 08:33:28.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_preopen.8	2017-11-02 12:44:55.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_readahead.8 samba-4.7.1/docs/manpages/vfs_readahead.8
--- samba-4.7.0/docs/manpages/vfs_readahead.8	2017-09-21 08:33:28.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_readahead.8	2017-11-02 12:44:55.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -64,6 +64,7 @@ The number of bytes requested to be read
 .RE
 .PP
 The following suffixes may be applied to BYTES:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_readonly.8 samba-4.7.1/docs/manpages/vfs_readonly.8
--- samba-4.7.0/docs/manpages/vfs_readonly.8	2017-09-21 08:33:28.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_readonly.8	2017-11-02 12:44:56.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READONLY" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_recycle.8 samba-4.7.1/docs/manpages/vfs_recycle.8
--- samba-4.7.0/docs/manpages/vfs_recycle.8	2017-09-21 08:33:28.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_recycle.8	2017-11-02 12:44:56.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_shadow_copy.8 samba-4.7.1/docs/manpages/vfs_shadow_copy.8
--- samba-4.7.0/docs/manpages/vfs_shadow_copy.8	2017-09-21 08:33:28.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_shadow_copy.8	2017-11-02 12:44:56.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -52,6 +52,7 @@ Filesystem snapshots must be mounted on
 vfs_shadow_copy\&. The snapshot mount points must be immediate children of a the directory being shared\&.
 .PP
 The snapshot naming convention is @GMT\-YYYY\&.MM\&.DD\-hh\&.mm\&.ss, where:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_shadow_copy2.8 samba-4.7.1/docs/manpages/vfs_shadow_copy2.8
--- samba-4.7.0/docs/manpages/vfs_shadow_copy2.8	2017-09-21 08:33:29.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_shadow_copy2.8	2017-11-02 12:44:56.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -45,6 +45,7 @@ VFS module offers a functionality simila
 This is a second implementation of a shadow copy module which has the following additional features (compared to the original
 \fBshadow_copy\fR(8)
 module):
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -126,6 +127,7 @@ vfs_shadow_copy2\&. These snapshot direc
 The snapshot at a given point in time is expected in a subdirectory of the snapshot directory where the snapshot\*(Aqs directory is expected to be a formatted version of the snapshot time\&. The default format which can be changed with the
 shadow:format
 option is @GMT\-YYYY\&.MM\&.DD\-hh\&.mm\&.ss, where:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -253,6 +255,7 @@ shadow:basedir = BASEDIR
 The basedir option allows one to specify a directory between the share\*(Aqs mount point and the share root, relative to which the file system\*(Aqs snapshots are taken\&.
 .sp
 For example, if
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -323,6 +326,7 @@ can be set to
 path/to/share\&.
 .sp
 With this parameter, it is no longer assumed that a snapshot represents an image of the original file system or a portion of it\&. For example, a system could perform backups of only files contained in shares, and then expose the backup files in a logical structure:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_shell_snap.8 samba-4.7.1/docs/manpages/vfs_shell_snap.8
--- samba-4.7.0/docs/manpages/vfs_shell_snap.8	2017-09-21 08:33:29.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_shell_snap.8	2017-11-02 12:44:56.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -45,6 +45,7 @@ VFS provides shell\-script callouts for
 The following shell callouts may be configured in smb\&.conf:
 .PP
 \m[blue]\fBshell_snap:check path command\fR\m[]
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -86,6 +87,7 @@ is capable of being snapshotted\&.
 .RE
 .PP
 \m[blue]\fBshell_snap:create command\fR\m[]
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -136,6 +138,7 @@ The command must output the path of the
 .RE
 .PP
 \m[blue]\fBshell_snap:delete command\fR\m[]
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_snapper.8 samba-4.7.1/docs/manpages/vfs_snapper.8
--- samba-4.7.0/docs/manpages/vfs_snapper.8	2017-09-21 08:33:29.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_snapper.8	2017-11-02 12:44:57.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_streams_depot.8 samba-4.7.1/docs/manpages/vfs_streams_depot.8
--- samba-4.7.0/docs/manpages/vfs_streams_depot.8	2017-09-21 08:33:29.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_streams_depot.8	2017-11-02 12:44:57.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -53,6 +53,7 @@ Path of the directory where the alternat
 streams_depot:delete_lost = [ yes | no ]
 .RS 4
 In the case of an already existing data streams directory for a newly created file the streams directory will be renamed to "lost\-%lu", random()\&. With this option lost stream directories will be removed instead of renamed\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_streams_xattr.8 samba-4.7.1/docs/manpages/vfs_streams_xattr.8
--- samba-4.7.0/docs/manpages/vfs_streams_xattr.8	2017-09-21 08:33:30.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_streams_xattr.8	2017-11-02 12:44:57.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_syncops.8 samba-4.7.1/docs/manpages/vfs_syncops.8
--- samba-4.7.0/docs/manpages/vfs_syncops.8	2017-09-21 08:33:30.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_syncops.8	2017-11-02 12:44:57.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_time_audit.8 samba-4.7.1/docs/manpages/vfs_time_audit.8
--- samba-4.7.0/docs/manpages/vfs_time_audit.8	2017-09-21 08:33:30.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_time_audit.8	2017-11-02 12:44:57.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_tsmsm.8 samba-4.7.1/docs/manpages/vfs_tsmsm.8
--- samba-4.7.0/docs/manpages/vfs_tsmsm.8	2017-09-21 08:33:30.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_tsmsm.8	2017-11-02 12:44:58.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TSMSM" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_unityed_media.8 samba-4.7.1/docs/manpages/vfs_unityed_media.8
--- samba-4.7.0/docs/manpages/vfs_unityed_media.8	2017-09-21 08:33:30.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_unityed_media.8	2017-11-02 12:44:58.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -49,6 +49,7 @@ If Mac and Windows Avid clients will be
 unityed_media:clientid = user | hostname | ip
 .RS 4
 Controls what client related identifier is appended to user specific paths:
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfs_worm.8 samba-4.7.1/docs/manpages/vfs_worm.8
--- samba-4.7.0/docs/manpages/vfs_worm.8	2017-09-21 08:33:31.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_worm.8	2017-11-02 12:44:58.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_WORM" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_xattr_tdb.8 samba-4.7.1/docs/manpages/vfs_xattr_tdb.8
--- samba-4.7.0/docs/manpages/vfs_xattr_tdb.8	2017-09-21 08:33:31.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_xattr_tdb.8	2017-11-02 12:44:58.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/vfs_zfsacl.8 samba-4.7.1/docs/manpages/vfs_zfsacl.8
--- samba-4.7.0/docs/manpages/vfs_zfsacl.8	2017-09-21 08:33:31.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfs_zfsacl.8	2017-11-02 12:44:58.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -43,6 +43,7 @@ zfsacl
 VFS module is the home for all ACL extensions that Samba requires for proper integration with ZFS\&.
 .PP
 Currently the zfsacl vfs module provides extensions in following areas :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -73,6 +74,7 @@ nfs4:mode = [ simple | special ]
 Controls substitution of special IDs (OWNER@ and GROUP@) on ZFS\&. The use of mode simple is recommended\&. In this mode only non inheriting ACL entries for the file owner and group are mapped to special IDs\&.
 .sp
 The following MODEs are understood by the module:
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -106,6 +108,7 @@ nfs4:acedup = [dontcare|reject|ignore|me
 This parameter configures how Samba handles duplicate ACEs encountered in ZFS ACLs\&. ZFS allows/creates duplicate ACE for different bits for same ID\&.
 .sp
 Following is the behaviour of Samba for different values :
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -165,6 +168,7 @@ This parameter allows enabling or disabl
 Some filesystems allow chown as a) giving b) stealing\&. It is the latter that is considered a risk\&.
 .sp
 Following is the behaviour of Samba for different values :
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/vfstest.1 samba-4.7.1/docs/manpages/vfstest.1
--- samba-4.7.0/docs/manpages/vfstest.1	2017-09-21 08:33:31.000000000 +0200
+++ samba-4.7.1/docs/manpages/vfstest.1	2017-11-02 12:44:59.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "VFSTEST" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -103,6 +103,7 @@ option "<name>" to value "<value>" from
 .SH "COMMANDS"
 .PP
 \fIVFS COMMANDS\fR
+.RS
 .sp
 .RS 4
 .ie n \{\
@@ -743,6 +744,7 @@ translate_name
 .RE
 .PP
 \fIGENERAL COMMANDS\fR
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs/manpages/wbinfo.1 samba-4.7.1/docs/manpages/wbinfo.1
--- samba-4.7.0/docs/manpages/wbinfo.1	2017-09-21 08:33:32.000000000 +0200
+++ samba-4.7.1/docs/manpages/wbinfo.1	2017-11-02 12:44:59.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "09/21/2017" "Samba 4\&.7" "User Commands"
+.TH "WBINFO" "1" "11/02/2017" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/winbind_krb5_locator.7 samba-4.7.1/docs/manpages/winbind_krb5_locator.7
--- samba-4.7.0/docs/manpages/winbind_krb5_locator.7	2017-09-21 08:33:32.000000000 +0200
+++ samba-4.7.1/docs/manpages/winbind_krb5_locator.7	2017-11-02 12:44:59.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_locator
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCATOR" "7" "09/21/2017" "Samba 4\&.7" "7"
+.TH "WINBIND_KRB5_LOCATOR" "7" "11/02/2017" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.0/docs/manpages/winbindd.8 samba-4.7.1/docs/manpages/winbindd.8
--- samba-4.7.0/docs/manpages/winbindd.8	2017-09-21 08:33:32.000000000 +0200
+++ samba-4.7.1/docs/manpages/winbindd.8	2017-11-02 12:44:59.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 09/21/2017
+.\"      Date: 11/02/2017
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "09/21/2017" "Samba 4\&.7" "System Administration tools"
+.TH "WINBINDD" "8" "11/02/2017" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -262,6 +262,7 @@ winbindd
 daemon is done through configuration parameters in the
 \fBsmb.conf\fR(5)
 file\&. All parameters should be specified in the [global] section of smb\&.conf\&.
+.RS
 .sp
 .RS 4
 .ie n \{\
diff -Npur samba-4.7.0/docs-xml/wscript_build samba-4.7.1/docs-xml/wscript_build
--- samba-4.7.0/docs-xml/wscript_build	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/docs-xml/wscript_build	2017-11-02 12:38:36.000000000 +0100
@@ -1,5 +1,6 @@
 #!/usr/bin/env python
 from samba_utils import save_file
+import os
 manpages='''
          manpages/cifsdd.8
          manpages/dbwrap_tool.1
@@ -129,7 +130,13 @@ def smbdotconf_generate_parameter_list(t
     save_file(parameter_all, t , create_dir=True)
     return 0
 
-articles = bld.path.ant_glob("smbdotconf/**/*.xml", flat=True)
+# Since nothing really forces sorting in glob, we have to sort by file name
+# POSIX file systems aren't required to return sorted content but we want
+# smb.conf parameters to be sorted alphabetically
+sources = bld.path.ant_glob("smbdotconf/**/*.xml", flat=False)
+articles = " ".join(sorted([x.relpath_gen(bld.path) for x in sources],
+                           key=lambda m: m.split(os.sep)[-1]))
+
 parameter_all = 'smbdotconf/parameters.all.xml'
 bld.SAMBA_GENERATOR(parameter_all,
                     source=articles,
diff -Npur samba-4.7.0/docs-xml/xslt/man.xsl samba-4.7.1/docs-xml/xslt/man.xsl
--- samba-4.7.0/docs-xml/xslt/man.xsl	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/docs-xml/xslt/man.xsl	2017-11-02 12:38:36.000000000 +0100
@@ -43,6 +43,7 @@
   <!-- * content (if any) before getting the list items -->
   <xsl:apply-templates
     select="*[not(self::listitem) and not(self::title)]"/>
+  <xsl:text>&#10;.RS&#10;</xsl:text>
   <xsl:apply-templates select="listitem"/>
   <xsl:if test="(parent::para or parent::listitem) or following-sibling::node()">
     <xsl:text>.sp&#10;</xsl:text>
diff -Npur samba-4.7.0/lib/krb5_wrap/krb5_samba.c samba-4.7.1/lib/krb5_wrap/krb5_samba.c
--- samba-4.7.0/lib/krb5_wrap/krb5_samba.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/lib/krb5_wrap/krb5_samba.c	2017-11-02 12:38:36.000000000 +0100
@@ -150,7 +150,7 @@ bool smb_krb5_sockaddr_to_kaddr(struct s
 				krb5_address *pkaddr)
 {
 	memset(pkaddr, '\0', sizeof(krb5_address));
-#if defined(HAVE_IPV6) && defined(KRB5_ADDRESS_INET6)
+#ifdef HAVE_IPV6
 	if (paddr->ss_family == AF_INET6) {
 		pkaddr->addr_type = KRB5_ADDRESS_INET6;
 		pkaddr->address.length = sizeof(((struct sockaddr_in6 *)paddr)->sin6_addr);
@@ -183,7 +183,7 @@ bool smb_krb5_sockaddr_to_kaddr(struct s
 				krb5_address *pkaddr)
 {
 	memset(pkaddr, '\0', sizeof(krb5_address));
-#if defined(HAVE_IPV6) && defined(ADDRTYPE_INET6)
+#ifdef HAVE_IPV6
 	if (paddr->ss_family == AF_INET6) {
 		pkaddr->addrtype = ADDRTYPE_INET6;
 		pkaddr->length = sizeof(((struct sockaddr_in6 *)paddr)->sin6_addr);
diff -Npur samba-4.7.0/lib/replace/wscript samba-4.7.1/lib/replace/wscript
--- samba-4.7.0/lib/replace/wscript	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/lib/replace/wscript	2017-11-02 12:38:36.000000000 +0100
@@ -251,10 +251,13 @@ def configure(conf):
 
     conf.CHECK_FUNCS('prctl dirname basename')
 
+    strlcpy_in_bsd = False
+
     # libbsd on some platforms provides strlcpy and strlcat
     if not conf.CHECK_FUNCS('strlcpy strlcat'):
-        conf.CHECK_FUNCS_IN('strlcpy strlcat', 'bsd', headers='bsd/string.h',
-                checklibc=True)
+        if conf.CHECK_FUNCS_IN('strlcpy strlcat', 'bsd', headers='bsd/string.h',
+                               checklibc=True):
+            strlcpy_in_bsd = True
     if not conf.CHECK_FUNCS('getpeereid'):
         conf.CHECK_FUNCS_IN('getpeereid', 'bsd', headers='sys/types.h bsd/unistd.h')
     if not conf.CHECK_FUNCS_IN('setproctitle', 'setproctitle', headers='setproctitle.h'):
@@ -611,6 +614,9 @@ removeea setea
 
     # look for a method of finding the list of network interfaces
     for method in ['HAVE_IFACE_GETIFADDRS', 'HAVE_IFACE_AIX', 'HAVE_IFACE_IFCONF', 'HAVE_IFACE_IFREQ']:
+        bsd_for_strlcpy = ''
+        if strlcpy_in_bsd:
+            bsd_for_strlcpy = ' bsd'
         if conf.CHECK_CODE('''
                            #define %s 1
                            #define NO_CONFIG_H 1
@@ -623,7 +629,7 @@ removeea setea
                            #include "test/getifaddrs.c"
                            ''' % method,
                            method,
-                           lib='nsl socket',
+                           lib='nsl socket' + bsd_for_strlcpy,
                            addmain=False,
                            execute=True):
             break
diff -Npur samba-4.7.0/lib/util/util_runcmd.c samba-4.7.1/lib/util/util_runcmd.c
--- samba-4.7.0/lib/util/util_runcmd.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/lib/util/util_runcmd.c	2017-11-02 12:38:36.000000000 +0100
@@ -32,18 +32,21 @@
 #include "../lib/util/tfork.h"
 #include "../lib/util/sys_rw.h"
 
-static int samba_runcmd_state_destructor(struct samba_runcmd_state *state)
+static void samba_runcmd_cleanup_fn(struct tevent_req *req,
+				    enum tevent_req_state req_state)
 {
-	if (state->pid > 0) {
-		kill(state->pid, SIGKILL);
-		waitpid(state->pid, NULL, 0);
-		state->pid = -1;
+	struct samba_runcmd_state *state = tevent_req_data(
+		req, struct samba_runcmd_state);
+
+	if (state->tfork != NULL) {
+		tfork_destroy(&state->tfork);
 	}
+	state->pid = -1;
 
 	if (state->fd_stdin != -1) {
 		close(state->fd_stdin);
+		state->fd_stdin = -1;
 	}
-	return 0;
 }
 
 static void samba_runcmd_io_handler(struct tevent_context *ev,
@@ -110,7 +113,6 @@ struct tevent_req *samba_runcmd_send(TAL
 
 	state->tfork = tfork_create();
 	if (state->tfork == NULL) {
-		printf("state->tfork == NULL\n");
 		close(p1[0]);
 		close(p1[1]);
 		close(p2[0]);
@@ -141,7 +143,7 @@ struct tevent_req *samba_runcmd_send(TAL
 		smb_set_close_on_exec(state->fd_stderr);
 		smb_set_close_on_exec(state->fd_status);
 
-		talloc_set_destructor(state, samba_runcmd_state_destructor);
+		tevent_req_set_cleanup_fn(req, samba_runcmd_cleanup_fn);
 
 		state->fde_stdout = tevent_add_fd(ev, state,
 						  state->fd_stdout,
@@ -275,6 +277,7 @@ static void samba_runcmd_io_handler(stru
 			tevent_req_error(req, errno);
 			return;
 		}
+		state->pid = -1;
 		TALLOC_FREE(fde);
 
 		if (WIFEXITED(status)) {
diff -Npur samba-4.7.0/libgpo/gpo_ldap.c samba-4.7.1/libgpo/gpo_ldap.c
--- samba-4.7.0/libgpo/gpo_ldap.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/libgpo/gpo_ldap.c	2017-11-02 12:38:36.000000000 +0100
@@ -554,6 +554,7 @@ ADS_STATUS ads_get_gpo(ADS_STRUCT *ads,
 static ADS_STATUS add_gplink_to_gpo_list(ADS_STRUCT *ads,
 					 TALLOC_CTX *mem_ctx,
 					 struct GROUP_POLICY_OBJECT **gpo_list,
+					 struct GROUP_POLICY_OBJECT **forced_gpo_list,
 					 const char *link_dn,
 					 struct GP_LINK *gp_link,
 					 enum GPO_LINK_TYPE link_type,
@@ -561,11 +562,20 @@ static ADS_STATUS add_gplink_to_gpo_list
 					 const struct security_token *token)
 {
 	ADS_STATUS status;
-	int i;
-
-	for (i = 0; i < gp_link->num_links; i++) {
+	uint32_t count;
 
+	/*
+	 * Note: DLIST_ADD pushes to the front,
+	 * so loop from last to first to get the
+	 * order right.
+	 */
+	for (count = gp_link->num_links; count > 0; count--) {
+		/* NB. Index into arrays is one less than counter. */
+		uint32_t i = count - 1;
+		struct GROUP_POLICY_OBJECT **target_list = NULL;
 		struct GROUP_POLICY_OBJECT *new_gpo = NULL;
+		bool is_forced =
+			(gp_link->link_opts[i] & GPO_LINK_OPT_ENFORCED) != 0;
 
 		if (gp_link->link_opts[i] & GPO_LINK_OPT_DISABLED) {
 			DEBUG(10,("skipping disabled GPO\n"));
@@ -574,7 +584,7 @@ static ADS_STATUS add_gplink_to_gpo_list
 
 		if (only_add_forced_gpos) {
 
-			if (!(gp_link->link_opts[i] & GPO_LINK_OPT_ENFORCED)) {
+			if (!is_forced) {
 				DEBUG(10,("skipping nonenforced GPO link "
 					"because GPOPTIONS_BLOCK_INHERITANCE "
 					"has been set\n"));
@@ -617,7 +627,8 @@ static ADS_STATUS add_gplink_to_gpo_list
 		new_gpo->link = link_dn;
 		new_gpo->link_type = link_type;
 
-		DLIST_ADD(*gpo_list, new_gpo);
+		target_list = is_forced ? forced_gpo_list : gpo_list;
+		DLIST_ADD(*target_list, new_gpo);
 
 		DEBUG(10,("add_gplink_to_gplist: added GPLINK #%d %s "
 			"to GPO list\n", i, gp_link->link_names[i]));
@@ -716,17 +727,28 @@ static ADS_STATUS add_local_policy_to_gp
 }
 
 /****************************************************************
- get the full list of GROUP_POLICY_OBJECTs for a given dn
+ Get the full list of GROUP_POLICY_OBJECTs for a given dn.
 ****************************************************************/
 
-ADS_STATUS ads_get_gpo_list(ADS_STRUCT *ads,
+static ADS_STATUS ads_get_gpo_list_internal(ADS_STRUCT *ads,
 			    TALLOC_CTX *mem_ctx,
 			    const char *dn,
 			    uint32_t flags,
 			    const struct security_token *token,
-			    struct GROUP_POLICY_OBJECT **gpo_list)
+			    struct GROUP_POLICY_OBJECT **gpo_list,
+			    struct GROUP_POLICY_OBJECT **forced_gpo_list)
 {
-	/* (L)ocal (S)ite (D)omain (O)rganizational(U)nit */
+	/*
+	 * Push GPOs to gpo_list so that the traversal order of the list matches
+	 * the order of application:
+	 * (L)ocal (S)ite (D)omain (O)rganizational(U)nit
+	 * For different domains and OUs: parent-to-child.
+	 * Within same level of domains and OUs: Link order.
+	 * Since GPOs are pushed to the front of gpo_list, GPOs have to be
+	 * pushed in the opposite order of application (OUs first, local last,
+	 * child-to-parent).
+	 * Forced GPOs are appended in the end since they override all others.
+	 */
 
 	ADS_STATUS status;
 	struct GP_LINK gp_link;
@@ -734,6 +756,7 @@ ADS_STATUS ads_get_gpo_list(ADS_STRUCT *
 	bool add_only_forced_gpos = false;
 
 	ZERO_STRUCTP(gpo_list);
+	ZERO_STRUCTP(forced_gpo_list);
 
 	if (!dn) {
 		return ADS_ERROR_NT(NT_STATUS_INVALID_PARAMETER);
@@ -745,52 +768,54 @@ ADS_STATUS ads_get_gpo_list(ADS_STRUCT *
 
 	DEBUG(10,("ads_get_gpo_list: getting GPO list for [%s]\n", dn));
 
-	/* (L)ocal */
-	status = add_local_policy_to_gpo_list(mem_ctx, gpo_list,
-					      GP_LINK_LOCAL);
-	if (!ADS_ERR_OK(status)) {
-		return status;
-	}
+	tmp_dn = dn;
 
-	/* (S)ite */
+	while ((parent_dn = ads_parent_dn(tmp_dn)) &&
+	       (!strequal(parent_dn, ads_parent_dn(ads->config.bind_path)))) {
 
-	/* are site GPOs valid for users as well ??? */
-	if (flags & GPO_LIST_FLAG_MACHINE) {
 
-		status = ads_site_dn_for_machine(ads, mem_ctx,
-						 ads->config.ldap_server_name,
-						 &site_dn);
-		if (!ADS_ERR_OK(status)) {
-			return status;
-		}
+		/* (O)rganizational(U)nit */
 
-		DEBUG(10,("ads_get_gpo_list: query SITE: [%s] for GPOs\n",
-			site_dn));
+		/* An account can be a member of more OUs */
+		if (strncmp(parent_dn, "OU=", strlen("OU=")) == 0) {
 
-		status = ads_get_gpo_link(ads, mem_ctx, site_dn, &gp_link);
-		if (ADS_ERR_OK(status)) {
+			DEBUG(10,("ads_get_gpo_list: query OU: [%s] for GPOs\n",
+				parent_dn));
 
-			if (DEBUGLEVEL >= 100) {
-				dump_gplink(&gp_link);
-			}
+			status = ads_get_gpo_link(ads, mem_ctx, parent_dn,
+						  &gp_link);
+			if (ADS_ERR_OK(status)) {
 
-			status = add_gplink_to_gpo_list(ads, mem_ctx, gpo_list,
-							site_dn, &gp_link,
-							GP_LINK_SITE,
+				if (DEBUGLEVEL >= 100) {
+					dump_gplink(&gp_link);
+				}
+
+				status = add_gplink_to_gpo_list(ads,
+							mem_ctx,
+							gpo_list,
+							forced_gpo_list,
+							parent_dn,
+							&gp_link,
+							GP_LINK_OU,
 							add_only_forced_gpos,
 							token);
-			if (!ADS_ERR_OK(status)) {
-				return status;
-			}
+				if (!ADS_ERR_OK(status)) {
+					return status;
+				}
 
-			if (flags & GPO_LIST_FLAG_SITEONLY) {
-				return ADS_ERROR(LDAP_SUCCESS);
+				/* block inheritance from now on */
+				if (gp_link.gp_opts &
+				    GPOPTIONS_BLOCK_INHERITANCE) {
+					add_only_forced_gpos = true;
+				}
 			}
-
-			/* inheritance can't be blocked at the site level */
 		}
+
+		tmp_dn = parent_dn;
+
 	}
 
+	/* reset dn again */
 	tmp_dn = dn;
 
 	while ((parent_dn = ads_parent_dn(tmp_dn)) &&
@@ -812,15 +837,10 @@ ADS_STATUS ads_get_gpo_list(ADS_STRUCT *
 					dump_gplink(&gp_link);
 				}
 
-				/* block inheritance from now on */
-				if (gp_link.gp_opts &
-				    GPOPTIONS_BLOCK_INHERITANCE) {
-					add_only_forced_gpos = true;
-				}
-
 				status = add_gplink_to_gpo_list(ads,
 							mem_ctx,
 							gpo_list,
+							forced_gpo_list,
 							parent_dn,
 							&gp_link,
 							GP_LINK_DOMAIN,
@@ -829,58 +849,101 @@ ADS_STATUS ads_get_gpo_list(ADS_STRUCT *
 				if (!ADS_ERR_OK(status)) {
 					return status;
 				}
+
+				/* block inheritance from now on */
+				if (gp_link.gp_opts &
+				    GPOPTIONS_BLOCK_INHERITANCE) {
+					add_only_forced_gpos = true;
+				}
 			}
 		}
 
 		tmp_dn = parent_dn;
 	}
 
-	/* reset dn again */
-	tmp_dn = dn;
-
-	while ((parent_dn = ads_parent_dn(tmp_dn)) &&
-	       (!strequal(parent_dn, ads_parent_dn(ads->config.bind_path)))) {
-
-
-		/* (O)rganizational(U)nit */
+	/* (S)ite */
 
-		/* An account can be a member of more OUs */
-		if (strncmp(parent_dn, "OU=", strlen("OU=")) == 0) {
+	/* are site GPOs valid for users as well ??? */
+	if (flags & GPO_LIST_FLAG_MACHINE) {
 
-			DEBUG(10,("ads_get_gpo_list: query OU: [%s] for GPOs\n",
-				parent_dn));
+		status = ads_site_dn_for_machine(ads, mem_ctx,
+						 ads->config.ldap_server_name,
+						 &site_dn);
+		if (!ADS_ERR_OK(status)) {
+			return status;
+		}
 
-			status = ads_get_gpo_link(ads, mem_ctx, parent_dn,
-						  &gp_link);
-			if (ADS_ERR_OK(status)) {
+		DEBUG(10,("ads_get_gpo_list: query SITE: [%s] for GPOs\n",
+			site_dn));
 
-				if (DEBUGLEVEL >= 100) {
-					dump_gplink(&gp_link);
-				}
+		status = ads_get_gpo_link(ads, mem_ctx, site_dn, &gp_link);
+		if (ADS_ERR_OK(status)) {
 
-				/* block inheritance from now on */
-				if (gp_link.gp_opts &
-				    GPOPTIONS_BLOCK_INHERITANCE) {
-					add_only_forced_gpos = true;
-				}
+			if (DEBUGLEVEL >= 100) {
+				dump_gplink(&gp_link);
+			}
 
-				status = add_gplink_to_gpo_list(ads,
+			status = add_gplink_to_gpo_list(ads,
 							mem_ctx,
 							gpo_list,
-							parent_dn,
+							forced_gpo_list,
+							site_dn,
 							&gp_link,
-							GP_LINK_OU,
+							GP_LINK_SITE,
 							add_only_forced_gpos,
 							token);
-				if (!ADS_ERR_OK(status)) {
-					return status;
-				}
+			if (!ADS_ERR_OK(status)) {
+				return status;
+			}
+
+			if (flags & GPO_LIST_FLAG_SITEONLY) {
+				return ADS_ERROR(LDAP_SUCCESS);
 			}
+
+			/* inheritance can't be blocked at the site level */
 		}
+	}
 
-		tmp_dn = parent_dn;
+	/* (L)ocal */
+	status = add_local_policy_to_gpo_list(mem_ctx, gpo_list,
+					      GP_LINK_LOCAL);
+	if (!ADS_ERR_OK(status)) {
+		return status;
+	}
+
+	return ADS_ERROR(LDAP_SUCCESS);
+}
+
+/****************************************************************
+ Get the full list of GROUP_POLICY_OBJECTs for a given dn, wrapper
+ around ads_get_gpo_list_internal() that ensures correct ordering.
+****************************************************************/
 
-	};
+ADS_STATUS ads_get_gpo_list(ADS_STRUCT *ads,
+			    TALLOC_CTX *mem_ctx,
+			    const char *dn,
+			    uint32_t flags,
+			    const struct security_token *token,
+			    struct GROUP_POLICY_OBJECT **gpo_list)
+{
+	struct GROUP_POLICY_OBJECT *forced_gpo_list = NULL;
+	ADS_STATUS status;
+
+	status = ads_get_gpo_list_internal(ads,
+					   mem_ctx,
+					   dn,
+					   flags,
+					   token,
+					   gpo_list,
+					   &forced_gpo_list);
+	if (!ADS_ERR_OK(status)) {
+		return status;
+	}
+	/*
+	 * Append |forced_gpo_list| at the end of |gpo_list|,
+	 * so that forced GPOs are applied on top of non enforced GPOs.
+	 */
+	DLIST_CONCATENATE(*gpo_list, forced_gpo_list);
 
 	return ADS_ERROR(LDAP_SUCCESS);
 }
diff -Npur samba-4.7.0/librpc/idl/dns.idl samba-4.7.1/librpc/idl/dns.idl
--- samba-4.7.0/librpc/idl/dns.idl	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/librpc/idl/dns.idl	2017-11-02 12:38:36.000000000 +0100
@@ -18,6 +18,9 @@ import "misc.idl", "dnsp.idl";
 interface dns
 {
 	const int DNS_SERVICE_PORT       = 53;
+	const int DNS_MAX_LABELS         = 127;
+	const int DNS_MAX_DOMAIN_LENGTH  = 253;
+	const int DNS_MAX_LABEL_LENGTH   = 63;
 
 	typedef [public,bitmap16bit] bitmap {
 		DNS_RCODE                   = 0x000F,
diff -Npur samba-4.7.0/python/samba/netcmd/dns.py samba-4.7.1/python/samba/netcmd/dns.py
--- samba-4.7.0/python/samba/netcmd/dns.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/python/samba/netcmd/dns.py	2017-11-02 12:38:36.000000000 +0100
@@ -819,7 +819,8 @@ class cmd_query(Command):
         record_type = dns_type_flag(rtype)
 
         if name.find('*') != -1:
-            raise CommandError('Wildcard searches not supported. To dump entire zone use "@"')
+            self.outf.write('use "@" to dump entire domain, looking up %s\n' %
+                            name)
 
         select_flags = 0
         if authority:
diff -Npur samba-4.7.0/python/samba/tests/dns_wildcard.py samba-4.7.1/python/samba/tests/dns_wildcard.py
--- samba-4.7.0/python/samba/tests/dns_wildcard.py	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/python/samba/tests/dns_wildcard.py	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,288 @@
+# Unix SMB/CIFS implementation.
+# Copyright (C) Andrew Bartlett 2007
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+#
+
+import sys
+from samba import credentials
+from samba.dcerpc import dns, dnsserver
+from samba.netcmd.dns import data_to_dns_record
+from samba.tests.subunitrun import SubunitOptions, TestProgram
+from samba import werror, WERRORError
+from samba.tests.dns_base import DNSTest
+import samba.getopt as options
+import optparse
+
+parser = optparse.OptionParser(
+    "dns_wildcard.py <server name> <server ip> [options]")
+sambaopts = options.SambaOptions(parser)
+parser.add_option_group(sambaopts)
+
+# This timeout only has relevance when testing against Windows
+# Format errors tend to return patchy responses, so a timeout is needed.
+parser.add_option("--timeout", type="int", dest="timeout",
+                  help="Specify timeout for DNS requests")
+
+# To run against Windows
+# python python/samba/tests/dns_wildcard.py computer_name ip
+#                                  -U"Administrator%admin_password"
+#                                  --realm=Domain_name
+#                                  --timeout 10
+#
+
+# use command line creds if available
+credopts = options.CredentialsOptions(parser)
+parser.add_option_group(credopts)
+subunitopts = SubunitOptions(parser)
+parser.add_option_group(subunitopts)
+
+opts, args = parser.parse_args()
+
+lp = sambaopts.get_loadparm()
+creds = credopts.get_credentials(lp)
+
+timeout = opts.timeout
+
+if len(args) < 2:
+    parser.print_usage()
+    sys.exit(1)
+
+server_name = args[0]
+server_ip = args[1]
+creds.set_krb_forwardable(credentials.NO_KRB_FORWARDABLE)
+
+WILDCARD_IP        = "1.1.1.1"
+WILDCARD           = "*.wildcardtest"
+EXACT_IP           = "1.1.1.2"
+EXACT              = "exact.wildcardtest"
+LEVEL2_WILDCARD_IP = "1.1.1.3"
+LEVEL2_WILDCARD    = "*.level2.wildcardtest"
+LEVEL2_EXACT_IP    = "1.1.1.4"
+LEVEL2_EXACT       = "exact.level2.wildcardtest"
+
+
+class TestWildCardQueries(DNSTest):
+
+    def setUp(self):
+        super(TestWildCardQueries, self).setUp()
+        global server, server_ip, lp, creds, timeout
+        self.server = server_name
+        self.server_ip = server_ip
+        self.lp = lp
+        self.creds = creds
+        self.timeout = timeout
+
+        # Create the dns records
+        self.dns_records = [(dns.DNS_QTYPE_A,
+                             "%s.%s" % (WILDCARD, self.get_dns_domain()),
+                             WILDCARD_IP),
+                            (dns.DNS_QTYPE_A,
+                             "%s.%s" % (EXACT, self.get_dns_domain()),
+                             EXACT_IP),
+                            (dns.DNS_QTYPE_A,
+                             ("%s.%s" % (
+                                 LEVEL2_WILDCARD,
+                                 self.get_dns_domain())),
+                             LEVEL2_WILDCARD_IP),
+                            (dns.DNS_QTYPE_A,
+                             ("%s.%s" % (
+                                 LEVEL2_EXACT,
+                                 self.get_dns_domain())),
+                             LEVEL2_EXACT_IP)]
+
+        c = self.dns_connect()
+        for (typ, name, data) in self.dns_records:
+            self.add_record(c, typ, name, data)
+
+    def tearDown(self):
+        c = self.dns_connect()
+        for (typ, name, data) in self.dns_records:
+            self.delete_record(c, typ, name, data)
+
+    def dns_connect(self):
+        binding_str = "ncacn_ip_tcp:%s[sign]" % self.server_ip
+        return dnsserver.dnsserver(binding_str, self.lp, self.creds)
+
+    def delete_record(self, dns_conn, typ, name, data):
+
+        rec = data_to_dns_record(typ, data)
+        del_rec_buf = dnsserver.DNS_RPC_RECORD_BUF()
+        del_rec_buf.rec = rec
+
+        try:
+            dns_conn.DnssrvUpdateRecord2(dnsserver.DNS_CLIENT_VERSION_LONGHORN,
+                                         0,
+                                         self.server,
+                                         self.get_dns_domain(),
+                                         name,
+                                         None,
+                                         del_rec_buf)
+        except WERRORError as e:
+            # Ignore record does not exist errors
+            if e.args[0] != werror.WERR_DNS_ERROR_NAME_DOES_NOT_EXIST:
+                raise e
+
+    def add_record(self, dns_conn, typ, name, data):
+
+        rec = data_to_dns_record(typ, data)
+        add_rec_buf = dnsserver.DNS_RPC_RECORD_BUF()
+        add_rec_buf.rec = rec
+        try:
+            dns_conn.DnssrvUpdateRecord2(dnsserver.DNS_CLIENT_VERSION_LONGHORN,
+                                         0,
+                                         self.server,
+                                         self.get_dns_domain(),
+                                         name,
+                                         add_rec_buf,
+                                         None)
+        except WERRORError as e:
+            raise e
+
+    def test_one_a_query_match_wildcard(self):
+        "Query an A record, should match the wildcard entry"
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "miss.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
+
+    def test_one_a_query_wildcard_entry(self):
+        "Query the wildcard entry"
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "%s.%s" % (WILDCARD, self.get_dns_domain())
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
+
+    def test_one_a_query_exact_match(self):
+        """Query an entry that matches the wild card but has an exact match as
+         well.
+         """
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "%s.%s" % (EXACT, self.get_dns_domain())
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, EXACT_IP)
+
+    def test_one_a_query_match_wildcard_l2(self):
+        "Query an A record, should match the level 2 wildcard entry"
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "miss.level2.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, LEVEL2_WILDCARD_IP)
+
+    def test_one_a_query_exact_match_l2(self):
+        """Query an entry that matches the wild card but has an exact match as
+         well.
+         """
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "%s.%s" % (LEVEL2_EXACT, self.get_dns_domain())
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, LEVEL2_EXACT_IP)
+
+    def test_one_a_query_wildcard_entry_l2(self):
+        "Query the level 2 wildcard entry"
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "%s.%s" % (LEVEL2_WILDCARD, self.get_dns_domain())
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, LEVEL2_WILDCARD_IP)
+
+
+TestProgram(module=__name__, opts=subunitopts)
diff -Npur samba-4.7.0/python/samba/tests/dsdb_schema_attributes.py samba-4.7.1/python/samba/tests/dsdb_schema_attributes.py
--- samba-4.7.0/python/samba/tests/dsdb_schema_attributes.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/python/samba/tests/dsdb_schema_attributes.py	2017-11-02 12:38:36.000000000 +0100
@@ -173,3 +173,56 @@ systemOnly: FALSE
 
         self.assertIn(attr_ldap_name, [str(x) for x in idx_res[0]["@IDXATTR"]])
         self.assertIn(attr_ldap_name2, [str(x) for x in idx_res[0]["@IDXATTR"]])
+
+    def test_modify_at_attributes(self):
+        m = {"dn": "@ATTRIBUTES",
+             "@TEST_EXTRA": ["HIDDEN"]
+             }
+
+        msg = ldb.Message.from_dict(self.samdb, m, ldb.FLAG_MOD_ADD)
+        self.samdb.modify(msg)
+
+        res = self.samdb.search(base="@ATTRIBUTES", scope=ldb.SCOPE_BASE,
+                                attrs=["@TEST_EXTRA"])
+        self.assertEquals(len(res), 1)
+        self.assertEquals(str(res[0].dn), "@ATTRIBUTES")
+        self.assertEquals(len(res[0]), 1)
+        self.assertTrue("@TEST_EXTRA" in res[0])
+        self.assertEquals(len(res[0]["@TEST_EXTRA"]), 1)
+        self.assertEquals(res[0]["@TEST_EXTRA"][0], "HIDDEN")
+
+        samdb2 = samba.tests.connect_samdb(self.lp.samdb_url())
+
+        res = self.samdb.search(base="@ATTRIBUTES", scope=ldb.SCOPE_BASE,
+                                attrs=["@TEST_EXTRA"])
+        self.assertEquals(len(res), 1)
+        self.assertEquals(str(res[0].dn), "@ATTRIBUTES")
+        self.assertEquals(len(res[0]), 0)
+        self.assertFalse("@TEST_EXTRA" in res[0])
+
+
+    def test_modify_at_indexlist(self):
+        m = {"dn": "@INDEXLIST",
+             "@TEST_EXTRA": ["1"]
+             }
+
+        msg = ldb.Message.from_dict(self.samdb, m, ldb.FLAG_MOD_ADD)
+        self.samdb.modify(msg)
+
+        res = self.samdb.search(base="@INDEXLIST", scope=ldb.SCOPE_BASE,
+                                attrs=["@TEST_EXTRA"])
+        self.assertEquals(len(res), 1)
+        self.assertEquals(str(res[0].dn), "@INDEXLIST")
+        self.assertEquals(len(res[0]), 1)
+        self.assertTrue("@TEST_EXTRA" in res[0])
+        self.assertEquals(len(res[0]["@TEST_EXTRA"]), 1)
+        self.assertEquals(res[0]["@TEST_EXTRA"][0], "1")
+
+        samdb2 = samba.tests.connect_samdb(self.lp.samdb_url())
+
+        res = self.samdb.search(base="@INDEXLIST", scope=ldb.SCOPE_BASE,
+                                attrs=["@TEST_EXTRA"])
+        self.assertEquals(len(res), 1)
+        self.assertEquals(str(res[0].dn), "@INDEXLIST")
+        self.assertEquals(len(res[0]), 0)
+        self.assertFalse("@TEST_EXTRA" in res[0])
diff -Npur samba-4.7.0/python/samba/tests/samba_tool/dnscmd.py samba-4.7.1/python/samba/tests/samba_tool/dnscmd.py
--- samba-4.7.0/python/samba/tests/samba_tool/dnscmd.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/python/samba/tests/samba_tool/dnscmd.py	2017-11-02 12:38:36.000000000 +0100
@@ -659,3 +659,70 @@ class DnsCmdTestCase(SambaToolCmdTest):
                                           self.zone, "testrecord2",
                                           "A", self.testip, self.creds_string)
         self.assertCmdFail(result)
+
+    def test_dns_wildcards(self):
+        """
+        Ensure that DNS wild card entries can be added deleted and queried
+        """
+        num_failures = 0
+        failure_msgs = []
+        records = [("*.",       "MISS",         "A", "1.1.1.1"),
+                   ("*.SAMDOM", "MISS.SAMDOM",  "A", "1.1.1.2")]
+        for (name, miss, dnstype, record) in records:
+            try:
+                result, out, err = self.runsubcmd("dns", "add",
+                                                  os.environ["SERVER"],
+                                                  self.zone, name,
+                                                  dnstype, record,
+                                                  self.creds_string)
+                self.assertCmdSuccess(
+                    result,
+                    out,
+                    err,
+                    ("Failed to add record %s (%s) with type %s."
+                     % (name, record, dnstype)))
+
+                result, out, err = self.runsubcmd("dns", "query",
+                                                  os.environ["SERVER"],
+                                                  self.zone, name,
+                                                  dnstype,
+                                                  self.creds_string)
+                self.assertCmdSuccess(
+                    result,
+                    out,
+                    err,
+                    ("Failed to query record %s with qualifier %s."
+                     % (record, dnstype)))
+
+                # dns tool does not perform dns wildcard search if the name
+                # does not match
+                result, out, err = self.runsubcmd("dns", "query",
+                                                  os.environ["SERVER"],
+                                                  self.zone, miss,
+                                                  dnstype,
+                                                  self.creds_string)
+                self.assertCmdFail(
+                    result,
+                    ("Failed to query record %s with qualifier %s."
+                     % (record, dnstype)))
+
+                result, out, err = self.runsubcmd("dns", "delete",
+                                                  os.environ["SERVER"],
+                                                  self.zone, name,
+                                                  dnstype, record,
+                                                  self.creds_string)
+                self.assertCmdSuccess(
+                    result,
+                    out,
+                    err,
+                    ("Failed to remove record %s with type %s."
+                     % (record, dnstype)))
+            except AssertionError as e:
+                num_failures = num_failures + 1
+                failure_msgs.append(e)
+
+        if num_failures > 0:
+            for msg in failure_msgs:
+                print(msg)
+            self.fail("Failed to accept valid commands. %d total failures."
+                      "Errors above." % num_failures)
diff -Npur samba-4.7.0/selftest/knownfail samba-4.7.1/selftest/knownfail
--- samba-4.7.0/selftest/knownfail	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.1/selftest/knownfail	2017-11-02 12:38:36.000000000 +0100
@@ -171,6 +171,7 @@
 ^samba3.smb2.setinfo.setinfo
 ^samba3.smb2.session.*reauth5 # some special anonymous checks?
 ^samba3.smb2.compound.interim2 # wrong return code (STATUS_CANCELLED)
+^samba3.smb2.compound.aio.interim2 # wrong return code (STATUS_CANCELLED)
 ^samba3.smb2.replay.channel-sequence
 ^samba3.smb2.replay.replay3
 ^samba3.smb2.replay.replay4
diff -Npur samba-4.7.0/selftest/target/Samba3.pm samba-4.7.1/selftest/target/Samba3.pm
--- samba-4.7.0/selftest/target/Samba3.pm	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/selftest/target/Samba3.pm	2017-11-02 12:38:36.000000000 +0100
@@ -795,6 +795,8 @@ sub setup_fileserver($$)
 	push(@dirs,$usershare_sharedir);
 
 	my $fileserver_options = "
+	kernel change notify = yes
+
 	usershare path = $usershare_dir
 	usershare max shares = 10
 	usershare allow guests = yes
diff -Npur samba-4.7.0/source3/client/client.c samba-4.7.1/source3/client/client.c
--- samba-4.7.0/source3/client/client.c	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.1/source3/client/client.c	2017-11-02 12:38:36.000000000 +0100
@@ -346,6 +346,37 @@ static void normalize_name(char *newdir)
 }
 
 /****************************************************************************
+ Local name cleanup before sending to server. SMB1 allows relative pathnames,
+ but SMB2 does not, so we need to resolve them locally.
+****************************************************************************/
+
+char *client_clean_name(TALLOC_CTX *ctx, const char *name)
+{
+	char *newname = NULL;
+	if (name == NULL) {
+		return NULL;
+	}
+
+	/* First ensure any path separators are correct. */
+	newname = talloc_strdup(ctx, name);
+	if (newname == NULL) {
+		return NULL;
+	}
+	normalize_name(newname);
+
+	/* Now remove any relative (..) path components. */
+	if (cli->requested_posix_capabilities & CIFS_UNIX_POSIX_PATHNAMES_CAP) {
+		newname = unix_clean_name(ctx, newname);
+	} else {
+		newname = clean_name(ctx, newname);
+	}
+	if (newname == NULL) {
+		return NULL;
+	}
+	return newname;
+}
+
+/****************************************************************************
  Change directory - inner section.
 ****************************************************************************/
 
@@ -399,7 +430,7 @@ static int do_cd(const char *new_dir)
 	}
 	client_set_cur_dir(new_cd);
 
-	new_cd = clean_name(ctx, new_cd);
+	new_cd = client_clean_name(ctx, new_cd);
 	client_set_cur_dir(new_cd);
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
@@ -443,7 +474,7 @@ static int do_cd(const char *new_dir)
 			client_set_cur_dir(saved_dir);
 			goto out;
 		}
-		targetpath = clean_name(ctx, targetpath);
+		targetpath = client_clean_name(ctx, targetpath);
 		if (!targetpath) {
 			client_set_cur_dir(saved_dir);
 			goto out;
@@ -953,6 +984,11 @@ static int cmd_dir(void)
 		return 1;
 	}
 
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
+
 	if (showacls) {
 		/* cwd is only used if showacls is on */
 		client_set_cwd(client_get_cur_dir());
@@ -1005,6 +1041,14 @@ static int cmd_du(void)
 	} else {
 		mask = talloc_strdup(ctx, "*");
 	}
+	if (!mask) {
+		return 1;
+	}
+
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = do_list(mask, attribute, do_du, recurse, true);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -1201,7 +1245,7 @@ static int cmd_get(void)
 	if (!rname) {
 		return 1;
 	}
-	rname = clean_name(ctx, rname);
+	rname = client_clean_name(ctx, rname);
 	if (!rname) {
 		return 1;
 	}
@@ -1267,6 +1311,10 @@ static NTSTATUS do_mget(struct cli_state
 		if (!rname) {
 			return NT_STATUS_NO_MEMORY;
 		}
+		rname = client_clean_name(ctx, rname);
+		if (rname == NULL) {
+			return NT_STATUS_NO_MEMORY;
+		}
 		do_get(rname, finfo->name, false);
 		TALLOC_FREE(rname);
 		return NT_STATUS_OK;
@@ -1286,6 +1334,10 @@ static NTSTATUS do_mget(struct cli_state
 	if (!new_cd) {
 		return NT_STATUS_NO_MEMORY;
 	}
+	new_cd = client_clean_name(ctx, new_cd);
+	if (new_cd == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
 	client_set_cur_dir(new_cd);
 
 	string_replace(finfo->name,'\\','/');
@@ -1316,6 +1368,10 @@ static NTSTATUS do_mget(struct cli_state
 		return NT_STATUS_NO_MEMORY;
 	}
 
+	mget_mask = client_clean_name(ctx, mget_mask);
+	if (mget_mask == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
 	status = do_list(mget_mask,
 			 (FILE_ATTRIBUTE_SYSTEM
 			  | FILE_ATTRIBUTE_HIDDEN
@@ -1385,7 +1441,7 @@ static int cmd_more(void)
 	if (!rname) {
 		return 1;
 	}
-	rname = clean_name(ctx,rname);
+	rname = client_clean_name(ctx,rname);
 	if (!rname) {
 		return 1;
 	}
@@ -1443,6 +1499,10 @@ static int cmd_mget(void)
 		if (!mget_mask) {
 			return 1;
 		}
+		mget_mask = client_clean_name(ctx, mget_mask);
+		if (mget_mask == NULL) {
+			return 1;
+		}
 		status = do_list(mget_mask, attribute, do_mget, false, true);
 		if (!NT_STATUS_IS_OK(status)) {
 			return 1;
@@ -1461,6 +1521,10 @@ static int cmd_mget(void)
 		if (!mget_mask) {
 			return 1;
 		}
+		mget_mask = client_clean_name(ctx, mget_mask);
+		if (mget_mask == NULL) {
+			return 1;
+		}
 		status = do_list(mget_mask, attribute, do_mget, false, true);
 		if (!NT_STATUS_IS_OK(status)) {
 			return 1;
@@ -1557,6 +1621,10 @@ static int cmd_mkdir(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	if (recurse) {
 		char *ddir = NULL;
@@ -1628,6 +1696,10 @@ static int cmd_altname(void)
 	if (!name) {
 		return 1;
 	}
+	name = client_clean_name(ctx, name);
+	if (name == NULL) {
+		return 1;
+	}
 	do_altname(name);
 	return 0;
 }
@@ -1858,7 +1930,10 @@ static int cmd_allinfo(void)
 	if (!name) {
 		return 1;
 	}
-
+	name = client_clean_name(ctx, name);
+	if (name == NULL) {
+		return 1;
+	}
 	do_allinfo(name);
 
 	return 0;
@@ -2021,7 +2096,7 @@ static int cmd_put(void)
 		return 1;
 	}
 
-	rname = clean_name(ctx, rname);
+	rname = client_clean_name(ctx, rname);
 	if (!rname) {
 		return 1;
 	}
@@ -2230,6 +2305,19 @@ static int cmd_mput(void)
 						break;
 					}
 					normalize_name(rname);
+					{
+						char *tmp_rname =
+							client_clean_name(ctx, rname);
+						if (tmp_rname == NULL) {
+							break;
+						}
+						SAFE_FREE(rname);
+						rname = smb_xstrdup(tmp_rname);
+						TALLOC_FREE(tmp_rname);
+						if (rname == NULL) {
+							break;
+						}
+					}
 					if (!NT_STATUS_IS_OK(cli_chkpath(cli, rname)) &&
 					    !do_mkdir(rname)) {
 						DEBUG (0, ("Unable to make dir, skipping..."));
@@ -2260,6 +2348,18 @@ static int cmd_mput(void)
 
 			normalize_name(rname);
 
+			{
+				char *tmp_rname = client_clean_name(ctx, rname);
+				if (tmp_rname == NULL) {
+					break;
+				}
+				SAFE_FREE(rname);
+				rname = smb_xstrdup(tmp_rname);
+				TALLOC_FREE(tmp_rname);
+				if (rname == NULL) {
+					break;
+				}
+			}
 			do_put(rname, lname, false);
 		}
 		free_file_list(file_list);
@@ -2430,6 +2530,10 @@ static int cmd_del(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = do_list(mask,attribute,do_del,false,false);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -2546,6 +2650,10 @@ static int cmd_deltree(void)
 	if (mask == NULL) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	deltree_list_head = NULL;
 
@@ -2647,6 +2755,10 @@ static int cmd_wdel(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 				cli, mask, &targetcli, &targetname);
@@ -2688,6 +2800,11 @@ static int cmd_open(void)
 		return 1;
 	}
 
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
+
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, mask, &targetcli, &targetname);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -2803,6 +2920,10 @@ static int cmd_posix_open(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	if (!next_token_talloc(ctx, &cmd_ptr,&buf,NULL)) {
 		d_printf("posix_open <filename> 0<mode>\n");
@@ -2858,6 +2979,10 @@ static int cmd_posix_mkdir(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	if (!next_token_talloc(ctx, &cmd_ptr,&buf,NULL)) {
 		d_printf("posix_mkdir <filename> 0<mode>\n");
@@ -2902,6 +3027,10 @@ static int cmd_posix_unlink(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 				cli, mask, &targetcli, &targetname);
@@ -2941,6 +3070,10 @@ static int cmd_posix_rmdir(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, mask, &targetcli, &targetname);
@@ -3243,6 +3376,10 @@ static int cmd_rmdir(void)
 	if (!mask) {
 		return 1;
 	}
+	mask = client_clean_name(ctx, mask);
+	if (mask == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, mask, &targetcli, &targetname);
@@ -3287,6 +3424,10 @@ static int cmd_link(void)
 	if (!oldname) {
 		return 1;
 	}
+	oldname = client_clean_name(ctx, oldname);
+	if (oldname == NULL) {
+		return 1;
+	}
 	newname = talloc_asprintf(ctx,
 			"%s%s",
 			client_get_cur_dir(),
@@ -3294,6 +3435,10 @@ static int cmd_link(void)
 	if (!newname) {
 		return 1;
 	}
+	newname = client_clean_name(ctx, newname);
+	if (newname == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, oldname, &targetcli, &targetname);
@@ -3341,6 +3486,10 @@ static int cmd_readlink(void)
 	if (!name) {
 		return 1;
 	}
+	name = client_clean_name(ctx, name);
+	if (name == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, name, &targetcli, &targetname);
@@ -3395,6 +3544,10 @@ static int cmd_symlink(void)
 		if (!newname) {
 			return 1;
 		}
+		newname = client_clean_name(ctx, newname);
+		if (newname == NULL) {
+			return 1;
+		}
 		/* New name must be present in share namespace. */
 		status = cli_resolve_path(ctx, "",
 				popt_get_cmdline_auth_info(), cli, newname,
@@ -3446,6 +3599,10 @@ static int cmd_chmod(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	mode = (mode_t)strtol(buf, NULL, 8);
 
@@ -3605,6 +3762,10 @@ static int cmd_getfacl(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetname);
@@ -3773,6 +3934,10 @@ static int cmd_geteas(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetname);
@@ -3830,6 +3995,10 @@ static int cmd_setea(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetname);
@@ -3876,6 +4045,10 @@ static int cmd_stat(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetname);
@@ -3985,6 +4158,10 @@ static int cmd_chown(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetname);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -4035,6 +4212,10 @@ static int cmd_rename(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	dest = talloc_asprintf(ctx,
 			"%s%s",
@@ -4043,6 +4224,10 @@ static int cmd_rename(void)
 	if (!dest) {
 		return 1;
 	}
+	dest = client_clean_name(ctx, dest);
+	if (dest == NULL) {
+		return 1;
+	}
 
 	if (next_token_talloc(ctx, &cmd_ptr, &buf, NULL) &&
 	    strcsequal(buf, "-f")) {
@@ -4128,6 +4313,10 @@ static int cmd_scopy(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	dest = talloc_asprintf(ctx,
 			"%s%s",
@@ -4136,6 +4325,10 @@ static int cmd_scopy(void)
 	if (!dest) {
 		return 1;
 	}
+	dest = client_clean_name(ctx, dest);
+	if (dest == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 			cli, src, &targetcli, &targetsrc);
@@ -4258,6 +4451,10 @@ static int cmd_hardlink(void)
 	if (!src) {
 		return 1;
 	}
+	src = client_clean_name(ctx, src);
+	if (src == NULL) {
+		return 1;
+	}
 
 	dest = talloc_asprintf(ctx,
 			"%s%s",
@@ -4266,6 +4463,10 @@ static int cmd_hardlink(void)
 	if (!dest) {
 		return 1;
 	}
+	dest = client_clean_name(ctx, dest);
+	if (dest == NULL) {
+		return 1;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 				cli, src, &targetcli, &targetname);
@@ -4345,6 +4546,10 @@ static int cmd_notify(void)
 	if (name == NULL) {
 		goto fail;
 	}
+	name = client_clean_name(talloc_tos(), name);
+	if (name == NULL) {
+		return 1;
+	}
 	status = cli_ntcreate(
 		cli, name, 0, FILE_READ_DATA, 0,
 		FILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE,
@@ -4519,7 +4724,7 @@ static int cmd_reget(void)
 	if (!remote_name) {
 		return 1;
 	}
-	remote_name = clean_name(ctx,remote_name);
+	remote_name = client_clean_name(ctx,remote_name);
 	if (!remote_name) {
 		return 1;
 	}
@@ -4571,7 +4776,7 @@ static int cmd_reput(void)
 		return 1;
 	}
 
-	remote_name = clean_name(ctx, remote_name);
+	remote_name = client_clean_name(ctx, remote_name);
 	if (!remote_name) {
 		return 1;
 	}
@@ -5010,6 +5215,11 @@ int cmd_setmode(void)
 		err = 1;
 		goto out;
 	}
+	fname = client_clean_name(ctx, fname);
+	if (fname == NULL) {
+		err = 1;
+		goto out;
+	}
 
 	while (next_token_talloc(ctx, &cmd_ptr, &buf, NULL)) {
 		const char *s = buf;
@@ -5518,6 +5728,10 @@ static char **remote_completion(const ch
 	if (!dirmask) {
 		goto cleanup;
 	}
+	dirmask = client_clean_name(ctx, dirmask);
+	if (dirmask == NULL) {
+		goto cleanup;
+	}
 
 	status = cli_resolve_path(ctx, "", popt_get_cmdline_auth_info(),
 				cli, dirmask, &targetcli, &targetpath);
diff -Npur samba-4.7.0/source3/client/client_proto.h samba-4.7.1/source3/client/client_proto.h
--- samba-4.7.0/source3/client/client_proto.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/client/client_proto.h	2017-11-02 12:38:36.000000000 +0100
@@ -35,6 +35,7 @@ enum {
 
 const char *client_get_cur_dir(void);
 const char *client_set_cur_dir(const char *newdir);
+char *client_clean_name(TALLOC_CTX *ctx, const char *name);
 NTSTATUS do_list(const char *mask,
 			uint16_t attribute,
 			NTSTATUS (*fn)(struct cli_state *cli_state, struct file_info *,
diff -Npur samba-4.7.0/source3/client/clitar.c samba-4.7.1/source3/client/clitar.c
--- samba-4.7.0/source3/client/clitar.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/client/clitar.c	2017-11-02 12:38:36.000000000 +0100
@@ -699,6 +699,11 @@ static int tar_create(struct tar* t)
 			err = 1;
 			goto out_close;
 		}
+		mask = client_clean_name(ctx, mask);
+		if (mask == NULL) {
+			err = 1;
+			goto out_close;
+		}
 		DBG(5, ("tar_process do_list with mask: %s\n", mask));
 		status = do_list(mask, TAR_DO_LIST_ATTR, get_file_callback, false, true);
 		if (!NT_STATUS_IS_OK(status)) {
@@ -764,6 +769,11 @@ static int tar_create_from_list(struct t
 			err = 1;
 			goto out;
 		}
+		mask = client_clean_name(ctx, mask);
+		if (mask == NULL) {
+			err = 1;
+			goto out;
+		}
 
 		DBG(5, ("incl. path='%s', base='%s', mask='%s'\n",
 					path, base ? base : "NULL", mask));
@@ -775,6 +785,12 @@ static int tar_create_from_list(struct t
 				err = 1;
 				goto out;
 			}
+			base = client_clean_name(ctx, base);
+			if (base == NULL) {
+				err = 1;
+				goto out;
+			}
+
 			DBG(5, ("cd '%s' before do_list\n", base));
 			client_set_cur_dir(base);
 		}
@@ -820,6 +836,11 @@ static NTSTATUS get_file_callback(struct
 		status = NT_STATUS_NO_MEMORY;
 		goto out;
 	}
+	remote_name = client_clean_name(ctx, remote_name);
+	if (remote_name == NULL) {
+		status = NT_STATUS_NO_MEMORY;
+		goto out;
+	}
 
 	if (strequal(finfo->name, "..") || strequal(finfo->name, ".")) {
 		goto out;
@@ -853,6 +874,11 @@ static NTSTATUS get_file_callback(struct
 			status = NT_STATUS_NO_MEMORY;
 			goto out;
 		}
+		mask = client_clean_name(ctx, mask);
+		if (mask == NULL) {
+			status = NT_STATUS_NO_MEMORY;
+			goto out;
+		}
 
 		rc = tar_get_file(&tar_ctx, remote_name, finfo);
 		if (rc != 0) {
@@ -1111,6 +1137,11 @@ static int tar_send_file(struct tar *t,
 	if (full_path == NULL) {
 		err = 1;
 		goto out;
+	}
+	full_path = client_clean_name(ctx, full_path);
+	if (full_path == NULL) {
+		err = 1;
+		goto out;
 	}
 
 	if (mode != AE_IFREG && mode != AE_IFDIR) {
diff -Npur samba-4.7.0/source3/include/ctdbd_conn.h samba-4.7.1/source3/include/ctdbd_conn.h
--- samba-4.7.0/source3/include/ctdbd_conn.h	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/include/ctdbd_conn.h	2017-11-02 12:38:36.000000000 +0100
@@ -49,7 +49,7 @@ int ctdbd_messaging_send_iov(struct ctdb
 			     const struct iovec *iov, int iovlen);
 
 bool ctdbd_process_exists(struct ctdbd_connection *conn, uint32_t vnn,
-			  pid_t pid);
+			  pid_t pid, uint64_t unique_id);
 
 char *ctdbd_dbpath(struct ctdbd_connection *conn,
 		   TALLOC_CTX *mem_ctx, uint32_t db_id);
diff -Npur samba-4.7.0/source3/include/messages.h samba-4.7.1/source3/include/messages.h
--- samba-4.7.0/source3/include/messages.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/include/messages.h	2017-11-02 12:38:36.000000000 +0100
@@ -133,18 +133,15 @@ struct tevent_req *messaging_read_send(T
 int messaging_read_recv(struct tevent_req *req, TALLOC_CTX *mem_ctx,
 			struct messaging_rec **presult);
 
-struct tevent_req *messaging_handler_send(
-	TALLOC_CTX *mem_ctx, struct tevent_context *ev,
-	struct messaging_context *msg_ctx, uint32_t msg_type,
-	bool (*handler)(struct messaging_context *msg_ctx,
-			struct messaging_rec **rec, void *private_data),
-	void *private_data);
-int messaging_handler_recv(struct tevent_req *req);
-
 int messaging_cleanup(struct messaging_context *msg_ctx, pid_t pid);
 
 bool messaging_parent_dgm_cleanup_init(struct messaging_context *msg);
 
+struct messaging_rec *messaging_rec_create(
+	TALLOC_CTX *mem_ctx, struct server_id src, struct server_id dst,
+	uint32_t msg_type, const struct iovec *iov, int iovlen,
+	const int *fds, size_t num_fds);
+
 #include "librpc/gen_ndr/ndr_messaging.h"
 
 #endif
diff -Npur samba-4.7.0/source3/lib/ctdb_dummy.c samba-4.7.1/source3/lib/ctdb_dummy.c
--- samba-4.7.0/source3/lib/ctdb_dummy.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/lib/ctdb_dummy.c	2017-11-02 12:38:36.000000000 +0100
@@ -59,7 +59,8 @@ int ctdbd_register_ips(struct ctdbd_conn
 	return ENOSYS;
 }
 
-bool ctdbd_process_exists(struct ctdbd_connection *conn, uint32_t vnn, pid_t pid)
+bool ctdbd_process_exists(struct ctdbd_connection *conn, uint32_t vnn,
+			  pid_t pid, uint64_t unique_id)
 {
 	return false;
 }
diff -Npur samba-4.7.0/source3/lib/ctdbd_conn.c samba-4.7.1/source3/lib/ctdbd_conn.c
--- samba-4.7.0/source3/lib/ctdbd_conn.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/lib/ctdbd_conn.c	2017-11-02 12:38:36.000000000 +0100
@@ -775,14 +775,30 @@ static int ctdbd_control(struct ctdbd_co
 /*
  * see if a remote process exists
  */
-bool ctdbd_process_exists(struct ctdbd_connection *conn, uint32_t vnn, pid_t pid)
+bool ctdbd_process_exists(struct ctdbd_connection *conn, uint32_t vnn,
+			  pid_t pid, uint64_t unique_id)
 {
+	uint8_t buf[sizeof(pid)+sizeof(unique_id)];
 	int32_t cstatus = 0;
 	int ret;
 
-	ret = ctdbd_control(conn, vnn, CTDB_CONTROL_PROCESS_EXISTS, 0, 0,
-			    (TDB_DATA) { .dptr = (uint8_t *)&pid,
-					 .dsize = sizeof(pid) },
+	if (unique_id == SERVERID_UNIQUE_ID_NOT_TO_VERIFY) {
+		ret = ctdbd_control(conn, vnn, CTDB_CONTROL_PROCESS_EXISTS,
+				    0, 0,
+				    (TDB_DATA) { .dptr = (uint8_t *)&pid,
+						    .dsize = sizeof(pid) },
+				    NULL, NULL, &cstatus);
+		if (ret != 0) {
+			return false;
+		}
+		return (cstatus == 0);
+	}
+
+	memcpy(buf, &pid, sizeof(pid));
+	memcpy(buf+sizeof(pid), &unique_id, sizeof(unique_id));
+
+	ret = ctdbd_control(conn, vnn, CTDB_CONTROL_CHECK_PID_SRVID, 0, 0,
+			    (TDB_DATA) { .dptr = buf, .dsize = sizeof(buf) },
 			    NULL, NULL, &cstatus);
 	if (ret != 0) {
 		return false;
diff -Npur samba-4.7.0/source3/lib/messages.c samba-4.7.1/source3/lib/messages.c
--- samba-4.7.0/source3/lib/messages.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/lib/messages.c	2017-11-02 12:38:36.000000000 +0100
@@ -110,7 +110,7 @@ static void ping_message(struct messagin
 	messaging_send(msg_ctx, src, MSG_PONG, data);
 }
 
-static struct messaging_rec *messaging_rec_create(
+struct messaging_rec *messaging_rec_create(
 	TALLOC_CTX *mem_ctx, struct server_id src, struct server_id dst,
 	uint32_t msg_type, const struct iovec *iov, int iovlen,
 	const int *fds, size_t num_fds)
@@ -906,87 +906,6 @@ int messaging_read_recv(struct tevent_re
 	return 0;
 }
 
-struct messaging_handler_state {
-	struct tevent_context *ev;
-	struct messaging_context *msg_ctx;
-	uint32_t msg_type;
-	bool (*handler)(struct messaging_context *msg_ctx,
-			struct messaging_rec **rec, void *private_data);
-	void *private_data;
-};
-
-static void messaging_handler_got_msg(struct tevent_req *subreq);
-
-struct tevent_req *messaging_handler_send(
-	TALLOC_CTX *mem_ctx, struct tevent_context *ev,
-	struct messaging_context *msg_ctx, uint32_t msg_type,
-	bool (*handler)(struct messaging_context *msg_ctx,
-			struct messaging_rec **rec, void *private_data),
-	void *private_data)
-{
-	struct tevent_req *req, *subreq;
-	struct messaging_handler_state *state;
-
-	req = tevent_req_create(mem_ctx, &state,
-				struct messaging_handler_state);
-	if (req == NULL) {
-		return NULL;
-	}
-	state->ev = ev;
-	state->msg_ctx = msg_ctx;
-	state->msg_type = msg_type;
-	state->handler = handler;
-	state->private_data = private_data;
-
-	subreq = messaging_read_send(state, state->ev, state->msg_ctx,
-				     state->msg_type);
-	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
-	}
-	tevent_req_set_callback(subreq, messaging_handler_got_msg, req);
-	return req;
-}
-
-static void messaging_handler_got_msg(struct tevent_req *subreq)
-{
-	struct tevent_req *req = tevent_req_callback_data(
-		subreq, struct tevent_req);
-	struct messaging_handler_state *state = tevent_req_data(
-		req, struct messaging_handler_state);
-	struct messaging_rec *rec;
-	int ret;
-	bool ok;
-
-	ret = messaging_read_recv(subreq, state, &rec);
-	TALLOC_FREE(subreq);
-	if (tevent_req_error(req, ret)) {
-		return;
-	}
-
-	subreq = messaging_read_send(state, state->ev, state->msg_ctx,
-				     state->msg_type);
-	if (tevent_req_nomem(subreq, req)) {
-		return;
-	}
-	tevent_req_set_callback(subreq, messaging_handler_got_msg, req);
-
-	ok = state->handler(state->msg_ctx, &rec, state->private_data);
-	TALLOC_FREE(rec);
-	if (ok) {
-		/*
-		 * Next round
-		 */
-		return;
-	}
-	TALLOC_FREE(subreq);
-	tevent_req_done(req);
-}
-
-int messaging_handler_recv(struct tevent_req *req)
-{
-	return tevent_req_simple_recv_unix(req);
-}
-
 static bool messaging_append_new_waiters(struct messaging_context *msg_ctx)
 {
 	if (msg_ctx->num_new_waiters == 0) {
diff -Npur samba-4.7.0/source3/lib/serverid.c samba-4.7.1/source3/lib/serverid.c
--- samba-4.7.0/source3/lib/serverid.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/lib/serverid.c	2017-11-02 12:38:36.000000000 +0100
@@ -199,7 +199,7 @@ bool serverid_exists(const struct server
 
 	if (lp_clustering()) {
 		return ctdbd_process_exists(messaging_ctdbd_connection(),
-					    id->vnn, id->pid);
+					    id->vnn, id->pid, id->unique_id);
 	}
 
 	return false;
diff -Npur samba-4.7.0/source3/lib/system.c samba-4.7.1/source3/lib/system.c
--- samba-4.7.0/source3/lib/system.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/lib/system.c	2017-11-02 12:38:36.000000000 +0100
@@ -594,7 +594,9 @@ char *sys_getwd(void)
 			break;
 		}
 		if (errno != ERANGE) {
+			int saved_errno = errno;
 			SAFE_FREE(s);
+			errno = saved_errno;
 			break;
 		}
 		allocated *= 2;
@@ -605,11 +607,18 @@ char *sys_getwd(void)
 	}
 	return wd;
 #else
+	char *wd = NULL;
 	char *s = SMB_MALLOC_ARRAY(char, PATH_MAX);
 	if (s == NULL) {
 		return NULL;
 	}
-	return getwd(s);
+	wd = getwd(s);
+	if (wd == NULL) {
+		int saved_errno = errno;
+		SAFE_FREE(s);
+		errno = saved_errno;
+	}
+	return wd;
 #endif
 }
 
diff -Npur samba-4.7.0/source3/modules/nfs4_acls.c samba-4.7.1/source3/modules/nfs4_acls.c
--- samba-4.7.0/source3/modules/nfs4_acls.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/nfs4_acls.c	2017-11-02 12:38:36.000000000 +0100
@@ -352,10 +352,6 @@ static bool smbacl4_nfs42win(TALLOC_CTX
 		DEBUG(10, ("mapped %d to %s\n", ace->who.id,
 			   sid_string_dbg(&sid)));
 
-		if (is_directory && (ace->aceMask & SMB_ACE4_ADD_FILE)) {
-			ace->aceMask |= SMB_ACE4_DELETE_CHILD;
-		}
-
 		if (!is_directory && params->map_full_control) {
 			/*
 			 * Do we have all access except DELETE_CHILD
@@ -386,13 +382,6 @@ static bool smbacl4_nfs42win(TALLOC_CTX
 		      ace->aceFlags, win_ace_flags));
 
 		mask = ace->aceMask;
-		/* Windows clients expect SYNC on acls to
-		   correctly allow rename. See bug #7909. */
-		/* But not on DENY ace entries. See
-		   bug #8442. */
-		if(ace->aceType == SMB_ACE4_ACCESS_ALLOWED_ACE_TYPE) {
-			mask = ace->aceMask | SMB_ACE4_SYNCHRONIZE;
-		}
 
 		/* Mapping of owner@ and group@ to creator owner and
 		   creator group. Keep old behavior in mode special. */
diff -Npur samba-4.7.0/source3/modules/posixacl_xattr.c samba-4.7.1/source3/modules/posixacl_xattr.c
--- samba-4.7.0/source3/modules/posixacl_xattr.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/posixacl_xattr.c	2017-11-02 12:38:36.000000000 +0100
@@ -384,7 +384,7 @@ SMB_ACL_T posixacl_xattr_acl_get_file(vf
 		TALLOC_CTX *frame = talloc_stackframe();
 		struct smb_filename *smb_fname_tmp =
 			cp_smb_filename_nostream(frame, smb_fname);
-		if (smb_fname == NULL) {
+		if (smb_fname_tmp == NULL) {
 			errno = ENOMEM;
 			ret = -1;
 		} else {
diff -Npur samba-4.7.0/source3/modules/string_replace.c samba-4.7.1/source3/modules/string_replace.c
--- samba-4.7.0/source3/modules/string_replace.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/source3/modules/string_replace.c	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,178 @@
+/*
+ * Unix SMB/CIFS implementation.
+ *
+ * Copyright (C) Volker Lendecke, 2005
+ * Copyright (C) Aravind Srinivasan, 2009
+ * Copyright (C) Guenter Kukkukk, 2013
+ * Copyright (C) Ralph Boehme, 2017
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, see <http://www.gnu.org/licenses/>.
+ */
+
+#include "includes.h"
+#include "smbd/smbd.h"
+#include "string_replace.h"
+
+#define MAP_SIZE        0xFF
+#define MAP_NUM         0x101 /* max unicode charval / MAP_SIZE */
+#define T_OFFSET(_v_)   ((_v_ % MAP_SIZE))
+#define T_START(_v_)    (((_v_ / MAP_SIZE) * MAP_SIZE))
+#define T_PICK(_v_)     ((_v_ / MAP_SIZE))
+
+struct char_mappings {
+	smb_ucs2_t entry[MAP_SIZE][2];
+};
+
+static bool build_table(struct char_mappings **cmaps, int value)
+{
+	int i;
+	int start = T_START(value);
+
+	(*cmaps) = talloc_zero(NULL, struct char_mappings);
+
+	if (!*cmaps)
+		return False;
+
+	for (i = 0; i < MAP_SIZE;i++) {
+		(*cmaps)->entry[i][vfs_translate_to_unix] = start + i;
+		(*cmaps)->entry[i][vfs_translate_to_windows] = start + i;
+	}
+
+	return True;
+}
+
+static void set_tables(struct char_mappings **cmaps,
+		       long unix_map,
+		       long windows_map)
+{
+	int i;
+
+	/* set unix -> windows */
+	i = T_OFFSET(unix_map);
+	cmaps[T_PICK(unix_map)]->entry[i][vfs_translate_to_windows] = windows_map;
+
+	/* set windows -> unix */
+	i = T_OFFSET(windows_map);
+	cmaps[T_PICK(windows_map)]->entry[i][vfs_translate_to_unix] = unix_map;
+}
+
+static bool build_ranges(struct char_mappings **cmaps,
+			 long unix_map,
+			 long windows_map)
+{
+
+	if (!cmaps[T_PICK(unix_map)]) {
+		if (!build_table(&cmaps[T_PICK(unix_map)], unix_map))
+			return False;
+	}
+
+	if (!cmaps[T_PICK(windows_map)]) {
+		if (!build_table(&cmaps[T_PICK(windows_map)], windows_map))
+			return False;
+	}
+
+	set_tables(cmaps, unix_map, windows_map);
+
+	return True;
+}
+
+struct char_mappings **string_replace_init_map(const char **mappings)
+{
+	int i;
+	char *tmp;
+	fstring mapping;
+	long unix_map, windows_map;
+	struct char_mappings **cmaps = NULL;
+
+	if (mappings == NULL) {
+		return NULL;
+	}
+
+	cmaps = TALLOC_ZERO(NULL, MAP_NUM * sizeof(struct char_mappings *));
+	if (cmaps == NULL) {
+		return NULL;
+	}
+
+	/*
+	 * catia mappings are of the form :
+	 * UNIX char (in 0xnn hex) : WINDOWS char (in 0xnn hex)
+	 *
+	 * multiple mappings are comma separated in smb.conf
+	 */
+
+	for (i = 0; mappings[i]; i++) {
+		fstrcpy(mapping, mappings[i]);
+		unix_map = strtol(mapping, &tmp, 16);
+		if (unix_map == 0 && errno == EINVAL) {
+			DEBUG(0, ("INVALID CATIA MAPPINGS - %s\n", mapping));
+			continue;
+		}
+		windows_map = strtol(++tmp, NULL, 16);
+		if (windows_map == 0 && errno == EINVAL) {
+			DEBUG(0, ("INVALID CATIA MAPPINGS - %s\n", mapping));
+			continue;
+		}
+
+		if (!build_ranges(cmaps, unix_map, windows_map)) {
+			DEBUG(0, ("TABLE ERROR - CATIA MAPPINGS - %s\n", mapping));
+			continue;
+		}
+	}
+
+	return cmaps;
+}
+
+NTSTATUS string_replace_allocate(connection_struct *conn,
+				 const char *name_in,
+				 struct char_mappings **cmaps,
+				 TALLOC_CTX *mem_ctx,
+				 char **mapped_name,
+				 enum vfs_translate_direction direction)
+{
+	static smb_ucs2_t *tmpbuf = NULL;
+	smb_ucs2_t *ptr = NULL;
+	struct char_mappings *map = NULL;
+	size_t converted_size;
+	bool ok;
+
+	ok = push_ucs2_talloc(talloc_tos(), &tmpbuf, name_in,
+			      &converted_size);
+	if (!ok) {
+		return map_nt_error_from_unix(errno);
+	}
+
+	for (ptr = tmpbuf; *ptr; ptr++) {
+		if (*ptr == 0) {
+			break;
+		}
+		if (cmaps == NULL) {
+			continue;
+		}
+		map = cmaps[T_PICK((*ptr))];
+		if (map == NULL) {
+			/* nothing to do */
+			continue;
+		}
+
+		*ptr = map->entry[T_OFFSET((*ptr))][direction];
+	}
+
+	ok = pull_ucs2_talloc(mem_ctx, mapped_name, tmpbuf,
+			      &converted_size);
+	TALLOC_FREE(tmpbuf);
+	if (!ok) {
+		return map_nt_error_from_unix(errno);
+	}
+	return NT_STATUS_OK;
+}
diff -Npur samba-4.7.0/source3/modules/string_replace.h samba-4.7.1/source3/modules/string_replace.h
--- samba-4.7.0/source3/modules/string_replace.h	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/source3/modules/string_replace.h	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,32 @@
+/*
+ * Unix SMB/CIFS implementation.
+ *
+ * Copyright (C) Volker Lendecke, 2005
+ * Copyright (C) Aravind Srinivasan, 2009
+ * Copyright (C) Guenter Kukkukk, 2013
+ * Copyright (C) Ralph Boehme, 2017
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, see <http://www.gnu.org/licenses/>.
+ */
+
+struct char_mappings;
+
+struct char_mappings **string_replace_init_map(const char **mappings);
+
+NTSTATUS string_replace_allocate(connection_struct *conn,
+				 const char *name_in,
+				 struct char_mappings **cmaps,
+				 TALLOC_CTX *mem_ctx,
+				 char **mapped_name,
+				 enum vfs_translate_direction direction);
diff -Npur samba-4.7.0/source3/modules/vfs_acl_common.c samba-4.7.1/source3/modules/vfs_acl_common.c
--- samba-4.7.0/source3/modules/vfs_acl_common.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_acl_common.c	2017-11-02 12:38:36.000000000 +0100
@@ -1056,8 +1056,10 @@ static NTSTATUS set_underlying_acl(vfs_h
 				   uint32_t security_info_sent,
 				   bool chown_needed)
 {
-	NTSTATUS status =
-	    SMB_VFS_NEXT_FSET_NT_ACL(handle, fsp, security_info_sent, psd);
+	NTSTATUS status;
+	const struct security_token *token = NULL;
+
+	status = SMB_VFS_NEXT_FSET_NT_ACL(handle, fsp, security_info_sent, psd);
 	if (!NT_STATUS_EQUAL(status, NT_STATUS_ACCESS_DENIED)) {
 		return status;
 	}
@@ -1070,6 +1072,18 @@ static NTSTATUS set_underlying_acl(vfs_h
 		return NT_STATUS_ACCESS_DENIED;
 	}
 
+	/*
+	 * Only allow take-ownership, not give-ownership. That's the way Windows
+	 * implements SEC_STD_WRITE_OWNER. MS-FSA 2.1.5.16 just states: If
+	 * InputBuffer.OwnerSid is not a valid owner SID for a file in the
+	 * objectstore, as determined in an implementation specific manner, the
+	 * object store MUST return STATUS_INVALID_OWNER.
+	 */
+	token = get_current_nttok(fsp->conn);
+	if (!security_token_is_sid(token, psd->owner_sid)) {
+		return NT_STATUS_INVALID_OWNER;
+	}
+
 	DBG_DEBUG("overriding chown on file %s for sid %s\n",
 		   fsp_str_dbg(fsp), sid_string_tos(psd->owner_sid));
 
diff -Npur samba-4.7.0/source3/modules/vfs_catia.c samba-4.7.1/source3/modules/vfs_catia.c
--- samba-4.7.0/source3/modules/vfs_catia.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_catia.c	2017-11-02 12:38:36.000000000 +0100
@@ -31,23 +31,13 @@
 #include "smbd/smbd.h"
 #include "lib/util/tevent_unix.h"
 #include "lib/util/tevent_ntstatus.h"
+#include "string_replace.h"
 
 static int vfs_catia_debug_level = DBGC_VFS;
 
 #undef DBGC_CLASS
 #define DBGC_CLASS vfs_catia_debug_level
 
-#define GLOBAL_SNUM     0xFFFFFFF
-#define MAP_SIZE        0xFF
-#define MAP_NUM         0x101 /* max unicode charval / MAP_SIZE */
-#define T_OFFSET(_v_)   ((_v_ % MAP_SIZE))
-#define T_START(_v_)    (((_v_ / MAP_SIZE) * MAP_SIZE))
-#define T_PICK(_v_)     ((_v_ / MAP_SIZE))
-
-struct char_mappings {
-	smb_ucs2_t entry[MAP_SIZE][2];
-};
-
 struct share_mapping_entry {
 	int snum;
 	struct share_mapping_entry *next;
@@ -65,66 +55,13 @@ struct catia_cache {
 
 struct share_mapping_entry *srt_head = NULL;
 
-static bool build_table(struct char_mappings **cmaps, int value)
-{
-	int i;
-	int start = T_START(value);
-
-	(*cmaps) = talloc_zero(NULL, struct char_mappings);
-
-	if (!*cmaps)
-		return False;
-
-	for (i = 0; i < MAP_SIZE;i++) {
-		(*cmaps)->entry[i][vfs_translate_to_unix] = start + i;
-		(*cmaps)->entry[i][vfs_translate_to_windows] = start + i;
-	}
-
-	return True;
-}
-
-static void set_tables(struct char_mappings **cmaps,
-		       long unix_map,
-		       long windows_map)
-{
-	int i;
-
-	/* set unix -> windows */
-	i = T_OFFSET(unix_map);
-	cmaps[T_PICK(unix_map)]->entry[i][vfs_translate_to_windows] = windows_map;
-
-	/* set windows -> unix */
-	i = T_OFFSET(windows_map);
-	cmaps[T_PICK(windows_map)]->entry[i][vfs_translate_to_unix] = unix_map;
-}
-
-static bool build_ranges(struct char_mappings **cmaps,
-			 long unix_map,
-			 long windows_map)
-{
-
-	if (!cmaps[T_PICK(unix_map)]) {
-		if (!build_table(&cmaps[T_PICK(unix_map)], unix_map))
-			return False;
-	}
-
-	if (!cmaps[T_PICK(windows_map)]) {
-		if (!build_table(&cmaps[T_PICK(windows_map)], windows_map))
-			return False;
-	}
-
-	set_tables(cmaps, unix_map, windows_map);
-
-	return True;
-}
-
 static struct share_mapping_entry *get_srt(connection_struct *conn,
 					   struct share_mapping_entry **global)
 {
 	struct share_mapping_entry *share;
 
 	for (share = srt_head; share != NULL; share = share->next) {
-		if (share->snum == GLOBAL_SNUM)
+		if (share->snum == GLOBAL_SECTION_SNUM)
 			(*global) = share;
 
 		if (share->snum == SNUM(conn))
@@ -136,61 +73,24 @@ static struct share_mapping_entry *get_s
 
 static struct share_mapping_entry *add_srt(int snum, const char **mappings)
 {
+	struct share_mapping_entry *sme = NULL;
 
-	char *tmp;
-	fstring mapping;
-	int i;
-	long unix_map, windows_map;
-	struct share_mapping_entry *ret = NULL;
-
-	ret = (struct share_mapping_entry *)
-		TALLOC_ZERO(NULL, sizeof(struct share_mapping_entry) +
-		(mappings ? (MAP_NUM * sizeof(struct char_mappings *)) : 0));
-
-	if (!ret)
-		return ret;
-
-	ret->snum = snum;
+	sme = TALLOC_ZERO(NULL, sizeof(struct share_mapping_entry));
+	if (sme == NULL)
+		return sme;
 
-	ret->next = srt_head;
-	srt_head = ret;
+	sme->snum = snum;
+	sme->next = srt_head;
+	srt_head = sme;
 
-	if (mappings) {
-		ret->mappings = (struct char_mappings**) ((unsigned char*) ret +
-		    sizeof(struct share_mapping_entry));
-		memset(ret->mappings, 0,
-		    MAP_NUM * sizeof(struct char_mappings *));
-	} else {
-		ret->mappings = NULL;
-		return ret;
+	if (mappings == NULL) {
+		sme->mappings = NULL;
+		return sme;
 	}
 
-	/*
-	 * catia mappings are of the form :
-	 * UNIX char (in 0xnn hex) : WINDOWS char (in 0xnn hex)
-	 *
-	 * multiple mappings are comma separated in smb.conf
-	 */
-	for (i=0;mappings[i];i++) {
-		fstrcpy(mapping, mappings[i]);
-		unix_map = strtol(mapping, &tmp, 16);
-		if (unix_map == 0 && errno == EINVAL) {
-			DEBUG(0, ("INVALID CATIA MAPPINGS - %s\n", mapping));
-			continue;
-		}
-		windows_map = strtol(++tmp, NULL, 16);
-		if (windows_map == 0 && errno == EINVAL) {
-			DEBUG(0, ("INVALID CATIA MAPPINGS - %s\n", mapping));
-			continue;
-		}
+	sme->mappings = string_replace_init_map(mappings);
 
-		if (!build_ranges(ret->mappings, unix_map, windows_map)) {
-			DEBUG(0, ("TABLE ERROR - CATIA MAPPINGS - %s\n", mapping));
-			continue;
-		}
-	}
-
-	return ret;
+	return sme;
 }
 
 static bool init_mappings(connection_struct *conn,
@@ -211,7 +111,7 @@ static bool init_mappings(connection_str
 	if (!global) {
 		/* global setting */
 		mappings = lp_parm_string_list(-1, "catia", "mappings", NULL);
-		global = add_srt(GLOBAL_SNUM, mappings);
+		global = add_srt(GLOBAL_SECTION_SNUM, mappings);
 	}
 
 	/* no global setting - what about share level ? */
@@ -236,16 +136,12 @@ static NTSTATUS catia_string_replace_all
 					      char **mapped_name,
 					enum vfs_translate_direction direction)
 {
-	static smb_ucs2_t *tmpbuf = NULL;
-	smb_ucs2_t *ptr;
 	struct share_mapping_entry *selected;
-	struct char_mappings *map = NULL;
-	size_t converted_size;
-	TALLOC_CTX *ctx = talloc_tos();
+	NTSTATUS status;
 
 	if (!init_mappings(conn, &selected)) {
 		/* No mappings found. Just use the old name */
-		*mapped_name = talloc_strdup(NULL, name_in);
+		*mapped_name = talloc_strdup(talloc_tos(), name_in);
 		if (!*mapped_name) {
 			errno = ENOMEM;
 			return NT_STATUS_NO_MEMORY;
@@ -253,30 +149,13 @@ static NTSTATUS catia_string_replace_all
 		return NT_STATUS_OK;
 	}
 
-	if ((push_ucs2_talloc(ctx, &tmpbuf, name_in,
-			      &converted_size)) == false) {
-		return map_nt_error_from_unix(errno);
-	}
-	ptr = tmpbuf;
-	for(;*ptr;ptr++) {
-		if (*ptr == 0)
-			break;
-		map = selected->mappings[T_PICK((*ptr))];
-
-		/* nothing to do */
-		if (!map)
-			continue;
-
-		*ptr = map->entry[T_OFFSET((*ptr))][direction];
-	}
-
-	if ((pull_ucs2_talloc(ctx, mapped_name, tmpbuf,
-			      &converted_size)) == false) {
-		TALLOC_FREE(tmpbuf);
-		return map_nt_error_from_unix(errno);
-	}
-	TALLOC_FREE(tmpbuf);
-	return NT_STATUS_OK;
+	status = string_replace_allocate(conn,
+					 name_in,
+					 selected->mappings,
+					 talloc_tos(),
+					 mapped_name,
+					 direction);
+	return status;
 }
 
 static DIR *catia_opendir(vfs_handle_struct *handle,
@@ -2527,6 +2406,7 @@ static NTSTATUS catia_readdir_attr(struc
 	status = SMB_VFS_NEXT_READDIR_ATTR(handle, smb_fname, mem_ctx, pattr_data);
 
 	TALLOC_FREE(smb_fname);
+	TALLOC_FREE(fname);
 	return status;
 }
 
diff -Npur samba-4.7.0/source3/modules/vfs_default.c samba-4.7.1/source3/modules/vfs_default.c
--- samba-4.7.0/source3/modules/vfs_default.c	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_default.c	2017-11-02 12:38:36.000000000 +0100
@@ -2226,6 +2226,10 @@ static struct smb_filename *vfswrap_getw
 	START_PROFILE(syscall_getwd);
 	result = sys_getwd();
 	END_PROFILE(syscall_getwd);
+
+	if (result == NULL) {
+		return NULL;
+	}
 	smb_fname = synthetic_smb_fname(ctx,
 				result,
 				NULL,
diff -Npur samba-4.7.0/source3/modules/vfs_fake_acls.c samba-4.7.1/source3/modules/vfs_fake_acls.c
--- samba-4.7.0/source3/modules/vfs_fake_acls.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_fake_acls.c	2017-11-02 12:38:36.000000000 +0100
@@ -413,6 +413,12 @@ static int fake_acls_chown(vfs_handle_st
 	int ret;
 	uint8_t id_buf[4];
 	if (uid != -1) {
+		uid_t current_uid = get_current_uid(handle->conn);
+
+		if (current_uid != 0 && current_uid != uid) {
+			return EACCES;
+		}
+
 		SIVAL(id_buf, 0, uid);
 		ret = SMB_VFS_NEXT_SETXATTR(handle,
 				smb_fname,
@@ -447,6 +453,12 @@ static int fake_acls_lchown(vfs_handle_s
 	int ret;
 	uint8_t id_buf[4];
 	if (uid != -1) {
+		uid_t current_uid = get_current_uid(handle->conn);
+
+		if (current_uid != 0 && current_uid != uid) {
+			return EACCES;
+		}
+
 		/* This isn't quite right (calling setxattr not
 		 * lsetxattr), but for the test purposes of this
 		 * module (fake NT ACLs from windows clients), it is
@@ -486,6 +498,12 @@ static int fake_acls_fchown(vfs_handle_s
 	int ret;
 	uint8_t id_buf[4];
 	if (uid != -1) {
+		uid_t current_uid = get_current_uid(handle->conn);
+
+		if (current_uid != 0 && current_uid != uid) {
+			return EACCES;
+		}
+
 		SIVAL(id_buf, 0, uid);
 		ret = SMB_VFS_NEXT_FSETXATTR(handle, fsp, FAKE_UID, id_buf, sizeof(id_buf), 0);
 		if (ret != 0) {
diff -Npur samba-4.7.0/source3/modules/vfs_fruit.c samba-4.7.1/source3/modules/vfs_fruit.c
--- samba-4.7.0/source3/modules/vfs_fruit.c	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_fruit.c	2017-11-02 12:38:36.000000000 +0100
@@ -33,6 +33,7 @@
 #include "lib/util/tevent_ntstatus.h"
 #include "lib/util/tevent_unix.h"
 #include "offload_token.h"
+#include "string_replace.h"
 
 /*
  * Enhanced OS X and Netatalk compatibility
@@ -177,6 +178,19 @@ static const struct enum_list fruit_enco
 	{ -1, NULL}
 };
 
+static const char *fruit_catia_maps =
+	"0x01:0xf001,0x02:0xf002,0x03:0xf003,0x04:0xf004,"
+	"0x05:0xf005,0x06:0xf006,0x07:0xf007,0x08:0xf008,"
+	"0x09:0xf009,0x0a:0xf00a,0x0b:0xf00b,0x0c:0xf00c,"
+	"0x0d:0xf00d,0x0e:0xf00e,0x0f:0xf00f,0x10:0xf010,"
+	"0x11:0xf011,0x12:0xf012,0x13:0xf013,0x14:0xf014,"
+	"0x15:0xf015,0x16:0xf016,0x17:0xf017,0x18:0xf018,"
+	"0x19:0xf019,0x1a:0xf01a,0x1b:0xf01b,0x1c:0xf01c,"
+	"0x1d:0xf01d,0x1e:0xf01e,0x1f:0xf01f,"
+	"0x22:0xf020,0x2a:0xf021,0x3a:0xf022,0x3c:0xf023,"
+	"0x3e:0xf024,0x3f:0xf025,0x5c:0xf026,0x7c:0xf027,"
+	"0x0d:0xf00d";
+
 /*****************************************************************************
  * Defines, functions and data structures that deal with AppleDouble
  *****************************************************************************/
@@ -344,12 +358,48 @@ typedef enum {ADOUBLE_META, ADOUBLE_RSRC
 #define AD_DATE_FROM_UNIX(x)  (htonl((x) - AD_DATE_DELTA))
 #define AD_DATE_TO_UNIX(x)    (ntohl(x) + AD_DATE_DELTA)
 
+#define AD_XATTR_HDR_MAGIC    0x41545452 /* 'ATTR' */
+#define AD_XATTR_MAX_ENTRIES  1024 /* Some arbitrarily enforced limit */
+#define AD_XATTR_HDR_SIZE     36
+#define AD_XATTR_MAX_HDR_SIZE 65536
+
 /* Accessor macros */
 #define ad_getentrylen(ad,eid)     ((ad)->ad_eid[(eid)].ade_len)
 #define ad_getentryoff(ad,eid)     ((ad)->ad_eid[(eid)].ade_off)
 #define ad_setentrylen(ad,eid,len) ((ad)->ad_eid[(eid)].ade_len = (len))
 #define ad_setentryoff(ad,eid,off) ((ad)->ad_eid[(eid)].ade_off = (off))
 
+/*
+ * Both struct ad_xattr_header and struct ad_xattr_entry describe the in memory
+ * representation as well as the on-disk format.
+ *
+ * The ad_xattr_header follows the FinderInfo data in the FinderInfo entry if
+ * the length of the FinderInfo entry is larger then 32 bytes. It is then
+ * preceeded with 2 bytes padding.
+ *
+ * Cf: https://opensource.apple.com/source/xnu/xnu-4570.1.46/bsd/vfs/vfs_xattr.c
+ */
+
+struct ad_xattr_header {
+	uint32_t adx_magic;        /* ATTR_HDR_MAGIC */
+	uint32_t adx_debug_tag;    /* for debugging == file id of owning file */
+	uint32_t adx_total_size;   /* file offset of end of attribute header + entries + data */
+	uint32_t adx_data_start;   /* file offset to attribute data area */
+	uint32_t adx_data_length;  /* length of attribute data area */
+	uint32_t adx_reserved[3];
+	uint16_t adx_flags;
+	uint16_t adx_num_attrs;
+};
+
+/* On-disk entries are aligned on 4 byte boundaries */
+struct ad_xattr_entry {
+	uint32_t adx_offset;    /* file offset to data */
+	uint32_t adx_length;    /* size of attribute data */
+	uint16_t adx_flags;
+	uint8_t  adx_namelen;	/* included the NULL terminator */
+	char    *adx_name;      /* NULL-terminated UTF-8 name */
+};
+
 struct ad_entry {
 	size_t ade_off;
 	size_t ade_len;
@@ -364,6 +414,8 @@ struct adouble {
 	uint32_t                  ad_version;
 	struct ad_entry           ad_eid[ADEID_MAX];
 	char                     *ad_data;
+	struct ad_xattr_header    adx_header;
+	struct ad_xattr_entry    *adx_entries;
 };
 
 struct ad_entry_order {
@@ -539,6 +591,10 @@ static bool ad_pack(struct adouble *ad)
 	uint32_t       offset = 0;
 
 	bufsize = talloc_get_size(ad->ad_data);
+	if (bufsize < AD_DATASZ_DOT_UND) {
+		DBG_ERR("bad buffer size [0x%" PRIx32 "]\n", bufsize);
+		return false;
+	}
 
 	if (offset + ADEDLEN_MAGIC < offset ||
 			offset + ADEDLEN_MAGIC >= bufsize) {
@@ -610,6 +666,141 @@ static bool ad_pack(struct adouble *ad)
 	return true;
 }
 
+static bool ad_unpack_xattrs(struct adouble *ad)
+{
+	struct ad_xattr_header *h = &ad->adx_header;
+	const char *p = ad->ad_data;
+	uint32_t hoff;
+	uint32_t i;
+
+	if (ad_getentrylen(ad, ADEID_FINDERI) <= ADEDLEN_FINDERI) {
+		return true;
+	}
+
+	/* 2 bytes padding */
+	hoff = ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI + 2;
+
+	h->adx_magic       = RIVAL(p, hoff + 0);
+	h->adx_debug_tag   = RIVAL(p, hoff + 4); /* Not used -> not checked */
+	h->adx_total_size  = RIVAL(p, hoff + 8);
+	h->adx_data_start  = RIVAL(p, hoff + 12);
+	h->adx_data_length = RIVAL(p, hoff + 16);
+	h->adx_flags       = RSVAL(p, hoff + 32); /* Not used -> not checked */
+	h->adx_num_attrs   = RSVAL(p, hoff + 34);
+
+	if (h->adx_magic != AD_XATTR_HDR_MAGIC) {
+		DBG_ERR("Bad magic: 0x%" PRIx32 "\n", h->adx_magic);
+		return false;
+	}
+
+	if (h->adx_total_size > ad_getentryoff(ad, ADEID_RFORK)) {
+		DBG_ERR("Bad total size: 0x%" PRIx32 "\n", h->adx_total_size);
+		return false;
+	}
+	if (h->adx_total_size > AD_XATTR_MAX_HDR_SIZE) {
+		DBG_ERR("Bad total size: 0x%" PRIx32 "\n", h->adx_total_size);
+		return false;
+	}
+
+	if (h->adx_data_start < (hoff + AD_XATTR_HDR_SIZE)) {
+		DBG_ERR("Bad start: 0x%" PRIx32 "\n", h->adx_data_start);
+		return false;
+	}
+
+	if ((h->adx_data_start + h->adx_data_length) < h->adx_data_start) {
+		DBG_ERR("Bad length: %" PRIu32 "\n", h->adx_data_length);
+		return false;
+	}
+	if ((h->adx_data_start + h->adx_data_length) >
+	    ad->adx_header.adx_total_size)
+	{
+		DBG_ERR("Bad length: %" PRIu32 "\n", h->adx_data_length);
+		return false;
+	}
+
+	if (h->adx_num_attrs > AD_XATTR_MAX_ENTRIES) {
+		DBG_ERR("Bad num xattrs: %" PRIu16 "\n", h->adx_num_attrs);
+		return false;
+	}
+
+	if (h->adx_num_attrs == 0) {
+		return true;
+	}
+
+	ad->adx_entries = talloc_zero_array(
+		ad, struct ad_xattr_entry, h->adx_num_attrs);
+	if (ad->adx_entries == NULL) {
+		return false;
+	}
+
+	hoff += AD_XATTR_HDR_SIZE;
+
+	for (i = 0; i < h->adx_num_attrs; i++) {
+		struct ad_xattr_entry *e = &ad->adx_entries[i];
+
+		hoff = (hoff + 3) & ~3;
+
+		e->adx_offset  = RIVAL(p, hoff + 0);
+		e->adx_length  = RIVAL(p, hoff + 4);
+		e->adx_flags   = RSVAL(p, hoff + 8);
+		e->adx_namelen = *(p + hoff + 10);
+
+		if (e->adx_offset >= ad->adx_header.adx_total_size) {
+			DBG_ERR("Bad adx_offset: %" PRIx32 "\n",
+				e->adx_offset);
+			return false;
+		}
+
+		if ((e->adx_offset + e->adx_length) < e->adx_offset) {
+			DBG_ERR("Bad adx_length: %" PRIx32 "\n",
+				e->adx_length);
+			return false;
+		}
+
+		if ((e->adx_offset + e->adx_length) >
+		    ad->adx_header.adx_total_size)
+		{
+			DBG_ERR("Bad adx_length: %" PRIx32 "\n",
+				e->adx_length);
+			return false;
+		}
+
+		if (e->adx_namelen == 0) {
+			DBG_ERR("Bad adx_namelen: %" PRIx32 "\n",
+				e->adx_namelen);
+			return false;
+		}
+		if ((hoff + 11 + e->adx_namelen) < hoff + 11) {
+			DBG_ERR("Bad adx_namelen: %" PRIx32 "\n",
+				e->adx_namelen);
+			return false;
+		}
+		if ((hoff + 11 + e->adx_namelen) >
+		    ad->adx_header.adx_data_start)
+		{
+			DBG_ERR("Bad adx_namelen: %" PRIx32 "\n",
+				e->adx_namelen);
+			return false;
+		}
+
+		e->adx_name = talloc_strndup(ad->adx_entries,
+					     p + hoff + 11,
+					     e->adx_namelen);
+		if (e->adx_name == NULL) {
+			return false;
+		}
+
+		DBG_DEBUG("xattr [%s] offset [0x%x] size [0x%x]\n",
+			  e->adx_name, e->adx_offset, e->adx_length);
+		dump_data(10, (uint8_t *)(ad->ad_data + e->adx_offset),
+			  e->adx_length);
+
+		hoff += 11 + e->adx_namelen;
+	}
+
+	return true;
+}
+
 /**
  * Unpack an AppleDouble blob into a struct adoble
  **/
@@ -619,6 +810,7 @@ static bool ad_unpack(struct adouble *ad
 	size_t bufsize = talloc_get_size(ad->ad_data);
 	size_t adentries, i;
 	uint32_t eid, len, off;
+	bool ok;
 
 	/*
 	 * The size of the buffer ad->ad_data is checked when read, so
@@ -732,6 +924,124 @@ static bool ad_unpack(struct adouble *ad
 		ad->ad_eid[eid].ade_len = len;
 	}
 
+	ok = ad_unpack_xattrs(ad);
+	if (!ok) {
+		return false;
+	}
+
+	return true;
+}
+
+static bool ad_convert_xattr(struct adouble *ad,
+			     const struct smb_filename *smb_fname,
+			     char *map)
+{
+	static struct char_mappings **string_replace_cmaps = NULL;
+	uint16_t i;
+	int saved_errno = 0;
+	NTSTATUS status;
+
+	if (ad->adx_header.adx_num_attrs == 0) {
+		return true;
+	}
+
+	if (string_replace_cmaps == NULL) {
+		const char **mappings = NULL;
+
+		mappings = str_list_make_v3_const(
+			talloc_tos(), fruit_catia_maps, NULL);
+		if (mappings == NULL) {
+			return false;
+		}
+		string_replace_cmaps = string_replace_init_map(mappings);
+		TALLOC_FREE(mappings);
+	}
+
+	for (i = 0; i < ad->adx_header.adx_num_attrs; i++) {
+		struct ad_xattr_entry *e = &ad->adx_entries[i];
+		char *mapped_name = NULL;
+		char *tmp = NULL;
+		struct smb_filename *stream_name = NULL;
+		files_struct *fsp = NULL;
+		ssize_t nwritten;
+
+		status = string_replace_allocate(ad->ad_handle->conn,
+						 e->adx_name,
+						 string_replace_cmaps,
+						 talloc_tos(),
+						 &mapped_name,
+						 vfs_translate_to_windows);
+		if (!NT_STATUS_IS_OK(status) &&
+		    !NT_STATUS_EQUAL(status, NT_STATUS_NONE_MAPPED))
+		{
+			DBG_ERR("string_replace_allocate failed\n");
+			return -1;
+		}
+
+		tmp = mapped_name;
+		mapped_name = talloc_asprintf(talloc_tos(), ":%s", tmp);
+		TALLOC_FREE(tmp);
+		if (mapped_name == NULL) {
+			return -1;
+		}
+
+		stream_name = synthetic_smb_fname(talloc_tos(),
+						  smb_fname->base_name,
+						  mapped_name,
+						  NULL,
+						  smb_fname->flags);
+		TALLOC_FREE(mapped_name);
+		if (stream_name == NULL) {
+			DBG_ERR("synthetic_smb_fname failed\n");
+			return -1;
+		}
+
+		DBG_DEBUG("stream_name: %s\n", smb_fname_str_dbg(stream_name));
+
+		status = SMB_VFS_CREATE_FILE(
+			ad->ad_handle->conn,		/* conn */
+			NULL,				/* req */
+			0,				/* root_dir_fid */
+			stream_name,			/* fname */
+			FILE_GENERIC_WRITE,		/* access_mask */
+			FILE_SHARE_READ | FILE_SHARE_WRITE, /* share_access */
+			FILE_OPEN_IF,			/* create_disposition */
+			0,				/* create_options */
+			0,				/* file_attributes */
+			INTERNAL_OPEN_ONLY,		/* oplock_request */
+			NULL,				/* lease */
+			0,				/* allocation_size */
+			0,				/* private_flags */
+			NULL,				/* sd */
+			NULL,				/* ea_list */
+			&fsp,				/* result */
+			NULL,				/* psbuf */
+			NULL, NULL);			/* create context */
+		TALLOC_FREE(stream_name);
+		if (!NT_STATUS_IS_OK(status)) {
+			DBG_ERR("SMB_VFS_CREATE_FILE failed\n");
+			return -1;
+		}
+
+		nwritten = SMB_VFS_PWRITE(fsp,
+					  map + e->adx_offset,
+					  e->adx_length,
+					  0);
+		if (nwritten == -1) {
+			DBG_ERR("SMB_VFS_PWRITE failed\n");
+			saved_errno = errno;
+			close_file(NULL, fsp, ERROR_CLOSE);
+			errno = saved_errno;
+			return -1;
+		}
+
+		status = close_file(NULL, fsp, NORMAL_CLOSE);
+		if (!NT_STATUS_IS_OK(status)) {
+			return -1;
+		}
+		fsp = NULL;
+	}
+
 	return true;
 }
 
@@ -745,11 +1055,14 @@ static bool ad_unpack(struct adouble *ad
  * @return -1 in case an error occurred, 0 if no conversion was done, 1
  * otherwise
  **/
-static int ad_convert(struct adouble *ad, int fd)
+static int ad_convert(struct adouble *ad,
+		      const struct smb_filename *smb_fname,
+		      int fd)
 {
 	int rc = 0;
 	char *map = MAP_FAILED;
 	size_t origlen;
+	bool ok;
 
 	origlen = ad_getentryoff(ad, ADEID_RFORK) +
 		ad_getentrylen(ad, ADEID_RFORK);
@@ -762,6 +1075,11 @@ static int ad_convert(struct adouble *ad
 		goto exit;
 	}
 
+	ok = ad_convert_xattr(ad, smb_fname, map);
+	if (!ok) {
+		return -1;
+	}
+
 	if (ad_getentrylen(ad, ADEID_RFORK) > 0) {
 		memmove(map + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI,
 			map + ad_getentryoff(ad, ADEID_RFORK),
@@ -982,22 +1300,44 @@ static ssize_t ad_read_rsrc_adouble(stru
 	char *p_ad = NULL;
 	char *p_meta_ad = NULL;
 	ssize_t len;
+	size_t size;
 	int ret;
 	bool ok;
 
-	len = sys_pread(ad->ad_fd, ad->ad_data, AD_DATASZ_DOT_UND, 0);
-	if (len != AD_DATASZ_DOT_UND) {
-		DBG_NOTICE("%s %s: bad size: %zd\n",
-			   smb_fname->base_name, strerror(errno), len);
-		return -1;
-	}
-
 	ret = sys_fstat(ad->ad_fd, &sbuf, lp_fake_directory_create_times(
 				SNUM(ad->ad_handle->conn)));
 	if (ret != 0) {
 		return -1;
 	}
 
+	/*
+	 * AppleDouble file header content and size, two cases:
+	 *
+	 * - without xattrs it is exactly AD_DATASZ_DOT_UND (82) bytes large
+	 * - with embedded xattrs it can be larger, up to AD_XATTR_MAX_HDR_SIZE
+	 *
+	 * Read as much as we can up to AD_XATTR_MAX_HDR_SIZE.
+	 */
+	size = sbuf.st_ex_size;
+	if (size > talloc_array_length(ad->ad_data)) {
+		if (size > AD_XATTR_MAX_HDR_SIZE) {
+			size = AD_XATTR_MAX_HDR_SIZE;
+		}
+		p_ad = talloc_realloc(ad, ad->ad_data, char, size);
+		if (p_ad == NULL) {
+			return -1;
+		}
+		ad->ad_data = p_ad;
+	}
+
+	len = sys_pread(ad->ad_fd, ad->ad_data,
+			talloc_array_length(ad->ad_data), 0);
+	if (len != talloc_array_length(ad->ad_data)) {
+		DBG_NOTICE("%s %s: bad size: %zd\n",
+			   smb_fname->base_name, strerror(errno), len);
+		return -1;
+	}
+
 	/* Now parse entries */
 	ok = ad_unpack(ad, ADEID_NUM_DOT_UND, sbuf.st_ex_size);
 	if (!ok) {
@@ -1027,7 +1367,7 @@ static ssize_t ad_read_rsrc_adouble(stru
 	 * there is lost.
 	 */
 
-	ret = ad_convert(ad, ad->ad_fd);
+	ret = ad_convert(ad, smb_fname, ad->ad_fd);
 	if (ret != 0) {
 		DBG_WARNING("Failed to convert [%s]\n", smb_fname->base_name);
 		return len;
@@ -1413,9 +1753,9 @@ static int ad_fset(struct adouble *ad, f
 		len = SMB_VFS_NEXT_PWRITE(ad->ad_handle,
 					  fsp,
 					  ad->ad_data,
-					  talloc_get_size(ad->ad_data),
+					  AD_DATASZ_DOT_UND,
 					  0);
-		if (len != (ssize_t)talloc_get_size(ad->ad_data)) {
+		if (len != AD_DATASZ_DOT_UND) {
 			DBG_ERR("short write on %s: %zd", fsp_str_dbg(fsp), len);
 			return -1;
 		}
@@ -2621,20 +2961,9 @@ static int fruit_connect(vfs_handle_stru
 	}
 
 	if (config->encoding == FRUIT_ENC_NATIVE) {
-		lp_do_parameter(
-			SNUM(handle->conn),
-			"catia:mappings",
-			"0x01:0xf001,0x02:0xf002,0x03:0xf003,0x04:0xf004,"
-			"0x05:0xf005,0x06:0xf006,0x07:0xf007,0x08:0xf008,"
-			"0x09:0xf009,0x0a:0xf00a,0x0b:0xf00b,0x0c:0xf00c,"
-			"0x0d:0xf00d,0x0e:0xf00e,0x0f:0xf00f,0x10:0xf010,"
-			"0x11:0xf011,0x12:0xf012,0x13:0xf013,0x14:0xf014,"
-			"0x15:0xf015,0x16:0xf016,0x17:0xf017,0x18:0xf018,"
-			"0x19:0xf019,0x1a:0xf01a,0x1b:0xf01b,0x1c:0xf01c,"
-			"0x1d:0xf01d,0x1e:0xf01e,0x1f:0xf01f,"
-			"0x22:0xf020,0x2a:0xf021,0x3a:0xf022,0x3c:0xf023,"
-			"0x3e:0xf024,0x3f:0xf025,0x5c:0xf026,0x7c:0xf027,"
-			"0x0d:0xf00d");
+		lp_do_parameter(SNUM(handle->conn),
+				"catia:mappings",
+				fruit_catia_maps);
 	}
 
 	return rc;
@@ -3435,7 +3764,7 @@ static int fruit_rmdir(struct vfs_handle
 
 exit_rmdir:
 	if (dh) {
-		closedir(dh);
+		SMB_VFS_CLOSEDIR(handle->conn, dh);
 	}
 	return SMB_VFS_NEXT_RMDIR(handle, smb_fname);
 }
@@ -4881,7 +5210,7 @@ static int fruit_ftruncate_rsrc_adouble(
 
 	ad_off = ad_getentryoff(ad, ADEID_RFORK);
 
-	rc = SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset + ad_off);
+	rc = ftruncate(fsp->fh->fd, offset + ad_off);
 	if (rc != 0) {
 		TALLOC_FREE(ad);
 		return -1;
diff -Npur samba-4.7.0/source3/modules/vfs_glusterfs.c samba-4.7.1/source3/modules/vfs_glusterfs.c
--- samba-4.7.0/source3/modules/vfs_glusterfs.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_glusterfs.c	2017-11-02 12:38:36.000000000 +0100
@@ -352,6 +352,16 @@ static int vfs_gluster_connect(struct vf
 			  volume, strerror(errno)));
 		goto done;
 	}
+
+	/*
+	 * The shadow_copy2 module will fail to export subdirectories
+	 * of a gluster volume unless we specify the mount point,
+	 * because the detection fails if the file system is not
+	 * locally mounted:
+	 * https://bugzilla.samba.org/show_bug.cgi?id=13091
+	 */
+	lp_do_parameter(SNUM(handle->conn), "shadow:mountpoint", "/");
+
 done:
 	if (ret < 0) {
 		if (fs)
@@ -1089,8 +1099,9 @@ static struct smb_filename *vfs_gluster_
 	}
 
 	ret = glfs_getcwd(handle->data, cwd, PATH_MAX - 1);
-	if (ret == 0) {
+	if (ret == NULL) {
 		free(cwd);
+		return NULL;
 	}
 	smb_fname = synthetic_smb_fname(ctx,
 					ret,
diff -Npur samba-4.7.0/source3/modules/vfs_solarisacl.c samba-4.7.1/source3/modules/vfs_solarisacl.c
--- samba-4.7.0/source3/modules/vfs_solarisacl.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_solarisacl.c	2017-11-02 12:38:36.000000000 +0100
@@ -306,7 +306,7 @@ int solarisacl_sys_acl_set_fd(vfs_handle
  * check is considered unnecessary. --- Agreed? XXX
  */
 int solarisacl_sys_acl_delete_def_file(vfs_handle_struct *handle,
-				struct smb_filename *smb_fname)
+				const struct smb_filename *smb_fname)
 {
 	SMB_ACL_T smb_acl;
 	int ret = -1;
diff -Npur samba-4.7.0/source3/modules/vfs_solarisacl.h samba-4.7.1/source3/modules/vfs_solarisacl.h
--- samba-4.7.0/source3/modules/vfs_solarisacl.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_solarisacl.h	2017-11-02 12:38:36.000000000 +0100
@@ -41,7 +41,7 @@ int solarisacl_sys_acl_set_fd(vfs_handle
 int solarisacl_sys_acl_delete_def_file(vfs_handle_struct *handle,
 				const struct smb_filename *smb_fname);
 
-NTSTATUS vfs_solarisacl_init(void);
+NTSTATUS vfs_solarisacl_init(TALLOC_CTX *);
 
 #endif
 
diff -Npur samba-4.7.0/source3/modules/vfs_zfsacl.c samba-4.7.1/source3/modules/vfs_zfsacl.c
--- samba-4.7.0/source3/modules/vfs_zfsacl.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/vfs_zfsacl.c	2017-11-02 12:38:36.000000000 +0100
@@ -40,22 +40,44 @@
  * read the local file's acls and return it in NT form
  * using the NFSv4 format conversion
  */
-static NTSTATUS zfs_get_nt_acl_common(TALLOC_CTX *mem_ctx,
-				      const char *name,
+static NTSTATUS zfs_get_nt_acl_common(struct connection_struct *conn,
+				      TALLOC_CTX *mem_ctx,
+				      const struct smb_filename *smb_fname,
 				      struct SMB4ACL_T **ppacl)
 {
 	int naces, i;
 	ace_t *acebuf;
 	struct SMB4ACL_T *pacl;
+	SMB_STRUCT_STAT sbuf;
+	const SMB_STRUCT_STAT *psbuf = NULL;
+	int ret;
+
+	if (VALID_STAT(smb_fname->st)) {
+		psbuf = &smb_fname->st;
+	}
+
+	if (psbuf == NULL) {
+		ret = vfs_stat_smb_basename(conn, smb_fname, &sbuf);
+		if (ret != 0) {
+			DBG_INFO("stat [%s]failed: %s\n",
+				 smb_fname_str_dbg(smb_fname), strerror(errno));
+			return map_nt_error_from_unix(errno);
+		}
+		psbuf = &sbuf;
+	}
+
+	if (S_ISDIR(psbuf->st_ex_mode) && (ace->aceMask & SMB_ACE4_ADD_FILE)) {
+		ace->aceMask |= SMB_ACE4_DELETE_CHILD;
+	}
 
 	/* read the number of file aces */
-	if((naces = acl(name, ACE_GETACLCNT, 0, NULL)) == -1) {
+	if((naces = acl(smb_fname->base_name, ACE_GETACLCNT, 0, NULL)) == -1) {
 		if(errno == ENOSYS) {
 			DEBUG(9, ("acl(ACE_GETACLCNT, %s): Operation is not "
 				  "supported on the filesystem where the file "
-				  "reside\n", name));
+				  "reside\n", smb_fname->base_name));
 		} else {
-			DEBUG(9, ("acl(ACE_GETACLCNT, %s): %s ", name,
+			DEBUG(9, ("acl(ACE_GETACLCNT, %s): %s ", smb_fname->base_name,
 					strerror(errno)));
 		}
 		return map_nt_error_from_unix(errno);
@@ -67,8 +89,8 @@ static NTSTATUS zfs_get_nt_acl_common(TA
 		return NT_STATUS_NO_MEMORY;
 	}
 	/* read the aces into the field */
-	if(acl(name, ACE_GETACL, naces, acebuf) < 0) {
-		DEBUG(9, ("acl(ACE_GETACL, %s): %s ", name,
+	if(acl(smb_fname->base_name, ACE_GETACL, naces, acebuf) < 0) {
+		DEBUG(9, ("acl(ACE_GETACL, %s): %s ", smb_fname->base_name,
 				strerror(errno)));
 		return map_nt_error_from_unix(errno);
 	}
@@ -84,6 +106,15 @@ static NTSTATUS zfs_get_nt_acl_common(TA
 		aceprop.aceMask  = (uint32_t) acebuf[i].a_access_mask;
 		aceprop.who.id   = (uint32_t) acebuf[i].a_who;
 
+		/*
+		 * Windows clients expect SYNC on acls to correctly allow
+		 * rename, cf bug #7909. But not on DENY ace entries, cf bug
+		 * #8442.
+		 */
+		if (aceprop.aceType == SMB_ACE4_ACCESS_ALLOWED_ACE_TYPE) {
+			aceprop.aceMask |= SMB_ACE4_SYNCHRONIZE;
+		}
+
 		if(aceprop.aceFlags & ACE_OWNER) {
 			aceprop.flags = SMB_ACE4_ID_SPECIAL;
 			aceprop.who.special_id = SMB_ACE4_WHO_OWNER;
@@ -201,9 +232,8 @@ static NTSTATUS zfsacl_fget_nt_acl(struc
 	NTSTATUS status;
 	TALLOC_CTX *frame = talloc_stackframe();
 
-	status = zfs_get_nt_acl_common(frame,
-				       fsp->fsp_name->base_name,
-				       &pacl);
+	status = zfs_get_nt_acl_common(handle->conn, frame,
+				       fsp->fsp_name, &pacl);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(frame);
 		return status;
@@ -225,9 +255,7 @@ static NTSTATUS zfsacl_get_nt_acl(struct
 	NTSTATUS status;
 	TALLOC_CTX *frame = talloc_stackframe();
 
-	status = zfs_get_nt_acl_common(frame,
-					smb_fname->base_name,
-					&pacl);
+	status = zfs_get_nt_acl_common(handle->conn, frame, smb_fname, &pacl);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(frame);
 		return status;
diff -Npur samba-4.7.0/source3/modules/wscript_build samba-4.7.1/source3/modules/wscript_build
--- samba-4.7.0/source3/modules/wscript_build	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.1/source3/modules/wscript_build	2017-11-02 12:38:36.000000000 +0100
@@ -26,6 +26,9 @@ bld.SAMBA3_SUBSYSTEM('OFFLOAD_TOKEN',
                     source='offload_token.c',
                     deps='samba-util')
 
+bld.SAMBA3_SUBSYSTEM('STRING_REPLACE',
+                    source='string_replace.c')
+
 bld.SAMBA3_MODULE('vfs_default',
                  subsystem='vfs',
                  source='vfs_default.c',
@@ -93,7 +96,7 @@ bld.SAMBA3_MODULE('vfs_netatalk',
 bld.SAMBA3_MODULE('vfs_fruit',
                  subsystem='vfs',
                  source='vfs_fruit.c',
-                 deps='samba-util OFFLOAD_TOKEN',
+                 deps='samba-util OFFLOAD_TOKEN STRING_REPLACE',
                  init_function='',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_fruit'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_fruit'))
@@ -236,7 +239,7 @@ bld.SAMBA3_MODULE('vfs_tru64acl',
 bld.SAMBA3_MODULE('vfs_catia',
                  subsystem='vfs',
                  source='vfs_catia.c',
-                 deps='samba-util',
+                 deps='samba-util STRING_REPLACE',
                  init_function='',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_catia'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_catia'))
diff -Npur samba-4.7.0/source3/passdb/machine_account_secrets.c samba-4.7.1/source3/passdb/machine_account_secrets.c
--- samba-4.7.0/source3/passdb/machine_account_secrets.c	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.1/source3/passdb/machine_account_secrets.c	2017-11-02 12:38:36.000000000 +0100
@@ -1090,8 +1090,10 @@ static int secrets_domain_info_kerberos_
 		return krb5_ret;
 	}
 
-	salt.data = discard_const(salt_data);
-	salt.length = strlen(salt_data);
+	salt = (krb5_data) {
+		.data = discard_const(salt_data),
+		.length = strlen(salt_data),
+	};
 
 	ok = convert_string_talloc(keys, CH_UTF16MUNGED, CH_UTF8,
 				   p->cleartext_blob.data,
@@ -1367,6 +1369,8 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 		DBG_ERR("secrets_fetch_domain_sid(%s) failed\n",
 			domain);
 		dbwrap_transaction_cancel(db);
+		SAFE_FREE(old_pw);
+		SAFE_FREE(pw);
 		TALLOC_FREE(frame);
 		return NT_STATUS_CANT_ACCESS_DOMAIN_INFO;
 	}
@@ -1381,6 +1385,8 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 	if (info->account_name == NULL) {
 		DBG_ERR("talloc_asprintf(%s$) failed\n", info->computer_name);
 		dbwrap_transaction_cancel(db);
+		SAFE_FREE(old_pw);
+		SAFE_FREE(pw);
 		TALLOC_FREE(frame);
 		return NT_STATUS_NO_MEMORY;
 	}
@@ -1418,6 +1424,8 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 			DBG_ERR("talloc_asprintf(%s#%02X) failed\n",
 				domain, NBT_NAME_PDC);
 			dbwrap_transaction_cancel(db);
+			SAFE_FREE(pw);
+			SAFE_FREE(old_pw);
 			TALLOC_FREE(frame);
 			return NT_STATUS_NO_MEMORY;
 		}
@@ -1438,6 +1446,8 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 		p = kerberos_secrets_fetch_salt_princ();
 		if (p == NULL) {
 			dbwrap_transaction_cancel(db);
+			SAFE_FREE(old_pw);
+			SAFE_FREE(pw);
 			TALLOC_FREE(frame);
 			return NT_STATUS_INTERNAL_ERROR;
 		}
@@ -1445,6 +1455,8 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 		SAFE_FREE(p);
 		if (info->salt_principal == NULL) {
 			dbwrap_transaction_cancel(db);
+			SAFE_FREE(pw);
+			SAFE_FREE(old_pw);
 			TALLOC_FREE(frame);
 			return NT_STATUS_NO_MEMORY;
 		}
@@ -1459,6 +1471,7 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 						     info->salt_principal,
 						     last_set_nt, server,
 						     &info->password);
+	SAFE_FREE(pw);
 	if (!NT_STATUS_IS_OK(status)) {
 		DBG_ERR("secrets_domain_info_password_create(pw) failed "
 			"for %s - %s\n", domain, nt_errstr(status));
@@ -1476,6 +1489,7 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 							     info->salt_principal,
 							     0, server,
 							     &info->old_password);
+		SAFE_FREE(old_pw);
 		if (!NT_STATUS_IS_OK(status)) {
 			DBG_ERR("secrets_domain_info_password_create(old) failed "
 				"for %s - %s\n", domain, nt_errstr(status));
diff -Npur samba-4.7.0/source3/rpc_server/mdssvc/marshalling.c samba-4.7.1/source3/rpc_server/mdssvc/marshalling.c
--- samba-4.7.0/source3/rpc_server/mdssvc/marshalling.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/rpc_server/mdssvc/marshalling.c	2017-11-02 12:38:36.000000000 +0100
@@ -164,6 +164,8 @@ static ssize_t sl_pack_float(double d, c
 		uint64_t w;
 	} ieee_fp_union;
 
+	ieee_fp_union.d = d;
+
 	offset = sl_push_uint64_val(buf, offset, bufsize, sl_pack_tag(SQ_TYPE_FLOAT, 2, 1));
 	if (offset == -1) {
 		return -1;
diff -Npur samba-4.7.0/source3/rpc_server/spoolss/srv_spoolss_nt.c samba-4.7.1/source3/rpc_server/spoolss/srv_spoolss_nt.c
--- samba-4.7.0/source3/rpc_server/spoolss/srv_spoolss_nt.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/rpc_server/spoolss/srv_spoolss_nt.c	2017-11-02 12:38:36.000000000 +0100
@@ -4238,7 +4238,7 @@ static WERROR construct_printer_info7(TA
 	if (is_printer_published(tmp_ctx, session_info, msg_ctx,
 				 servername, printer, &pinfo2)) {
 		struct GUID guid;
-		struct GUID_txt_buf guid_txt;
+		char *guidstr;
 		werr = nt_printer_guid_get(tmp_ctx, session_info, msg_ctx,
 					   printer, &guid);
 		if (!W_ERROR_IS_OK(werr)) {
@@ -4285,9 +4285,19 @@ static WERROR construct_printer_info7(TA
 					  printer));
 			}
 		}
-		r->guid = talloc_strdup_upper(mem_ctx,
-					     GUID_buf_string(&guid, &guid_txt));
+
+		/* [MS-RPRN] section 2.2: must use curly-braced GUIDs */
+		guidstr = GUID_string2(mem_ctx, &guid);
+		if (guidstr == NULL) {
+			werr = WERR_NOT_ENOUGH_MEMORY;
+			goto out_tmp_free;
+		}
+		/* Convert GUID string to uppercase otherwise printers
+		 * are pruned */
+		r->guid = talloc_strdup_upper(mem_ctx, guidstr);
 		r->action = DSPRINT_PUBLISH;
+
+		TALLOC_FREE(guidstr);
 	} else {
 		r->guid = talloc_strdup(mem_ctx, "");
 		r->action = DSPRINT_UNPUBLISH;
diff -Npur samba-4.7.0/source3/script/tests/test_acl_xattr.sh samba-4.7.1/source3/script/tests/test_acl_xattr.sh
--- samba-4.7.0/source3/script/tests/test_acl_xattr.sh	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/script/tests/test_acl_xattr.sh	2017-11-02 12:38:36.000000000 +0100
@@ -77,7 +77,8 @@ nt_affects_chown() {
     b4_actual=$($SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "getfacl $fname" 2>/dev/null) || exit 1
     echo "${b4_actual}" | grep -q "^# owner:" || exit 1
     b4_actual=$(echo "$b4_actual" | sed -rn 's/^# owner: (.*)/\1/p')
-    $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -C force_user 2>/dev/null || exit 1
+    $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -a "ACL:$SERVER\force_user:ALLOWED/0x0/FULL" || exit 1
+    $SMBCACLS //$SERVER/$share $fname -U force_user%$PASSWORD -C force_user 2>/dev/null || exit 1
     af_actual=$($SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "getfacl $fname" 2>/dev/null) || exit 1
     echo "${af_actual}" | grep -q "^# owner:" || exit 1
     af_actual=$(echo "$af_actual" | sed -rn 's/^# owner: (.*)/\1/p')
@@ -99,8 +100,8 @@ nt_affects_chgrp() {
     b4_expected=$(echo "$b4_expected" | awk -F: '{print $3}')
     echo "$b4_expected"
 
-    echo -n "determining uid of domadmins..."
-    af_expected=$(getent passwd domadmins) || exit 1
+    echo -n "determining gid of domadmins..."
+    af_expected=$(getent group domadmins) || exit 1
     af_expected=$(echo "$af_expected" | awk -F: '{print $3}')
     echo "$af_expected"
 
@@ -108,15 +109,15 @@ nt_affects_chgrp() {
     test "$b4_expected" != "$af_expected" || exit 1
 
     b4_actual=$($SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "getfacl $fname" 2>/dev/null) || exit 1
-    b4_actual=$(echo "$b4_actual" | sed -rn 's/^# group: (.*)/\1/p')
     echo "${b4_actual}" | grep -q "^# group:" || exit 1
+    b4_actual=$(echo "$b4_actual" | sed -rn 's/^# group: (.*)/\1/p')
     $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -G domadmins 2>/dev/null || exit 1
     af_actual=$($SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "getfacl $fname" 2>/dev/null) || exit 1
     echo "${af_actual}" | grep -q "^# group:" || exit 1
     af_actual=$(echo "$af_actual" | sed -rn 's/^# group: (.*)/\1/p')
     echo "before: $b4_actual"
     echo "after: $af_actual"
-    test "$b4_expected" = "$b4_actual" && test "$af_expected" = "$af_actual"
+    test "$af_expected" != "$b4_actual" && test "$af_expected" = "$af_actual"
 }
 
 testit "setup remote file tmp" setup_remote_file tmp
@@ -129,5 +130,5 @@ testit "nt_affects_chown tmp" nt_affects
 testit "nt_affects_chown ign_sysacls" nt_affects_chown ign_sysacls
 testit "setup remote file tmp" setup_remote_file tmp
 testit "setup remote file ign_sysacls" setup_remote_file ign_sysacls
-testit "nt_affects_chgrp tmp" nt_affects_chown tmp
-testit "nt_affects_chgrp ign_sysacls" nt_affects_chown ign_sysacls
+testit "nt_affects_chgrp tmp" nt_affects_chgrp tmp
+testit "nt_affects_chgrp ign_sysacls" nt_affects_chgrp ign_sysacls
diff -Npur samba-4.7.0/source3/script/tests/test_give_owner.sh samba-4.7.1/source3/script/tests/test_give_owner.sh
--- samba-4.7.0/source3/script/tests/test_give_owner.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.1/source3/script/tests/test_give_owner.sh	2017-11-02 12:38:36.000000000 +0100
@@ -0,0 +1,141 @@
+#!/bin/sh
+#
+# this verifies that SEC_STD_WRITE_OWNER only effectively grants take-ownership
+# permissions but NOT give-ownership.
+#
+
+if [ $# -lt 9 ]; then
+    echo "Usage: $0 SERVER SERVER_IP USERNAME PASSWORD PREFIX SMBCLIENT SMBCACLS NET SHARE"
+    exit 1
+fi
+
+SERVER="$1"
+SERVER_IP="$2"
+USERNAME="$3"
+PASSWORD="$4"
+PREFIX="$5"
+SMBCLIENT="$6"
+SMBCACLS="$7"
+NET="$8"
+SHARE="$9"
+
+SMBCLIENT="$VALGRIND ${SMBCLIENT}"
+SMBCACLS="$VALGRIND ${SMBCACLS}"
+NET="$VALGRIND ${NET}"
+failed=0
+
+incdir=`dirname $0`/../../../testprogs/blackbox
+. $incdir/subunit.sh
+
+setup_testfile() {
+    local share=$1
+    local fname=$2
+    touch $PREFIX/$fname
+    $SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "rm $fname"
+    $SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "ls" | grep "$fname" && return 1
+    $SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "lcd $PREFIX; put $fname" || return 1
+}
+
+remove_testfile() {
+    local share=$1
+    local fname=$2
+    $SMBCLIENT //$SERVER/$share -U $USERNAME%$PASSWORD -c "rm $fname"
+}
+
+set_win_owner() {
+    local share=$1
+    local fname=$2
+    local owner=$3
+    echo "$SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -C '$owner'"
+    $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -C "$owner" || return 1
+}
+
+win_owner_is() {
+    local share=$1
+    local fname=$2
+    local expected_owner=$3
+    local actual_owner
+
+    echo "$SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD"
+    $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD
+    actual_owner=$($SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD | sed -rn 's/^OWNER:(.*)/\1/p')
+    echo "actual_owner = $actual_owner"
+    if ! test "x$actual_owner" = "x$expected_owner" ; then
+        echo "Actual owner of $share/$fname is [$actual_owner] expected [$expected_owner]"
+        return 1
+    fi
+    return 0
+}
+
+add_ace() {
+    local share=$1
+    local fname=$2
+    local ace=$3
+
+    local_ace=$(printf '%s' "$ace" | sed 's|\\|/|')
+
+    # avoid duplicate
+    out=$($SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD)
+    if [ $? -ne 0 ] ; then
+	echo "get acl failed"
+	echo "$out"
+	return 1
+    fi
+    echo "Original ACL"
+    echo $out
+    echo "$out" | grep "$local_ace" && return 0
+
+    # add it
+    $SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -a "$ace"
+    if [ $? -ne 0 ] ; then
+	echo "add acl failed"
+	return 1
+    fi
+
+    # check it's there
+    out=$($SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD)
+    if [ $? -ne 0 ] ; then
+	echo "get new acl failed"
+	echo "$out"
+	return 1
+    fi
+    echo "New ACL"
+    echo $out
+    echo "Checking if new ACL has \"$local_ace\""
+    echo "$out" | grep "$local_ace" || return 1
+    echo "ok"
+}
+
+chown_give_fails() {
+    local share=$1
+    local fname=$2
+    local user=$3
+    local expected_error=$4
+
+    # this must fail
+    out=$($SMBCACLS //$SERVER/$share $fname -U $USERNAME%$PASSWORD -C "$user") && return 1
+    # it failed, now check it returned the expected error code
+    echo "$out" | grep $expected_error || return 1
+}
+
+# Create a testfile
+testit "create testfile" setup_testfile $SHARE afile || failed=`expr $failed + 1`
+testit "verify owner" win_owner_is $SHARE afile "$SERVER/$USERNAME" || failed=`expr $failed + 1`
+
+# Grant SeRestorePrivilege to the user and full rights on the file
+testit "grant SeRestorePrivilege" $NET rpc rights grant $USERNAME SeRestorePrivilege -U $USERNAME%$PASSWORD -I $SERVER_IP || failed=`expr $failed + 1`
+testit "grant full rights" add_ace $SHARE afile "ACL:$SERVER\\$USERNAME:ALLOWED/0x0/FULL" || failed=`expr $failed + 1`
+
+# We have SeRestorePrivilege, so both give and take ownership must succeed
+testit "give owner with SeRestorePrivilege" set_win_owner $SHARE afile "$SERVER\user1" || failed=`expr $failed + 1`
+testit "verify owner" win_owner_is $SHARE afile "$SERVER/user1" || failed=`expr $failed + 1`
+testit "take owner" set_win_owner $SHARE afile "$SERVER\\$USERNAME" || failed=`expr $failed + 1`
+testit "verify owner" win_owner_is $SHARE afile "$SERVER/$USERNAME" || failed=`expr $failed + 1`
+
+# Revoke SeRestorePrivilege, give ownership must fail now with NT_STATUS_INVALID_OWNER
+testit "revoke SeRestorePrivilege" $NET rpc rights revoke $USERNAME SeRestorePrivilege -U $USERNAME%$PASSWORD -I $SERVER_IP || failed=`expr $failed + 1`
+testit "give owner without SeRestorePrivilege" chown_give_fails $SHARE afile "$SERVER\user1" NT_STATUS_INVALID_OWNER || failed=`expr $failed + 1`
+
+testit "delete testfile" remove_testfile $SHARE afile || failed=`expr $failed + 1`
+
+exit $failed
diff -Npur samba-4.7.0/source3/script/tests/test_inherit_owner.sh samba-4.7.1/source3/script/tests/test_inherit_owner.sh
--- samba-4.7.0/source3/script/tests/test_inherit_owner.sh	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/script/tests/test_inherit_owner.sh	2017-11-02 12:38:36.000000000 +0100
@@ -4,9 +4,9 @@
 # currently needs to run in SMB1 mode, because it uses UNIX
 # extensions to fetch the UNIX owner of a file.
 
-if [ $# -lt 9 ]; then
+if [ $# -lt 10 ]; then
 cat <<EOF
-Usage: $0 SERVER USERNAME PASSWORD PREFIX SMBCLIENT SMBCACLS SHARE INH_WIN INH_UNIX <additional args>
+Usage: $0 SERVER USERNAME PASSWORD PREFIX SMBCLIENT SMBCACLS NET SHARE INH_WIN INH_UNIX <additional args>
 EOF
 exit 1;
 fi
@@ -17,13 +17,15 @@ PASSWORD="$3"
 PREFIX="$4"
 SMBCLIENT="$5"
 SMBCACLS="$6"
-SHARE="$7"
-INH_WIN="$8"
-INH_UNIX="$9"
-shift 9
+NET="$7"
+SHARE="$8"
+INH_WIN="$9"
+INH_UNIX="${10}"
+shift 10
 ADDARGS="$*"
 SMBCLIENT="$VALGRIND ${SMBCLIENT} ${ADDARGS}"
 SMBCACLS="$VALGRIND ${SMBCACLS} ${ADDARGS}"
+NET="$VALGRIND ${NET}"
 
 incdir=`dirname $0`/../../../testprogs/blackbox
 . $incdir/subunit.sh
@@ -137,6 +139,7 @@ fi
 
 # SETUP
 testit "$TEST_LABEL - setup root dir" create_dir tmp tmp.$$
+testit "grant SeRestorePrivilege" $NET rpc rights grant $USERNAME SeRestorePrivilege -U $USERNAME%$PASSWORD -I $SERVER || exit 1
 testit "$TEST_LABEL - assign default ACL" $SMBCACLS //$SERVER/tmp tmp.$$ -U $USERNAME%$PASSWORD -S "REVISION:1,OWNER:$SERVER\force_user,GROUP:$SERVER\domusers,ACL:Everyone:ALLOWED/0x3/FULL" 2>/dev/null
 # END SETUP
 
@@ -155,3 +158,5 @@ testit "$TEST_LABEL - verify file unix o
 testit "$TEST_LABEL - cleanup subdir" cleanup_dir $SHARE tmp.$$/subdir
 testit "$TEST_LABEL - cleanup file" cleanup_file $SHARE tmp.$$/afile
 testit "$TEST_LABEL - cleanup root" cleanup_dir $SHARE tmp.$$
+
+testit "revoke SeRestorePrivilege" $NET rpc rights revoke $USERNAME SeRestorePrivilege -U $USERNAME%$PASSWORD -I $SERVER || exit 1
diff -Npur samba-4.7.0/source3/script/tests/test_smbclient_s3.sh samba-4.7.1/source3/script/tests/test_smbclient_s3.sh
--- samba-4.7.0/source3/script/tests/test_smbclient_s3.sh	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.1/source3/script/tests/test_smbclient_s3.sh	2017-11-02 12:38:36.000000000 +0100
@@ -1414,6 +1414,50 @@ EOF
     fi
 }
 
+# Test smbclient renames with pathnames containing '..'
+test_rename_dotdot()
+{
+    tmpfile=$PREFIX/smbclient_interactive_prompt_commands
+
+cat > $tmpfile <<EOF
+deltree dotdot_test
+mkdir dotdot_test
+cd dotdot_test
+mkdir dir1
+mkdir dir2
+cd dir1
+put ${SMBCLIENT} README
+rename README ..\\dir2\\README
+cd ..
+cd dir2
+allinfo README
+cd \\
+deltree dotdot_test
+quit
+EOF
+    cmd='CLI_FORCE_INTERACTIVE=yes $SMBCLIENT "$@" -U$USERNAME%$PASSWORD //$SERVER/tmp -I $SERVER_IP $ADDARGS < $tmpfile 2>&1'
+    eval echo "$cmd"
+    out=`eval $cmd`
+    ret=$?
+
+    if [ $ret != 0 ] ; then
+	echo "$out"
+	echo "failed rename_dotdot test with output $ret"
+	false
+	return
+    fi
+
+    # We are allowed to get NT_STATUS_NO_SUCH_FILE listing \dotdot_test
+    # as the top level directory should not exist, but no other errors.
+
+    error_str=`echo $out | grep NT_STATUS | grep -v "NT_STATUS_NO_SUCH_FILE listing .dotdot_test"`
+    if [ "$error_str" != "" ]; then
+        echo "failed - unexpected NT_STATUS error in $out"
+        false
+        return
+    fi
+}
+
 
 test_server_os_message()
 {
@@ -1564,6 +1608,10 @@ testit "setmode test" \
     test_setmode || \
     failed=`expr $failed + 1`
 
+testit "rename_dotdot" \
+    test_rename_dotdot || \
+    failed=`expr $failed + 1`
+
 testit "rm -rf $LOGDIR" \
     rm -rf $LOGDIR || \
     failed=`expr $failed + 1`
diff -Npur samba-4.7.0/source3/selftest/tests.py samba-4.7.1/source3/selftest/tests.py
--- samba-4.7.0/source3/selftest/tests.py	2017-07-04 21:22:39.000000000 +0200
+++ samba-4.7.1/source3/selftest/tests.py	2017-11-02 12:38:36.000000000 +0100
@@ -56,6 +56,7 @@ finally:
 
 have_libarchive = ("HAVE_LIBARCHIVE" in config_hash)
 have_linux_kernel_oplocks = ("HAVE_KERNEL_OPLOCKS_LINUX" in config_hash)
+have_inotify = ("HAVE_INOTIFY" in config_hash)
 
 plantestsuite("samba3.blackbox.success", "nt4_dc:local", [os.path.join(samba3srcdir, "script/tests/test_success.sh")])
 plantestsuite("samba3.blackbox.failure", "nt4_dc:local", [os.path.join(samba3srcdir, "script/tests/test_failure.sh")])
@@ -245,14 +246,15 @@ for env in ["fileserver"]:
     plantestsuite("samba3.blackbox.acl_xattr.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_acl_xattr.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, '-mNT1'])
     plantestsuite("samba3.blackbox.acl_xattr.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_acl_xattr.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, '-mSMB3'])
     plantestsuite("samba3.blackbox.smb2.not_casesensitive (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_smb2_not_casesensitive.sh"), '//$SERVER/tmp', '$SERVER_IP', '$USERNAME', '$PASSWORD', '$LOCAL_PATH', smbclient3])
-    plantestsuite("samba3.blackbox.inherit_owner.default.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'tmp', '0', '0', '-m', 'NT1'])
-    plantestsuite("samba3.blackbox.inherit_owner.default.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'tmp', '0', '0', '-m', 'SMB3'])
-    plantestsuite("samba3.blackbox.inherit_owner.full.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'inherit_owner', '1', '1', '-m', 'NT1'])
-    plantestsuite("samba3.blackbox.inherit_owner.full.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'inherit_owner', '1', '1', '-m', 'SMB3'])
-    plantestsuite("samba3.blackbox.inherit_owner.unix.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'inherit_owner_u', '0', '1', '-m', 'NT1'])
-    plantestsuite("samba3.blackbox.inherit_owner.unix.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, 'inherit_owner_u', '0', '1', '-m', 'SMB3'])
+    plantestsuite("samba3.blackbox.inherit_owner.default.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'tmp', '0', '0', '-m', 'NT1'])
+    plantestsuite("samba3.blackbox.inherit_owner.default.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'tmp', '0', '0', '-m', 'SMB3'])
+    plantestsuite("samba3.blackbox.inherit_owner.full.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'inherit_owner', '1', '1', '-m', 'NT1'])
+    plantestsuite("samba3.blackbox.inherit_owner.full.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'inherit_owner', '1', '1', '-m', 'SMB3'])
+    plantestsuite("samba3.blackbox.inherit_owner.unix.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'inherit_owner_u', '0', '1', '-m', 'NT1'])
+    plantestsuite("samba3.blackbox.inherit_owner.unix.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_inherit_owner.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'inherit_owner_u', '0', '1', '-m', 'SMB3'])
     plantestsuite("samba3.blackbox.large_acl.NT1", env, [os.path.join(samba3srcdir, "script/tests/test_large_acl.sh"), '$SERVER', '$USERNAME', '$PASSWORD', smbclient3, smbcacls, '-m', 'NT1'])
     plantestsuite("samba3.blackbox.large_acl.SMB3", env, [os.path.join(samba3srcdir, "script/tests/test_large_acl.sh"), '$SERVER', '$USERNAME', '$PASSWORD', smbclient3, smbcacls, '-m', 'SMB3'])
+    plantestsuite("samba3.blackbox.give_owner", env, [os.path.join(samba3srcdir, "script/tests/test_give_owner.sh"), '$SERVER', '$SERVER_IP', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3, smbcacls, net, 'tmp'])
 
     #
     # tar command tests
@@ -496,6 +498,9 @@ for t in tests:
     elif t == "smb2.kernel-oplocks":
         if have_linux_kernel_oplocks:
             plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER/kernel_oplocks -U$USERNAME%$PASSWORD')
+    elif t == "smb2.notify-inotify":
+        if have_inotify:
+            plansmbtorture4testsuite(t, "fileserver", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
     elif t == "vfs.acl_xattr":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
     elif t == "smb2.compound_find":
@@ -505,6 +510,10 @@ for t in tests:
     elif t == "rpc.samr.users.privileges":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD --option=torture:nt4_dc=true')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
+    elif t == "smb2.compound":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/aio -U$USERNAME%$PASSWORD', 'aio')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
     else:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
diff -Npur samba-4.7.0/source3/smbd/aio.c samba-4.7.1/source3/smbd/aio.c
--- samba-4.7.0/source3/smbd/aio.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/smbd/aio.c	2017-11-02 12:38:36.000000000 +0100
@@ -697,6 +697,10 @@ NTSTATUS schedule_smb2_aio_read(connecti
 		return NT_STATUS_RETRY;
 	}
 
+	if (smbd_smb2_is_compound(smbreq->smb2req)) {
+		return NT_STATUS_RETRY;
+	}
+
 	/* Create the out buffer. */
 	*preadbuf = data_blob_talloc(ctx, NULL, smb_maxcnt);
 	if (preadbuf->data == NULL) {
@@ -841,6 +845,10 @@ NTSTATUS schedule_aio_smb2_write(connect
 		return NT_STATUS_RETRY;
 	}
 
+	if (smbd_smb2_is_compound(smbreq->smb2req)) {
+		return NT_STATUS_RETRY;
+	}
+
 	if (smbreq->unread_bytes) {
 		/* Can't do async with recvfile. */
 		return NT_STATUS_RETRY;
diff -Npur samba-4.7.0/source3/smbd/dosmode.c samba-4.7.1/source3/smbd/dosmode.c
--- samba-4.7.0/source3/smbd/dosmode.c	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.1/source3/smbd/dosmode.c	2017-11-02 12:38:36.000000000 +0100
@@ -415,6 +415,7 @@ NTSTATUS set_ea_dos_attribute(connection
 	struct xattr_DOSATTRIB dosattrib;
 	enum ndr_err_code ndr_err;
 	DATA_BLOB blob;
+	int ret;
 
 	if (!lp_store_dos_attributes(SNUM(conn))) {
 		return NT_STATUS_NOT_IMPLEMENTED;
@@ -456,14 +457,16 @@ NTSTATUS set_ea_dos_attribute(connection
 		return NT_STATUS_INVALID_PARAMETER;
 	}
 
-	if (SMB_VFS_SETXATTR(conn, smb_fname,
-			     SAMBA_XATTR_DOS_ATTRIB, blob.data, blob.length,
-			     0) == -1) {
+	ret = SMB_VFS_SETXATTR(conn, smb_fname,
+			       SAMBA_XATTR_DOS_ATTRIB,
+			       blob.data, blob.length, 0);
+	if (ret != 0) {
 		NTSTATUS status = NT_STATUS_OK;
 		bool need_close = false;
 		files_struct *fsp = NULL;
+		bool set_dosmode_ok = false;
 
-		if((errno != EPERM) && (errno != EACCES)) {
+		if ((errno != EPERM) && (errno != EACCES)) {
 			DBG_INFO("Cannot set "
 				 "attribute EA on file %s: Error = %s\n",
 				 smb_fname_str_dbg(smb_fname), strerror(errno));
@@ -475,10 +478,21 @@ NTSTATUS set_ea_dos_attribute(connection
 		*/
 
 		/* Check if we have write access. */
-		if(!CAN_WRITE(conn) || !lp_dos_filemode(SNUM(conn)))
+		if (!CAN_WRITE(conn)) {
 			return NT_STATUS_ACCESS_DENIED;
+		}
+
+		status = smbd_check_access_rights(conn, smb_fname, false,
+						  FILE_WRITE_ATTRIBUTES);
+		if (NT_STATUS_IS_OK(status)) {
+			set_dosmode_ok = true;
+		}
+
+		if (!set_dosmode_ok && lp_dos_filemode(SNUM(conn))) {
+			set_dosmode_ok = can_write_to_file(conn, smb_fname);
+		}
 
-		if (!can_write_to_file(conn, smb_fname)) {
+		if (!set_dosmode_ok) {
 			return NT_STATUS_ACCESS_DENIED;
 		}
 
@@ -496,9 +510,10 @@ NTSTATUS set_ea_dos_attribute(connection
 		}
 
 		become_root();
-		if (SMB_VFS_FSETXATTR(fsp,
-				     SAMBA_XATTR_DOS_ATTRIB, blob.data,
-				     blob.length, 0) == 0) {
+		ret = SMB_VFS_FSETXATTR(fsp,
+					SAMBA_XATTR_DOS_ATTRIB,
+					blob.data, blob.length, 0);
+		if (ret == 0) {
 			status = NT_STATUS_OK;
 		}
 		unbecome_root();
@@ -1152,7 +1167,7 @@ static NTSTATUS get_file_handle_for_meta
 		NULL,                                   /* req */
 		0,                                      /* root_dir_fid */
 		smb_fname_cp,				/* fname */
-		FILE_WRITE_DATA,                        /* access_mask */
+		FILE_WRITE_ATTRIBUTES,			/* access_mask */
 		(FILE_SHARE_READ | FILE_SHARE_WRITE |   /* share_access */
 			FILE_SHARE_DELETE),
 		FILE_OPEN,                              /* create_disposition*/
diff -Npur samba-4.7.0/source3/smbd/globals.h samba-4.7.1/source3/smbd/globals.h
--- samba-4.7.0/source3/smbd/globals.h	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/smbd/globals.h	2017-11-02 12:38:36.000000000 +0100
@@ -225,6 +225,7 @@ void smbd_server_connection_terminate_ex
 
 const char *smb2_opcode_name(uint16_t opcode);
 bool smbd_is_smb2_header(const uint8_t *inbuf, size_t size);
+bool smbd_smb2_is_compound(const struct smbd_smb2_request *req);
 
 NTSTATUS smbd_add_connection(struct smbXsrv_client *client, int sock_fd,
 			     struct smbXsrv_connection **_xconn);
diff -Npur samba-4.7.0/source3/smbd/notifyd/notifyd.c samba-4.7.1/source3/smbd/notifyd/notifyd.c
--- samba-4.7.0/source3/smbd/notifyd/notifyd.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/smbd/notifyd/notifyd.c	2017-11-02 12:38:36.000000000 +0100
@@ -32,6 +32,7 @@
 #include "notifyd.h"
 #include "lib/util/server_id_db.h"
 #include "lib/util/tevent_unix.h"
+#include "lib/util/tevent_ntstatus.h"
 #include "ctdbd_conn.h"
 #include "ctdb_srvids.h"
 #include "server_id_db_util.h"
@@ -122,20 +123,20 @@ struct notifyd_peer {
 	time_t last_broadcast;
 };
 
-static bool notifyd_rec_change(struct messaging_context *msg_ctx,
-			       struct messaging_rec **prec,
-			       void *private_data);
-static bool notifyd_trigger(struct messaging_context *msg_ctx,
-			    struct messaging_rec **prec,
-			    void *private_data);
-static bool notifyd_get_db(struct messaging_context *msg_ctx,
-			   struct messaging_rec **prec,
-			   void *private_data);
+static void notifyd_rec_change(struct messaging_context *msg_ctx,
+			       void *private_data, uint32_t msg_type,
+			       struct server_id src, DATA_BLOB *data);
+static void notifyd_trigger(struct messaging_context *msg_ctx,
+			    void *private_data, uint32_t msg_type,
+			    struct server_id src, DATA_BLOB *data);
+static void notifyd_get_db(struct messaging_context *msg_ctx,
+			   void *private_data, uint32_t msg_type,
+			   struct server_id src, DATA_BLOB *data);
 
 #ifdef CLUSTER_SUPPORT
-static bool notifyd_got_db(struct messaging_context *msg_ctx,
-			   struct messaging_rec **prec,
-			   void *private_data);
+static void notifyd_got_db(struct messaging_context *msg_ctx,
+			   void *private_data, uint32_t msg_type,
+			   struct server_id src, DATA_BLOB *data);
 static void notifyd_broadcast_reclog(struct ctdbd_connection *ctdbd_conn,
 				     struct server_id src,
 				     struct messaging_reclog *log);
@@ -175,8 +176,6 @@ static int sys_notify_watch_dummy(
 	return 0;
 }
 
-static void notifyd_handler_done(struct tevent_req *subreq);
-
 #ifdef CLUSTER_SUPPORT
 static void notifyd_broadcast_reclog_finished(struct tevent_req *subreq);
 static void notifyd_clean_peers_finished(struct tevent_req *subreq);
@@ -192,9 +191,13 @@ struct tevent_req *notifyd_send(TALLOC_C
 				sys_notify_watch_fn sys_notify_watch,
 				struct sys_notify_context *sys_notify_ctx)
 {
-	struct tevent_req *req, *subreq;
+	struct tevent_req *req;
+#ifdef CLUSTER_SUPPORT
+	struct tevent_req *subreq;
+#endif
 	struct notifyd_state *state;
 	struct server_id_db *names_db;
+	NTSTATUS status;
 	int ret;
 
 	req = tevent_req_create(mem_ctx, &state, struct notifyd_state);
@@ -217,39 +220,23 @@ struct tevent_req *notifyd_send(TALLOC_C
 		return tevent_req_post(req, ev);
 	}
 
-	subreq = messaging_handler_send(state, ev, msg_ctx,
-					MSG_SMB_NOTIFY_REC_CHANGE,
-					notifyd_rec_change, state);
-	if (tevent_req_nomem(subreq, req)) {
+	status = messaging_register(msg_ctx, state, MSG_SMB_NOTIFY_REC_CHANGE,
+				    notifyd_rec_change);
+	if (tevent_req_nterror(req, status)) {
 		return tevent_req_post(req, ev);
 	}
-	tevent_req_set_callback(subreq, notifyd_handler_done, req);
 
-	subreq = messaging_handler_send(state, ev, msg_ctx,
-					MSG_SMB_NOTIFY_TRIGGER,
-					notifyd_trigger, state);
-	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
+	status = messaging_register(msg_ctx, state, MSG_SMB_NOTIFY_TRIGGER,
+				    notifyd_trigger);
+	if (tevent_req_nterror(req, status)) {
+		goto deregister_rec_change;
 	}
-	tevent_req_set_callback(subreq, notifyd_handler_done, req);
 
-	subreq = messaging_handler_send(state, ev, msg_ctx,
-					MSG_SMB_NOTIFY_GET_DB,
-					notifyd_get_db, state);
-	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
+	status = messaging_register(msg_ctx, state, MSG_SMB_NOTIFY_GET_DB,
+				    notifyd_get_db);
+	if (tevent_req_nterror(req, status)) {
+		goto deregister_trigger;
 	}
-	tevent_req_set_callback(subreq, notifyd_handler_done, req);
-
-#ifdef CLUSTER_SUPPORT
-	subreq = messaging_handler_send(state, ev, msg_ctx,
-					MSG_SMB_NOTIFY_DB,
-					notifyd_got_db, state);
-	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
-	}
-	tevent_req_set_callback(subreq, notifyd_handler_done, req);
-#endif
 
 	names_db = messaging_names_db(msg_ctx);
 
@@ -258,7 +245,7 @@ struct tevent_req *notifyd_send(TALLOC_C
 		DEBUG(10, ("%s: server_id_db_add failed: %s\n",
 			   __func__, strerror(ret)));
 		tevent_req_error(req, ret);
-		return tevent_req_post(req, ev);
+		goto deregister_get_db;
 	}
 
 	if (ctdbd_conn == NULL) {
@@ -270,47 +257,57 @@ struct tevent_req *notifyd_send(TALLOC_C
 	}
 
 #ifdef CLUSTER_SUPPORT
+	status = messaging_register(msg_ctx, state, MSG_SMB_NOTIFY_DB,
+				    notifyd_got_db);
+	if (tevent_req_nterror(req, status)) {
+		goto deregister_get_db;
+	}
+
 	state->log = talloc_zero(state, struct messaging_reclog);
 	if (tevent_req_nomem(state->log, req)) {
-		return tevent_req_post(req, ev);
+		goto deregister_db;
 	}
 
 	subreq = notifyd_broadcast_reclog_send(
-		state->log, ev, ctdbd_conn, messaging_server_id(msg_ctx),
+		state->log, ev, ctdbd_conn,
+		messaging_server_id(msg_ctx),
 		state->log);
 	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
+		goto deregister_db;
 	}
-	tevent_req_set_callback(subreq, notifyd_broadcast_reclog_finished,
+	tevent_req_set_callback(subreq,
+				notifyd_broadcast_reclog_finished,
 				req);
 
 	subreq = notifyd_clean_peers_send(state, ev, state);
 	if (tevent_req_nomem(subreq, req)) {
-		return tevent_req_post(req, ev);
+		goto deregister_db;
 	}
 	tevent_req_set_callback(subreq, notifyd_clean_peers_finished,
 				req);
 
-	ret = register_with_ctdbd(ctdbd_conn, CTDB_SRVID_SAMBA_NOTIFY_PROXY,
+	ret = register_with_ctdbd(ctdbd_conn,
+				  CTDB_SRVID_SAMBA_NOTIFY_PROXY,
 				  notifyd_snoop_broadcast, state);
 	if (ret != 0) {
 		tevent_req_error(req, ret);
-		return tevent_req_post(req, ev);
+		goto deregister_db;
 	}
 #endif
 
 	return req;
-}
 
-static void notifyd_handler_done(struct tevent_req *subreq)
-{
-	struct tevent_req *req = tevent_req_callback_data(
-		subreq, struct tevent_req);
-	int ret;
-
-	ret = messaging_handler_recv(subreq);
-	TALLOC_FREE(subreq);
-	tevent_req_error(req, ret);
+#ifdef CLUSTER_SUPPORT
+deregister_db:
+	messaging_deregister(msg_ctx, MSG_SMB_NOTIFY_DB, state);
+#endif
+deregister_get_db:
+	messaging_deregister(msg_ctx, MSG_SMB_NOTIFY_GET_DB, state);
+deregister_trigger:
+	messaging_deregister(msg_ctx, MSG_SMB_NOTIFY_TRIGGER, state);
+deregister_rec_change:
+	messaging_deregister(msg_ctx, MSG_SMB_NOTIFY_REC_CHANGE, state);
+	return tevent_req_post(req, ev);
 }
 
 #ifdef CLUSTER_SUPPORT
@@ -567,40 +564,38 @@ static bool notifyd_parse_rec_change(uin
 	return true;
 }
 
-static bool notifyd_rec_change(struct messaging_context *msg_ctx,
-			       struct messaging_rec **prec,
-			       void *private_data)
+static void notifyd_rec_change(struct messaging_context *msg_ctx,
+			       void *private_data, uint32_t msg_type,
+			       struct server_id src, DATA_BLOB *data)
 {
 	struct notifyd_state *state = talloc_get_type_abort(
 		private_data, struct notifyd_state);
 	struct server_id_buf idbuf;
-	struct messaging_rec *rec = *prec;
 	struct notify_rec_change_msg *msg;
 	size_t pathlen;
 	bool ok;
 
-	DEBUG(10, ("%s: Got %d bytes from %s\n", __func__,
-		   (unsigned)rec->buf.length,
-		   server_id_str_buf(rec->src, &idbuf)));
+	DBG_DEBUG("Got %zu bytes from %s\n", data->length,
+		  server_id_str_buf(src, &idbuf));
 
-	ok = notifyd_parse_rec_change(rec->buf.data, rec->buf.length,
+	ok = notifyd_parse_rec_change(data->data, data->length,
 				      &msg, &pathlen);
 	if (!ok) {
-		return true;
+		return;
 	}
 
 	ok = notifyd_apply_rec_change(
-		&rec->src, msg->path, pathlen, &msg->instance,
+		&src, msg->path, pathlen, &msg->instance,
 		state->entries, state->sys_notify_watch, state->sys_notify_ctx,
 		state->msg_ctx);
 	if (!ok) {
 		DEBUG(1, ("%s: notifyd_apply_rec_change failed, ignoring\n",
 			  __func__));
-		return true;
+		return;
 	}
 
 	if ((state->log == NULL) || (state->ctdbd_conn == NULL)) {
-		return true;
+		return;
 	}
 
 #ifdef CLUSTER_SUPPORT
@@ -608,6 +603,7 @@ static bool notifyd_rec_change(struct me
 
 	struct messaging_rec **tmp;
 	struct messaging_reclog *log;
+	struct iovec iov = { .iov_base = data->data, .iov_len = data->length };
 
 	log = state->log;
 
@@ -615,11 +611,19 @@ static bool notifyd_rec_change(struct me
 			     log->num_recs+1);
 	if (tmp == NULL) {
 		DEBUG(1, ("%s: talloc_realloc failed, ignoring\n", __func__));
-		return true;
+		return;
 	}
 	log->recs = tmp;
 
-	log->recs[log->num_recs] = talloc_move(log->recs, prec);
+	log->recs[log->num_recs] = messaging_rec_create(
+		log->recs, src, messaging_server_id(msg_ctx),
+		msg_type, &iov, 1, NULL, 0);
+
+	if (log->recs[log->num_recs] == NULL) {
+		DBG_WARNING("messaging_rec_create failed, ignoring\n");
+		return;
+	}
+
 	log->num_recs += 1;
 
 	if (log->num_recs >= 100) {
@@ -632,8 +636,6 @@ static bool notifyd_rec_change(struct me
 
 	}
 #endif
-
-	return true;
 }
 
 struct notifyd_trigger_state {
@@ -646,34 +648,33 @@ struct notifyd_trigger_state {
 static void notifyd_trigger_parser(TDB_DATA key, TDB_DATA data,
 				   void *private_data);
 
-static bool notifyd_trigger(struct messaging_context *msg_ctx,
-			    struct messaging_rec **prec,
-			    void *private_data)
+static void notifyd_trigger(struct messaging_context *msg_ctx,
+			    void *private_data, uint32_t msg_type,
+			    struct server_id src, DATA_BLOB *data)
 {
 	struct notifyd_state *state = talloc_get_type_abort(
 		private_data, struct notifyd_state);
 	struct server_id my_id = messaging_server_id(msg_ctx);
-	struct messaging_rec *rec = *prec;
 	struct notifyd_trigger_state tstate;
 	const char *path;
 	const char *p, *next_p;
 
-	if (rec->buf.length < offsetof(struct notify_trigger_msg, path) + 1) {
-		DEBUG(1, ("message too short, ignoring: %u\n",
-			  (unsigned)rec->buf.length));
-		return true;
+	if (data->length < offsetof(struct notify_trigger_msg, path) + 1) {
+		DBG_WARNING("message too short, ignoring: %zu\n",
+			    data->length);
+		return;
 	}
-	if (rec->buf.data[rec->buf.length-1] != 0) {
+	if (data->data[data->length-1] != 0) {
 		DEBUG(1, ("%s: path not 0-terminated, ignoring\n", __func__));
-		return true;
+		return;
 	}
 
 	tstate.msg_ctx = msg_ctx;
 
-	tstate.covered_by_sys_notify = (rec->src.vnn == my_id.vnn);
-	tstate.covered_by_sys_notify &= !server_id_equal(&rec->src, &my_id);
+	tstate.covered_by_sys_notify = (src.vnn == my_id.vnn);
+	tstate.covered_by_sys_notify &= !server_id_equal(&src, &my_id);
 
-	tstate.msg = (struct notify_trigger_msg *)rec->buf.data;
+	tstate.msg = (struct notify_trigger_msg *)data->data;
 	path = tstate.msg->path;
 
 	DEBUG(10, ("%s: Got trigger_msg action=%u, filter=%u, path=%s\n",
@@ -683,7 +684,7 @@ static bool notifyd_trigger(struct messa
 	if (path[0] != '/') {
 		DEBUG(1, ("%s: path %s does not start with /, ignoring\n",
 			  __func__, path));
-		return true;
+		return;
 	}
 
 	for (p = strchr(path+1, '/'); p != NULL; p = next_p) {
@@ -707,7 +708,7 @@ static bool notifyd_trigger(struct messa
 			continue;
 		}
 
-		if (rec->src.vnn != my_id.vnn) {
+		if (src.vnn != my_id.vnn) {
 			continue;
 		}
 
@@ -722,8 +723,6 @@ static bool notifyd_trigger(struct messa
 					    notifyd_trigger_parser, &tstate);
 		}
 	}
-
-	return true;
 }
 
 static void notifyd_send_delete(struct messaging_context *msg_ctx,
@@ -845,13 +844,12 @@ static void notifyd_send_delete(struct m
 	}
 }
 
-static bool notifyd_get_db(struct messaging_context *msg_ctx,
-			   struct messaging_rec **prec,
-			   void *private_data)
+static void notifyd_get_db(struct messaging_context *msg_ctx,
+			   void *private_data, uint32_t msg_type,
+			   struct server_id src, DATA_BLOB *data)
 {
 	struct notifyd_state *state = talloc_get_type_abort(
 		private_data, struct notifyd_state);
-	struct messaging_rec *rec = *prec;
 	struct server_id_buf id1, id2;
 	NTSTATUS status;
 	uint64_t rec_index = UINT64_MAX;
@@ -862,11 +860,11 @@ static bool notifyd_get_db(struct messag
 
 	dbsize = dbwrap_marshall(state->entries, NULL, 0);
 
-	buf = talloc_array(rec, uint8_t, dbsize);
+	buf = talloc_array(talloc_tos(), uint8_t, dbsize);
 	if (buf == NULL) {
 		DEBUG(1, ("%s: talloc_array(%ju) failed\n",
 			  __func__, (uintmax_t)dbsize));
-		return true;
+		return;
 	}
 
 	dbsize = dbwrap_marshall(state->entries, buf, dbsize);
@@ -876,7 +874,7 @@ static bool notifyd_get_db(struct messag
 			  (uintmax_t)talloc_get_size(buf),
 			  (uintmax_t)dbsize));
 		TALLOC_FREE(buf);
-		return true;
+		return;
 	}
 
 	if (state->log != NULL) {
@@ -892,17 +890,15 @@ static bool notifyd_get_db(struct messag
 	DEBUG(10, ("%s: Sending %ju bytes to %s->%s\n", __func__,
 		   (uintmax_t)iov_buflen(iov, ARRAY_SIZE(iov)),
 		   server_id_str_buf(messaging_server_id(msg_ctx), &id1),
-		   server_id_str_buf(rec->src, &id2)));
+		   server_id_str_buf(src, &id2)));
 
-	status = messaging_send_iov(msg_ctx, rec->src, MSG_SMB_NOTIFY_DB,
+	status = messaging_send_iov(msg_ctx, src, MSG_SMB_NOTIFY_DB,
 				    iov, ARRAY_SIZE(iov), NULL, 0);
 	TALLOC_FREE(buf);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("%s: messaging_send_iov failed: %s\n",
 			  __func__, nt_errstr(status)));
 	}
-
-	return true;
 }
 
 #ifdef CLUSTER_SUPPORT
@@ -910,13 +906,12 @@ static bool notifyd_get_db(struct messag
 static int notifyd_add_proxy_syswatches(struct db_record *rec,
 					void *private_data);
 
-static bool notifyd_got_db(struct messaging_context *msg_ctx,
-			   struct messaging_rec **prec,
-			   void *private_data)
+static void notifyd_got_db(struct messaging_context *msg_ctx,
+			   void *private_data, uint32_t msg_type,
+			   struct server_id src, DATA_BLOB *data)
 {
 	struct notifyd_state *state = talloc_get_type_abort(
 		private_data, struct notifyd_state);
-	struct messaging_rec *rec = *prec;
 	struct notifyd_peer *p = NULL;
 	struct server_id_buf idbuf;
 	NTSTATUS status;
@@ -924,52 +919,49 @@ static bool notifyd_got_db(struct messag
 	size_t i;
 
 	for (i=0; i<state->num_peers; i++) {
-		if (server_id_equal(&rec->src, &state->peers[i]->pid)) {
+		if (server_id_equal(&src, &state->peers[i]->pid)) {
 			p = state->peers[i];
 			break;
 		}
 	}
 
 	if (p == NULL) {
-		DEBUG(10, ("%s: Did not find peer for db from %s\n",
-			   __func__, server_id_str_buf(rec->src, &idbuf)));
-		return true;
+		DBG_DEBUG("Did not find peer for db from %s\n",
+			  server_id_str_buf(src, &idbuf));
+		return;
 	}
 
-	if (rec->buf.length < 8) {
-		DEBUG(10, ("%s: Got short db length %u from %s\n", __func__,
-			   (unsigned)rec->buf.length,
-			   server_id_str_buf(rec->src, &idbuf)));
+	if (data->length < 8) {
+		DBG_DEBUG("Got short db length %zu from %s\n", data->length,
+			   server_id_str_buf(src, &idbuf));
 		TALLOC_FREE(p);
-		return true;
+		return;
 	}
 
-	p->rec_index = BVAL(rec->buf.data, 0);
+	p->rec_index = BVAL(data->data, 0);
 
 	p->db = db_open_rbt(p);
 	if (p->db == NULL) {
 		DEBUG(10, ("%s: db_open_rbt failed\n", __func__));
 		TALLOC_FREE(p);
-		return true;
+		return;
 	}
 
-	status = dbwrap_unmarshall(p->db, rec->buf.data + 8,
-				   rec->buf.length - 8);
+	status = dbwrap_unmarshall(p->db, data->data + 8,
+				   data->length - 8);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(10, ("%s: dbwrap_unmarshall returned %s for db %s\n",
 			   __func__, nt_errstr(status),
-			   server_id_str_buf(rec->src, &idbuf)));
+			   server_id_str_buf(src, &idbuf)));
 		TALLOC_FREE(p);
-		return true;
+		return;
 	}
 
 	dbwrap_traverse_read(p->db, notifyd_add_proxy_syswatches, state,
 			     &count);
 
 	DEBUG(10, ("%s: Database from %s contained %d records\n", __func__,
-		   server_id_str_buf(rec->src, &idbuf), count));
-
-	return true;
+		   server_id_str_buf(src, &idbuf), count));
 }
 
 static void notifyd_broadcast_reclog(struct ctdbd_connection *ctdbd_conn,
diff -Npur samba-4.7.0/source3/smbd/posix_acls.c samba-4.7.1/source3/smbd/posix_acls.c
--- samba-4.7.0/source3/smbd/posix_acls.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/smbd/posix_acls.c	2017-11-02 12:38:36.000000000 +0100
@@ -3671,7 +3671,7 @@ NTSTATUS try_chown(files_struct *fsp, ui
 	   a local SID on the users workstation
 	*/
 	if (uid != get_current_uid(fsp->conn)) {
-		return NT_STATUS_ACCESS_DENIED;
+		return NT_STATUS_INVALID_OWNER;
 	}
 
 	become_root();
diff -Npur samba-4.7.0/source3/smbd/server.c samba-4.7.1/source3/smbd/server.c
--- samba-4.7.0/source3/smbd/server.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/smbd/server.c	2017-11-02 12:38:36.000000000 +0100
@@ -334,6 +334,7 @@ static struct tevent_req *notifyd_req(st
 	struct tevent_req *req;
 	sys_notify_watch_fn sys_notify_watch = NULL;
 	struct sys_notify_context *sys_notify_ctx = NULL;
+	struct ctdbd_connection *ctdbd_conn = NULL;
 
 	if (lp_kernel_change_notify()) {
 
@@ -358,8 +359,11 @@ static struct tevent_req *notifyd_req(st
 		}
 	}
 
-	req = notifyd_send(msg_ctx, ev, msg_ctx,
-			   messaging_ctdbd_connection(),
+	if (lp_clustering()) {
+		ctdbd_conn = messaging_ctdbd_connection();
+	}
+
+	req = notifyd_send(msg_ctx, ev, msg_ctx, ctdbd_conn,
 			   sys_notify_watch, sys_notify_ctx);
 	if (req == NULL) {
 		TALLOC_FREE(sys_notify_ctx);
diff -Npur samba-4.7.0/source3/smbd/smb2_read.c samba-4.7.1/source3/smbd/smb2_read.c
--- samba-4.7.0/source3/smbd/smb2_read.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/smbd/smb2_read.c	2017-11-02 12:38:36.000000000 +0100
@@ -350,7 +350,7 @@ static NTSTATUS schedule_smb2_sendfile_r
 	if (!lp__use_sendfile(SNUM(fsp->conn)) ||
 	    smb2req->do_signing ||
 	    smb2req->do_encryption ||
-	    smb2req->in.vector_count >= (2*SMBD_SMB2_NUM_IOV_PER_REQ) ||
+	    smbd_smb2_is_compound(smb2req) ||
 	    (fsp->base_fsp != NULL) ||
 	    (fsp->wcp != NULL) ||
 	    (!S_ISREG(fsp->fsp_name->st.st_ex_mode)) ||
diff -Npur samba-4.7.0/source3/smbd/smb2_server.c samba-4.7.1/source3/smbd/smb2_server.c
--- samba-4.7.0/source3/smbd/smb2_server.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/smbd/smb2_server.c	2017-11-02 12:38:36.000000000 +0100
@@ -204,6 +204,11 @@ bool smbd_is_smb2_header(const uint8_t *
 	return true;
 }
 
+bool smbd_smb2_is_compound(const struct smbd_smb2_request *req)
+{
+	return req->in.vector_count >= (2*SMBD_SMB2_NUM_IOV_PER_REQ);
+}
+
 static NTSTATUS smbd_initialize_smb2(struct smbXsrv_connection *xconn,
 				     uint64_t expected_seq_low)
 {
diff -Npur samba-4.7.0/source3/smbd/vfs.c samba-4.7.1/source3/smbd/vfs.c
--- samba-4.7.0/source3/smbd/vfs.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source3/smbd/vfs.c	2017-11-02 12:38:36.000000000 +0100
@@ -858,6 +858,8 @@ const char *vfs_readdirname(connection_s
 int vfs_ChDir(connection_struct *conn, const struct smb_filename *smb_fname)
 {
 	int ret;
+	int saved_errno = 0;
+	struct smb_filename *saved_cwd = NULL;
 
 	if (!LastDir) {
 		LastDir = SMB_STRDUP("");
@@ -872,23 +874,80 @@ int vfs_ChDir(connection_struct *conn, c
 		return 0;
 	}
 
+	if (conn->cwd_fname != NULL) {
+		/*
+		 * Save off where we are in case we need to return
+		 * on vfs_GetWd() failure after successful SMB_VFS_CHDIR().
+		 */
+		saved_cwd = cp_smb_filename(conn, conn->cwd_fname);
+		if (saved_cwd == NULL) {
+			return -1;
+		}
+	}
+
 	DEBUG(4,("vfs_ChDir to %s\n", smb_fname->base_name));
 
 	ret = SMB_VFS_CHDIR(conn, smb_fname);
-	if (ret == 0) {
-		/* Global cache. */
-		SAFE_FREE(LastDir);
-		LastDir = SMB_STRDUP(smb_fname->base_name);
-
-		/* conn cache. */
-		TALLOC_FREE(conn->cwd_fname);
-		conn->cwd_fname = vfs_GetWd(conn, conn);
-		if (conn->cwd_fname == NULL) {
-			smb_panic("con->cwd getwd failed\n");
+	if (ret != 0) {
+		saved_errno = errno;
+		TALLOC_FREE(saved_cwd);
+		errno = saved_errno;
+		return -1;
+	}
+
+	/*
+	 * Always replace conn->cwd_fname. We
+	 * don't know if it's been modified by
+	 * VFS modules in the stack.
+	 */
+
+	/* conn cache. */
+	TALLOC_FREE(conn->cwd_fname);
+	conn->cwd_fname = vfs_GetWd(conn, conn);
+	if (conn->cwd_fname == NULL) {
+		/*
+		 * vfs_GetWd() failed.
+		 * We must be able to read cwd.
+		 * Return to original directory
+		 * and return -1.
+		 */
+		saved_errno = errno;
+
+		if (saved_cwd == NULL) {
+			/*
+			 * Failed on the very first chdir()+getwd()
+			 * for this connection. We can't
+			 * continue.
+			 */
+			smb_panic("conn->cwd getwd failed\n");
 			/* NOTREACHED */
 			return -1;
 		}
-		DEBUG(4,("vfs_ChDir got %s\n",conn->cwd_fname->base_name));
+
+		/* Return to the previous $cwd. */
+		ret = SMB_VFS_CHDIR(conn, saved_cwd);
+		if (ret != 0) {
+			smb_panic("conn->cwd getwd failed\n");
+			/* NOTREACHED */
+			return -1;
+		}
+		/* Restore original conn->cwd_fname. */
+		conn->cwd_fname = saved_cwd;
+		errno = saved_errno;
+		/* And fail the chdir(). */
+		return -1;
+	}
+
+	/* vfs_GetWd() succeeded. */
+	/* Replace global cache. */
+	SAFE_FREE(LastDir);
+	LastDir = SMB_STRDUP(smb_fname->base_name);
+
+	DEBUG(4,("vfs_ChDir got %s\n", conn->cwd_fname->base_name));
+
+	TALLOC_FREE(saved_cwd);
+	if (saved_errno != 0) {
+		errno = saved_errno;
 	}
 	return ret;
 }
diff -Npur samba-4.7.0/source3/utils/net_groupmap.c samba-4.7.1/source3/utils/net_groupmap.c
--- samba-4.7.0/source3/utils/net_groupmap.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source3/utils/net_groupmap.c	2017-11-02 12:38:36.000000000 +0100
@@ -764,7 +764,9 @@ static int net_groupmap_cleanup(struct n
 			printf(_("Group %s is not mapped\n"),
 				maps[i]->nt_name);
 
-		if (!sid_check_is_in_our_sam(&maps[i]->sid)) {
+		if (!sid_check_is_in_our_sam(&maps[i]->sid) &&
+		    !sid_check_is_in_builtin(&maps[i]->sid))
+		{
 			printf(_("Deleting mapping for NT Group %s, sid %s\n"),
 				maps[i]->nt_name,
 				sid_string_tos(&maps[i]->sid));
diff -Npur samba-4.7.0/source4/dns_server/dlz_bind9.c samba-4.7.1/source4/dns_server/dlz_bind9.c
--- samba-4.7.0/source4/dns_server/dlz_bind9.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dlz_bind9.c	2017-11-02 12:38:36.000000000 +0100
@@ -865,8 +865,8 @@ static isc_result_t dlz_lookup_types(str
 			return ISC_R_NOMEMORY;
 		}
 
-		werr = dns_common_lookup(state->samdb, tmp_ctx, dn,
-					 &records, &num_records, NULL);
+		werr = dns_common_wildcard_lookup(state->samdb, tmp_ctx, dn,
+					 &records, &num_records);
 		if (W_ERROR_IS_OK(werr)) {
 			break;
 		}
diff -Npur samba-4.7.0/source4/dns_server/dns_query.c samba-4.7.1/source4/dns_server/dns_query.c
--- samba-4.7.0/source4/dns_server/dns_query.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dns_query.c	2017-11-02 12:38:36.000000000 +0100
@@ -625,9 +625,8 @@ static struct tevent_req *handle_authori
 	if (tevent_req_werror(req, werr)) {
 		return tevent_req_post(req, ev);
 	}
-
-	werr = dns_lookup_records(dns, state, dn, &state->recs,
-				  &state->rec_count);
+	werr = dns_lookup_records_wildcard(dns, state, dn, &state->recs,
+				           &state->rec_count);
 	TALLOC_FREE(dn);
 	if (tevent_req_werror(req, werr)) {
 		return tevent_req_post(req, ev);
diff -Npur samba-4.7.0/source4/dns_server/dns_server.h samba-4.7.1/source4/dns_server/dns_server.h
--- samba-4.7.0/source4/dns_server/dns_server.h	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dns_server.h	2017-11-02 12:38:36.000000000 +0100
@@ -95,6 +95,11 @@ WERROR dns_lookup_records(struct dns_ser
 			  struct ldb_dn *dn,
 			  struct dnsp_DnssrvRpcRecord **records,
 			  uint16_t *rec_count);
+WERROR dns_lookup_records_wildcard(struct dns_server *dns,
+			  TALLOC_CTX *mem_ctx,
+			  struct ldb_dn *dn,
+			  struct dnsp_DnssrvRpcRecord **records,
+			  uint16_t *rec_count);
 WERROR dns_replace_records(struct dns_server *dns,
 			   TALLOC_CTX *mem_ctx,
 			   struct ldb_dn *dn,
diff -Npur samba-4.7.0/source4/dns_server/dns_utils.c samba-4.7.1/source4/dns_server/dns_utils.c
--- samba-4.7.0/source4/dns_server/dns_utils.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dns_utils.c	2017-11-02 12:38:36.000000000 +0100
@@ -107,6 +107,10 @@ bool dns_records_match(struct dnsp_Dnssr
 	return false;
 }
 
+/*
+ * Lookup a DNS record, performing an exact match.
+ * i.e. DNS wild card records are not considered.
+ */
 WERROR dns_lookup_records(struct dns_server *dns,
 			  TALLOC_CTX *mem_ctx,
 			  struct ldb_dn *dn,
@@ -117,6 +121,20 @@ WERROR dns_lookup_records(struct dns_ser
 				 records, rec_count, NULL);
 }
 
+/*
+ * Lookup a DNS record, will match DNS wild card records if an exact match
+ * is not found.
+ */
+WERROR dns_lookup_records_wildcard(struct dns_server *dns,
+			  TALLOC_CTX *mem_ctx,
+			  struct ldb_dn *dn,
+			  struct dnsp_DnssrvRpcRecord **records,
+			  uint16_t *rec_count)
+{
+	return dns_common_wildcard_lookup(dns->samdb, mem_ctx, dn,
+				 records, rec_count);
+}
+
 WERROR dns_replace_records(struct dns_server *dns,
 			   TALLOC_CTX *mem_ctx,
 			   struct ldb_dn *dn,
diff -Npur samba-4.7.0/source4/dns_server/dnsserver_common.c samba-4.7.1/source4/dns_server/dnsserver_common.c
--- samba-4.7.0/source4/dns_server/dnsserver_common.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dnsserver_common.c	2017-11-02 12:38:36.000000000 +0100
@@ -133,6 +133,10 @@ WERROR dns_common_extract(struct ldb_con
 	return WERR_OK;
 }
 
+/*
+ * Lookup a DNS record, performing an exact match.
+ * i.e. DNS wild card records are not considered.
+ */
 WERROR dns_common_lookup(struct ldb_context *samdb,
 			 TALLOC_CTX *mem_ctx,
 			 struct ldb_dn *dn,
@@ -229,6 +233,350 @@ WERROR dns_common_lookup(struct ldb_cont
 	return WERR_OK;
 }
 
+/*
+ * Build an ldb_parse_tree node for an equality check
+ *
+ * Note: name is assumed to have been validated by dns_name_check
+ *       so will be zero terminated and of a reasonable size.
+ */
+static struct ldb_parse_tree *build_equality_operation(
+	TALLOC_CTX *mem_ctx,
+	bool add_asterix,     /* prepend an '*' to the name          */
+	const uint8_t *name,  /* the value being matched             */
+	const char *attr,     /* the attribute to check name against */
+	size_t size)          /* length of name                      */
+{
+
+	struct ldb_parse_tree *el = NULL;  /* Equality node being built */
+	struct ldb_val *value = NULL;      /* Value the attr will be compared
+					      with */
+	size_t length = 0;                 /* calculated length of the value
+	                                      including option '*' prefix and
+					      '\0' string terminator */
+
+	el = talloc(mem_ctx, struct ldb_parse_tree);
+	if (el == NULL) {
+		DBG_ERR("Unable to allocate ldb_parse_tree\n");
+		return NULL;
+	}
+
+	el->operation = LDB_OP_EQUALITY;
+	el->u.equality.attr = talloc_strdup(mem_ctx, attr);
+	value = &el->u.equality.value;
+	length = (add_asterix) ? size + 2 : size + 1;
+	value->data = talloc_zero_array(el, uint8_t, length);
+	if (el == NULL) {
+		DBG_ERR("Unable to allocate value->data\n");
+		TALLOC_FREE(el);
+		return NULL;
+	}
+
+	value->length = length;
+	if (add_asterix) {
+		value->data[0] = '*';
+		memcpy(&value->data[1], name, size);
+	} else {
+		memcpy(value->data, name, size);
+	}
+	return el;
+}
+
+/*
+ * Determine the number of levels in name
+ * essentially the number of '.'s in the name + 1
+ *
+ * name is assumed to have been validated by dns_name_check
+ */
+static unsigned int number_of_labels(const struct ldb_val *name) {
+	int x  = 0;
+	unsigned int labels = 1;
+	for (x = 0; x < name->length; x++) {
+		if (name->data[x] == '.') {
+			labels++;
+		}
+	}
+	return labels;
+}
+/*
+ * Build a query that matches the target name, and any possible
+ * DNS wild card entries
+ *
+ * Builds a parse tree equivalent to the example query.
+ *
+ * x.y.z -> (|(name=x.y.z)(name=\2a.y.z)(name=\2a.z)(name=\2a))
+ *
+ * Returns NULL if unable to build the query.
+ *
+ * The first component of the DN is assumed to be the name being looked up
+ * and also that it has been validated by dns_name_check
+ *
+ */
+#define BASE "(&(objectClass=dnsNode)(!(dNSTombstoned=TRUE))(|(a=b)(c=d)))"
+static struct ldb_parse_tree *build_wildcard_query(
+	TALLOC_CTX *mem_ctx,
+	struct ldb_dn *dn)
+{
+	const struct ldb_val *name = NULL;            /* The DNS name being
+							 queried */
+	const char *attr = NULL;                      /* The attribute name */
+	struct ldb_parse_tree *query = NULL;          /* The constructed query
+							 parse tree*/
+	struct ldb_parse_tree *wildcard_query = NULL; /* The parse tree for the
+							 name and wild card
+							 entries */
+	int labels = 0;         /* The number of labels in the name */
+
+	attr = ldb_dn_get_rdn_name(dn);
+	if (attr == NULL) {
+		DBG_ERR("Unable to get rdn_name\n");
+		return NULL;
+	}
+
+	name = ldb_dn_get_rdn_val(dn);
+	if (name == NULL) {
+		DBG_ERR("Unable to get domain name value\n");
+		return NULL;
+	}
+	labels = number_of_labels(name);
+
+	query = ldb_parse_tree(mem_ctx, BASE);
+	if (query == NULL) {
+		DBG_ERR("Unable to parse query %s\n", BASE);
+		return NULL;
+	}
+
+	/*
+	 * The 3rd element of BASE is a place holder which is replaced with
+	 * the actual wild card query
+	 */
+	wildcard_query = query->u.list.elements[2];
+	TALLOC_FREE(wildcard_query->u.list.elements);
+
+	wildcard_query->u.list.num_elements = labels + 1;
+	wildcard_query->u.list.elements = talloc_array(
+		wildcard_query,
+		struct ldb_parse_tree *,
+		labels + 1);
+	/*
+	 * Build the wild card query
+	 */
+	{
+		int x = 0;   /* current character in the name               */
+		int l = 0;   /* current equality operator index in elements */
+		struct ldb_parse_tree *el = NULL; /* Equality operator being
+						     built */
+		bool add_asterix = true;  /* prepend an '*' to the value    */
+		for (l = 0, x = 0; l < labels && x < name->length; l++) {
+			unsigned int size = name->length - x;
+			add_asterix = (name->data[x] == '.');
+			el = build_equality_operation(
+				mem_ctx,
+				add_asterix,
+				&name->data[x],
+				attr,
+				size);
+			if (el == NULL) {
+				return NULL;  /* Reason will have been logged */
+			}
+			wildcard_query->u.list.elements[l] = el;
+
+			/* skip to the start of the next label */
+			for (;x < name->length && name->data[x] != '.'; x++);
+		}
+
+		/* Add the base level "*" only query */
+		el = build_equality_operation(mem_ctx, true, NULL, attr, 0);
+		if (el == NULL) {
+			TALLOC_FREE(query);
+			return NULL;  /* Reason will have been logged */
+		}
+		wildcard_query->u.list.elements[l] = el;
+	}
+	return query;
+}
+
+/*
+ * Scan the list of records matching a dns wildcard query and return the
+ * best match.
+ *
+ * The best match is either an exact name match, or the longest wild card
+ * entry returned
+ *
+ * i.e. name = a.b.c candidates *.b.c, *.c,        - *.b.c would be selected
+ *      name = a.b.c candidates a.b.c, *.b.c, *.c  - a.b.c would be selected
+ */
+static struct ldb_message *get_best_match(struct ldb_dn *dn,
+		                          struct ldb_result *result)
+{
+	int matched = 0;    /* Index of the current best match in result */
+	size_t length = 0;  /* The length of the current candidate       */
+	const struct ldb_val *target = NULL;    /* value we're looking for */
+	const struct ldb_val *candidate = NULL; /* current candidate value */
+	int x = 0;
+
+	target = ldb_dn_get_rdn_val(dn);
+	for(x = 0; x < result->count; x++) {
+		candidate = ldb_dn_get_rdn_val(result->msgs[x]->dn);
+		if (strncasecmp((char *) target->data,
+				(char *) candidate->data,
+				target->length) == 0) {
+			/* Exact match stop searching and return */
+			return result->msgs[x];
+		}
+		if (candidate->length > length) {
+			matched = x;
+			length  = candidate->length;
+		}
+	}
+	return result->msgs[matched];
+}
+
+/*
+ * Look up a DNS entry, if an exact match does not exist, return the
+ * closest matching DNS wildcard entry if available
+ *
+ * Returns: LDB_ERR_NO_SUCH_OBJECT     If no matching record exists
+ *          LDB_ERR_OPERATIONS_ERROR   If the query fails
+ *          LDB_SUCCESS                If a matching record was retrieved
+ *
+ */
+static int dns_wildcard_lookup(struct ldb_context *samdb,
+			       TALLOC_CTX *mem_ctx,
+			       struct ldb_dn *dn,
+			       struct ldb_message **msg)
+{
+	static const char * const attrs[] = {
+		"dnsRecord",
+		"dNSTombstoned",
+		NULL
+	};
+	struct ldb_dn *parent = NULL;     /* The parent dn                    */
+	struct ldb_result *result = NULL; /* Results of the search            */
+	int ret;                          /* Return code                      */
+	struct ldb_parse_tree *query = NULL; /* The query to run              */
+	struct ldb_request *request = NULL;  /* LDB request for the query op  */
+	struct ldb_message *match = NULL;    /* the best matching DNS record  */
+	TALLOC_CTX *frame = talloc_stackframe();
+
+	parent = ldb_dn_get_parent(frame, dn);
+	if (parent == NULL) {
+		DBG_ERR("Unable to extract parent from dn\n");
+		TALLOC_FREE(frame);
+		return LDB_ERR_OPERATIONS_ERROR;
+	}
+
+	query = build_wildcard_query(frame, dn);
+	if (query == NULL) {
+		TALLOC_FREE(frame);
+		return LDB_ERR_OPERATIONS_ERROR;
+	}
+
+	result = talloc_zero(mem_ctx, struct ldb_result);
+	if (result == NULL) {
+		TALLOC_FREE(frame);
+		DBG_ERR("Unable to allocate ldb_result\n");
+		return LDB_ERR_OPERATIONS_ERROR;
+	}
+
+	ret = ldb_build_search_req_ex(&request,
+				      samdb,
+				      frame,
+				      parent,
+				      LDB_SCOPE_ONELEVEL,
+				      query,
+				      attrs,
+				      NULL,
+				      result,
+				      ldb_search_default_callback,
+				      NULL);
+	if (ret != LDB_SUCCESS) {
+		TALLOC_FREE(frame);
+		DBG_ERR("ldb_build_search_req_ex returned %d\n", ret);
+		return ret;
+	}
+
+	ret = ldb_request(samdb, request);
+	if (ret != LDB_SUCCESS) {
+		TALLOC_FREE(frame);
+		return ret;
+	}
+
+	ret = ldb_wait(request->handle, LDB_WAIT_ALL);
+	if (ret != LDB_SUCCESS) {
+		TALLOC_FREE(frame);
+		return ret;
+	}
+
+	if (result->count == 0) {
+		TALLOC_FREE(frame);
+		return LDB_ERR_NO_SUCH_OBJECT;
+	}
+
+	match = get_best_match(dn, result);
+	if (match == NULL) {
+		TALLOC_FREE(frame);
+		return LDB_ERR_OPERATIONS_ERROR;
+	}
+
+	*msg = talloc_move(mem_ctx, &match);
+	TALLOC_FREE(frame);
+	return LDB_SUCCESS;
+}
+
+/*
+ * Lookup a DNS record, will match DNS wild card records if an exact match
+ * is not found.
+ */
+WERROR dns_common_wildcard_lookup(struct ldb_context *samdb,
+				  TALLOC_CTX *mem_ctx,
+				  struct ldb_dn *dn,
+				  struct dnsp_DnssrvRpcRecord **records,
+				  uint16_t *num_records)
+{
+	int ret;
+	WERROR werr;
+	struct ldb_message *msg = NULL;
+	struct ldb_message_element *el = NULL;
+	const struct ldb_val *name = NULL;
+
+	*records = NULL;
+	*num_records = 0;
+
+	name = ldb_dn_get_rdn_val(dn);
+	if (name == NULL) {
+		return DNS_ERR(NAME_ERROR);
+	}
+
+	werr =  dns_name_check(
+			mem_ctx,
+			strlen((const char*)name->data),
+			(const char*) name->data);
+	if (!W_ERROR_IS_OK(werr)) {
+		return werr;
+	}
+
+	ret = dns_wildcard_lookup(samdb, mem_ctx, dn, &msg);
+	if (ret == LDB_ERR_OPERATIONS_ERROR) {
+		return DNS_ERR(SERVER_FAILURE);
+	}
+	if (ret != LDB_SUCCESS) {
+		return DNS_ERR(NAME_ERROR);
+	}
+
+	el = ldb_msg_find_element(msg, "dnsRecord");
+	if (el == NULL) {
+		return WERR_DNS_ERROR_NAME_DOES_NOT_EXIST;
+	}
+
+	werr = dns_common_extract(samdb, el, mem_ctx, records, num_records);
+	TALLOC_FREE(msg);
+	if (!W_ERROR_IS_OK(werr)) {
+		return werr;
+	}
+
+	return WERR_OK;
+}
+
 static int rec_cmp(const struct dnsp_DnssrvRpcRecord *r1,
 		   const struct dnsp_DnssrvRpcRecord *r2)
 {
@@ -246,25 +594,48 @@ static int rec_cmp(const struct dnsp_Dns
 }
 
 /*
- * Check for valid DNS names. These are names which are non-empty, do not
- * start with a dot and do not have any empty segments.
+ * Check for valid DNS names. These are names which:
+ *   - are non-empty
+ *   - do not start with a dot
+ *   - do not have any empty labels
+ *   - have no more than 127 labels
+ *   - are no longer than 253 characters
+ *   - none of the labels exceed 63 characters
  */
 WERROR dns_name_check(TALLOC_CTX *mem_ctx, size_t len, const char *name)
 {
 	size_t i;
+	unsigned int labels    = 0;
+	unsigned int label_len = 0;
 
 	if (len == 0) {
 		return WERR_DS_INVALID_DN_SYNTAX;
 	}
 
+	if (len > 1 && name[0] == '.') {
+		return WERR_DS_INVALID_DN_SYNTAX;
+	}
+
+	if ((len - 1) > DNS_MAX_DOMAIN_LENGTH) {
+		return WERR_DS_INVALID_DN_SYNTAX;
+	}
+
 	for (i = 0; i < len - 1; i++) {
 		if (name[i] == '.' && name[i+1] == '.') {
 			return WERR_DS_INVALID_DN_SYNTAX;
 		}
-	}
-
-	if (len > 1 && name[0] == '.') {
-		return WERR_DS_INVALID_DN_SYNTAX;
+		if (name[i] == '.') {
+			labels++;
+			if (labels > DNS_MAX_LABELS) {
+				return WERR_DS_INVALID_DN_SYNTAX;
+			}
+			label_len = 0;
+		} else {
+			label_len++;
+			if (label_len > DNS_MAX_LABEL_LENGTH) {
+				return WERR_DS_INVALID_DN_SYNTAX;
+			}
+		}
 	}
 
 	return WERR_OK;
diff -Npur samba-4.7.0/source4/dns_server/dnsserver_common.h samba-4.7.1/source4/dns_server/dnsserver_common.h
--- samba-4.7.0/source4/dns_server/dnsserver_common.h	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dns_server/dnsserver_common.h	2017-11-02 12:38:36.000000000 +0100
@@ -47,6 +47,11 @@ WERROR dns_common_lookup(struct ldb_cont
 			 struct dnsp_DnssrvRpcRecord **records,
 			 uint16_t *num_records,
 			 bool *tombstoned);
+WERROR dns_common_wildcard_lookup(struct ldb_context *samdb,
+				  TALLOC_CTX *mem_ctx,
+				  struct ldb_dn *dn,
+				  struct dnsp_DnssrvRpcRecord **records,
+				  uint16_t *num_records);
 WERROR dns_name_check(TALLOC_CTX *mem_ctx,
 		      size_t len,
 		      const char *name);
diff -Npur samba-4.7.0/source4/dsdb/samdb/ldb_modules/repl_meta_data.c samba-4.7.1/source4/dsdb/samdb/ldb_modules/repl_meta_data.c
--- samba-4.7.0/source4/dsdb/samdb/ldb_modules/repl_meta_data.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/source4/dsdb/samdb/ldb_modules/repl_meta_data.c	2017-11-02 12:38:36.000000000 +0100
@@ -2090,6 +2090,37 @@ static int get_parsed_dns_trusted(struct
 }
 
 /*
+   Return LDB_SUCCESS if a parsed_dn list contains no duplicate values,
+   otherwise an error code. For compatibility the error code differs depending
+   on whether or not the attribute is "member".
+
+   As always, the parsed_dn list is assumed to be sorted.
+ */
+static int check_parsed_dn_duplicates(struct ldb_module *module,
+				      struct ldb_message_element *el,
+				      struct parsed_dn *pdn)
+{
+	unsigned int i;
+	struct ldb_context *ldb = ldb_module_get_ctx(module);
+
+	for (i = 1; i < el->num_values; i++) {
+		struct parsed_dn *p = &pdn[i];
+		if (parsed_dn_compare(p, &pdn[i - 1]) == 0) {
+			ldb_asprintf_errstring(ldb,
+					       "Linked attribute %s has "
+					       "multiple identical values",
+					       el->name);
+			if (ldb_attr_cmp(el->name, "member") == 0) {
+				return LDB_ERR_ENTRY_ALREADY_EXISTS;
+			} else {
+				return LDB_ERR_ATTRIBUTE_OR_VALUE_EXISTS;
+			}
+		}
+	}
+	return LDB_SUCCESS;
+}
+
+/*
   build a new extended DN, including all meta data fields
 
   RMD_FLAGS           = DSDB_RMD_FLAG_* bits
@@ -2898,6 +2929,12 @@ static int replmd_modify_la_replace(stru
 	if (ret != LDB_SUCCESS) {
 		talloc_free(tmp_ctx);
 		return ret;
+	}
+
+	ret = check_parsed_dn_duplicates(module, el, dns);
+	if (ret != LDB_SUCCESS) {
+		talloc_free(tmp_ctx);
+		return ret;
 	}
 
 	ret = get_parsed_dns(module, tmp_ctx, old_el, &old_dns,
diff -Npur samba-4.7.0/source4/dsdb/tests/python/linked_attributes.py samba-4.7.1/source4/dsdb/tests/python/linked_attributes.py
--- samba-4.7.0/source4/dsdb/tests/python/linked_attributes.py	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/dsdb/tests/python/linked_attributes.py	2017-11-02 12:38:36.000000000 +0100
@@ -464,6 +464,16 @@ class LATests(samba.tests.TestCase):
         self.assert_back_links(u3, [g1])
         self.assert_back_links(u4, [])
 
+        try:
+            # adding u2 twice should be an error
+            self.replace_linked_attribute(g2, [u1, u2, u3, u2])
+        except ldb.LdbError as (num, msg):
+            if num != ldb.ERR_ENTRY_ALREADY_EXISTS:
+                self.fail("adding duplicate values, expected "
+                          "ERR_ENTRY_ALREADY_EXISTS, (%d) "
+                          "got %d" % (ldb.ERR_ENTRY_ALREADY_EXISTS, num))
+        else:
+            self.fail("replacing duplicate values succeeded when it shouldn't")
 
     def test_la_links_replace2(self):
         users = self.add_objects(12, 'user', 'u_replace2')
diff -Npur samba-4.7.0/source4/param/pyparam.c samba-4.7.1/source4/param/pyparam.c
--- samba-4.7.0/source4/param/pyparam.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/param/pyparam.c	2017-11-02 12:38:36.000000000 +0100
@@ -331,6 +331,9 @@ static PyObject *py_lp_dump_a_parameter(
 
 	if (!ret) {
 		PyErr_Format(PyExc_RuntimeError, "Parameter %s unknown for section %s", param_name, section_name);
+		if (f != stdout) {
+			fclose(f);
+		}
 		return NULL;
 	}
 
@@ -479,6 +482,9 @@ static PyObject *py_lp_service_dump(PyOb
 
 	if (!PyObject_TypeCheck(py_default_service, &PyLoadparmService)) {
 		PyErr_SetNone(PyExc_TypeError);
+		if (f != stdout) {
+			fclose(f);
+		}
 		return NULL;
 	}
 
diff -Npur samba-4.7.0/source4/rpc_server/backupkey/dcesrv_backupkey.c samba-4.7.1/source4/rpc_server/backupkey/dcesrv_backupkey.c
--- samba-4.7.0/source4/rpc_server/backupkey/dcesrv_backupkey.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/rpc_server/backupkey/dcesrv_backupkey.c	2017-11-02 12:38:36.000000000 +0100
@@ -360,6 +360,8 @@ static WERROR get_and_verify_access_chec
 					  uint32_t access_check_len,
 					  struct auth_session_info *session_info)
 {
+	struct bkrp_access_check_v2 uncrypted_accesscheckv2;
+	struct bkrp_access_check_v3 uncrypted_accesscheckv3;
 	gnutls_cipher_hd_t cipher_handle = { 0 };
 	gnutls_cipher_algorithm_t cipher_algo;
 	DATA_BLOB blob_us;
@@ -422,7 +424,6 @@ static WERROR get_and_verify_access_chec
 		uint32_t hash_size = 20;
 		uint8_t hash[hash_size];
 		gnutls_hash_hd_t dig_ctx;
-		struct bkrp_access_check_v2 uncrypted_accesscheckv2;
 
 		ndr_err = ndr_pull_struct_blob(&blob_us, sub_ctx, &uncrypted_accesscheckv2,
 					(ndr_pull_flags_fn_t)ndr_pull_bkrp_access_check_v2);
@@ -457,7 +458,6 @@ static WERROR get_and_verify_access_chec
 		uint32_t hash_size = 64;
 		uint8_t hash[hash_size];
 		gnutls_hash_hd_t dig_ctx;
-		struct bkrp_access_check_v3 uncrypted_accesscheckv3;
 
 		ndr_err = ndr_pull_struct_blob(&blob_us, sub_ctx, &uncrypted_accesscheckv3,
 					(ndr_pull_flags_fn_t)ndr_pull_bkrp_access_check_v3);
diff -Npur samba-4.7.0/source4/rpc_server/dnsserver/dcerpc_dnsserver.c samba-4.7.1/source4/rpc_server/dnsserver/dcerpc_dnsserver.c
--- samba-4.7.0/source4/rpc_server/dnsserver/dcerpc_dnsserver.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/rpc_server/dnsserver/dcerpc_dnsserver.c	2017-11-02 12:38:36.000000000 +0100
@@ -1674,10 +1674,13 @@ static WERROR dnsserver_enumerate_root_r
 	/* Add any additional records */
 	if (select_flag & DNS_RPC_VIEW_ADDITIONAL_DATA) {
 		for (i=0; i<add_count; i++) {
+			char *encoded_name
+				= ldb_binary_encode_string(tmp_ctx,
+							   add_names[i]);
 			ret = ldb_search(dsstate->samdb, tmp_ctx, &res, z->zone_dn,
 					 LDB_SCOPE_ONELEVEL, attrs,
 					 "(&(objectClass=dnsNode)(name=%s)(!(dNSTombstoned=TRUE)))",
-					add_names[i]);
+					 encoded_name);
 			if (ret != LDB_SUCCESS || res->count == 0) {
 				talloc_free(res);
 				continue;
@@ -1744,10 +1747,12 @@ static WERROR dnsserver_enumerate_record
 				 LDB_SCOPE_ONELEVEL, attrs,
 				 "(&(objectClass=dnsNode)(!(dNSTombstoned=TRUE)))");
 	} else {
+		char *encoded_name
+			= ldb_binary_encode_string(tmp_ctx, name);
 		ret = ldb_search(dsstate->samdb, tmp_ctx, &res, z->zone_dn,
 				 LDB_SCOPE_ONELEVEL, attrs,
 				 "(&(objectClass=dnsNode)(|(name=%s)(name=*.%s))(!(dNSTombstoned=TRUE)))",
-				name, name);
+				 encoded_name, encoded_name);
 	}
 	if (ret != LDB_SUCCESS) {
 		talloc_free(tmp_ctx);
@@ -1818,11 +1823,15 @@ static WERROR dnsserver_enumerate_record
 
 			/* Search all the available zones for additional name */
 			for (z2 = dsstate->zones; z2; z2 = z2->next) {
+				char *encoded_name;
 				name = dns_split_node_name(tmp_ctx, add_names[i], z2->name);
+				encoded_name
+					= ldb_binary_encode_string(tmp_ctx,
+								   name);
 				ret = ldb_search(dsstate->samdb, tmp_ctx, &res, z2->zone_dn,
 						LDB_SCOPE_ONELEVEL, attrs,
 						"(&(objectClass=dnsNode)(name=%s)(!(dNSTombstoned=TRUE)))",
-						name);
+						encoded_name);
 				talloc_free(name);
 				if (ret != LDB_SUCCESS) {
 					continue;
diff -Npur samba-4.7.0/source4/rpc_server/dnsserver/dnsdb.c samba-4.7.1/source4/rpc_server/dnsserver/dnsdb.c
--- samba-4.7.0/source4/rpc_server/dnsserver/dnsdb.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/rpc_server/dnsserver/dnsdb.c	2017-11-02 12:38:36.000000000 +0100
@@ -364,10 +364,12 @@ WERROR dnsserver_db_add_empty_node(TALLO
 	const char * const attrs[] = { "name", NULL };
 	struct ldb_result *res;
 	struct ldb_dn *dn;
+	char *encoded_name = ldb_binary_encode_string(mem_ctx, name);
 	int ret;
 
 	ret = ldb_search(samdb, mem_ctx, &res, z->zone_dn, LDB_SCOPE_BASE, attrs,
-			"(&(objectClass=dnsNode)(name=%s))", name);
+			"(&(objectClass=dnsNode)(name=%s))",
+			 encoded_name);
 	if (ret != LDB_SUCCESS) {
 		return WERR_INTERNAL_DB_ERROR;
 	}
@@ -406,6 +408,7 @@ WERROR dnsserver_db_add_record(TALLOC_CT
 	int serial;
 	WERROR werr;
 	bool was_tombstoned = false;
+	char *encoded_name = ldb_binary_encode_string(mem_ctx, name);
 
 	werr = dns_to_dnsp_convert(mem_ctx, add_record, &rec, true);
 	if (!W_ERROR_IS_OK(werr)) {
@@ -436,7 +439,8 @@ WERROR dnsserver_db_add_record(TALLOC_CT
 	rec->dwTimeStamp = t;
 
 	ret = ldb_search(samdb, mem_ctx, &res, z->zone_dn, LDB_SCOPE_ONELEVEL, attrs,
-			"(&(objectClass=dnsNode)(name=%s))", name);
+			"(&(objectClass=dnsNode)(name=%s))",
+			 encoded_name);
 	if (ret != LDB_SUCCESS) {
 		return WERR_INTERNAL_DB_ERROR;
 	}
@@ -524,6 +528,7 @@ WERROR dnsserver_db_update_record(TALLOC
 	int ret, i;
 	int serial;
 	WERROR werr;
+	char *encoded_name = ldb_binary_encode_string(mem_ctx, name);
 
 	werr = dns_to_dnsp_convert(mem_ctx, add_record, &arec, true);
 	if (!W_ERROR_IS_OK(werr)) {
@@ -541,7 +546,8 @@ WERROR dnsserver_db_update_record(TALLOC
 	arec->dwTimeStamp = t;
 
 	ret = ldb_search(samdb, mem_ctx, &res, z->zone_dn, LDB_SCOPE_ONELEVEL, attrs,
-			"(&(objectClass=dnsNode)(name=%s)(!(dNSTombstoned=TRUE)))", name);
+			"(&(objectClass=dnsNode)(name=%s)(!(dNSTombstoned=TRUE)))",
+			 encoded_name);
 	if (ret != LDB_SUCCESS) {
 		return WERR_INTERNAL_DB_ERROR;
 	}
@@ -642,7 +648,8 @@ WERROR dnsserver_db_delete_record(TALLOC
 	}
 
 	ret = ldb_search(samdb, mem_ctx, &res, z->zone_dn, LDB_SCOPE_ONELEVEL, attrs,
-			"(&(objectClass=dnsNode)(name=%s))", name);
+			"(&(objectClass=dnsNode)(name=%s))",
+			 ldb_binary_encode_string(mem_ctx, name));
 	if (ret != LDB_SUCCESS) {
 		return WERR_INTERNAL_DB_ERROR;
 	}
@@ -650,6 +657,9 @@ WERROR dnsserver_db_delete_record(TALLOC
 	if (res->count == 0) {
 		return WERR_DNS_ERROR_RECORD_DOES_NOT_EXIST;
 	}
+	if (res->count > 1) {
+		return WERR_DNS_ERROR_RCODE_SERVER_FAILURE;
+	}
 
 	el = ldb_msg_find_element(res->msgs[0], "dnsRecord");
 	if (el == NULL || el->num_values == 0) {
diff -Npur samba-4.7.0/source4/scripting/bin/gen_ntstatus.py samba-4.7.1/source4/scripting/bin/gen_ntstatus.py
--- samba-4.7.0/source4/scripting/bin/gen_ntstatus.py	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/scripting/bin/gen_ntstatus.py	2017-11-02 12:38:36.000000000 +0100
@@ -32,7 +32,7 @@ def generateHeaderFile(out_file, errors)
     out_file.write("#ifndef _NTSTATUS_GEN_H\n")
     out_file.write("#define _NTSTATUS_GEN_H\n")
     for err in errors:
-        line = "#define %s NT_STATUS(%s)\n" % (err.err_define, hex(err.err_code))
+        line = "#define %s NT_STATUS(%#x)\n" % (err.err_define, err.err_code)
         out_file.write(line)
     out_file.write("\n#endif /* _NTSTATUS_GEN_H */\n")
 
diff -Npur samba-4.7.0/source4/selftest/tests.py samba-4.7.1/source4/selftest/tests.py
--- samba-4.7.0/source4/selftest/tests.py	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.1/source4/selftest/tests.py	2017-11-02 12:38:36.000000000 +0100
@@ -367,7 +367,7 @@ plantestsuite_loadlist("samba.tests.dns"
 plantestsuite_loadlist("samba.tests.dns_forwarder", "fl2003dc:local", [python, os.path.join(srcdir(), "python/samba/tests/dns_forwarder.py"), '$SERVER', '$SERVER_IP', '$DNS_FORWARDER1', '$DNS_FORWARDER2', '--machine-pass', '-U"$USERNAME%$PASSWORD"', '--workgroup=$DOMAIN', '$LOADLIST', '$LISTOPT'])
 
 plantestsuite_loadlist("samba.tests.dns_tkey", "fl2008r2dc", [python, os.path.join(srcdir(), "python/samba/tests/dns_tkey.py"), '$SERVER', '$SERVER_IP', '--machine-pass', '-U"$USERNAME%$PASSWORD"', '--workgroup=$DOMAIN', '$LOADLIST', '$LISTOPT'])
-
+plantestsuite_loadlist("samba.tests.dns_wildcard", "ad_dc", [python, os.path.join(srcdir(), "python/samba/tests/dns_wildcard.py"), '$SERVER', '$SERVER_IP', '--machine-pass', '-U"$USERNAME%$PASSWORD"', '--workgroup=$DOMAIN', '$LOADLIST', '$LISTOPT'])
 for t in smbtorture4_testsuites("dns_internal."):
     plansmbtorture4testsuite(t, "ad_dc_ntvfs:local", '//$SERVER/whavever')
 
diff -Npur samba-4.7.0/source4/torture/smb2/compound.c samba-4.7.1/source4/torture/smb2/compound.c
--- samba-4.7.0/source4/torture/smb2/compound.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/torture/smb2/compound.c	2017-11-02 12:38:36.000000000 +0100
@@ -671,6 +671,77 @@ done:
 	return ret;
 }
 
+static bool test_compound_create_write_close(struct torture_context *tctx,
+					     struct smb2_tree *tree)
+{
+	struct smb2_handle handle = { .data = { UINT64_MAX, UINT64_MAX } };
+	struct smb2_create create;
+	struct smb2_write write;
+	struct smb2_close close;
+	const char *fname = "compound_create_write_close.dat";
+	struct smb2_request *req[3];
+	NTSTATUS status;
+	bool ret = false;
+
+	smb2_util_unlink(tree, fname);
+
+	ZERO_STRUCT(create);
+	create.in.security_flags = 0x00;
+	create.in.oplock_level = 0;
+	create.in.impersonation_level = NTCREATEX_IMPERSONATION_IMPERSONATION;
+	create.in.create_flags = 0x00000000;
+	create.in.reserved = 0x00000000;
+	create.in.desired_access = SEC_RIGHTS_FILE_ALL;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN_IF;
+	create.in.create_options = NTCREATEX_OPTIONS_SEQUENTIAL_ONLY |
+		NTCREATEX_OPTIONS_ASYNC_ALERT |
+		NTCREATEX_OPTIONS_NON_DIRECTORY_FILE |
+		0x00200000;
+	create.in.fname = fname;
+
+	smb2_transport_compound_start(tree->session->transport, 3);
+
+	req[0] = smb2_create_send(tree, &create);
+
+	smb2_transport_compound_set_related(tree->session->transport, true);
+
+	ZERO_STRUCT(write);
+	write.in.file.handle = handle;
+	write.in.offset = 0;
+	write.in.data = data_blob_talloc(tctx, NULL, 1024);
+
+	req[1] = smb2_write_send(tree, &write);
+
+	ZERO_STRUCT(close);
+	close.in.file.handle = handle;
+
+	req[2] = smb2_close_send(tree, &close);
+
+	status = smb2_create_recv(req[0], tree, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CREATE failed.");
+
+	status = smb2_write_recv(req[1], &write);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"WRITE failed.");
+
+	status = smb2_close_recv(req[2], &close);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CLOSE failed.");
+
+	status = smb2_util_unlink(tree, fname);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"File deletion failed.");
+
+	ret = true;
+done:
+	return ret;
+}
+
 static bool test_compound_unrelated1(struct torture_context *tctx,
 				     struct smb2_tree *tree)
 {
@@ -1230,6 +1301,8 @@ struct torture_suite *torture_smb2_compo
 	torture_suite_add_1smb2_test(suite, "interim2",  test_compound_interim2);
 	torture_suite_add_1smb2_test(suite, "compound-break", test_compound_break);
 	torture_suite_add_1smb2_test(suite, "compound-padding", test_compound_padding);
+	torture_suite_add_1smb2_test(suite, "create-write-close",
+				     test_compound_create_write_close);
 
 	suite->description = talloc_strdup(suite, "SMB2-COMPOUND tests");
 
diff -Npur samba-4.7.0/source4/torture/smb2/notify.c samba-4.7.1/source4/torture/smb2/notify.c
--- samba-4.7.0/source4/torture/smb2/notify.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/torture/smb2/notify.c	2017-11-02 12:38:36.000000000 +0100
@@ -2354,6 +2354,151 @@ static bool torture_smb2_notify_rmdir4(s
 	return torture_smb2_notify_rmdir(torture, tree1, tree2, true);
 }
 
+static void notify_timeout(struct tevent_context *ev,
+			   struct tevent_timer *te,
+			   struct timeval current_time,
+			   void *private_data)
+{
+	struct smb2_request *req = talloc_get_type_abort(
+		private_data, struct smb2_request);
+
+	smb2_cancel(req);
+}
+
+static bool torture_smb2_inotify_rename(struct torture_context *torture,
+					struct smb2_tree *tree1,
+					struct smb2_tree *tree2)
+{
+	NTSTATUS status;
+	struct smb2_notify notify;
+	struct notify_changes change1 = {0};
+	struct notify_changes change2 = {0};
+	struct smb2_create create;
+	union smb_setfileinfo sinfo;
+	struct smb2_handle h1 = {{0}};
+	struct smb2_handle h2 = {{0}};
+	struct smb2_request *req;
+	struct tevent_timer *te = NULL;
+	bool ok = false;
+
+	smb2_deltree(tree1, BASEDIR);
+
+	torture_comment(torture, "Testing change notify of a rename with inotify\n");
+
+	status = torture_smb2_testdir(tree1, BASEDIR, &h1);
+	torture_assert_ntstatus_ok_goto(torture, status, ok, done, "torture_smb2_testdir failed");
+
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_RIGHTS_FILE_READ |
+		SEC_RIGHTS_FILE_WRITE|
+		SEC_RIGHTS_FILE_ALL;
+	create.in.create_options = NTCREATEX_OPTIONS_DIRECTORY;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN_IF;
+	create.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS;
+	create.in.fname = BASEDIR "\\subdir-name";
+
+	status = smb2_create(tree2, torture, &create);
+	torture_assert_ntstatus_ok_goto(torture, status, ok, done, "smb2_create failed\n");
+	h2 = create.out.file.handle;
+
+	ZERO_STRUCT(notify);
+	notify.level = RAW_NOTIFY_SMB2;
+	notify.in.buffer_size = 4096;
+	notify.in.completion_filter = FILE_NOTIFY_CHANGE_NAME;
+	notify.in.file.handle = h1;
+	notify.in.recursive = true;
+	req = smb2_notify_send(tree1, &notify);
+	torture_assert_not_null_goto(torture, req, ok, done, "smb2_notify_send failed\n");
+
+	while (!NT_STATUS_EQUAL(req->status, STATUS_PENDING)) {
+		if (tevent_loop_once(torture->ev) != 0) {
+			return false;
+		}
+	}
+
+	ZERO_STRUCT(sinfo);
+	sinfo.rename_information.level = RAW_SFILEINFO_RENAME_INFORMATION;
+	sinfo.rename_information.in.file.handle = h2;
+	sinfo.rename_information.in.new_name = BASEDIR "\\subdir-name-r";
+
+	status = smb2_setinfo_file(tree2, &sinfo);
+	torture_assert_ntstatus_ok_goto(torture, status, ok, done, "smb2_setinfo_file failed\n");
+
+	smb2_util_close(tree2, h2);
+
+	te = tevent_add_timer(torture->ev,
+			      tree1,
+			      tevent_timeval_current_ofs(1, 0),
+			      notify_timeout,
+			      req);
+	torture_assert_not_null_goto(torture, te, ok, done, "tevent_add_timer failed\n");
+
+	status = smb2_notify_recv(req, torture, &notify);
+	torture_assert_ntstatus_ok_goto(torture, status, ok, done, "smb2_notify_recv failed\n");
+
+	torture_assert_goto(torture, notify.out.num_changes == 1 || notify.out.num_changes == 2,
+			    ok, done, "bad notify\n");
+
+	change1 = notify.out.changes[0];
+	if (notify.out.num_changes == 2) {
+		change2 = notify.out.changes[1];
+	} else {
+		/*
+		 * We may only get one event at a time, so check for the
+		 * matching second event for the oldname/newname or
+		 * removed/added pair.
+		 */
+		ZERO_STRUCT(notify);
+		notify.level = RAW_NOTIFY_SMB2;
+		notify.in.buffer_size = 4096;
+		notify.in.completion_filter = FILE_NOTIFY_CHANGE_NAME;
+		notify.in.file.handle = h1;
+		notify.in.recursive = true;
+		req = smb2_notify_send(tree1, &notify);
+		torture_assert_not_null_goto(torture, req, ok, done, "smb2_notify_send failed\n");
+
+		status = smb2_notify_recv(req, torture, &notify);
+		torture_assert_ntstatus_ok_goto(torture, status, ok, done, "smb2_notify_recv failed\n");
+
+		torture_assert_goto(torture, notify.out.num_changes == 1, ok, done,
+				    "bad notify\n");
+
+		change2 = notify.out.changes[0];
+	}
+
+	if ((change1.action != NOTIFY_ACTION_OLD_NAME) &&
+	    (change1.action != NOTIFY_ACTION_REMOVED))
+	{
+		torture_fail_goto(torture, done, "bad change notification\n");
+	}
+	torture_assert_str_equal_goto(torture, change1.name.s, "subdir-name",
+			    ok, done, "bad change notification\n");
+
+	if ((change2.action != NOTIFY_ACTION_NEW_NAME) &&
+	    (change2.action != NOTIFY_ACTION_ADDED))
+	{
+		torture_fail_goto(torture, done, "bad change notification\n");
+	}
+	torture_assert_str_equal_goto(torture, change2.name.s, "subdir-name-r",
+			    ok, done, "bad change notification\n");
+
+	ok = true;
+done:
+	if (!smb2_util_handle_empty(h1)) {
+		smb2_util_close(tree2, h1);
+	}
+	if (!smb2_util_handle_empty(h2)) {
+		smb2_util_close(tree2, h2);
+	}
+
+	smb2_deltree(tree1, BASEDIR);
+	return ok;
+}
+
 /*
    basic testing of SMB2 change notify
 */
@@ -2393,3 +2538,16 @@ struct torture_suite *torture_smb2_notif
 	return suite;
 }
 
+/*
+   basic testing of SMB2 change notify
+*/
+struct torture_suite *torture_smb2_notify_inotify_init(TALLOC_CTX *ctx)
+{
+	struct torture_suite *suite = torture_suite_create(ctx, "notify-inotify");
+
+	suite->description = talloc_strdup(suite, "SMB2-NOTIFY tests that use inotify");
+
+	torture_suite_add_2smb2_test(suite, "inotify-rename", torture_smb2_inotify_rename);
+
+	return suite;
+}
diff -Npur samba-4.7.0/source4/torture/smb2/smb2.c samba-4.7.1/source4/torture/smb2/smb2.c
--- samba-4.7.0/source4/torture/smb2/smb2.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.1/source4/torture/smb2/smb2.c	2017-11-02 12:38:36.000000000 +0100
@@ -155,6 +155,7 @@ NTSTATUS torture_smb2_init(TALLOC_CTX *c
 	torture_suite_add_suite(suite, torture_smb2_create_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_acls_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_notify_init(suite));
+	torture_suite_add_suite(suite, torture_smb2_notify_inotify_init(suite));
 	torture_suite_add_suite(suite,
 		torture_smb2_notify_disabled_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_durable_open_init(suite));
diff -Npur samba-4.7.0/source4/torture/vfs/fruit.c samba-4.7.1/source4/torture/vfs/fruit.c
--- samba-4.7.0/source4/torture/vfs/fruit.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.1/source4/torture/vfs/fruit.c	2017-11-02 12:38:36.000000000 +0100
@@ -237,22 +237,107 @@ Offset     : 00000032 : 50
 Length     : 00000EB0 : 3760
 
 -FInfo-----:
-Type       : 54455854 : TEXT
-Creator    : 21526368 : !Rch
-...
+Type       : 54455354 : TEST
+Creator    : 534C4F57 : SLOW
+isAlias    : 0
+Invisible  : 0
+hasBundle  : 0
+nameLocked : 0
+Stationery : 0
+CustomIcon : 0
+Reserved   : 0
+Inited     : 0
+NoINITS    : 0
+Shared     : 0
+SwitchLaunc: 0
+Hidden Ext : 0
+color      : 100      : blue
+isOnDesk   : 0
+Location v : 0000     : 0
+Location h : 0000     : 0
+Fldr       : 0000     : ..
+
+-FXInfo----:
+Rsvd|IconID: 0000     : 0
+Rsvd       : 0000     : ..
+Rsvd       : 0000     : ..
+Rsvd       : 0000     : ..
+AreInvalid : 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+CustomBadge: 0
+ObjctIsBusy: 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+unknown bit: 0
+RoutingInfo: 0
+unknown bit: 0
+unknown bit: 0
+Rsvd|commnt: 0000     : 0
+PutAway    : 00000000 : 0
 
 -EA--------:
 pad        : 0000     : ..
 magic      : 41545452 : ATTR
-debug_tag  : 0007F98E : 522638
+debug_tag  : 53D4580C : 1406425100
 total_size : 00000EE2 : 3810
-data_start : 00000078 : 120
-data_length: 00000000 : 0
+data_start : 000000BC : 188
+data_length: 0000005E : 94
 reserved[0]: 00000000 : ....
 reserved[1]: 00000000 : ....
 reserved[2]: 00000000 : ....
 flags      : 0000     : ..
-num_attrs  : 0000     : 0
+num_attrs  : 0002     : 2
+-EA ENTRY--:
+offset     : 000000BC : 188
+length     : 0000005B : 91
+flags      : 0000     : ..
+namelen    : 24       : 36
+-EA NAME---:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+00000000   : 63 6F 6D 2E 61 70 70 6C 65 2E 6D 65 74 61 64 61 : com.apple.metada
+00000010   : 74 61 3A 5F 6B 4D 44 49 74 65 6D 55 73 65 72 54 : ta:_kMDItemUserT
+00000020   : 61 67 73 00                                     : ags.
+-EA VALUE--:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+00000000   : 62 70 6C 69 73 74 30 30 A5 01 02 03 04 05 54 74 : bplist00......Tt
+00000010   : 65 73 74 66 00 47 00 72 00 FC 00 6E 00 0A 00 32 : estf.G.r...n...2
+00000020   : 56 4C 69 6C 61 0A 33 56 47 65 6C 62 0A 35 56 42 : VLila.3VGelb.5VB
+00000030   : 6C 61 75 0A 34 08 0E 13 20 27 2E 00 00 00 00 00 : lau.4... '......
+00000040   : 00 01 01 00 00 00 00 00 00 00 06 00 00 00 00 00 : ................
+00000050   : 00 00 00 00 00 00 00 00 00 00 35                : ..........5
+-EA ENTRY--:
+offset     : 00000117 : 279
+length     : 00000003 : 3
+flags      : 0000     : ..
+namelen    : 08       : 8
+-EA NAME---:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+00000000   : 66 6F 6F 3A 62 61 72 00                         : foo:bar.
+-EA VALUE--:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+00000000   : 62 61 7A                                        : baz
+
+-RAW DUMP--:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+00000000   : 54 45 53 54 53 4C 4F 57 00 08 00 00 00 00 00 00 : TESTSLOW........
+00000010   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000020   : 00 00 41 54 54 52 53 D4 58 0C 00 00 0E E2 00 00 : ..ATTRS.X.......
+00000030   : 00 BC 00 00 00 5E 00 00 00 00 00 00 00 00 00 00 : .....^..........
+00000040   : 00 00 00 00 00 02 00 00 00 BC 00 00 00 5B 00 00 : .............[..
+00000050   : 24 63 6F 6D 2E 61 70 70 6C 65 2E 6D 65 74 61 64 : $com.apple.metad
+00000060   : 61 74 61 3A 5F 6B 4D 44 49 74 65 6D 55 73 65 72 : ata:_kMDItemUser
+00000070   : 54 61 67 73 00 00 00 00 01 17 00 00 00 03 00 00 : Tags............
+00000080   : 08 66 6F 6F 3A 62 61 72 00 66 62 70 6C 69 73 74 : .foo:bar.fbplist
+00000090   : 30 30 A5 01 02 03 04 05 54 74 65 73 74 66 00 47 : 00......Ttestf.G
+000000A0   : 00 72 00 FC 00 6E 00 0A 00 32 56 4C 69 6C 61 0A : .r...n...2VLila.
+000000B0   : 33 56 47 65 6C 62 0A 35 56 42 6C 61 75 0A 34 08 : 3VGelb.5VBlau.4.
+000000C0   : 0E 13 20 27 2E 00 00 00 00 00 00 01 01 00 00 00 : .. '............
+000000D0   : 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000E0   : 00 00 00 00 35 62 61 7A 00 00 00 00 00 00 00 00 : ....5baz........
+000000F0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+... all zeroes ...
+00000EA0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
 
 -------------------------------------------------------------------------------
 Entry ID   : 00000002 : Resource Fork
@@ -264,8 +349,23 @@ Length     : 0000011E : 286
 00000010   : 54 68 69 73 20 72 65 73 6F 75 72 63 65 20 66 6F : This resource fo
 00000020   : 72 6B 20 69 6E 74 65 6E 74 69 6F 6E 61 6C 6C 79 : rk intentionally
 00000030   : 20 6C 65 66 74 20 62 6C 61 6E 6B 20 20 20 00 00 :  left blank   ..
-...
+00000040   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000050   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000060   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000070   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000080   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000090   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000A0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000B0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000C0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000D0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000E0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+000000F0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+00000100   : 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 1E : ................
 00000110   : 00 00 00 00 00 00 00 00 00 1C 00 1E FF FF       : ..............
+
+It was created with:
+$ hexdump -ve '"\t" 7/1 "0x%02x, " 1/1 " 0x%02x," "\n"'
 */
 static char osx_adouble_w_xattr[] = {
 	0x00, 0x05, 0x16, 0x07, 0x00, 0x02, 0x00, 0x00,
@@ -274,36 +374,36 @@ static char osx_adouble_w_xattr[] = {
 	0x00, 0x02, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00,
 	0x00, 0x32, 0x00, 0x00, 0x0e, 0xb0, 0x00, 0x00,
 	0x00, 0x02, 0x00, 0x00, 0x0e, 0xe2, 0x00, 0x00,
-	0x01, 0x1e, 0x54, 0x45, 0x58, 0x54, 0x21, 0x52,
-	0x63, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x01, 0x1e, 0x54, 0x45, 0x53, 0x54, 0x53, 0x4c,
+	0x4f, 0x57, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x41, 0x54, 0x54, 0x52,
-	0x00, 0x07, 0xf9, 0x8e, 0x00, 0x00, 0x0e, 0xe2,
-	0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x53, 0xd4, 0x58, 0x0c, 0x00, 0x00, 0x0e, 0xe2,
+	0x00, 0x00, 0x00, 0xbc, 0x00, 0x00, 0x00, 0x5e,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
+	0x00, 0x00, 0x00, 0xbc, 0x00, 0x00, 0x00, 0x5b,
+	0x00, 0x00, 0x24, 0x63, 0x6f, 0x6d, 0x2e, 0x61,
+	0x70, 0x70, 0x6c, 0x65, 0x2e, 0x6d, 0x65, 0x74,
+	0x61, 0x64, 0x61, 0x74, 0x61, 0x3a, 0x5f, 0x6b,
+	0x4d, 0x44, 0x49, 0x74, 0x65, 0x6d, 0x55, 0x73,
+	0x65, 0x72, 0x54, 0x61, 0x67, 0x73, 0x00, 0x00,
+	0x00, 0x00, 0x01, 0x17, 0x00, 0x00, 0x00, 0x03,
+	0x00, 0x00, 0x08, 0x66, 0x6f, 0x6f, 0x3a, 0x62,
+	0x61, 0x72, 0x00, 0x66, 0x62, 0x70, 0x6c, 0x69,
+	0x73, 0x74, 0x30, 0x30, 0xa5, 0x01, 0x02, 0x03,
+	0x04, 0x05, 0x54, 0x74, 0x65, 0x73, 0x74, 0x66,
+	0x00, 0x47, 0x00, 0x72, 0x00, 0xfc, 0x00, 0x6e,
+	0x00, 0x0a, 0x00, 0x32, 0x56, 0x4c, 0x69, 0x6c,
+	0x61, 0x0a, 0x33, 0x56, 0x47, 0x65, 0x6c, 0x62,
+	0x0a, 0x35, 0x56, 0x42, 0x6c, 0x61, 0x75, 0x0a,
+	0x34, 0x08, 0x0e, 0x13, 0x20, 0x27, 0x2e, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x35, 0x62,
+	0x61, 0x7a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
@@ -1936,6 +2036,11 @@ static bool test_adouble_conversion(stru
 			    fname, AFPRESOURCE_STREAM,
 			    16, datalen, 0, datalen, data);
 
+	ret &= check_stream(tree, __location__, tctx, mem_ctx,
+			    fname,
+			    ":foo" "\xef\x80\xa2" "bar:$DATA", /* "foo:bar:$DATA" */
+			    0, 3, 0, 3, "baz");
+
 done:
 	smb2_deltree(tree, BASEDIR);
 	talloc_free(mem_ctx);
