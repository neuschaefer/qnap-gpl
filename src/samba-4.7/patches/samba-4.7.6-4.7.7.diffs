diff -Npur samba-4.7.6/VERSION samba-4.7.7/VERSION
--- samba-4.7.6/VERSION	2018-03-12 09:53:46.000000000 +0100
+++ samba-4.7.7/VERSION	2018-04-17 09:35:02.000000000 +0200
@@ -25,7 +25,7 @@
 ########################################################
 SAMBA_VERSION_MAJOR=4
 SAMBA_VERSION_MINOR=7
-SAMBA_VERSION_RELEASE=6
+SAMBA_VERSION_RELEASE=7
 
 ########################################################
 # If a official release has a serious bug              #
diff -Npur samba-4.7.6/WHATSNEW.txt samba-4.7.7/WHATSNEW.txt
--- samba-4.7.6/WHATSNEW.txt	2018-03-12 09:53:25.000000000 +0100
+++ samba-4.7.7/WHATSNEW.txt	2018-04-17 09:35:02.000000000 +0200
@@ -1,4 +1,109 @@
                    =============================
+                   Release Notes for Samba 4.7.7
+                           April 17, 2018
+                   =============================
+
+
+This is the latest stable release of the Samba 4.7 release series.
+
+
+Changes since 4.7.6:
+--------------------
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13206: s4:auth_sam: Allow logons with an empty domain name.
+   * BUG 13244: s3: ldap: Ensure the ADS_STRUCT pointer doesn't get freed on
+     error, we don't own it here.
+   * BUG 13270: s3: smbd: Fix possible directory fd leak if the underlying
+     OS doesn't support fdopendir().
+   * BUG 13319: Round-tripping ACL get/set through vfs_fruit will increase
+     the number of ACE entries without limit.
+   * BUG 13347: s3: smbd: SMB2: Add DBGC_SMB2_CREDITS class to specifically
+     debug credit issues.
+   * BUG 13358: s3: smbd: Files or directories can't be opened DELETE_ON_CLOSE
+     without delete access.
+   * BUG 13372: s3: smbd: Fix memory leak in vfswrap_getwd().
+   * BUG 13375: s3: smbd: Unix extensions attempts to change wrong field
+     in fchown call.
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 13363: s3:smbd: Don't use the directory cache for SMB2/3.
+
+o  GÃ¼nther Deschner <gd@samba.org>
+   * BUG 13277: build: Fix libceph-common detection.
+
+o  David Disseldorp <ddiss@suse.de>
+   * BUG 13250: build: Fix ceph_statx check when configured with libcephfs_dir.
+
+o  Poornima G <pgurusid@redhat.com>
+   * BUG 13297: vfs_glusterfs: Fix the wrong pointer being sent in
+     glfs_fsync_async.
+
+o  Amitay Isaacs <amitay@gmail.com>
+   * BUG 13359: ctdb-scripts: Drop 'net serverid wipe' from 50.samba event
+     script.
+
+o  Lutz Justen <ljusten@google.com>
+   * BUG 13368: s3: lib: messages: Don't use the result of sec_init() before
+     calling sec_init().
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13215: smbd can panic if the client-supplied channel sequence number
+     wraps.
+   * BUG 13367: dsdb: Fix CID 1034966 Uninitialized scalar variable.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13206: s3:libsmb: Allow -U"\\administrator" to work.
+   * BUG 13328: Windows 10 cannot logon on Samba NT4 domain.
+
+o  David Mulder <dmulder@suse.com>
+   * BUG 13050: smbc_opendir should not return EEXIST with invalid login
+     credentials.
+
+o  Anton Nefedov
+   * BUG 13338: s3:smbd: map nterror on smb2_flush errorpath.
+
+o  Dan Robertson <drobertson@tripwire.com>
+   * BUG 13310: libsmb: Use smb2 tcon if conn_protocol >= SMB2_02.
+
+o  Garming Sam <garming@catalyst.net.nz>
+   * BUG 13031: subnet: Avoid a segfault when renaming subnet objects.
+
+o  Christof Schmitt <cs@samba.org>
+   * BUG 13312: 'wbinfo --name-to-sid' returns misleading result on invalid
+     query.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 13315: s3:smbd: Do not crash if we fail to init the session table.
+
+o  Eric Vannier <evannier@google.com>
+   * BUG 13302: Allow AESNI to be used on all processor supporting AESNI.
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
+                   =============================
                    Release Notes for Samba 4.7.6
                            March 13, 2018
                    =============================
@@ -71,8 +176,8 @@ database (https://bugzilla.samba.org/).
 ======================================================================
 
 
-Release notes for older releases follow:
-----------------------------------------
+----------------------------------------------------------------------
+
 
                    =============================
                    Release Notes for Samba 4.7.5
diff -Npur samba-4.7.6/auth/auth_sam_reply.c samba-4.7.7/auth/auth_sam_reply.c
--- samba-4.7.6/auth/auth_sam_reply.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/auth/auth_sam_reply.c	2018-04-17 09:35:02.000000000 +0200
@@ -333,6 +333,41 @@ NTSTATUS make_user_info_SamBaseInfo(TALL
 	return NT_STATUS_OK;
 }
 
+struct auth_user_info *auth_user_info_copy(TALLOC_CTX *mem_ctx,
+					   const struct auth_user_info *src)
+{
+	struct auth_user_info *dst = NULL;
+
+	dst = talloc_zero(mem_ctx, struct auth_user_info);
+	if (dst == NULL) {
+		return NULL;
+	}
+
+	*dst = *src;
+#define _COPY_STRING(_mem, _str) do { \
+	if ((_str) != NULL) { \
+		(_str) = talloc_strdup((_mem), (_str)); \
+		if ((_str) == NULL) { \
+			TALLOC_FREE(dst); \
+			return NULL; \
+		} \
+	} \
+} while(0)
+	_COPY_STRING(dst, dst->account_name);
+	_COPY_STRING(dst, dst->user_principal_name);
+	_COPY_STRING(dst, dst->domain_name);
+	_COPY_STRING(dst, dst->dns_domain_name);
+	_COPY_STRING(dst, dst->full_name);
+	_COPY_STRING(dst, dst->logon_script);
+	_COPY_STRING(dst, dst->profile_path);
+	_COPY_STRING(dst, dst->home_directory);
+	_COPY_STRING(dst, dst->home_drive);
+	_COPY_STRING(dst, dst->logon_server);
+#undef _COPY_STRING
+
+	return dst;
+}
+
 /**
  * Make a user_info_dc struct from the info3 returned by a domain logon
  */
diff -Npur samba-4.7.6/auth/auth_sam_reply.h samba-4.7.7/auth/auth_sam_reply.h
--- samba-4.7.6/auth/auth_sam_reply.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/auth/auth_sam_reply.h	2018-04-17 09:35:02.000000000 +0200
@@ -38,6 +38,9 @@ NTSTATUS make_user_info_SamBaseInfo(TALL
 				    bool authenticated,
 				    struct auth_user_info **_user_info);
 
+struct auth_user_info *auth_user_info_copy(TALLOC_CTX *mem_ctx,
+					   const struct auth_user_info *src);
+
 NTSTATUS auth_convert_user_info_dc_saminfo6(TALLOC_CTX *mem_ctx,
 					   const struct auth_user_info_dc *user_info_dc,
 					   struct netr_SamInfo6 **_sam6);
diff -Npur samba-4.7.6/auth/credentials/tests/bind.py samba-4.7.7/auth/credentials/tests/bind.py
--- samba-4.7.6/auth/credentials/tests/bind.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/auth/credentials/tests/bind.py	2018-04-17 09:35:02.000000000 +0200
@@ -43,6 +43,7 @@ creds_machine = copy.deepcopy(creds)
 creds_user1 = copy.deepcopy(creds)
 creds_user2 = copy.deepcopy(creds)
 creds_user3 = copy.deepcopy(creds)
+creds_user4 = copy.deepcopy(creds)
 
 class BindTests(samba.tests.TestCase):
 
@@ -64,7 +65,7 @@ class BindTests(samba.tests.TestCase):
         self.config_dn = self.info_dc["configurationNamingContext"][0]
         self.computer_dn = "CN=centos53,CN=Computers,%s" % self.domain_dn
         self.password = "P@ssw0rd"
-        self.username = "BindTestUser_" + time.strftime("%s", time.gmtime())
+        self.username = "BindTestUser"
 
     def tearDown(self):
         super(BindTests, self).tearDown()
@@ -113,6 +114,7 @@ unicodePwd:: """ + base64.b64encode("\"P
                                       expression="(samAccountName=%s)" % self.username)
         self.assertEquals(len(ldb_res), 1)
         user_dn = ldb_res[0]["dn"]
+        self.addCleanup(delete_force, self.ldb, user_dn)
 
         # do a simple bind and search with the user account in format user@realm
         creds_user1.set_bind_dn(self.username + "@" + creds.get_realm())
@@ -138,5 +140,27 @@ unicodePwd:: """ + base64.b64encode("\"P
                                               lp=lp, ldap_only=True)
         res = ldb_user3.search(base="", expression="", scope=SCOPE_BASE, attrs=["*"])
 
+    def test_user_account_bind_no_domain(self):
+        # create user
+        self.ldb.newuser(username=self.username, password=self.password)
+        ldb_res = self.ldb.search(base=self.domain_dn,
+                                      scope=SCOPE_SUBTREE,
+                                      expression="(samAccountName=%s)" % self.username)
+        self.assertEquals(len(ldb_res), 1)
+        user_dn = ldb_res[0]["dn"]
+        self.addCleanup(delete_force, self.ldb, user_dn)
+
+        creds_user4.set_username(self.username)
+        creds_user4.set_password(self.password)
+        creds_user4.set_domain('')
+        creds_user4.set_workstation('')
+        print "BindTest (no domain) with: " + self.username
+        try:
+            ldb_user4 = samba.tests.connect_samdb(host, credentials=creds_user4,
+                                              lp=lp, ldap_only=True)
+        except:
+            self.fail("Failed to connect without the domain set")
+
+        res = ldb_user4.search(base="", expression="", scope=SCOPE_BASE, attrs=["*"])
 
 TestProgram(module=__name__, opts=subunitopts)
diff -Npur samba-4.7.6/ctdb/config/events.d/50.samba samba-4.7.7/ctdb/config/events.d/50.samba
--- samba-4.7.6/ctdb/config/events.d/50.samba	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/ctdb/config/events.d/50.samba	2018-04-17 09:35:02.000000000 +0200
@@ -53,8 +53,6 @@ service_start ()
     # start Samba service. Start it reniced, as under very heavy load
     # the number of smbd processes will mean that it leaves few cycles
     # for anything else
-    net serverid wipe
-
     if [ -n "$CTDB_SERVICE_NMB" ] ; then
 	nice_service "$CTDB_SERVICE_NMB" start || die "Failed to start nmbd"
     fi
diff -Npur samba-4.7.6/ctdb/doc/ctdb-etcd.7 samba-4.7.7/ctdb/doc/ctdb-etcd.7
--- samba-4.7.6/ctdb/doc/ctdb-etcd.7	2018-03-12 09:55:27.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb-etcd.7	2018-04-17 09:40:13.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb-statistics.7 samba-4.7.7/ctdb/doc/ctdb-statistics.7
--- samba-4.7.6/ctdb/doc/ctdb-statistics.7	2018-03-12 09:55:26.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb-statistics.7	2018-04-17 09:40:12.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb-tunables.7 samba-4.7.7/ctdb/doc/ctdb-tunables.7
--- samba-4.7.6/ctdb/doc/ctdb-tunables.7	2018-03-12 09:55:27.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb-tunables.7	2018-04-17 09:40:13.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb.1 samba-4.7.7/ctdb/doc/ctdb.1
--- samba-4.7.6/ctdb/doc/ctdb.1	2018-03-12 09:55:23.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb.1	2018-04-17 09:40:09.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb.7 samba-4.7.7/ctdb/doc/ctdb.7
--- samba-4.7.6/ctdb/doc/ctdb.7	2018-03-12 09:55:26.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb.7	2018-04-17 09:40:12.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb_diagnostics.1 samba-4.7.7/ctdb/doc/ctdb_diagnostics.1
--- samba-4.7.6/ctdb/doc/ctdb_diagnostics.1	2018-03-12 09:55:25.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb_diagnostics.1	2018-04-17 09:40:11.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.7.7/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.7.6/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-03-12 09:55:27.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-04-17 09:40:13.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdbd.1 samba-4.7.7/ctdb/doc/ctdbd.1
--- samba-4.7.6/ctdb/doc/ctdbd.1	2018-03-12 09:55:24.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdbd.1	2018-04-17 09:40:10.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdbd.conf.5 samba-4.7.7/ctdb/doc/ctdbd.conf.5
--- samba-4.7.6/ctdb/doc/ctdbd.conf.5	2018-03-12 09:55:26.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdbd.conf.5	2018-04-17 09:40:12.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ctdbd_wrapper.1 samba-4.7.7/ctdb/doc/ctdbd_wrapper.1
--- samba-4.7.6/ctdb/doc/ctdbd_wrapper.1	2018-03-12 09:55:25.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ctdbd_wrapper.1	2018-04-17 09:40:11.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ltdbtool.1 samba-4.7.7/ctdb/doc/ltdbtool.1
--- samba-4.7.6/ctdb/doc/ltdbtool.1	2018-03-12 09:55:24.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ltdbtool.1	2018-04-17 09:40:10.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/onnode.1 samba-4.7.7/ctdb/doc/onnode.1
--- samba-4.7.6/ctdb/doc/onnode.1	2018-03-12 09:55:25.000000000 +0100
+++ samba-4.7.7/ctdb/doc/onnode.1	2018-04-17 09:40:11.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/ctdb/doc/ping_pong.1 samba-4.7.7/ctdb/doc/ping_pong.1
--- samba-4.7.6/ctdb/doc/ping_pong.1	2018-03-12 09:55:24.000000000 +0100
+++ samba-4.7.7/ctdb/doc/ping_pong.1	2018-04-17 09:40:10.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "03/12/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "04/17/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/cifsdd.8 samba-4.7.7/docs/manpages/cifsdd.8
--- samba-4.7.6/docs/manpages/cifsdd.8	2018-03-12 09:55:29.000000000 +0100
+++ samba-4.7.7/docs/manpages/cifsdd.8	2018-04-17 09:40:15.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "CIFSDD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/dbwrap_tool.1 samba-4.7.7/docs/manpages/dbwrap_tool.1
--- samba-4.7.6/docs/manpages/dbwrap_tool.1	2018-03-12 09:55:29.000000000 +0100
+++ samba-4.7.7/docs/manpages/dbwrap_tool.1	2018-04-17 09:40:15.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/eventlogadm.8 samba-4.7.7/docs/manpages/eventlogadm.8
--- samba-4.7.6/docs/manpages/eventlogadm.8	2018-03-12 09:55:29.000000000 +0100
+++ samba-4.7.7/docs/manpages/eventlogadm.8	2018-04-17 09:40:15.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "EVENTLOGADM" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/findsmb.1 samba-4.7.7/docs/manpages/findsmb.1
--- samba-4.7.6/docs/manpages/findsmb.1	2018-03-12 09:55:30.000000000 +0100
+++ samba-4.7.7/docs/manpages/findsmb.1	2018-04-17 09:40:16.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "FINDSMB" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_ad.8 samba-4.7.7/docs/manpages/idmap_ad.8
--- samba-4.7.6/docs/manpages/idmap_ad.8	2018-03-12 09:55:30.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_ad.8	2018-04-17 09:40:16.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_autorid.8 samba-4.7.7/docs/manpages/idmap_autorid.8
--- samba-4.7.6/docs/manpages/idmap_autorid.8	2018-03-12 09:55:30.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_autorid.8	2018-04-17 09:40:16.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_hash.8 samba-4.7.7/docs/manpages/idmap_hash.8
--- samba-4.7.6/docs/manpages/idmap_hash.8	2018-03-12 09:55:30.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_hash.8	2018-04-17 09:40:16.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_HASH" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_ldap.8 samba-4.7.7/docs/manpages/idmap_ldap.8
--- samba-4.7.6/docs/manpages/idmap_ldap.8	2018-03-12 09:55:30.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_ldap.8	2018-04-17 09:40:16.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_nss.8 samba-4.7.7/docs/manpages/idmap_nss.8
--- samba-4.7.6/docs/manpages/idmap_nss.8	2018-03-12 09:55:31.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_nss.8	2018-04-17 09:40:17.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_NSS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_rfc2307.8 samba-4.7.7/docs/manpages/idmap_rfc2307.8
--- samba-4.7.6/docs/manpages/idmap_rfc2307.8	2018-03-12 09:55:31.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_rfc2307.8	2018-04-17 09:40:17.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_rid.8 samba-4.7.7/docs/manpages/idmap_rid.8
--- samba-4.7.6/docs/manpages/idmap_rid.8	2018-03-12 09:55:31.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_rid.8	2018-04-17 09:40:17.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RID" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_script.8 samba-4.7.7/docs/manpages/idmap_script.8
--- samba-4.7.6/docs/manpages/idmap_script.8	2018-03-12 09:55:31.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_script.8	2018-04-17 09:40:17.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_tdb.8 samba-4.7.7/docs/manpages/idmap_tdb.8
--- samba-4.7.6/docs/manpages/idmap_tdb.8	2018-03-12 09:55:31.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_tdb.8	2018-04-17 09:40:17.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/idmap_tdb2.8 samba-4.7.7/docs/manpages/idmap_tdb2.8
--- samba-4.7.6/docs/manpages/idmap_tdb2.8	2018-03-12 09:55:32.000000000 +0100
+++ samba-4.7.7/docs/manpages/idmap_tdb2.8	2018-04-17 09:40:18.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/libsmbclient.7 samba-4.7.7/docs/manpages/libsmbclient.7
--- samba-4.7.6/docs/manpages/libsmbclient.7	2018-03-12 09:55:32.000000000 +0100
+++ samba-4.7.7/docs/manpages/libsmbclient.7	2018-04-17 09:40:18.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "03/12/2018" "Samba 4\&.7" "7"
+.TH "LIBSMBCLIENT" "7" "04/17/2018" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/lmhosts.5 samba-4.7.7/docs/manpages/lmhosts.5
--- samba-4.7.6/docs/manpages/lmhosts.5	2018-03-12 09:55:32.000000000 +0100
+++ samba-4.7.7/docs/manpages/lmhosts.5	2018-04-17 09:40:18.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "03/12/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "04/17/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/log2pcap.1 samba-4.7.7/docs/manpages/log2pcap.1
--- samba-4.7.6/docs/manpages/log2pcap.1	2018-03-12 09:55:32.000000000 +0100
+++ samba-4.7.7/docs/manpages/log2pcap.1	2018-04-17 09:40:18.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "LOG2PCAP" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/mvxattr.1 samba-4.7.7/docs/manpages/mvxattr.1
--- samba-4.7.6/docs/manpages/mvxattr.1	2018-03-12 09:55:32.000000000 +0100
+++ samba-4.7.7/docs/manpages/mvxattr.1	2018-04-17 09:40:18.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "MVXATTR" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/net.8 samba-4.7.7/docs/manpages/net.8
--- samba-4.7.6/docs/manpages/net.8	2018-03-12 09:55:33.000000000 +0100
+++ samba-4.7.7/docs/manpages/net.8	2018-04-17 09:40:19.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NET" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "NET" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/nmbd.8 samba-4.7.7/docs/manpages/nmbd.8
--- samba-4.7.6/docs/manpages/nmbd.8	2018-03-12 09:55:33.000000000 +0100
+++ samba-4.7.7/docs/manpages/nmbd.8	2018-04-17 09:40:19.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "NMBD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/nmblookup.1 samba-4.7.7/docs/manpages/nmblookup.1
--- samba-4.7.6/docs/manpages/nmblookup.1	2018-03-12 09:55:33.000000000 +0100
+++ samba-4.7.7/docs/manpages/nmblookup.1	2018-04-17 09:40:19.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "NMBLOOKUP" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/ntlm_auth.1 samba-4.7.7/docs/manpages/ntlm_auth.1
--- samba-4.7.6/docs/manpages/ntlm_auth.1	2018-03-12 09:55:33.000000000 +0100
+++ samba-4.7.7/docs/manpages/ntlm_auth.1	2018-04-17 09:40:19.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "NTLM_AUTH" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/pam_winbind.8 samba-4.7.7/docs/manpages/pam_winbind.8
--- samba-4.7.6/docs/manpages/pam_winbind.8	2018-03-12 09:55:34.000000000 +0100
+++ samba-4.7.7/docs/manpages/pam_winbind.8	2018-04-17 09:40:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: 8
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "03/12/2018" "Samba 4\&.7" "8"
+.TH "PAM_WINBIND" "8" "04/17/2018" "Samba 4\&.7" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/pam_winbind.conf.5 samba-4.7.7/docs/manpages/pam_winbind.conf.5
--- samba-4.7.6/docs/manpages/pam_winbind.conf.5	2018-03-12 09:55:34.000000000 +0100
+++ samba-4.7.7/docs/manpages/pam_winbind.conf.5	2018-04-17 09:40:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: 5
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "03/12/2018" "Samba 4\&.7" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "04/17/2018" "Samba 4\&.7" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/pdbedit.8 samba-4.7.7/docs/manpages/pdbedit.8
--- samba-4.7.6/docs/manpages/pdbedit.8	2018-03-12 09:55:34.000000000 +0100
+++ samba-4.7.7/docs/manpages/pdbedit.8	2018-04-17 09:40:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "PDBEDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/profiles.1 samba-4.7.7/docs/manpages/profiles.1
--- samba-4.7.6/docs/manpages/profiles.1	2018-03-12 09:55:34.000000000 +0100
+++ samba-4.7.7/docs/manpages/profiles.1	2018-04-17 09:40:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "PROFILES" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/rpcclient.1 samba-4.7.7/docs/manpages/rpcclient.1
--- samba-4.7.6/docs/manpages/rpcclient.1	2018-03-12 09:55:35.000000000 +0100
+++ samba-4.7.7/docs/manpages/rpcclient.1	2018-04-17 09:40:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "RPCCLIENT" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/samba-regedit.8 samba-4.7.7/docs/manpages/samba-regedit.8
--- samba-4.7.6/docs/manpages/samba-regedit.8	2018-03-12 09:55:35.000000000 +0100
+++ samba-4.7.7/docs/manpages/samba-regedit.8	2018-04-17 09:40:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/samba-tool.8 samba-4.7.7/docs/manpages/samba-tool.8
--- samba-4.7.6/docs/manpages/samba-tool.8	2018-03-12 09:55:35.000000000 +0100
+++ samba-4.7.7/docs/manpages/samba-tool.8	2018-04-17 09:40:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/samba.7 samba-4.7.7/docs/manpages/samba.7
--- samba-4.7.6/docs/manpages/samba.7	2018-03-12 09:55:35.000000000 +0100
+++ samba-4.7.7/docs/manpages/samba.7	2018-04-17 09:40:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: Miscellanea
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "03/12/2018" "Samba 4\&.7" "Miscellanea"
+.TH "SAMBA" "7" "04/17/2018" "Samba 4\&.7" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/samba.8 samba-4.7.7/docs/manpages/samba.8
--- samba-4.7.6/docs/manpages/samba.8	2018-03-12 09:55:35.000000000 +0100
+++ samba-4.7.7/docs/manpages/samba.8	2018-04-17 09:40:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/sharesec.1 samba-4.7.7/docs/manpages/sharesec.1
--- samba-4.7.6/docs/manpages/sharesec.1	2018-03-12 09:55:36.000000000 +0100
+++ samba-4.7.7/docs/manpages/sharesec.1	2018-04-17 09:40:22.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SHARESEC" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smb.conf.5 samba-4.7.7/docs/manpages/smb.conf.5
--- samba-4.7.6/docs/manpages/smb.conf.5	2018-03-12 09:55:37.000000000 +0100
+++ samba-4.7.7/docs/manpages/smb.conf.5	2018-04-17 09:40:23.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "03/12/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "04/17/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -3081,7 +3081,7 @@ Example:
 directory name cache size (S)
 .PP
 .RS 4
-This parameter specifies the size of the directory name cache\&. It will be needed to turn this off for *BSD systems\&.
+This parameter specifies the size of the directory name cache for SMB1 connections\&. It is not used for SMB2\&. It will be needed to turn this off for *BSD systems\&.
 .sp
 Default:
 \fI\fIdirectory name cache size\fR\fR\fI = \fR\fI100\fR\fI \fR
@@ -5743,6 +5743,28 @@ This parameter has been extended since t
 .RE
 .sp
 .RS 4
+.ie n \{\
+\h'-04'\(bu\h'+03'\c
+.\}
+.el \{\
+.sp -1
+.IP \(bu 2.3
+.\}
+\fIsmb2\fR
+.RE
+.sp
+.RS 4
+.ie n \{\
+\h'-04'\(bu\h'+03'\c
+.\}
+.el \{\
+.sp -1
+.IP \(bu 2.3
+.\}
+\fIsmb2_credits\fR
+.RE
+.sp
+.RS 4
 .ie n \{\
 \h'-04'\(bu\h'+03'\c
 .\}
diff -Npur samba-4.7.6/docs/manpages/smbcacls.1 samba-4.7.7/docs/manpages/smbcacls.1
--- samba-4.7.6/docs/manpages/smbcacls.1	2018-03-12 09:55:37.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbcacls.1	2018-04-17 09:40:23.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCACLS" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbclient.1 samba-4.7.7/docs/manpages/smbclient.1
--- samba-4.7.6/docs/manpages/smbclient.1	2018-03-12 09:55:38.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbclient.1	2018-04-17 09:40:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCLIENT" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbcontrol.1 samba-4.7.7/docs/manpages/smbcontrol.1
--- samba-4.7.6/docs/manpages/smbcontrol.1	2018-03-12 09:55:38.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbcontrol.1	2018-04-17 09:40:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCONTROL" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbcquotas.1 samba-4.7.7/docs/manpages/smbcquotas.1
--- samba-4.7.6/docs/manpages/smbcquotas.1	2018-03-12 09:55:38.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbcquotas.1	2018-04-17 09:40:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCQUOTAS" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbd.8 samba-4.7.7/docs/manpages/smbd.8
--- samba-4.7.6/docs/manpages/smbd.8	2018-03-12 09:55:38.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbd.8	2018-04-17 09:40:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbget.1 samba-4.7.7/docs/manpages/smbget.1
--- samba-4.7.6/docs/manpages/smbget.1	2018-03-12 09:55:38.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbget.1	2018-04-17 09:40:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBGET" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbgetrc.5 samba-4.7.7/docs/manpages/smbgetrc.5
--- samba-4.7.6/docs/manpages/smbgetrc.5	2018-03-12 09:55:39.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbgetrc.5	2018-04-17 09:40:25.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "03/12/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "04/17/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbpasswd.5 samba-4.7.7/docs/manpages/smbpasswd.5
--- samba-4.7.6/docs/manpages/smbpasswd.5	2018-03-12 09:55:39.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbpasswd.5	2018-04-17 09:40:25.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "03/12/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "04/17/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbpasswd.8 samba-4.7.7/docs/manpages/smbpasswd.8
--- samba-4.7.6/docs/manpages/smbpasswd.8	2018-03-12 09:55:39.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbpasswd.8	2018-04-17 09:40:25.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBPASSWD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbspool.8 samba-4.7.7/docs/manpages/smbspool.8
--- samba-4.7.6/docs/manpages/smbspool.8	2018-03-12 09:55:39.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbspool.8	2018-04-17 09:40:25.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbspool_krb5_wrapper.8 samba-4.7.7/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.7.6/docs/manpages/smbspool_krb5_wrapper.8	2018-03-12 09:55:40.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbspool_krb5_wrapper.8	2018-04-17 09:40:25.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbstatus.1 samba-4.7.7/docs/manpages/smbstatus.1
--- samba-4.7.6/docs/manpages/smbstatus.1	2018-03-12 09:55:40.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbstatus.1	2018-04-17 09:40:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBSTATUS" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbtar.1 samba-4.7.7/docs/manpages/smbtar.1
--- samba-4.7.6/docs/manpages/smbtar.1	2018-03-12 09:55:40.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbtar.1	2018-04-17 09:40:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBTAR" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/smbtree.1 samba-4.7.7/docs/manpages/smbtree.1
--- samba-4.7.6/docs/manpages/smbtree.1	2018-03-12 09:55:40.000000000 +0100
+++ samba-4.7.7/docs/manpages/smbtree.1	2018-04-17 09:40:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBTREE" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/testparm.1 samba-4.7.7/docs/manpages/testparm.1
--- samba-4.7.6/docs/manpages/testparm.1	2018-03-12 09:55:40.000000000 +0100
+++ samba-4.7.7/docs/manpages/testparm.1	2018-04-17 09:40:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "TESTPARM" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_acl_tdb.8 samba-4.7.7/docs/manpages/vfs_acl_tdb.8
--- samba-4.7.6/docs/manpages/vfs_acl_tdb.8	2018-03-12 09:55:41.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_acl_tdb.8	2018-04-17 09:40:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_acl_xattr.8 samba-4.7.7/docs/manpages/vfs_acl_xattr.8
--- samba-4.7.6/docs/manpages/vfs_acl_xattr.8	2018-03-12 09:55:41.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_acl_xattr.8	2018-04-17 09:40:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_aio_fork.8 samba-4.7.7/docs/manpages/vfs_aio_fork.8
--- samba-4.7.6/docs/manpages/vfs_aio_fork.8	2018-03-12 09:55:41.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_aio_fork.8	2018-04-17 09:40:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_aio_linux.8 samba-4.7.7/docs/manpages/vfs_aio_linux.8
--- samba-4.7.6/docs/manpages/vfs_aio_linux.8	2018-03-12 09:55:41.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_aio_linux.8	2018-04-17 09:40:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_linux
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_LINUX" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_LINUX" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_aio_pthread.8 samba-4.7.7/docs/manpages/vfs_aio_pthread.8
--- samba-4.7.6/docs/manpages/vfs_aio_pthread.8	2018-03-12 09:55:42.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_aio_pthread.8	2018-04-17 09:40:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_audit.8 samba-4.7.7/docs/manpages/vfs_audit.8
--- samba-4.7.6/docs/manpages/vfs_audit.8	2018-03-12 09:55:42.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_audit.8	2018-04-17 09:40:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AUDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_btrfs.8 samba-4.7.7/docs/manpages/vfs_btrfs.8
--- samba-4.7.6/docs/manpages/vfs_btrfs.8	2018-03-12 09:55:42.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_btrfs.8	2018-04-17 09:40:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_BTRFS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_cacheprime.8 samba-4.7.7/docs/manpages/vfs_cacheprime.8
--- samba-4.7.6/docs/manpages/vfs_cacheprime.8	2018-03-12 09:55:42.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_cacheprime.8	2018-04-17 09:40:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_cap.8 samba-4.7.7/docs/manpages/vfs_cap.8
--- samba-4.7.6/docs/manpages/vfs_cap.8	2018-03-12 09:55:42.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_cap.8	2018-04-17 09:40:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CAP" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_catia.8 samba-4.7.7/docs/manpages/vfs_catia.8
--- samba-4.7.6/docs/manpages/vfs_catia.8	2018-03-12 09:55:43.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_catia.8	2018-04-17 09:40:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CATIA" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_ceph.8 samba-4.7.7/docs/manpages/vfs_ceph.8
--- samba-4.7.6/docs/manpages/vfs_ceph.8	2018-03-12 09:55:43.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_ceph.8	2018-04-17 09:40:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CEPH" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_commit.8 samba-4.7.7/docs/manpages/vfs_commit.8
--- samba-4.7.6/docs/manpages/vfs_commit.8	2018-03-12 09:55:43.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_commit.8	2018-04-17 09:40:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_COMMIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_crossrename.8 samba-4.7.7/docs/manpages/vfs_crossrename.8
--- samba-4.7.6/docs/manpages/vfs_crossrename.8	2018-03-12 09:55:43.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_crossrename.8	2018-04-17 09:40:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_default_quota.8 samba-4.7.7/docs/manpages/vfs_default_quota.8
--- samba-4.7.6/docs/manpages/vfs_default_quota.8	2018-03-12 09:55:43.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_default_quota.8	2018-04-17 09:40:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_dirsort.8 samba-4.7.7/docs/manpages/vfs_dirsort.8
--- samba-4.7.6/docs/manpages/vfs_dirsort.8	2018-03-12 09:55:44.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_dirsort.8	2018-04-17 09:40:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_extd_audit.8 samba-4.7.7/docs/manpages/vfs_extd_audit.8
--- samba-4.7.6/docs/manpages/vfs_extd_audit.8	2018-03-12 09:55:44.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_extd_audit.8	2018-04-17 09:40:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_fake_perms.8 samba-4.7.7/docs/manpages/vfs_fake_perms.8
--- samba-4.7.6/docs/manpages/vfs_fake_perms.8	2018-03-12 09:55:44.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_fake_perms.8	2018-04-17 09:40:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_fileid.8 samba-4.7.7/docs/manpages/vfs_fileid.8
--- samba-4.7.6/docs/manpages/vfs_fileid.8	2018-03-12 09:55:44.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_fileid.8	2018-04-17 09:40:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FILEID" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_fruit.8 samba-4.7.7/docs/manpages/vfs_fruit.8
--- samba-4.7.6/docs/manpages/vfs_fruit.8	2018-03-12 09:55:45.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_fruit.8	2018-04-17 09:40:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FRUIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_full_audit.8 samba-4.7.7/docs/manpages/vfs_full_audit.8
--- samba-4.7.6/docs/manpages/vfs_full_audit.8	2018-03-12 09:55:45.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_full_audit.8	2018-04-17 09:40:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_glusterfs.8 samba-4.7.7/docs/manpages/vfs_glusterfs.8
--- samba-4.7.6/docs/manpages/vfs_glusterfs.8	2018-03-12 09:55:45.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_glusterfs.8	2018-04-17 09:40:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_gpfs.8 samba-4.7.7/docs/manpages/vfs_gpfs.8
--- samba-4.7.6/docs/manpages/vfs_gpfs.8	2018-03-12 09:55:45.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_gpfs.8	2018-04-17 09:40:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GPFS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.7.7/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.7.6/docs/manpages/vfs_linux_xfs_sgid.8	2018-03-12 09:55:45.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_linux_xfs_sgid.8	2018-04-17 09:40:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_media_harmony.8 samba-4.7.7/docs/manpages/vfs_media_harmony.8
--- samba-4.7.6/docs/manpages/vfs_media_harmony.8	2018-03-12 09:55:46.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_media_harmony.8	2018-04-17 09:40:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_netatalk.8 samba-4.7.7/docs/manpages/vfs_netatalk.8
--- samba-4.7.6/docs/manpages/vfs_netatalk.8	2018-03-12 09:55:46.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_netatalk.8	2018-04-17 09:40:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_NETATALK" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_offline.8 samba-4.7.7/docs/manpages/vfs_offline.8
--- samba-4.7.6/docs/manpages/vfs_offline.8	2018-03-12 09:55:46.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_offline.8	2018-04-17 09:40:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_prealloc.8 samba-4.7.7/docs/manpages/vfs_prealloc.8
--- samba-4.7.6/docs/manpages/vfs_prealloc.8	2018-03-12 09:55:46.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_prealloc.8	2018-04-17 09:40:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_preopen.8 samba-4.7.7/docs/manpages/vfs_preopen.8
--- samba-4.7.6/docs/manpages/vfs_preopen.8	2018-03-12 09:55:46.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_preopen.8	2018-04-17 09:40:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_readahead.8 samba-4.7.7/docs/manpages/vfs_readahead.8
--- samba-4.7.6/docs/manpages/vfs_readahead.8	2018-03-12 09:55:47.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_readahead.8	2018-04-17 09:40:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_readonly.8 samba-4.7.7/docs/manpages/vfs_readonly.8
--- samba-4.7.6/docs/manpages/vfs_readonly.8	2018-03-12 09:55:47.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_readonly.8	2018-04-17 09:40:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READONLY" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_recycle.8 samba-4.7.7/docs/manpages/vfs_recycle.8
--- samba-4.7.6/docs/manpages/vfs_recycle.8	2018-03-12 09:55:47.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_recycle.8	2018-04-17 09:40:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_shadow_copy.8 samba-4.7.7/docs/manpages/vfs_shadow_copy.8
--- samba-4.7.6/docs/manpages/vfs_shadow_copy.8	2018-03-12 09:55:47.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_shadow_copy.8	2018-04-17 09:40:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_shadow_copy2.8 samba-4.7.7/docs/manpages/vfs_shadow_copy2.8
--- samba-4.7.6/docs/manpages/vfs_shadow_copy2.8	2018-03-12 09:55:48.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_shadow_copy2.8	2018-04-17 09:40:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_shell_snap.8 samba-4.7.7/docs/manpages/vfs_shell_snap.8
--- samba-4.7.6/docs/manpages/vfs_shell_snap.8	2018-03-12 09:55:48.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_shell_snap.8	2018-04-17 09:40:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_snapper.8 samba-4.7.7/docs/manpages/vfs_snapper.8
--- samba-4.7.6/docs/manpages/vfs_snapper.8	2018-03-12 09:55:48.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_snapper.8	2018-04-17 09:40:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_streams_depot.8 samba-4.7.7/docs/manpages/vfs_streams_depot.8
--- samba-4.7.6/docs/manpages/vfs_streams_depot.8	2018-03-12 09:55:48.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_streams_depot.8	2018-04-17 09:40:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_streams_xattr.8 samba-4.7.7/docs/manpages/vfs_streams_xattr.8
--- samba-4.7.6/docs/manpages/vfs_streams_xattr.8	2018-03-12 09:55:48.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_streams_xattr.8	2018-04-17 09:40:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_syncops.8 samba-4.7.7/docs/manpages/vfs_syncops.8
--- samba-4.7.6/docs/manpages/vfs_syncops.8	2018-03-12 09:55:49.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_syncops.8	2018-04-17 09:40:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_time_audit.8 samba-4.7.7/docs/manpages/vfs_time_audit.8
--- samba-4.7.6/docs/manpages/vfs_time_audit.8	2018-03-12 09:55:49.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_time_audit.8	2018-04-17 09:40:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_tsmsm.8 samba-4.7.7/docs/manpages/vfs_tsmsm.8
--- samba-4.7.6/docs/manpages/vfs_tsmsm.8	2018-03-12 09:55:49.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_tsmsm.8	2018-04-17 09:40:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TSMSM" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_unityed_media.8 samba-4.7.7/docs/manpages/vfs_unityed_media.8
--- samba-4.7.6/docs/manpages/vfs_unityed_media.8	2018-03-12 09:55:49.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_unityed_media.8	2018-04-17 09:40:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_worm.8 samba-4.7.7/docs/manpages/vfs_worm.8
--- samba-4.7.6/docs/manpages/vfs_worm.8	2018-03-12 09:55:49.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_worm.8	2018-04-17 09:40:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_WORM" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_xattr_tdb.8 samba-4.7.7/docs/manpages/vfs_xattr_tdb.8
--- samba-4.7.6/docs/manpages/vfs_xattr_tdb.8	2018-03-12 09:55:50.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_xattr_tdb.8	2018-04-17 09:40:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfs_zfsacl.8 samba-4.7.7/docs/manpages/vfs_zfsacl.8
--- samba-4.7.6/docs/manpages/vfs_zfsacl.8	2018-03-12 09:55:50.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfs_zfsacl.8	2018-04-17 09:40:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/vfstest.1 samba-4.7.7/docs/manpages/vfstest.1
--- samba-4.7.6/docs/manpages/vfstest.1	2018-03-12 09:55:50.000000000 +0100
+++ samba-4.7.7/docs/manpages/vfstest.1	2018-04-17 09:40:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "VFSTEST" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/wbinfo.1 samba-4.7.7/docs/manpages/wbinfo.1
--- samba-4.7.6/docs/manpages/wbinfo.1	2018-03-12 09:55:50.000000000 +0100
+++ samba-4.7.7/docs/manpages/wbinfo.1	2018-04-17 09:40:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "03/12/2018" "Samba 4\&.7" "User Commands"
+.TH "WBINFO" "1" "04/17/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/winbind_krb5_locator.7 samba-4.7.7/docs/manpages/winbind_krb5_locator.7
--- samba-4.7.6/docs/manpages/winbind_krb5_locator.7	2018-03-12 09:55:50.000000000 +0100
+++ samba-4.7.7/docs/manpages/winbind_krb5_locator.7	2018-04-17 09:40:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_locator
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCATOR" "7" "03/12/2018" "Samba 4\&.7" "7"
+.TH "WINBIND_KRB5_LOCATOR" "7" "04/17/2018" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs/manpages/winbindd.8 samba-4.7.7/docs/manpages/winbindd.8
--- samba-4.7.6/docs/manpages/winbindd.8	2018-03-12 09:55:51.000000000 +0100
+++ samba-4.7.7/docs/manpages/winbindd.8	2018-04-17 09:40:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/12/2018
+.\"      Date: 04/17/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "03/12/2018" "Samba 4\&.7" "System Administration tools"
+.TH "WINBINDD" "8" "04/17/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.6/docs-xml/smbdotconf/logging/loglevel.xml samba-4.7.7/docs-xml/smbdotconf/logging/loglevel.xml
--- samba-4.7.6/docs-xml/smbdotconf/logging/loglevel.xml	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/docs-xml/smbdotconf/logging/loglevel.xml	2018-04-17 09:35:02.000000000 +0200
@@ -22,6 +22,8 @@
 	<listitem><para><parameter moreinfo="none">printdrivers</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">lanman</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">smb</parameter></para></listitem>
+	<listitem><para><parameter moreinfo="none">smb2</parameter></para></listitem>
+	<listitem><para><parameter moreinfo="none">smb2_credits</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_parse</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_srv</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_cli</parameter></para></listitem>
diff -Npur samba-4.7.6/docs-xml/smbdotconf/misc/directorynamecachesize.xml samba-4.7.7/docs-xml/smbdotconf/misc/directorynamecachesize.xml
--- samba-4.7.6/docs-xml/smbdotconf/misc/directorynamecachesize.xml	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/docs-xml/smbdotconf/misc/directorynamecachesize.xml	2018-04-17 09:35:02.000000000 +0200
@@ -4,8 +4,9 @@
                  xmlns:samba="http://www.samba.org/samba/DTD/samba-doc">
 <description>
 	<para>
-	This parameter specifies the size of the directory name cache.
-	It will be needed to turn this off for *BSD systems.
+	This parameter specifies the size of the directory name cache for SMB1
+	connections. It is not used for SMB2. It will be needed to turn this off
+	for *BSD systems.
 	</para>
 
 </description>
diff -Npur samba-4.7.6/lib/crypto/aes.c samba-4.7.7/lib/crypto/aes.c
--- samba-4.7.6/lib/crypto/aes.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.7/lib/crypto/aes.c	2018-04-17 09:35:02.000000000 +0200
@@ -66,22 +66,6 @@ static bool has_intel_aes_instructions(v
 		return (bool)has_aes_instructions;
 	}
 
-	__cpuid(cpuid_results, 0);
-	/*
-	 *        MSB         LSB
-	 *  EBX = 'u' 'n' 'e' 'G'
-	 *  EDX = 'I' 'e' 'n' 'i'
-	 *  ECX = 'l' 'e' 't' 'n'
-	 */
-	if (memcmp((unsigned char *)&cpuid_results[1], "Genu", 4) != 0 ||
-			memcmp((unsigned char *)&cpuid_results[3],
-				"ineI", 4) != 0 ||
-			memcmp((unsigned char *)&cpuid_results[2],
-				"ntel", 4) != 0) {
-		has_aes_instructions = 0;
-		return (bool)has_aes_instructions;
-	}
-
 	__cpuid(cpuid_results, 1);
 	has_aes_instructions = !!(cpuid_results[2] & (1 << 25));
 	return (bool)has_aes_instructions;
diff -Npur samba-4.7.6/lib/util/debug.c samba-4.7.7/lib/util/debug.c
--- samba-4.7.6/lib/util/debug.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.7/lib/util/debug.c	2018-04-17 09:35:02.000000000 +0200
@@ -541,6 +541,8 @@ static const char *default_classname_tab
 	[DBGC_AUTH_AUDIT_JSON] = "auth_json_audit",
 	[DBGC_KERBEROS] =       "kerberos",
 	[DBGC_DRS_REPL] =       "drs_repl",
+	[DBGC_SMB2] =           "smb2",
+	[DBGC_SMB2_CREDITS] =   "smb2_credits",
 };
 
 /*
diff -Npur samba-4.7.6/lib/util/debug.h samba-4.7.7/lib/util/debug.h
--- samba-4.7.6/lib/util/debug.h	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.7/lib/util/debug.h	2018-04-17 09:35:02.000000000 +0200
@@ -93,6 +93,8 @@ bool dbghdr( int level, const char *loca
 #define DBGC_AUTH_AUDIT_JSON	25
 #define DBGC_KERBEROS           26
 #define DBGC_DRS_REPL           27
+#define DBGC_SMB2               28
+#define DBGC_SMB2_CREDITS       29
 
 /* So you can define DBGC_CLASS before including debug.h */
 #ifndef DBGC_CLASS
@@ -216,6 +218,14 @@ extern int  *DEBUGLEVEL_CLASS;
 		&& (dbgtext("%s: ", __func__))				\
 		&& (dbgtext body) )
 
+/* Prefix messages with the function name - class specific */
+#define DBGC_PREFIX(dbgc_class, level, body ) \
+	(void)( ((level) <= MAX_DEBUG_LEVEL) &&			\
+		unlikely(DEBUGLEVEL_CLASS[ dbgc_class ] >= (level))	\
+		&& (dbghdrclass(level, dbgc_class, __location__, __func__ )) \
+		&& (dbgtext("%s: ", __func__))				\
+		&& (dbgtext body) )
+
 /*
  * Debug levels matching RFC 3164
  */
@@ -231,12 +241,34 @@ extern int  *DEBUGLEVEL_CLASS;
 #define DBG_INFO(...)		DBG_PREFIX(DBGLVL_INFO,		(__VA_ARGS__))
 #define DBG_DEBUG(...)		DBG_PREFIX(DBGLVL_DEBUG,	(__VA_ARGS__))
 
+#define DBGC_ERR(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_ERR, (__VA_ARGS__))
+#define DBGC_WARNING(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_WARNING,	(__VA_ARGS__))
+#define DBGC_NOTICE(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_NOTICE,	(__VA_ARGS__))
+#define DBGC_INFO(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_INFO,	(__VA_ARGS__))
+#define DBGC_DEBUG(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_DEBUG,	(__VA_ARGS__))
+
 #define D_ERR(...)		DEBUG(DBGLVL_ERR,	(__VA_ARGS__))
 #define D_WARNING(...)		DEBUG(DBGLVL_WARNING,	(__VA_ARGS__))
 #define D_NOTICE(...)		DEBUG(DBGLVL_NOTICE,	(__VA_ARGS__))
 #define D_INFO(...)		DEBUG(DBGLVL_INFO,	(__VA_ARGS__))
 #define D_DEBUG(...)		DEBUG(DBGLVL_DEBUG,	(__VA_ARGS__))
 
+#define DC_ERR(...)		DEBUGC(dbgc_class, \
+					DBGLVL_ERR,	(__VA_ARGS__))
+#define DC_WARNING(...)		DEBUGC(dbgc_class, \
+					DBGLVL_WARNING,	(__VA_ARGS__))
+#define DC_NOTICE(...)		DEBUGC(dbgc_class, \
+					DBGLVL_NOTICE,	(__VA_ARGS__))
+#define DC_INFO(...)		DEBUGC(dbgc_class, \
+					DBGLVL_INFO,	(__VA_ARGS__))
+#define DC_DEBUG(...)		DEBUGC(dbgc_class, \
+					DBGLVL_DEBUG,	(__VA_ARGS__))
+
 /* The following definitions come from lib/debug.c  */
 
 /** Possible destinations for the debug log (in order of precedence -
diff -Npur samba-4.7.6/libcli/security/session.c samba-4.7.7/libcli/security/session.c
--- samba-4.7.6/libcli/security/session.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/libcli/security/session.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 enum security_user_level security_session_user_level(struct auth_session_info *session_info,
 						     const struct dom_sid *domain_sid)
 {
+	bool authenticated = false;
+	bool guest = false;
+
 	if (!session_info) {
 		return SECURITY_ANONYMOUS;
 	}
@@ -38,8 +41,13 @@ enum security_user_level security_sessio
 		return SECURITY_ANONYMOUS;
 	}
 
-	if (security_token_has_builtin_guests(session_info->security_token)) {
-		return SECURITY_GUEST;
+	authenticated = security_token_has_nt_authenticated_users(session_info->security_token);
+	guest = security_token_has_builtin_guests(session_info->security_token);
+	if (!authenticated) {
+		if (guest) {
+			return SECURITY_GUEST;
+		}
+		return SECURITY_ANONYMOUS;
 	}
 
 	if (security_token_has_builtin_administrators(session_info->security_token)) {
@@ -60,9 +68,5 @@ enum security_user_level security_sessio
 		return SECURITY_DOMAIN_CONTROLLER;
 	}
 
-	if (security_token_has_nt_authenticated_users(session_info->security_token)) {
-		return SECURITY_USER;
-	}
-
-	return SECURITY_ANONYMOUS;
+	return SECURITY_USER;
 }
diff -Npur samba-4.7.6/libcli/smb/smbXcli_base.c samba-4.7.7/libcli/smb/smbXcli_base.c
--- samba-4.7.6/libcli/smb/smbXcli_base.c	2017-09-21 08:28:20.000000000 +0200
+++ samba-4.7.7/libcli/smb/smbXcli_base.c	2018-04-17 09:35:02.000000000 +0200
@@ -138,6 +138,8 @@ struct smbXcli_conn {
 
 		uint8_t io_priority;
 
+		bool force_channel_sequence;
+
 		uint8_t preauth_sha512[64];
 	} smb2;
 
@@ -549,6 +551,17 @@ const struct GUID *smbXcli_conn_server_g
 	return &conn->smb1.server.guid;
 }
 
+bool smbXcli_conn_get_force_channel_sequence(struct smbXcli_conn *conn)
+{
+	return conn->smb2.force_channel_sequence;
+}
+
+void smbXcli_conn_set_force_channel_sequence(struct smbXcli_conn *conn,
+					     bool v)
+{
+	conn->smb2.force_channel_sequence = v;
+}
+
 struct smbXcli_conn_samba_suicide_state {
 	struct smbXcli_conn *conn;
 	struct iovec iov;
@@ -2899,7 +2912,7 @@ struct tevent_req *smb2cli_req_create(TA
 	uint32_t flags = 0;
 	uint32_t tid = 0;
 	uint64_t uid = 0;
-	bool use_channel_sequence = false;
+	bool use_channel_sequence = conn->smb2.force_channel_sequence;
 	uint16_t channel_sequence = 0;
 	bool use_replay_flag = false;
 
diff -Npur samba-4.7.6/libcli/smb/smbXcli_base.h samba-4.7.7/libcli/smb/smbXcli_base.h
--- samba-4.7.6/libcli/smb/smbXcli_base.h	2017-09-21 08:28:20.000000000 +0200
+++ samba-4.7.7/libcli/smb/smbXcli_base.h	2018-04-17 09:35:02.000000000 +0200
@@ -59,6 +59,10 @@ uint16_t smbXcli_conn_max_requests(struc
 NTTIME smbXcli_conn_server_system_time(struct smbXcli_conn *conn);
 const DATA_BLOB *smbXcli_conn_server_gss_blob(struct smbXcli_conn *conn);
 const struct GUID *smbXcli_conn_server_guid(struct smbXcli_conn *conn);
+bool smbXcli_conn_get_force_channel_sequence(struct smbXcli_conn *conn);
+void smbXcli_conn_set_force_channel_sequence(struct smbXcli_conn *conn,
+					     bool v);
+
 
 struct tevent_req *smbXcli_conn_samba_suicide_send(TALLOC_CTX *mem_ctx,
 						   struct tevent_context *ev,
diff -Npur samba-4.7.6/nsswitch/libwbclient/tests/wbclient.c samba-4.7.7/nsswitch/libwbclient/tests/wbclient.c
--- samba-4.7.6/nsswitch/libwbclient/tests/wbclient.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/nsswitch/libwbclient/tests/wbclient.c	2018-04-17 09:35:02.000000000 +0200
@@ -296,6 +296,7 @@ static bool test_wbc_users(struct tortur
 	char *name = NULL;
 	char *sid_string = NULL;
 	wbcErr ret = false;
+	char separator;
 
 	torture_assert_wbc_ok(tctx, wbcInterfaceDetails(&details),
 		"%s", "wbcInterfaceDetails failed");
@@ -306,6 +307,7 @@ static bool test_wbc_users(struct tortur
 			    ret,
 			    fail,
 			    "Failed to allocate domain_name");
+	separator = details->winbind_separator;
 	wbcFreeMemory(details);
 	details = NULL;
 
@@ -323,9 +325,38 @@ static bool test_wbc_users(struct tortur
 		struct wbcDomainSid sid;
 		enum wbcSidType name_type;
 		uint32_t num_sids;
+		const char *user;
+		char *c;
+
+		c = strchr(users[i], separator);
+
+		if (c == NULL) {
+			/*
+			 * NT4 DC
+			 * user name does not contain DOMAIN SEPARATOR prefix.
+			 */
+
+			user = users[i];
+		} else {
+			/*
+			 * AD DC
+			 * user name starts with DOMAIN SEPARATOR prefix.
+			 */
+			const char *dom;
+
+			*c = '\0';
+			dom = users[i];
+			user = c + 1;
+
+			torture_assert_str_equal_goto(tctx, dom, domain_name,
+						      ret, fail, "Domain part "
+						      "of user name does not "
+						      "match domain name.\n");
+		}
 
 		torture_assert_wbc_ok_goto_fail(tctx,
-						wbcLookupName(domain_name, users[i], &sid, &name_type),
+						wbcLookupName(domain_name, user,
+							      &sid, &name_type),
 						"wbcLookupName of %s failed",
 						users[i]);
 		torture_assert_int_equal_goto(tctx,
@@ -399,6 +430,7 @@ static bool test_wbc_groups(struct tortu
 	char *domain = NULL;
 	char *name = NULL;
 	char *sid_string = NULL;
+	char separator;
 
 	torture_assert_wbc_ok(tctx, wbcInterfaceDetails(&details),
 			      "%s", "wbcInterfaceDetails failed");
@@ -409,6 +441,7 @@ static bool test_wbc_groups(struct tortu
 			    ret,
 			    fail,
 			    "Failed to allocate domain_name");
+	separator = details->winbind_separator;
 	wbcFreeMemory(details);
 	details = NULL;
 
@@ -425,10 +458,39 @@ static bool test_wbc_groups(struct tortu
 	for (i=0; i < MIN(num_groups,100); i++) {
 		struct wbcDomainSid sid;
 		enum wbcSidType name_type;
+		const char *group;
+		char *c;
+
+		c = strchr(groups[i], separator);
+
+		if (c == NULL) {
+			/*
+			 * NT4 DC
+			 * group name does not contain DOMAIN SEPARATOR prefix.
+			 */
+
+			group = groups[i];
+		} else {
+			/*
+			 * AD DC
+			 * group name starts with DOMAIN SEPARATOR prefix.
+			 */
+			const char *dom;
+
+
+			*c = '\0';
+			dom = groups[i];
+			group = c + 1;
+
+			torture_assert_str_equal_goto(tctx, dom, domain_name,
+						      ret, fail, "Domain part "
+						      "of group name does not "
+						      "match domain name.\n");
+		}
 
 		torture_assert_wbc_ok_goto_fail(tctx,
 						wbcLookupName(domain_name,
-							      groups[i],
+							      group,
 							      &sid,
 							      &name_type),
 						"wbcLookupName for %s failed",
diff -Npur samba-4.7.6/nsswitch/tests/test_wbinfo_name_lookup.sh samba-4.7.7/nsswitch/tests/test_wbinfo_name_lookup.sh
--- samba-4.7.6/nsswitch/tests/test_wbinfo_name_lookup.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.7/nsswitch/tests/test_wbinfo_name_lookup.sh	2018-04-17 09:35:02.000000000 +0200
@@ -0,0 +1,40 @@
+#!/bin/sh
+# Blackbox test for wbinfo name lookup
+if [ $# -lt 2 ]; then
+cat <<EOF
+Usage: test_wbinfo.sh DOMAIN DC_USERNAME
+EOF
+exit 1;
+fi
+
+DOMAIN=$1
+DC_USERNAME=$2
+shift 2
+
+failed=0
+sambabindir="$BINDIR"
+wbinfo="$VALGRIND $sambabindir/wbinfo"
+
+. `dirname $0`/../../testprogs/blackbox/subunit.sh
+
+# Correct query is expected to work
+testit "name-to-sid.single-separator" \
+       $wbinfo -n $DOMAIN/$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Two separator characters should fail
+testit_expect_failure "name-to-sid.double-separator" \
+		      $wbinfo -n $DOMAIN//$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Invalid domain is expected to fail
+testit_expect_failure "name-to-sid.invalid-domain" \
+		      $wbinfo -n INVALID/$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Invalid domain with two separator characters is expected to fail
+testit_expect_failure "name-to-sid.double-separator-invalid-domain" \
+		      $wbinfo -n INVALID//$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+exit $failed
diff -Npur samba-4.7.6/python/samba/subnets.py samba-4.7.7/python/samba/subnets.py
--- samba-4.7.6/python/samba/subnets.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/python/samba/subnets.py	2018-04-17 09:35:02.000000000 +0200
@@ -127,6 +127,39 @@ def delete_subnet(samdb, configDn, subne
 
     samdb.delete(dnsubnet)
 
+def rename_subnet(samdb, configDn, subnet_name, new_name):
+    """Rename a subnet.
+
+    :param samdb: A samdb connection
+    :param configDn: The DN of the configuration partition
+    :param subnet_name: Name of the subnet to rename
+    :param new_name: New name for the subnet
+    :return: None
+    :raise SubnetNotFound: if the subnet to be renamed does not exist.
+    :raise SubnetExists: if the subnet to be created already exists.
+    """
+    dnsubnet = ldb.Dn(samdb, "CN=Subnets,CN=Sites")
+    if dnsubnet.add_base(configDn) == False:
+        raise SubnetException("dnsubnet.add_base() failed")
+    if dnsubnet.add_child("CN=X") == False:
+        raise SubnetException("dnsubnet.add_child() failed")
+    dnsubnet.set_component(0, "CN", subnet_name)
+
+    newdnsubnet = ldb.Dn(samdb, str(dnsubnet))
+    newdnsubnet.set_component(0, "CN", new_name)
+    try:
+        samdb.rename(dnsubnet, newdnsubnet)
+    except LdbError as (enum, estr):
+        if enum == ldb.ERR_NO_SUCH_OBJECT:
+            raise SubnetNotFound('Subnet %s does not exist' % subnet)
+        elif enum == ldb.ERR_ENTRY_ALREADY_EXISTS:
+            raise SubnetAlreadyExists('A subnet with the CIDR %s already exists'
+                                      % new_name)
+        elif enum == ldb.ERR_INVALID_DN_SYNTAX:
+            raise SubnetInvalid("%s is not a valid subnet: %s" % (new_name,
+                                                                  estr))
+        else:
+            raise
 
 def set_subnet_site(samdb, configDn, subnet_name, site_name):
     """Assign a subnet to a site.
diff -Npur samba-4.7.6/python/samba/tests/py_credentials.py samba-4.7.7/python/samba/tests/py_credentials.py
--- samba-4.7.6/python/samba/tests/py_credentials.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/python/samba/tests/py_credentials.py	2018-04-17 09:35:02.000000000 +0200
@@ -129,6 +129,33 @@ class PyCredentialsTests(TestCase):
             else:
                 raise
 
+    def test_SamLogonEx_no_domain(self):
+        c = self.get_netlogon_connection()
+
+        self.user_creds.set_domain('')
+
+        logon = samlogon_logon_info(self.domain,
+                                    self.machine_name,
+                                    self.user_creds)
+
+        logon_level = netlogon.NetlogonNetworkTransitiveInformation
+        validation_level = netlogon.NetlogonValidationSamInfo4
+        netr_flags = 0
+
+        try:
+            c.netr_LogonSamLogonEx(self.server,
+                                   self.user_creds.get_workstation(),
+                                   logon_level,
+                                   logon,
+                                   validation_level,
+                                   netr_flags)
+        except NTSTATUSError as e:
+            enum = ctypes.c_uint32(e[0]).value
+            if enum == ntstatus.NT_STATUS_WRONG_PASSWORD:
+                self.fail("got wrong password error")
+            else:
+                self.fail("got unexpected error" + str(e))
+
     def test_SamLogonExNTLM(self):
         c = self.get_netlogon_connection()
 
diff -Npur samba-4.7.6/selftest/target/Samba3.pm samba-4.7.7/selftest/target/Samba3.pm
--- samba-4.7.6/selftest/target/Samba3.pm	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/selftest/target/Samba3.pm	2018-04-17 09:35:02.000000000 +0200
@@ -1804,6 +1804,16 @@ sub provision($$$$$$$$$)
 
 [vfs_fruit]
 	path = $shrdir
+	vfs objects = catia fruit streams_xattr acl_xattr xattr_tdb
+	fruit:resource = file
+	fruit:metadata = netatalk
+	fruit:locking = netatalk
+	fruit:encoding = native
+	fruit:veto_appledouble = no
+
+[vfs_fruit_xattr]
+	path = $shrdir
+        # This is used by vfs.fruit tests that require real fs xattr
 	vfs objects = catia fruit streams_xattr acl_xattr
 	fruit:resource = file
 	fruit:metadata = netatalk
@@ -1813,25 +1823,25 @@ sub provision($$$$$$$$$)
 
 [vfs_fruit_metadata_stream]
 	path = $shrdir
-	vfs objects = fruit streams_xattr acl_xattr
+	vfs objects = fruit streams_xattr acl_xattr xattr_tdb
 	fruit:resource = file
 	fruit:metadata = stream
 	fruit:veto_appledouble = no
 
 [vfs_fruit_stream_depot]
 	path = $shrdir
-	vfs objects = fruit streams_depot acl_xattr
+	vfs objects = fruit streams_depot acl_xattr xattr_tdb
 	fruit:resource = stream
 	fruit:metadata = stream
 	fruit:veto_appledouble = no
 
 [vfs_wo_fruit]
 	path = $shrdir
-	vfs objects = streams_xattr acl_xattr
+	vfs objects = streams_xattr acl_xattr xattr_tdb
 
 [vfs_wo_fruit_stream_depot]
 	path = $shrdir
-	vfs objects = streams_depot acl_xattr
+	vfs objects = streams_depot acl_xattr xattr_tdb
 
 [badname-tmp]
 	path = $badnames_shrdir
diff -Npur samba-4.7.6/source3/auth/auth_builtin.c samba-4.7.7/source3/auth/auth_builtin.c
--- samba-4.7.6/source3/auth/auth_builtin.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/auth/auth_builtin.c	2018-04-17 09:35:02.000000000 +0200
@@ -81,7 +81,7 @@ static NTSTATUS check_guest_security(con
 		break;
 	}
 
-	return make_server_info_guest(NULL, server_info);
+	return make_server_info_anonymous(NULL, server_info);
 }
 
 /* Guest modules initialisation */
diff -Npur samba-4.7.6/source3/auth/auth_ntlmssp.c samba-4.7.7/source3/auth/auth_ntlmssp.c
--- samba-4.7.6/source3/auth/auth_ntlmssp.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/auth/auth_ntlmssp.c	2018-04-17 09:35:02.000000000 +0200
@@ -65,10 +65,7 @@ NTSTATUS auth3_generate_session_info(str
 
 		cmp = dom_sid_compare(sid, &global_sid_Anonymous);
 		if (cmp == 0) {
-			/*
-			 * TODO: use auth_anonymous_session_info() here?
-			 */
-			return make_session_info_guest(mem_ctx, session_info);
+			return make_session_info_anonymous(mem_ctx, session_info);
 		}
 
 		return NT_STATUS_INTERNAL_ERROR;
diff -Npur samba-4.7.6/source3/auth/auth_util.c samba-4.7.7/source3/auth/auth_util.c
--- samba-4.7.6/source3/auth/auth_util.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/auth/auth_util.c	2018-04-17 09:35:02.000000000 +0200
@@ -36,6 +36,7 @@
 #include "../librpc/gen_ndr/idmap.h"
 #include "lib/param/loadparm.h"
 #include "../lib/tsocket/tsocket.h"
+#include "source4/auth/auth.h"
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_AUTH
@@ -499,6 +500,26 @@ NTSTATUS create_local_token(TALLOC_CTX *
 		return NT_STATUS_LOGON_FAILURE;
 	}
 
+	if (server_info->cached_session_info != NULL) {
+		session_info = copy_session_info(mem_ctx,
+				server_info->cached_session_info);
+		if (session_info == NULL) {
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		/* This is a potentially untrusted username for use in %U */
+		alpha_strcpy(tmp, smb_username, ". _-$", sizeof(tmp));
+		session_info->unix_info->sanitized_username =
+				talloc_strdup(session_info->unix_info, tmp);
+		if (session_info->unix_info->sanitized_username == NULL) {
+			TALLOC_FREE(session_info);
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		*session_info_out = session_info;
+		return NT_STATUS_OK;
+	}
+
 	session_info = talloc_zero(mem_ctx, struct auth_session_info);
 	if (!session_info) {
 		return NT_STATUS_NO_MEMORY;
@@ -553,30 +574,6 @@ NTSTATUS create_local_token(TALLOC_CTX *
 		return status;
 	}
 
-	if (server_info->security_token) {
-		/* Just copy the token, it has already been finalised
-		 * (nasty hack to support a cached guest/system session_info
-		 */
-
-		session_info->security_token = dup_nt_token(session_info, server_info->security_token);
-		if (!session_info->security_token) {
-			TALLOC_FREE(session_info);
-			return NT_STATUS_NO_MEMORY;
-		}
-
-		session_info->unix_token->ngroups = server_info->utok.ngroups;
-		if (server_info->utok.ngroups != 0) {
-			session_info->unix_token->groups = (gid_t *)talloc_memdup(
-				session_info->unix_token, server_info->utok.groups,
-				sizeof(gid_t)*session_info->unix_token->ngroups);
-		} else {
-			session_info->unix_token->groups = NULL;
-		}
-
-		*session_info_out = session_info;
-		return NT_STATUS_OK;
-	}
-
 	/*
 	 * If winbind is not around, we can not make much use of the SIDs the
 	 * domain controller provided us with. Likewise if the user name was
@@ -660,7 +657,11 @@ NTSTATUS create_local_token(TALLOC_CTX *
 	 */
 
 	uid_to_unix_users_sid(session_info->unix_token->uid, &tmp_sid);
+	add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+				&session_info->security_token->sids,
+				&session_info->security_token->num_sids);
 
+	gid_to_unix_groups_sid(session_info->unix_token->gid, &tmp_sid);
 	add_sid_to_array_unique(session_info->security_token, &tmp_sid,
 				&session_info->security_token->sids,
 				&session_info->security_token->num_sids);
@@ -688,6 +689,558 @@ NTSTATUS create_local_token(TALLOC_CTX *
 	return NT_STATUS_OK;
 }
 
+NTSTATUS auth3_user_info_dc_add_hints(struct auth_user_info_dc *user_info_dc,
+				      uid_t uid,
+				      gid_t gid,
+				      uint32_t flags)
+{
+	uint32_t orig_num_sids = user_info_dc->num_sids;
+	struct dom_sid tmp_sid = { 0, };
+	NTSTATUS status;
+
+	/*
+	 * We add S-5-88-1-X in order to pass the uid
+	 * for the unix token.
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Users,
+		    (uint32_t)uid);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	/*
+	 * We add S-5-88-2-X in order to pass the gid
+	 * for the unix token.
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Groups,
+		    (uint32_t)gid);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	/*
+	 * We add S-5-88-3-X in order to pass some flags
+	 * (AUTH3_UNIX_HINT_*) to auth3_create_session_info().
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Mode,
+		    flags);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	return NT_STATUS_OK;
+
+fail:
+	user_info_dc->num_sids = orig_num_sids;
+	return status;
+}
+
+NTSTATUS auth3_session_info_create(TALLOC_CTX *mem_ctx,
+				   const struct auth_user_info_dc *user_info_dc,
+				   const char *original_user_name,
+				   uint32_t session_info_flags,
+				   struct auth_session_info **session_info_out)
+{
+	TALLOC_CTX *frame = talloc_stackframe();
+	struct auth_session_info *session_info = NULL;
+	uid_t hint_uid = -1;
+	bool found_hint_uid = false;
+	uid_t hint_gid = -1;
+	bool found_hint_gid = false;
+	uint32_t hint_flags = 0;
+	bool found_hint_flags = false;
+	bool need_getpwuid = false;
+	struct unixid *ids = NULL;
+	uint32_t num_gids = 0;
+	gid_t *gids = NULL;
+	struct dom_sid tmp_sid = { 0, };
+	fstring tmp = { 0, };
+	NTSTATUS status;
+	size_t i;
+	bool ok;
+
+	*session_info_out = NULL;
+
+	if (user_info_dc->num_sids == 0) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (user_info_dc->info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (user_info_dc->info->account_name == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	session_info = talloc_zero(mem_ctx, struct auth_session_info);
+	if (session_info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+	/* keep this under frame for easier cleanup */
+	talloc_reparent(mem_ctx, frame, session_info);
+
+	session_info->info = auth_user_info_copy(session_info,
+						 user_info_dc->info);
+	if (session_info->info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	session_info->security_token = talloc_zero(session_info,
+						   struct security_token);
+	if (session_info->security_token == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/*
+	 * Avoid a lot of reallocations and allocate what we'll
+	 * use in most cases.
+	 */
+	session_info->security_token->sids = talloc_zero_array(
+						session_info->security_token,
+						struct dom_sid,
+						user_info_dc->num_sids);
+	if (session_info->security_token->sids == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	for (i = PRIMARY_USER_SID_INDEX; i < user_info_dc->num_sids; i++) {
+		struct security_token *nt_token = session_info->security_token;
+		int cmp;
+
+		/*
+		 * S-1-5-88-X-Y sids are only used to give hints
+		 * to the unix token construction.
+		 *
+		 * S-1-5-88-1-Y gives the uid=Y
+		 * S-1-5-88-2-Y gives the gid=Y
+		 * S-1-5-88-3-Y gives flags=Y: AUTH3_UNIX_HINT_*
+		 */
+		cmp = dom_sid_compare_domain(&global_sid_Unix_NFS,
+					     &user_info_dc->sids[i]);
+		if (cmp == 0) {
+			bool match;
+			uint32_t hint = 0;
+
+			match = sid_peek_rid(&user_info_dc->sids[i], &hint);
+			if (!match) {
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Users,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_uid) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_uid = true;
+				hint_uid = (uid_t)hint;
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Groups,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_gid) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_gid = true;
+				hint_gid = (gid_t)hint;
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Mode,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_flags) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_flags = true;
+				hint_flags = hint;
+				continue;
+			}
+
+			continue;
+		}
+
+		status = add_sid_to_array_unique(nt_token->sids,
+						 &user_info_dc->sids[i],
+						 &nt_token->sids,
+						 &nt_token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			TALLOC_FREE(frame);
+			return status;
+		}
+	}
+
+	/*
+	 * We need at least one usable SID
+	 */
+	if (session_info->security_token->num_sids == 0) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	/*
+	 * We need all tree hints: uid, gid, flags
+	 * or none of them.
+	 */
+	if (found_hint_uid || found_hint_gid || found_hint_flags) {
+		if (!found_hint_uid) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+
+		if (!found_hint_gid) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+
+		if (!found_hint_flags) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+	}
+
+	if (session_info->info->authenticated) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(session_info->security_token,
+					 session_info_flags);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	/*
+	 * unless set otherwise, the session key is the user session
+	 * key from the auth subsystem
+	 */
+	if (user_info_dc->user_session_key.length != 0) {
+		session_info->session_key = data_blob_dup_talloc(session_info,
+						user_info_dc->user_session_key);
+		if (session_info->session_key.data == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+
+	if (!(session_info_flags & AUTH_SESSION_INFO_UNIX_TOKEN)) {
+		goto done;
+	}
+
+	session_info->unix_token = talloc_zero(session_info, struct security_unix_token);
+	if (session_info->unix_token == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+	session_info->unix_token->uid = -1;
+	session_info->unix_token->gid = -1;
+
+	session_info->unix_info = talloc_zero(session_info, struct auth_user_info_unix);
+	if (session_info->unix_info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* Convert the SIDs to uid/gids. */
+
+	ids = talloc_zero_array(frame, struct unixid,
+				session_info->security_token->num_sids);
+	if (ids == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	if (!(hint_flags & AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS)) {
+		ok = sids_to_unixids(session_info->security_token->sids,
+				     session_info->security_token->num_sids,
+				     ids);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+
+	if (found_hint_uid) {
+		session_info->unix_token->uid = hint_uid;
+	} else if (ids[0].type == ID_TYPE_UID) {
+		/*
+		 * The primary SID resolves to a UID only.
+		 */
+		session_info->unix_token->uid = ids[0].id;
+	} else if (ids[0].type == ID_TYPE_BOTH) {
+		/*
+		 * The primary SID resolves to a UID and GID,
+		 * use it as uid and add it as first element
+		 * to the groups array.
+		 */
+		session_info->unix_token->uid = ids[0].id;
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     session_info->unix_token->uid,
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else {
+		/*
+		 * It we can't get a uid, we can't imporsonate
+		 * the user.
+		 */
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (found_hint_gid) {
+		session_info->unix_token->gid = hint_gid;
+	} else {
+		need_getpwuid = true;
+	}
+
+	if (hint_flags & AUTH3_UNIX_HINT_QUALIFIED_NAME) {
+		session_info->unix_info->unix_name =
+			talloc_asprintf(session_info->unix_info,
+					"%s%c%s",
+					session_info->info->domain_name,
+					*lp_winbind_separator(),
+					session_info->info->account_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else if (hint_flags & AUTH3_UNIX_HINT_ISLOLATED_NAME) {
+		session_info->unix_info->unix_name =
+			talloc_strdup(session_info->unix_info,
+				      session_info->info->account_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else {
+		need_getpwuid = true;
+	}
+
+	if (need_getpwuid) {
+		struct passwd *pwd = NULL;
+
+		/*
+		 * Ask the system for the primary gid
+		 * and the real unix name.
+		 */
+		pwd = getpwuid_alloc(frame, session_info->unix_token->uid);
+		if (pwd == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+		if (!found_hint_gid) {
+			session_info->unix_token->gid = pwd->pw_gid;
+		}
+
+		session_info->unix_info->unix_name =
+			talloc_strdup(session_info->unix_info, pwd->pw_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		TALLOC_FREE(pwd);
+	}
+
+	ok = add_gid_to_array_unique(session_info->unix_token,
+				     session_info->unix_token->gid,
+				     &session_info->unix_token->groups,
+				     &session_info->unix_token->ngroups);
+	if (!ok) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* This is a potentially untrusted username for use in %U */
+	alpha_strcpy(tmp, original_user_name, ". _-$", sizeof(tmp));
+	session_info->unix_info->sanitized_username =
+				talloc_strdup(session_info->unix_info, tmp);
+	if (session_info->unix_info->sanitized_username == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	for (i=0; i < session_info->security_token->num_sids; i++) {
+
+		if (ids[i].type != ID_TYPE_GID &&
+		    ids[i].type != ID_TYPE_BOTH) {
+			struct security_token *nt_token =
+				session_info->security_token;
+
+			DEBUG(10, ("Could not convert SID %s to gid, "
+				   "ignoring it\n",
+				   sid_string_dbg(&nt_token->sids[i])));
+			continue;
+		}
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     ids[i].id,
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+	TALLOC_FREE(ids);
+
+	/*
+	 * Now we must get any groups this user has been
+	 * added to in /etc/group and merge them in.
+	 * This has to be done in every code path
+	 * that creates an NT token, as remote users
+	 * may have been added to the local /etc/group
+	 * database. Tokens created merely from the
+	 * info3 structs (via the DC or via the krb5 PAC)
+	 * won't have these local groups. Note the
+	 * groups added here will only be UNIX groups
+	 * (S-1-22-2-XXXX groups) as getgroups_unix_user()
+	 * turns off winbindd before calling getgroups().
+	 *
+	 * NB. This is duplicating work already
+	 * done in the 'unix_user:' case of
+	 * create_token_from_sid() but won't
+	 * do anything other than be inefficient
+	 * in that case.
+	 */
+	if (!(hint_flags & AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS)) {
+		ok = getgroups_unix_user(frame,
+					 session_info->unix_info->unix_name,
+					 session_info->unix_token->gid,
+					 &gids, &num_gids);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+	}
+
+	for (i=0; i < num_gids; i++) {
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     gids[i],
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+	TALLOC_FREE(gids);
+
+	if (hint_flags & AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS) {
+		/*
+		 * We should not translate the unix token uid/gids
+		 * to S-1-22-X-Y SIDs.
+		 */
+		goto done;
+	}
+
+	/*
+	 * Add the "Unix Group" SID for each gid to catch mapped groups
+	 * and their Unix equivalent.  This is to solve the backwards
+	 * compatibility problem of 'valid users = +ntadmin' where
+	 * ntadmin has been paired with "Domain Admins" in the group
+	 * mapping table.  Otherwise smb.conf would need to be changed
+	 * to 'valid user = "Domain Admins"'.  --jerry
+	 *
+	 * For consistency we also add the "Unix User" SID,
+	 * so that the complete unix token is represented within
+	 * the nt token.
+	 */
+
+	uid_to_unix_users_sid(session_info->unix_token->uid, &tmp_sid);
+	status = add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+					 &session_info->security_token->sids,
+					 &session_info->security_token->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	gid_to_unix_groups_sid(session_info->unix_token->gid, &tmp_sid);
+	status = add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+					 &session_info->security_token->sids,
+					 &session_info->security_token->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	for (i=0; i < session_info->unix_token->ngroups; i++ ) {
+		struct security_token *nt_token = session_info->security_token;
+
+		gid_to_unix_groups_sid(session_info->unix_token->groups[i],
+				       &tmp_sid);
+		status = add_sid_to_array_unique(nt_token->sids,
+						 &tmp_sid,
+						 &nt_token->sids,
+						 &nt_token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			TALLOC_FREE(frame);
+			return status;
+		}
+	}
+
+done:
+	security_token_debug(DBGC_AUTH, 10, session_info->security_token);
+	if (session_info->unix_token != NULL) {
+		debug_unix_user_token(DBGC_AUTH, 10,
+				      session_info->unix_token->uid,
+				      session_info->unix_token->gid,
+				      session_info->unix_token->ngroups,
+				      session_info->unix_token->groups);
+	}
+
+	status = log_nt_token(session_info->security_token);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	*session_info_out = talloc_move(mem_ctx, &session_info);
+	TALLOC_FREE(frame);
+	return NT_STATUS_OK;
+}
+
 /***************************************************************************
  Make (and fill) a server_info struct from a 'struct passwd' by conversion
  to a struct samu
@@ -739,31 +1292,6 @@ done:
 	return status;
 }
 
-static NTSTATUS get_system_info3(TALLOC_CTX *mem_ctx,
-				 struct netr_SamInfo3 *info3)
-{
-	NTSTATUS status;
-
-	/* Set account name */
-	init_lsa_String(&info3->base.account_name, "SYSTEM");
-
-	/* Set domain name */
-	init_lsa_StringLarge(&info3->base.logon_domain, "NT AUTHORITY");
-
-
-	status = dom_sid_split_rid(mem_ctx, &global_sid_System,
-				   &info3->base.domain_sid,
-				   &info3->base.rid);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
-	}
-
-	/* Primary gid is the same */
-	info3->base.primary_gid = info3->base.rid;
-
-	return NT_STATUS_OK;
-}
-
 static NTSTATUS get_guest_info3(TALLOC_CTX *mem_ctx,
 				struct netr_SamInfo3 *info3)
 {
@@ -892,80 +1420,148 @@ done:
 static NTSTATUS make_new_session_info_system(TALLOC_CTX *mem_ctx,
 					    struct auth_session_info **session_info)
 {
+	TALLOC_CTX *frame = talloc_stackframe();
+	struct auth_user_info_dc *user_info_dc = NULL;
+	uid_t uid = -1;
+	gid_t gid = -1;
+	uint32_t hint_flags = 0;
+	uint32_t session_info_flags = 0;
 	NTSTATUS status;
-	struct auth_serversupplied_info *server_info;
-	TALLOC_CTX *tmp_ctx;
-
-	tmp_ctx = talloc_stackframe();
-	if (tmp_ctx == NULL) {
-		return NT_STATUS_NO_MEMORY;
-	}
 
-	server_info = make_server_info(tmp_ctx);
-	if (!server_info) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("failed making server_info\n"));
+	status = auth_system_user_info_dc(frame, lp_netbios_name(),
+					  &user_info_dc);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth_system_user_info_dc failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	server_info->info3 = talloc_zero(server_info, struct netr_SamInfo3);
-	if (!server_info->info3) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc failed setting info3\n"));
+	/*
+	 * Just get the initial uid/gid
+	 * and don't expand the unix groups.
+	 */
+	uid = sec_initial_uid();
+	gid = sec_initial_gid();
+	hint_flags |= AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS;
+
+	/*
+	 * Also avoid sid mapping to gids,
+	 * as well as adding the unix_token uid/gids as
+	 * S-1-22-X-Y SIDs to the nt token.
+	 */
+	hint_flags |= AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS;
+	hint_flags |= AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS;
+
+	/*
+	 * The unix name will be "NT AUTHORITY+SYSTEM",
+	 * where '+' is the "winbind separator" character.
+	 */
+	hint_flags |= AUTH3_UNIX_HINT_QUALIFIED_NAME;
+	status = auth3_user_info_dc_add_hints(user_info_dc,
+					      uid,
+					      gid,
+					      hint_flags);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth3_user_info_dc_add_hints failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	status = get_system_info3(server_info, server_info->info3);
+	session_info_flags |= AUTH_SESSION_INFO_SIMPLE_PRIVILEGES;
+	session_info_flags |= AUTH_SESSION_INFO_UNIX_TOKEN;
+	status = auth3_session_info_create(mem_ctx, user_info_dc,
+					   user_info_dc->info->account_name,
+					   session_info_flags,
+					   session_info);
 	if (!NT_STATUS_IS_OK(status)) {
-		DEBUG(0, ("Failed creating system info3 with %s\n",
+		DEBUG(0, ("auth3_session_info_create failed: %s\n",
 			  nt_errstr(status)));
 		goto done;
 	}
 
-	server_info->utok.uid = sec_initial_uid();
-	server_info->utok.gid = sec_initial_gid();
-	server_info->unix_name = talloc_asprintf(server_info,
-						 "NT AUTHORITY%cSYSTEM",
-						 *lp_winbind_separator());
+done:
+	TALLOC_FREE(frame);
+	return status;
+}
 
-	if (!server_info->unix_name) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc_asprintf failed setting unix_name\n"));
-		goto done;
-	}
+static NTSTATUS make_new_session_info_anonymous(TALLOC_CTX *mem_ctx,
+					struct auth_session_info **session_info)
+{
+	TALLOC_CTX *frame = talloc_stackframe();
+	const char *guest_account = lp_guest_account();
+	struct auth_user_info_dc *user_info_dc = NULL;
+	struct passwd *pwd = NULL;
+	uint32_t hint_flags = 0;
+	uint32_t session_info_flags = 0;
+	NTSTATUS status;
 
-	server_info->security_token = talloc_zero(server_info, struct security_token);
-	if (!server_info->security_token) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc failed setting security token\n"));
+	/*
+	 * We use the guest account for the unix token
+	 * while we use a true anonymous nt token.
+	 *
+	 * It's very important to have a separate
+	 * nt token for anonymous.
+	 */
+
+	pwd = Get_Pwnam_alloc(frame, guest_account);
+	if (pwd == NULL) {
+		DBG_ERR("Unable to locate guest account [%s]!\n",
+			guest_account);
+		status = NT_STATUS_NO_SUCH_USER;
 		goto done;
 	}
 
-	status = add_sid_to_array_unique(server_info->security_token->sids,
-					 &global_sid_System,
-					 &server_info->security_token->sids,
-					 &server_info->security_token->num_sids);
+	status = auth_anonymous_user_info_dc(frame, lp_netbios_name(),
+					     &user_info_dc);
 	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth_anonymous_user_info_dc failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	/* SYSTEM has all privilages */
-	server_info->security_token->privilege_mask = ~0;
-
-	/* Now turn the server_info into a session_info with the full token etc */
-	status = create_local_token(mem_ctx, server_info, NULL, "SYSTEM", session_info);
-	talloc_free(server_info);
+	/*
+	 * Note we don't pass AUTH3_UNIX_HINT_QUALIFIED_NAME
+	 * nor AUTH3_UNIX_HINT_ISOLATED_NAME here
+	 * as we want the unix name be found by getpwuid_alloc().
+	 */
 
+	status = auth3_user_info_dc_add_hints(user_info_dc,
+					      pwd->pw_uid,
+					      pwd->pw_gid,
+					      hint_flags);
 	if (!NT_STATUS_IS_OK(status)) {
-		DEBUG(0, ("create_local_token failed: %s\n",
+		DEBUG(0, ("auth3_user_info_dc_add_hints failed: %s\n",
 			  nt_errstr(status)));
 		goto done;
 	}
 
-	talloc_steal(mem_ctx, *session_info);
+	/*
+	 * In future we may want to remove
+	 * AUTH_SESSION_INFO_DEFAULT_GROUPS.
+	 *
+	 * Similar to Windows with EveryoneIncludesAnonymous
+	 * and RestrictAnonymous.
+	 *
+	 * We may introduce AUTH_SESSION_INFO_ANON_WORLD...
+	 *
+	 * But for this is required to keep the existing tests
+	 * working.
+	 */
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	session_info_flags |= AUTH_SESSION_INFO_SIMPLE_PRIVILEGES;
+	session_info_flags |= AUTH_SESSION_INFO_UNIX_TOKEN;
+	status = auth3_session_info_create(mem_ctx, user_info_dc,
+					   "",
+					   session_info_flags,
+					   session_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth3_session_info_create failed: %s\n",
+			  nt_errstr(status)));
+		goto done;
+	}
 
 done:
-	TALLOC_FREE(tmp_ctx);
+	TALLOC_FREE(frame);
 	return status;
 }
 
@@ -1045,7 +1641,6 @@ static struct auth_serversupplied_info *
 	SMB_ASSERT(src->unix_info);
 
 	dst->guest = true;
-	dst->system = false;
 
 	/* This element must be provided to convert back to an
 	 * auth_serversupplied_info.  This needs to be from the
@@ -1068,12 +1663,6 @@ static struct auth_serversupplied_info *
 	 * to take the wrong path */
 	SMB_ASSERT(src->security_token);
 
-	dst->security_token = dup_nt_token(dst, src->security_token);
-	if (!dst->security_token) {
-		TALLOC_FREE(dst);
-		return NULL;
-	}
-
 	dst->session_key = data_blob_talloc( dst, src->session_key.data,
 						src->session_key.length);
 
@@ -1094,6 +1683,7 @@ static struct auth_serversupplied_info *
 		return NULL;
 	}
 
+	dst->cached_session_info = src;
 	return dst;
 }
 
@@ -1152,15 +1742,30 @@ bool session_info_set_session_key(struct
 }
 
 static struct auth_session_info *guest_info = NULL;
+static struct auth_session_info *anonymous_info = NULL;
 
 static struct auth_serversupplied_info *guest_server_info = NULL;
 
 bool init_guest_info(void)
 {
+	NTSTATUS status;
+
 	if (guest_info != NULL)
 		return true;
 
-	return NT_STATUS_IS_OK(make_new_session_info_guest(&guest_info, &guest_server_info));
+	status = make_new_session_info_guest(&guest_info,
+					     &guest_server_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+
+	status = make_new_session_info_anonymous(NULL,
+						 &anonymous_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+
+	return true;
 }
 
 NTSTATUS make_server_info_guest(TALLOC_CTX *mem_ctx,
@@ -1181,6 +1786,51 @@ NTSTATUS make_session_info_guest(TALLOC_
 	return (*session_info != NULL) ? NT_STATUS_OK : NT_STATUS_NO_MEMORY;
 }
 
+NTSTATUS make_server_info_anonymous(TALLOC_CTX *mem_ctx,
+				    struct auth_serversupplied_info **server_info)
+{
+	if (anonymous_info == NULL) {
+		return NT_STATUS_UNSUCCESSFUL;
+	}
+
+	/*
+	 * This is trickier than it would appear to need to be because
+	 * we are trying to avoid certain costly operations when the
+	 * structure is converted to a 'auth_session_info' again in
+	 * create_local_token()
+	 *
+	 * We use a guest server_info, but with the anonymous session info,
+	 * which means create_local_token() will return a copy
+	 * of the anonymous token.
+	 *
+	 * The server info is just used as legacy in order to
+	 * keep existing code working. Maybe some debug messages
+	 * will still refer to guest instead of anonymous.
+	 */
+	*server_info = copy_session_info_serverinfo_guest(mem_ctx, anonymous_info,
+							  guest_server_info);
+	if (*server_info == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	return NT_STATUS_OK;
+}
+
+NTSTATUS make_session_info_anonymous(TALLOC_CTX *mem_ctx,
+				     struct auth_session_info **session_info)
+{
+	if (anonymous_info == NULL) {
+		return NT_STATUS_UNSUCCESSFUL;
+	}
+
+	*session_info = copy_session_info(mem_ctx, anonymous_info);
+	if (*session_info == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	return NT_STATUS_OK;
+}
+
 static struct auth_session_info *system_info = NULL;
 
 NTSTATUS init_system_session_info(void)
diff -Npur samba-4.7.6/source3/auth/proto.h samba-4.7.7/source3/auth/proto.h
--- samba-4.7.6/source3/auth/proto.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/auth/proto.h	2018-04-17 09:35:02.000000000 +0200
@@ -225,6 +225,38 @@ NTSTATUS create_local_token(TALLOC_CTX *
 			    DATA_BLOB *session_key,
 			    const char *smb_name,
 			    struct auth_session_info **session_info_out);
+
+/*
+ * The unix name should be constructed as DOMAIN+ACCOUNT,
+ * while '+' will be the "winbind separator" character.
+ */
+#define AUTH3_UNIX_HINT_QUALIFIED_NAME             0x00000001
+/*
+ * The unix name will be just ACCOUNT
+ */
+#define AUTH3_UNIX_HINT_ISLOLATED_NAME             0x00000002
+/*
+ * Don't translate the nt token SIDS into uid/gids
+ */
+#define AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS   0x00000004
+/*
+ * Don't translate the unix token uid/gids to S-1-22-X-Y SIDS
+ */
+#define AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS     0x00000008
+/*
+ * The unix token won't get expanded gid values
+ * from getgroups_unix_user()
+ */
+#define AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS    0x00000010
+NTSTATUS auth3_user_info_dc_add_hints(struct auth_user_info_dc *user_info_dc,
+				      uid_t uid,
+				      gid_t gid,
+				      uint32_t flags);
+NTSTATUS auth3_session_info_create(TALLOC_CTX *mem_ctx,
+				   const struct auth_user_info_dc *user_info_dc,
+				   const char *original_user_name,
+				   uint32_t session_info_flags,
+				   struct auth_session_info **session_info_out);
 NTSTATUS create_token_from_username(TALLOC_CTX *mem_ctx, const char *username,
 				    bool is_guest,
 				    uid_t *uid, gid_t *gid,
@@ -252,6 +284,10 @@ NTSTATUS make_server_info_guest(TALLOC_C
 				struct auth_serversupplied_info **server_info);
 NTSTATUS make_session_info_guest(TALLOC_CTX *mem_ctx,
 				struct auth_session_info **server_info);
+NTSTATUS make_server_info_anonymous(TALLOC_CTX *mem_ctx,
+				    struct auth_serversupplied_info **server_info);
+NTSTATUS make_session_info_anonymous(TALLOC_CTX *mem_ctx,
+				     struct auth_session_info **psession_info);
 NTSTATUS make_session_info_system(TALLOC_CTX *mem_ctx,
 				 struct auth_session_info **session_info);
 const struct auth_session_info *get_session_info_system(void);
@@ -359,6 +395,8 @@ struct security_token *create_local_nt_t
 					    bool is_guest,
 					    int num_groupsids,
 					    const struct dom_sid *groupsids);
+NTSTATUS finalize_local_nt_token(struct security_token *result,
+				 uint32_t session_info_flags);
 NTSTATUS get_user_sid_info3_and_extra(const struct netr_SamInfo3 *info3,
 				      const struct extra_auth_info *extra,
 				      struct dom_sid *sid);
diff -Npur samba-4.7.6/source3/auth/token_util.c samba-4.7.7/source3/auth/token_util.c
--- samba-4.7.6/source3/auth/token_util.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/auth/token_util.c	2018-04-17 09:35:02.000000000 +0200
@@ -190,6 +190,9 @@ static NTSTATUS add_builtin_administrato
 	if ( IS_DC ) {
 		sid_copy( &domadm, get_global_sam_sid() );
 	} else {
+		if (dom_sid == NULL) {
+			return NT_STATUS_INVALID_PARAMETER_MIX;
+		}
 		sid_copy(&domadm, dom_sid);
 	}
 	sid_append_rid( &domadm, DOMAIN_RID_ADMINS );
@@ -208,8 +211,76 @@ static NTSTATUS add_builtin_administrato
 	return NT_STATUS_OK;
 }
 
-static NTSTATUS finalize_local_nt_token(struct security_token *result,
-					bool is_guest);
+static NTSTATUS add_builtin_guests(struct security_token *token,
+				   const struct dom_sid *dom_sid)
+{
+	struct dom_sid tmp_sid;
+	NTSTATUS status;
+
+	/*
+	 * First check the local GUEST account.
+	 */
+	sid_copy(&tmp_sid, get_global_sam_sid());
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUEST);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	/*
+	 * First check the local GUESTS group.
+	 */
+	sid_copy(&tmp_sid, get_global_sam_sid());
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUESTS);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	if (lp_server_role() != ROLE_DOMAIN_MEMBER) {
+		return NT_STATUS_OK;
+	}
+
+	if (dom_sid == NULL) {
+		return NT_STATUS_INVALID_PARAMETER_MIX;
+	}
+
+	/*
+	 * First check the domain GUESTS group.
+	 */
+	sid_copy(&tmp_sid, dom_sid);
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUESTS);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	return NT_STATUS_OK;
+}
+
+static NTSTATUS add_local_groups(struct security_token *result,
+				 bool is_guest);
 
 NTSTATUS get_user_sid_info3_and_extra(const struct netr_SamInfo3 *info3,
 				      const struct extra_auth_info *extra,
@@ -240,6 +311,7 @@ NTSTATUS create_local_nt_token_from_info
 					  struct security_token **ntok)
 {
 	struct security_token *usrtok = NULL;
+	uint32_t session_info_flags = 0;
 	NTSTATUS status;
 	int i;
 
@@ -323,7 +395,19 @@ NTSTATUS create_local_nt_token_from_info
 		}
 	}
 
-	status = finalize_local_nt_token(usrtok, is_guest);
+	status = add_local_groups(usrtok, is_guest);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(3, ("Failed to add local groups\n"));
+		TALLOC_FREE(usrtok);
+		return status;
+	}
+
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	if (!is_guest) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(usrtok, session_info_flags);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(3, ("Failed to finalize nt token\n"));
 		TALLOC_FREE(usrtok);
@@ -347,6 +431,7 @@ struct security_token *create_local_nt_t
 	struct security_token *result = NULL;
 	int i;
 	NTSTATUS status;
+	uint32_t session_info_flags = 0;
 
 	DEBUG(10, ("Create local NT token for %s\n",
 		   sid_string_dbg(user_sid)));
@@ -392,12 +477,46 @@ struct security_token *create_local_nt_t
 		}
 	}
 
-	status = finalize_local_nt_token(result, is_guest);
+	status = add_local_groups(result, is_guest);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(result);
+		return NULL;
+	}
+
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	if (!is_guest) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(result, session_info_flags);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(result);
 		return NULL;
 	}
 
+	if (is_guest) {
+		/*
+		 * It's ugly, but for now it's
+		 * needed to add Builtin_Guests
+		 * here, the "local" token only
+		 * consist of S-1-22-* SIDs
+		 * and finalize_local_nt_token()
+		 * doesn't have the chance to
+		 * to detect it need to
+		 * add Builtin_Guests via
+		 * add_builtin_guests().
+		 */
+		status = add_sid_to_array_unique(result,
+						 &global_sid_Builtin_Guests,
+						 &result->sids,
+						 &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(3, ("Failed to add SID to nt token\n"));
+			TALLOC_FREE(result);
+			return NULL;
+		}
+	}
+
 	return result;
 }
 
@@ -495,41 +614,53 @@ static NTSTATUS add_local_groups(struct
 	return NT_STATUS_OK;
 }
 
-static NTSTATUS finalize_local_nt_token(struct security_token *result,
-					bool is_guest)
+NTSTATUS finalize_local_nt_token(struct security_token *result,
+				 uint32_t session_info_flags)
 {
-	struct dom_sid dom_sid;
+	struct dom_sid _dom_sid = { 0, };
+	struct dom_sid *domain_sid = NULL;
 	NTSTATUS status;
 	struct acct_info *info;
+	bool ok;
 
-	/* Add any local groups. */
+	result->privilege_mask = 0;
+	result->rights_mask = 0;
 
-	status = add_local_groups(result, is_guest);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	if (result->num_sids == 0) {
+		return NT_STATUS_INVALID_TOKEN;
 	}
 
-	/* Add in BUILTIN sids */
+	if (session_info_flags & AUTH_SESSION_INFO_DEFAULT_GROUPS) {
+		status = add_sid_to_array(result, &global_sid_World,
+					  &result->sids, &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+		status = add_sid_to_array(result, &global_sid_Network,
+					  &result->sids, &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+	}
 
-	status = add_sid_to_array(result, &global_sid_World,
-				  &result->sids, &result->num_sids);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	/*
+	 * Don't expand nested groups of system, anonymous etc
+	 *
+	 * Note that they still get SID_WORLD and SID_NETWORK
+	 * for now in order let existing tests pass.
+	 *
+	 * But SYSTEM doesn't get AUTHENTICATED_USERS
+	 * and ANONYMOUS doesn't get BUILTIN GUESTS anymore.
+	 */
+	if (security_token_is_anonymous(result)) {
+		return NT_STATUS_OK;
 	}
-	status = add_sid_to_array(result, &global_sid_Network,
-				  &result->sids, &result->num_sids);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	if (security_token_is_system(result)) {
+		result->privilege_mask = ~0;
+		return NT_STATUS_OK;
 	}
 
-	if (is_guest) {
-		status = add_sid_to_array(result, &global_sid_Builtin_Guests,
-					  &result->sids,
-					  &result->num_sids);
-		if (!NT_STATUS_IS_OK(status)) {
-			return status;
-		}
-	} else {
+	if (session_info_flags & AUTH_SESSION_INFO_AUTHENTICATED) {
 		status = add_sid_to_array(result,
 					  &global_sid_Authenticated_Users,
 					  &result->sids,
@@ -539,6 +670,18 @@ static NTSTATUS finalize_local_nt_token(
 		}
 	}
 
+	/* Add in BUILTIN sids */
+
+	become_root();
+	ok = secrets_fetch_domain_sid(lp_workgroup(), &_dom_sid);
+	if (ok) {
+		domain_sid = &_dom_sid;
+	} else {
+		DEBUG(3, ("Failed to fetch domain sid for %s\n",
+			  lp_workgroup()));
+	}
+	unbecome_root();
+
 	info = talloc_zero(talloc_tos(), struct acct_info);
 	if (info == NULL) {
 		DEBUG(0, ("talloc failed!\n"));
@@ -553,18 +696,12 @@ static NTSTATUS finalize_local_nt_token(
 	if (!NT_STATUS_IS_OK(status)) {
 
 		become_root();
-		if (!secrets_fetch_domain_sid(lp_workgroup(), &dom_sid)) {
-			status = NT_STATUS_OK;
-			DEBUG(3, ("Failed to fetch domain sid for %s\n",
-				  lp_workgroup()));
-		} else {
-			status = create_builtin_administrators(&dom_sid);
-		}
+		status = create_builtin_administrators(domain_sid);
 		unbecome_root();
 
 		if (NT_STATUS_EQUAL(status, NT_STATUS_PROTOCOL_UNREACHABLE)) {
 			/* Add BUILTIN\Administrators directly to token. */
-			status = add_builtin_administrators(result, &dom_sid);
+			status = add_builtin_administrators(result, domain_sid);
 			if ( !NT_STATUS_IS_OK(status) ) {
 				DEBUG(3, ("Failed to check for local "
 					  "Administrators membership (%s)\n",
@@ -585,13 +722,7 @@ static NTSTATUS finalize_local_nt_token(
 	if (!NT_STATUS_IS_OK(status)) {
 
 		become_root();
-		if (!secrets_fetch_domain_sid(lp_workgroup(), &dom_sid)) {
-			status = NT_STATUS_OK;
-			DEBUG(3, ("Failed to fetch domain sid for %s\n",
-				  lp_workgroup()));
-		} else {
-			status = create_builtin_users(&dom_sid);
-		}
+		status = create_builtin_users(domain_sid);
 		unbecome_root();
 
 		if (!NT_STATUS_EQUAL(status, NT_STATUS_PROTOCOL_UNREACHABLE) &&
@@ -602,6 +733,28 @@ static NTSTATUS finalize_local_nt_token(
 		}
 	}
 
+	/*
+	 * Add BUILTIN\Guests directly to token.
+	 * But only if the token already indicates
+	 * real guest access by:
+	 * - local GUEST account
+	 * - local GUESTS group
+	 * - domain GUESTS group
+	 *
+	 * Even if a user was authenticated, it
+	 * can be member of a guest related group.
+	 */
+	status = add_builtin_guests(result, domain_sid);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(3, ("Failed to check for local "
+			  "Guests membership (%s)\n",
+			  nt_errstr(status)));
+		/*
+		 * This is a hard error.
+		 */
+		return status;
+	}
+
 	TALLOC_FREE(info);
 
 	/* Deal with local groups */
@@ -631,10 +784,16 @@ static NTSTATUS finalize_local_nt_token(
 		unbecome_root();
 	}
 
-	/* Add privileges based on current user sids */
 
-	get_privileges_for_sids(&result->privilege_mask, result->sids,
-				result->num_sids);
+	if (session_info_flags & AUTH_SESSION_INFO_SIMPLE_PRIVILEGES) {
+		if (security_token_has_builtin_administrators(result)) {
+			result->privilege_mask = ~0;
+		}
+	} else {
+		/* Add privileges based on current user sids */
+		get_privileges_for_sids(&result->privilege_mask, result->sids,
+					result->num_sids);
+	}
 
 	return NT_STATUS_OK;
 }
diff -Npur samba-4.7.6/source3/include/auth.h samba-4.7.7/source3/include/auth.h
--- samba-4.7.6/source3/include/auth.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/include/auth.h	2018-04-17 09:35:02.000000000 +0200
@@ -30,20 +30,18 @@ struct extra_auth_info {
 
 struct auth_serversupplied_info {
 	bool guest;
-	bool system;
 
 	struct security_unix_token utok;
 
 	/*
-	 * NT group information taken from the info3 structure
+	 * A complete auth_session_info
 	 *
 	 * This is not normally filled in, during the typical
 	 * authentication process.  If filled in, it has already been
 	 * finalised by a nasty hack to support a cached guest/system
 	 * session_info
 	 */
-
-	struct security_token *security_token;
+	const struct auth_session_info *cached_session_info;
 
 	/* These are the intermediate session keys, as provided by a
 	 * NETLOGON server and used by NTLMSSP to negotiate key
diff -Npur samba-4.7.6/source3/lib/messages.c samba-4.7.7/source3/lib/messages.c
--- samba-4.7.6/source3/lib/messages.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.7/source3/lib/messages.c	2018-04-17 09:35:02.000000000 +0200
@@ -248,6 +248,13 @@ static NTSTATUS messaging_init_internal(
 	const char *priv_path;
 	bool ok;
 
+	/*
+	 * sec_init() *must* be called before any other
+	 * functions that use sec_XXX(). e.g. sec_initial_uid().
+	 */
+
+	sec_init();
+
 	lck_path = lock_path("msg.lock");
 	if (lck_path == NULL) {
 		return NT_STATUS_NO_MEMORY;
@@ -292,8 +299,6 @@ static NTSTATUS messaging_init_internal(
 
 	ctx->event_ctx = ev;
 
-	sec_init();
-
 	ctx->msg_dgm_ref = messaging_dgm_ref(ctx,
 					     ctx->event_ctx,
 					     &ctx->id.unique_id,
diff -Npur samba-4.7.6/source3/libads/ldap_utils.c samba-4.7.7/source3/libads/ldap_utils.c
--- samba-4.7.6/source3/libads/ldap_utils.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/libads/ldap_utils.c	2018-04-17 09:35:02.000000000 +0200
@@ -105,9 +105,18 @@ static ADS_STATUS ads_do_search_retry_in
 		status = ads_connect(ads);
 
 		if (!ADS_ERR_OK(status)) {
+			bool orig_is_mine = ads->is_mine;
+
 			DEBUG(1,("ads_search_retry: failed to reconnect (%s)\n",
 				 ads_errstr(status)));
+			/*
+			 * We need to keep the ads pointer
+			 * from being freed here as we don't own it and
+			 * callers depend on it being around.
+			 */
+			ads->is_mine = false;
 			ads_destroy(&ads);
+			ads->is_mine = orig_is_mine;
 			SAFE_FREE(bp);
 			return status;
 		}
diff -Npur samba-4.7.6/source3/librpc/idl/smbXsrv.idl samba-4.7.7/source3/librpc/idl/smbXsrv.idl
--- samba-4.7.6/source3/librpc/idl/smbXsrv.idl	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/librpc/idl/smbXsrv.idl	2018-04-17 09:35:02.000000000 +0200
@@ -430,7 +430,8 @@ interface smbXsrv
 		uint32					durable_timeout_msec;
 		boolean8				durable;
 		DATA_BLOB				backend_cookie;
-		hyper					channel_sequence;
+		uint16					channel_sequence;
+		hyper					channel_generation;
 	} smbXsrv_open_global0;
 
 	typedef union {
diff -Npur samba-4.7.6/source3/libsmb/cliconnect.c samba-4.7.7/source3/libsmb/cliconnect.c
--- samba-4.7.6/source3/libsmb/cliconnect.c	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.7/source3/libsmb/cliconnect.c	2018-04-17 09:35:02.000000000 +0200
@@ -283,8 +283,9 @@ NTSTATUS cli_session_creds_prepare_krb5(
 
 	auth_requested = cli_credentials_authentication_requested(creds);
 	if (auth_requested) {
+		errno = 0;
 		user_principal = cli_credentials_get_principal(creds, frame);
-		if (user_principal == NULL) {
+		if (errno != 0) {
 			TALLOC_FREE(frame);
 			return NT_STATUS_NO_MEMORY;
 		}
@@ -299,6 +300,10 @@ NTSTATUS cli_session_creds_prepare_krb5(
 		try_kerberos = true;
 	}
 
+	if (user_principal == NULL) {
+		try_kerberos = false;
+	}
+
 	if (target_hostname == NULL) {
 		try_kerberos = false;
 	} else if (is_ipaddress(target_hostname)) {
@@ -1284,7 +1289,7 @@ static struct tevent_req *cli_session_se
 
 	status = cli_session_creds_prepare_krb5(cli, creds);
 	if (tevent_req_nterror(req, status)) {
-		return tevent_req_post(req, ev);;
+		return tevent_req_post(req, ev);
 	}
 
 	subreq = cli_session_setup_gensec_send(state, ev, cli, creds,
diff -Npur samba-4.7.6/source3/libsmb/clientgen.c samba-4.7.7/source3/libsmb/clientgen.c
--- samba-4.7.6/source3/libsmb/clientgen.c	2017-09-21 08:28:20.000000000 +0200
+++ samba-4.7.7/source3/libsmb/clientgen.c	2018-04-17 09:35:02.000000000 +0200
@@ -371,7 +371,7 @@ uint32_t cli_state_set_tid(struct cli_st
 	uint32_t ret;
 	if (smbXcli_conn_protocol(cli->conn) >= PROTOCOL_SMB2_02) {
 		ret = smb2cli_tcon_current_id(cli->smb2.tcon);
-		smb2cli_tcon_set_id(cli->smb1.tcon, tid);
+		smb2cli_tcon_set_id(cli->smb2.tcon, tid);
 	} else {
 		ret = smb1cli_tcon_current_id(cli->smb1.tcon);
 		smb1cli_tcon_set_id(cli->smb1.tcon, tid);
diff -Npur samba-4.7.6/source3/libsmb/libsmb_server.c samba-4.7.7/source3/libsmb/libsmb_server.c
--- samba-4.7.6/source3/libsmb/libsmb_server.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/libsmb/libsmb_server.c	2018-04-17 09:35:02.000000000 +0200
@@ -360,8 +360,8 @@ SMBC_server_internal(TALLOC_CTX *ctx,
 						  "?????",
 						  *pp_password);
 			if (!NT_STATUS_IS_OK(status)) {
-                                errno = map_errno_from_nt_status(status);
                                 cli_shutdown(srv->cli);
+                                errno = map_errno_from_nt_status(status);
 				srv->cli = NULL;
                                 smbc_getFunctionRemoveCachedServer(context)(context,
                                                                             srv);
@@ -571,8 +571,8 @@ SMBC_server_internal(TALLOC_CTX *ctx,
 
 	status = cli_tree_connect_creds(c, share, "?????", creds);
 	if (!NT_STATUS_IS_OK(status)) {
-		errno = map_errno_from_nt_status(status);
 		cli_shutdown(c);
+		errno = map_errno_from_nt_status(status);
 		return NULL;
 	}
 
diff -Npur samba-4.7.6/source3/modules/vfs_default.c samba-4.7.7/source3/modules/vfs_default.c
--- samba-4.7.6/source3/modules/vfs_default.c	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/source3/modules/vfs_default.c	2018-04-17 09:35:02.000000000 +0200
@@ -2235,9 +2235,12 @@ static struct smb_filename *vfswrap_getw
 				NULL,
 				NULL,
 				0);
-	if (smb_fname == NULL) {
-		SAFE_FREE(result);
-	}
+	/*
+	 * sys_getwd() *always* returns malloced memory.
+	 * We must free here to avoid leaks:
+	 * BUG:https://bugzilla.samba.org/show_bug.cgi?id=13372
+	 */
+	SAFE_FREE(result);
 	return smb_fname;
 }
 
diff -Npur samba-4.7.6/source3/modules/vfs_fruit.c samba-4.7.7/source3/modules/vfs_fruit.c
--- samba-4.7.6/source3/modules/vfs_fruit.c	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/source3/modules/vfs_fruit.c	2018-04-17 09:35:02.000000000 +0200
@@ -2936,10 +2936,54 @@ static NTSTATUS readdir_attr_macmeta(str
 	return status;
 }
 
+static NTSTATUS remove_virtual_nfs_aces(struct security_descriptor *psd)
+{
+	NTSTATUS status;
+	uint32_t i;
+
+	if (psd->dacl == NULL) {
+		return NT_STATUS_OK;
+	}
+
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		/* MS NFS style mode/uid/gid */
+		int cmp = dom_sid_compare_domain(
+				&global_sid_Unix_NFS,
+				&psd->dacl->aces[i].trustee);
+		if (cmp != 0) {
+			/* Normal ACE entry. */
+			continue;
+		}
+
+		/*
+		 * security_descriptor_dacl_del()
+		 * *must* return NT_STATUS_OK as we know
+		 * we have something to remove.
+		 */
+
+		status = security_descriptor_dacl_del(psd,
+				&psd->dacl->aces[i].trustee);
+		if (!NT_STATUS_IS_OK(status)) {
+			DBG_WARNING("failed to remove MS NFS style ACE: %s\n",
+				nt_errstr(status));
+			return status;
+		}
+
+		/*
+		 * security_descriptor_dacl_del() may delete more
+		 * then one entry subsequent to this one if the
+		 * SID matches, but we only need to ensure that
+		 * we stay looking at the same element in the array.
+		 */
+		i--;
+	}
+	return NT_STATUS_OK;
+}
+
 /* Search MS NFS style ACE with UNIX mode */
 static NTSTATUS check_ms_nfs(vfs_handle_struct *handle,
 			     files_struct *fsp,
-			     const struct security_descriptor *psd,
+			     struct security_descriptor *psd,
 			     mode_t *pmode,
 			     bool *pdo_chmod)
 {
@@ -2973,7 +3017,12 @@ static NTSTATUS check_ms_nfs(vfs_handle_
 		}
 	}
 
-	return NT_STATUS_OK;
+	/*
+	 * Remove any incoming virtual ACE entries generated by
+	 * fruit_fget_nt_acl().
+	 */
+
+	return remove_virtual_nfs_aces(psd);
 }
 
 /****************************************************************************
@@ -5677,6 +5726,13 @@ static NTSTATUS fruit_fget_nt_acl(vfs_ha
 		return NT_STATUS_OK;
 	}
 
+	/* First remove any existing ACE's with NFS style mode/uid/gid SIDs. */
+	status = remove_virtual_nfs_aces(*ppdesc);
+	if (!NT_STATUS_IS_OK(status)) {
+		DBG_WARNING("failed to remove MS NFS style ACEs\n");
+		return status;
+	}
+
 	/* MS NFS style mode */
 	sid_compose(&sid, &global_sid_Unix_NFS_Mode, fsp->fsp_name->st.st_ex_mode);
 	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
@@ -5710,24 +5766,53 @@ static NTSTATUS fruit_fget_nt_acl(vfs_ha
 static NTSTATUS fruit_fset_nt_acl(vfs_handle_struct *handle,
 				  files_struct *fsp,
 				  uint32_t security_info_sent,
-				  const struct security_descriptor *psd)
+				  const struct security_descriptor *orig_psd)
 {
 	NTSTATUS status;
 	bool do_chmod;
 	mode_t ms_nfs_mode = 0;
 	int result;
+	struct security_descriptor *psd = NULL;
+	uint32_t orig_num_aces = 0;
+
+	if (orig_psd->dacl != NULL) {
+		orig_num_aces = orig_psd->dacl->num_aces;
+	}
+
+	psd = security_descriptor_copy(talloc_tos(), orig_psd);
+	if (psd == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
 
 	DBG_DEBUG("fruit_fset_nt_acl: %s\n", fsp_str_dbg(fsp));
 
 	status = check_ms_nfs(handle, fsp, psd, &ms_nfs_mode, &do_chmod);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("fruit_fset_nt_acl: check_ms_nfs failed%s\n", fsp_str_dbg(fsp)));
+		TALLOC_FREE(psd);
 		return status;
 	}
 
+	/*
+	 * If only ms_nfs ACE entries were sent, ensure we set the DACL
+	 * sent/present flags correctly now we've removed them.
+	 */
+
+	if (orig_num_aces != 0) {
+		/*
+		 * Are there any ACE's left ?
+		 */
+		if (psd->dacl->num_aces == 0) {
+			/* No - clear the DACL sent/present flags. */
+			security_info_sent &= ~SECINFO_DACL;
+			psd->type &= ~SEC_DESC_DACL_PRESENT;
+		}
+	}
+
 	status = SMB_VFS_NEXT_FSET_NT_ACL(handle, fsp, security_info_sent, psd);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("fruit_fset_nt_acl: SMB_VFS_NEXT_FSET_NT_ACL failed%s\n", fsp_str_dbg(fsp)));
+		TALLOC_FREE(psd);
 		return status;
 	}
 
@@ -5745,10 +5830,12 @@ static NTSTATUS fruit_fset_nt_acl(vfs_ha
 				  result, (unsigned)ms_nfs_mode,
 				  strerror(errno)));
 			status = map_nt_error_from_unix(errno);
+			TALLOC_FREE(psd);
 			return status;
 		}
 	}
 
+	TALLOC_FREE(psd);
 	return NT_STATUS_OK;
 }
 
diff -Npur samba-4.7.6/source3/modules/vfs_glusterfs.c samba-4.7.7/source3/modules/vfs_glusterfs.c
--- samba-4.7.6/source3/modules/vfs_glusterfs.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/modules/vfs_glusterfs.c	2018-04-17 09:35:02.000000000 +0200
@@ -964,7 +964,7 @@ static struct tevent_req *vfs_gluster_fs
 
 	PROFILE_TIMESTAMP(&state->start);
 	ret = glfs_fsync_async(*(glfs_fd_t **)VFS_FETCH_FSP_EXTENSION(handle,
-				fsp), aio_glusterfs_done, req);
+				fsp), aio_glusterfs_done, state);
 	if (ret < 0) {
 		tevent_req_error(req, -ret);
 		return tevent_req_post(req, ev);
diff -Npur samba-4.7.6/source3/passdb/pdb_util.c samba-4.7.7/source3/passdb/pdb_util.c
--- samba-4.7.6/source3/passdb/pdb_util.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.7/source3/passdb/pdb_util.c	2018-04-17 09:35:02.000000000 +0200
@@ -130,8 +130,9 @@ NTSTATUS create_builtin_users(const stru
 	}
 
 	/* add domain users */
-	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER))
-		&& sid_compose(&dom_users, dom_sid, DOMAIN_RID_USERS))
+	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER)) &&
+	    (dom_sid != NULL) &&
+	    sid_compose(&dom_users, dom_sid, DOMAIN_RID_USERS))
 	{
 		status = add_sid_to_builtin(&global_sid_Builtin_Users,
 					    &dom_users);
@@ -159,8 +160,9 @@ NTSTATUS create_builtin_administrators(c
 	}
 
 	/* add domain admins */
-	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER))
-		&& sid_compose(&dom_admins, dom_sid, DOMAIN_RID_ADMINS))
+	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER)) &&
+	    (dom_sid != NULL) &&
+	    sid_compose(&dom_admins, dom_sid, DOMAIN_RID_ADMINS))
 	{
 		status = add_sid_to_builtin(&global_sid_Builtin_Administrators,
 					    &dom_admins);
diff -Npur samba-4.7.6/source3/rpc_server/rpc_server.c samba-4.7.7/source3/rpc_server/rpc_server.c
--- samba-4.7.6/source3/rpc_server/rpc_server.c	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.7/source3/rpc_server/rpc_server.c	2018-04-17 09:35:02.000000000 +0200
@@ -1104,14 +1104,11 @@ void dcerpc_ncacn_accept(struct tevent_c
 	}
 
 	if (ncacn_conn->session_info == NULL) {
-		/*
-		 * TODO: use auth_anonymous_session_info() here?
-		 */
-		status = make_session_info_guest(ncacn_conn,
-						 &ncacn_conn->session_info);
+		status = make_session_info_anonymous(ncacn_conn,
+						     &ncacn_conn->session_info);
 		if (!NT_STATUS_IS_OK(status)) {
 			DEBUG(2, ("Failed to create "
-				  "make_session_info_guest - %s\n",
+				  "make_session_info_anonymous - %s\n",
 				  nt_errstr(status)));
 			talloc_free(ncacn_conn);
 			return;
diff -Npur samba-4.7.6/source3/script/tests/test_smbclient_s3.sh samba-4.7.7/source3/script/tests/test_smbclient_s3.sh
--- samba-4.7.6/source3/script/tests/test_smbclient_s3.sh	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/script/tests/test_smbclient_s3.sh	2018-04-17 09:35:02.000000000 +0200
@@ -643,13 +643,17 @@ test_backup_privilege_list()
 {
     tmpfile=$PREFIX/smbclient_backup_privilege_list
 
+    # selftest uses the forward slash as a separator, but "net sam rights
+    # grant" requires the backslash separator
+    USER_TMP=$(printf '%s' "$USERNAME" | tr '/' '\\')
+
     # If we don't have a DOMAIN component to the username, add it.
-    echo "$USERNAME" | grep '\\' 2>&1
+    printf '%s' "$USER_TMP" | grep '\\' 2>&1
     ret=$?
     if [ $ret != 0 ] ; then
-	priv_username="$DOMAIN\\$USERNAME"
+	priv_username="$DOMAIN\\$USER_TMP"
     else
-	priv_username=$USERNAME
+	priv_username="$USER_TMP"
     fi
 
     $NET sam rights grant $priv_username SeBackupPrivilege 2>&1
diff -Npur samba-4.7.6/source3/selftest/tests.py samba-4.7.7/source3/selftest/tests.py
--- samba-4.7.6/source3/selftest/tests.py	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/source3/selftest/tests.py	2018-04-17 09:35:02.000000000 +0200
@@ -78,6 +78,7 @@ tests = ["FDPASS", "LOCK1", "LOCK2", "LO
         "GETADDRINFO", "UID-REGRESSION-TEST", "SHORTNAME-TEST",
         "CASE-INSENSITIVE-CREATE", "SMB2-BASIC", "NTTRANS-FSCTL", "SMB2-NEGPROT",
         "SMB2-SESSION-REAUTH", "SMB2-SESSION-RECONNECT", "SMB2-FTRUNCATE",
+        "SMB2-ANONYMOUS",
         "CLEANUP1",
         "CLEANUP2",
         "CLEANUP4",
@@ -197,6 +198,10 @@ for env in ["nt4_member", "ad_member"]:
 env = "ad_member"
 t = "--krb5auth=$DOMAIN/$DC_USERNAME%$DC_PASSWORD"
 plantestsuite("samba3.wbinfo_simple.(%s:local).%s" % (env, t), "%s:local" % env, [os.path.join(srcdir(), "nsswitch/tests/test_wbinfo_simple.sh"), t])
+plantestsuite("samba3.wbinfo_name_lookup", env,
+              [ os.path.join(srcdir(),
+                            "nsswitch/tests/test_wbinfo_name_lookup.sh"),
+                '$DOMAIN', '$DC_USERNAME' ])
 t = "WBCLIENT-MULTI-PING"
 plantestsuite("samba3.smbtorture_s3.%s" % t, env, [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//foo/bar', '""', '""', smbtorture3, ""])
 plantestsuite("samba3.substitutions", env, [os.path.join(samba3srcdir, "script/tests/test_substitutions.sh"), "$SERVER", "alice", "Secret007", "$PREFIX"])
@@ -485,7 +490,7 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_metadata_stream -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share --option=torture:share2=vfs_wo_fruit', 'metadata_stream')
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_stream_depot -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share --option=torture:share2=vfs_wo_fruit_stream_depot', 'streams_depot')
     elif t == "vfs.fruit_netatalk":
-        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_xattr -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
     elif t == "vfs.fruit_file_id":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit -U$USERNAME%$PASSWORD')
     elif t == "rpc.schannel_anon_setpw":
diff -Npur samba-4.7.6/source3/smbd/dir.c samba-4.7.7/source3/smbd/dir.c
--- samba-4.7.6/source3/smbd/dir.c	2017-11-15 08:42:13.000000000 +0100
+++ samba-4.7.7/source3/smbd/dir.c	2018-04-17 09:35:02.000000000 +0200
@@ -1227,7 +1227,15 @@ bool smbd_dirptr_get_entry(TALLOC_CTX *c
 			mask, smb_fname_str_dbg(&smb_fname),
 			dname, fname));
 
-		DirCacheAdd(dirptr->dir_hnd, dname, cur_offset);
+		if (!conn->sconn->using_smb2) {
+			/*
+			 * The dircache is only needed for SMB1 because SMB1
+			 * uses a name for the resume wheras SMB2 always
+			 * continues from the next position (unless it's told to
+			 * restart or close-and-reopen the listing).
+			 */
+			DirCacheAdd(dirptr->dir_hnd, dname, cur_offset);
+		}
 
 		TALLOC_FREE(dname);
 
@@ -1654,7 +1662,16 @@ static struct smb_Dir *OpenDir_internal(
 	}
 
 	dirp->conn = conn;
-	dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+
+	if (!conn->sconn->using_smb2) {
+		/*
+		 * The dircache is only needed for SMB1 because SMB1 uses a name
+		 * for the resume wheras SMB2 always continues from the next
+		 * position (unless it's told to restart or close-and-reopen the
+		 * listing).
+		 */
+		dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+	}
 
 	if (sconn && !sconn->using_smb2) {
 		sconn->searches.dirhandles_open++;
@@ -1776,7 +1793,16 @@ static struct smb_Dir *OpenDir_fsp(TALLO
 	}
 
 	dirp->conn = conn;
-	dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+
+	if (!conn->sconn->using_smb2) {
+		/*
+		 * The dircache is only needed for SMB1 because SMB1 uses a name
+		 * for the resume wheras SMB2 always continues from the next
+		 * position (unless it's told to restart or close-and-reopen the
+		 * listing).
+		 */
+		dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+	}
 
 	dirp->dir_smb_fname = cp_smb_filename(dirp, fsp->fsp_name);
 	if (!dirp->dir_smb_fname) {
diff -Npur samba-4.7.6/source3/smbd/globals.h samba-4.7.7/source3/smbd/globals.h
--- samba-4.7.6/source3/smbd/globals.h	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.7/source3/smbd/globals.h	2018-04-17 09:35:02.000000000 +0200
@@ -744,6 +744,7 @@ struct smbd_smb2_request {
 	 * adapted again in reply.
 	 */
 	bool request_counters_updated;
+	uint64_t channel_generation;
 
 	/*
 	 * The sub request for async backend calls.
diff -Npur samba-4.7.6/source3/smbd/negprot.c samba-4.7.7/source3/smbd/negprot.c
--- samba-4.7.6/source3/smbd/negprot.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/negprot.c	2018-04-17 09:35:02.000000000 +0200
@@ -65,6 +65,8 @@ static void reply_lanman1(struct smb_req
 	time_t t = time(NULL);
 	struct smbXsrv_connection *xconn = req->xconn;
 	uint16_t raw;
+	NTSTATUS status;
+
 	if (lp_async_smb_echo_handler()) {
 		raw = 0;
 	} else {
@@ -88,7 +90,11 @@ static void reply_lanman1(struct smb_req
 		SSVAL(req->outbuf,smb_vwv11, 8);
 	}
 
-	smbXsrv_connection_init_tables(xconn, PROTOCOL_LANMAN1);
+	status = smbXsrv_connection_init_tables(xconn, PROTOCOL_LANMAN1);
+	if (!NT_STATUS_IS_OK(status)) {
+		reply_nterror(req, status);
+		return;
+	}
 
 	/* Reply, SMBlockread, SMBwritelock supported. */
 	SCVAL(req->outbuf,smb_flg, FLAG_REPLY|FLAG_SUPPORT_LOCKREAD);
@@ -115,6 +121,8 @@ static void reply_lanman2(struct smb_req
 	time_t t = time(NULL);
 	struct smbXsrv_connection *xconn = req->xconn;
 	uint16_t raw;
+	NTSTATUS status;
+
 	if (lp_async_smb_echo_handler()) {
 		raw = 0;
 	} else {
@@ -140,7 +148,11 @@ static void reply_lanman2(struct smb_req
 		SSVAL(req->outbuf,smb_vwv11, 8);
 	}
 
-	smbXsrv_connection_init_tables(xconn, PROTOCOL_LANMAN2);
+	status = smbXsrv_connection_init_tables(xconn, PROTOCOL_LANMAN2);
+	if (!NT_STATUS_IS_OK(status)) {
+		reply_nterror(req, status);
+		return;
+	}
 
 	/* Reply, SMBlockread, SMBwritelock supported. */
 	SCVAL(req->outbuf,smb_flg,FLAG_REPLY|FLAG_SUPPORT_LOCKREAD);
@@ -260,6 +272,7 @@ static void reply_nt1(struct smb_request
 	struct smbXsrv_connection *xconn = req->xconn;
 	bool signing_desired = false;
 	bool signing_required = false;
+	NTSTATUS status;
 
 	xconn->smb1.negprot.encrypted_passwords = lp_encrypt_passwords();
 
@@ -337,7 +350,11 @@ static void reply_nt1(struct smb_request
 	SSVAL(req->outbuf,smb_vwv0,choice);
 	SCVAL(req->outbuf,smb_vwv1,secword);
 
-	smbXsrv_connection_init_tables(xconn, PROTOCOL_NT1);
+	status = smbXsrv_connection_init_tables(xconn, PROTOCOL_NT1);
+	if (!NT_STATUS_IS_OK(status)) {
+		reply_nterror(req, status);
+		return;
+	}
 
 	SSVAL(req->outbuf,smb_vwv1+1, lp_max_mux()); /* maxmpx */
 	SSVAL(req->outbuf,smb_vwv2+1, 1); /* num vcs */
diff -Npur samba-4.7.6/source3/smbd/open.c samba-4.7.7/source3/smbd/open.c
--- samba-4.7.6/source3/smbd/open.c	2017-11-15 08:42:13.000000000 +0100
+++ samba-4.7.7/source3/smbd/open.c	2018-04-17 09:35:02.000000000 +0200
@@ -5075,6 +5075,18 @@ static NTSTATUS create_file_unixpath(con
 		goto fail;
 	}
 
+	/*
+	 * Files or directories can't be opened DELETE_ON_CLOSE without
+	 * delete access.
+	 * BUG: https://bugzilla.samba.org/show_bug.cgi?id=13358
+	 */
+	if (create_options & FILE_DELETE_ON_CLOSE) {
+		if ((access_mask & DELETE_ACCESS) == 0) {
+			status = NT_STATUS_INVALID_PARAMETER;
+			goto fail;
+		}
+	}
+
 	if ((conn->fs_capabilities & FILE_NAMED_STREAMS)
 	    && is_ntfs_stream_smb_fname(smb_fname)
 	    && (!(private_flags & NTCREATEX_OPTIONS_PRIVATE_STREAM_DELETE))) {
diff -Npur samba-4.7.6/source3/smbd/smb2_break.c samba-4.7.7/source3/smbd/smb2_break.c
--- samba-4.7.6/source3/smbd/smb2_break.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_break.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "locking/leases_db.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static NTSTATUS smbd_smb2_request_process_lease_break(
 	struct smbd_smb2_request *req);
 
diff -Npur samba-4.7.6/source3/smbd/smb2_close.c samba-4.7.7/source3/smbd/smb2_close.c
--- samba-4.7.6/source3/smbd/smb2_close.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_close.c	2018-04-17 09:35:02.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "lib/tevent_wait.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_close_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_create.c samba-4.7.7/source3/smbd/smb2_create.c
--- samba-4.7.6/source3/smbd/smb2_create.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_create.c	2018-04-17 09:35:02.000000000 +0200
@@ -29,6 +29,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 int map_smb2_oplock_levels_to_samba(uint8_t in_oplock_level)
 {
 	switch(in_oplock_level) {
diff -Npur samba-4.7.6/source3/smbd/smb2_flush.c samba-4.7.7/source3/smbd/smb2_flush.c
--- samba-4.7.6/source3/smbd/smb2_flush.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_flush.c	2018-04-17 09:35:02.000000000 +0200
@@ -24,6 +24,9 @@
 #include "../libcli/smb/smb_common.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_flush_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
@@ -198,7 +201,7 @@ static void smbd_smb2_flush_done(struct
 	ret = SMB_VFS_FSYNC_RECV(subreq, &vfs_aio_state);
 	TALLOC_FREE(subreq);
 	if (ret == -1) {
-		tevent_req_error(req, vfs_aio_state.error);
+		tevent_req_nterror(req, map_nt_error_from_unix(vfs_aio_state.error));
 		return;
 	}
 	tevent_req_done(req);
diff -Npur samba-4.7.6/source3/smbd/smb2_getinfo.c samba-4.7.7/source3/smbd/smb2_getinfo.c
--- samba-4.7.6/source3/smbd/smb2_getinfo.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_getinfo.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 #include "trans2.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_getinfo_send(TALLOC_CTX *mem_ctx,
 						 struct tevent_context *ev,
 						 struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_glue.c samba-4.7.7/source3/smbd/smb2_glue.c
--- samba-4.7.6/source3/smbd/smb2_glue.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_glue.c	2018-04-17 09:35:02.000000000 +0200
@@ -23,6 +23,9 @@
 #include "smbd/globals.h"
 #include "../libcli/smb/smb_common.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smb_request *smbd_smb2_fake_smb_request(struct smbd_smb2_request *req)
 {
 	struct smb_request *smbreq;
diff -Npur samba-4.7.6/source3/smbd/smb2_ioctl.c samba-4.7.7/source3/smbd/smb2_ioctl.c
--- samba-4.7.6/source3/smbd/smb2_ioctl.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_ioctl.c	2018-04-17 09:35:02.000000000 +0200
@@ -27,6 +27,9 @@
 #include "smb2_ioctl_private.h"
 #include "librpc/gen_ndr/ioctl.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_ioctl_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_ioctl_dfs.c samba-4.7.7/source3/smbd/smb2_ioctl_dfs.c
--- samba-4.7.6/source3/smbd/smb2_ioctl_dfs.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_ioctl_dfs.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 #include "include/ntioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static NTSTATUS fsctl_dfs_get_refers(TALLOC_CTX *mem_ctx,
 				     struct tevent_context *ev,
 				     struct connection_struct *conn,
diff -Npur samba-4.7.6/source3/smbd/smb2_ioctl_filesys.c samba-4.7.7/source3/smbd/smb2_ioctl_filesys.c
--- samba-4.7.6/source3/smbd/smb2_ioctl_filesys.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_ioctl_filesys.c	2018-04-17 09:35:02.000000000 +0200
@@ -31,6 +31,9 @@
 #include "librpc/gen_ndr/ndr_ioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 /*
  * XXX this may reduce dup_extents->byte_count so that it's less than the
  * target file size.
diff -Npur samba-4.7.6/source3/smbd/smb2_ioctl_named_pipe.c samba-4.7.7/source3/smbd/smb2_ioctl_named_pipe.c
--- samba-4.7.6/source3/smbd/smb2_ioctl_named_pipe.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_ioctl_named_pipe.c	2018-04-17 09:35:02.000000000 +0200
@@ -27,6 +27,9 @@
 #include "include/ntioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void smbd_smb2_ioctl_pipe_write_done(struct tevent_req *subreq);
 static void smbd_smb2_ioctl_pipe_read_done(struct tevent_req *subreq);
 
diff -Npur samba-4.7.6/source3/smbd/smb2_ioctl_network_fs.c samba-4.7.7/source3/smbd/smb2_ioctl_network_fs.c
--- samba-4.7.6/source3/smbd/smb2_ioctl_network_fs.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_ioctl_network_fs.c	2018-04-17 09:35:02.000000000 +0200
@@ -31,6 +31,9 @@
 #include "smb2_ioctl_private.h"
 #include "../lib/tsocket/tsocket.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void copychunk_pack_limits(struct srv_copychunk_rsp *cc_rsp)
 {
 	cc_rsp->chunks_written = COPYCHUNK_MAX_CHUNKS;
diff -Npur samba-4.7.6/source3/smbd/smb2_keepalive.c samba-4.7.7/source3/smbd/smb2_keepalive.c
--- samba-4.7.6/source3/smbd/smb2_keepalive.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_keepalive.c	2018-04-17 09:35:02.000000000 +0200
@@ -23,6 +23,9 @@
 #include "smbd/globals.h"
 #include "../libcli/smb/smb_common.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 NTSTATUS smbd_smb2_request_process_keepalive(struct smbd_smb2_request *req)
 {
 	DATA_BLOB outbody;
diff -Npur samba-4.7.6/source3/smbd/smb2_lock.c samba-4.7.7/source3/smbd/smb2_lock.c
--- samba-4.7.6/source3/smbd/smb2_lock.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/smbd/smb2_lock.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smbd_smb2_lock_element {
 	uint64_t offset;
 	uint64_t length;
diff -Npur samba-4.7.6/source3/smbd/smb2_negprot.c samba-4.7.7/source3/smbd/smb2_negprot.c
--- samba-4.7.6/source3/smbd/smb2_negprot.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_negprot.c	2018-04-17 09:35:02.000000000 +0200
@@ -27,6 +27,9 @@
 #include "../librpc/ndr/libndr.h"
 #include "../libcli/smb/smb_signing.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 extern fstring remote_proto;
 
 /*
diff -Npur samba-4.7.6/source3/smbd/smb2_notify.c samba-4.7.7/source3/smbd/smb2_notify.c
--- samba-4.7.6/source3/smbd/smb2_notify.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_notify.c	2018-04-17 09:35:02.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../libcli/smb/smb_common.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smbd_smb2_notify_state {
 	struct smbd_smb2_request *smb2req;
 	struct smb_request *smbreq;
diff -Npur samba-4.7.6/source3/smbd/smb2_query_directory.c samba-4.7.7/source3/smbd/smb2_query_directory.c
--- samba-4.7.6/source3/smbd/smb2_query_directory.c	2017-09-17 21:15:34.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_query_directory.c	2018-04-17 09:35:02.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "system/filesys.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_query_directory_send(TALLOC_CTX *mem_ctx,
 					      struct tevent_context *ev,
 					      struct smbd_smb2_request *smb2req,
@@ -343,11 +346,14 @@ static struct tevent_req *smbd_smb2_quer
 	if (in_flags & SMB2_CONTINUE_FLAG_REOPEN) {
 		int flags;
 
-		dptr_CloseDir(fsp);
+		status = fd_close(fsp);
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 
 		/*
-		 * dptr_CloseDir() will close and invalidate the fsp's file
-		 * descriptor, we have to reopen it.
+		 * fd_close() will close and invalidate the fsp's file
+		 * descriptor. So we have to reopen it.
 		 */
 
 		flags = O_RDONLY;
diff -Npur samba-4.7.6/source3/smbd/smb2_read.c samba-4.7.7/source3/smbd/smb2_read.c
--- samba-4.7.6/source3/smbd/smb2_read.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.7/source3/smbd/smb2_read.c	2018-04-17 09:35:02.000000000 +0200
@@ -28,6 +28,9 @@
 #include "rpc_server/srv_pipe_hnd.h"
 #include "lib/util/sys_rw_data.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_read_send(TALLOC_CTX *mem_ctx,
 					      struct tevent_context *ev,
 					      struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_server.c samba-4.7.7/source3/smbd/smb2_server.c
--- samba-4.7.6/source3/smbd/smb2_server.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/smbd/smb2_server.c	2018-04-17 09:35:02.000000000 +0200
@@ -32,6 +32,9 @@
 #include "auth.h"
 #include "lib/crypto/sha512.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void smbd_smb2_connection_handler(struct tevent_context *ev,
 					 struct tevent_fd *fde,
 					 uint16_t flags,
@@ -613,34 +616,37 @@ static bool smb2_validate_sequence_numbe
 
 	seq_tmp = xconn->smb2.credits.seq_low;
 	if (seq_id < seq_tmp) {
-		DEBUG(0,("smb2_validate_sequence_number: bad message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: bad message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u)\n",
 			(unsigned long long)message_id,
 			(unsigned long long)seq_id,
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
-			(unsigned int)xconn->smb2.credits.seq_range));
+			(unsigned int)xconn->smb2.credits.seq_range);
 		return false;
 	}
 
 	seq_tmp += xconn->smb2.credits.seq_range;
 	if (seq_id >= seq_tmp) {
-		DEBUG(0,("smb2_validate_sequence_number: bad message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: bad message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u)\n",
 			(unsigned long long)message_id,
 			(unsigned long long)seq_id,
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
-			(unsigned int)xconn->smb2.credits.seq_range));
+			(unsigned int)xconn->smb2.credits.seq_range);
 		return false;
 	}
 
 	offset = seq_id % xconn->smb2.credits.max;
 
 	if (bitmap_query(credits_bm, offset)) {
-		DEBUG(0,("smb2_validate_sequence_number: duplicate message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: duplicate message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u) "
 			"(bm offset %u)\n",
@@ -649,7 +655,7 @@ static bool smb2_validate_sequence_numbe
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
 			(unsigned int)xconn->smb2.credits.seq_range,
-			offset));
+			offset);
 		return false;
 	}
 
@@ -665,10 +671,11 @@ static bool smb2_validate_sequence_numbe
 	 * already seen.
 	 */
 	while (bitmap_query(credits_bm, offset)) {
-		DEBUG(10,("smb2_validate_sequence_number: clearing "
+		DBGC_DEBUG(DBGC_SMB2_CREDITS,
+			  "smb2_validate_sequence_number: clearing "
 			  "id %llu (position %u) from bitmap\n",
 			  (unsigned long long)(xconn->smb2.credits.seq_low),
-			  offset));
+			  offset);
 		bitmap_clear(credits_bm, offset);
 
 		xconn->smb2.credits.seq_low += 1;
@@ -697,7 +704,9 @@ static bool smb2_validate_message_id(str
 		credit_charge = MAX(credit_charge, 1);
 	}
 
-	DEBUG(11, ("smb2_validate_message_id: mid %llu (charge %llu), "
+	DEBUGC(11,
+		   DBGC_SMB2_CREDITS,
+		   ("smb2_validate_message_id: mid %llu (charge %llu), "
 		   "credits_granted %llu, "
 		   "seqnum low/range: %llu/%llu\n",
 		   (unsigned long long) message_id,
@@ -707,7 +716,8 @@ static bool smb2_validate_message_id(str
 		   (unsigned long long) xconn->smb2.credits.seq_range));
 
 	if (xconn->smb2.credits.granted < credit_charge) {
-		DEBUG(0, ("smb2_validate_message_id: client used more "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			  "smb2_validate_message_id: client used more "
 			  "credits than granted, mid %llu, charge %llu, "
 			  "credits_granted %llu, "
 			  "seqnum low/range: %llu/%llu\n",
@@ -715,7 +725,7 @@ static bool smb2_validate_message_id(str
 			  (unsigned long long) credit_charge,
 			  (unsigned long long) xconn->smb2.credits.granted,
 			  (unsigned long long) xconn->smb2.credits.seq_low,
-			  (unsigned long long) xconn->smb2.credits.seq_range));
+			  (unsigned long long) xconn->smb2.credits.seq_range);
 		return false;
 	}
 
@@ -731,7 +741,9 @@ static bool smb2_validate_message_id(str
 		uint64_t id = message_id + i;
 		bool ok;
 
-		DEBUG(11, ("Iterating mid %llu charge %u (sequence %llu)\n",
+		DEBUGC(11,
+			   DBGC_SMB2_CREDITS,
+			   ("Iterating mid %llu charge %u (sequence %llu)\n",
 			   (unsigned long long)message_id,
 			   credit_charge,
 			   (unsigned long long)id));
@@ -909,7 +921,8 @@ static void smb2_set_operation_credit(st
 	xconn->smb2.credits.granted += credits_granted;
 	xconn->smb2.credits.seq_range += credits_granted;
 
-	DEBUG(10,("smb2_set_operation_credit: requested %u, charge %u, "
+	DBGC_DEBUG(DBGC_SMB2_CREDITS,
+		"smb2_set_operation_credit: requested %u, charge %u, "
 		"granted %u, current possible/max %u/%u, "
 		"total granted/max/low/range %u/%u/%llu/%u\n",
 		(unsigned int)credits_requested,
@@ -920,7 +933,7 @@ static void smb2_set_operation_credit(st
 		(unsigned int)xconn->smb2.credits.granted,
 		(unsigned int)xconn->smb2.credits.max,
 		(unsigned long long)xconn->smb2.credits.seq_low,
-		(unsigned int)xconn->smb2.credits.seq_range));
+		(unsigned int)xconn->smb2.credits.seq_range);
 }
 
 static void smb2_calculate_credits(const struct smbd_smb2_request *inreq,
@@ -1978,13 +1991,15 @@ NTSTATUS smbd_smb2_request_verify_credit
 
 	needed_charge = (data_length - 1)/ 65536 + 1;
 
-	DEBUG(10, ("mid %llu, CreditCharge: %d, NeededCharge: %d\n",
+	DBGC_DEBUG(DBGC_SMB2_CREDITS,
+		   "mid %llu, CreditCharge: %d, NeededCharge: %d\n",
 		   (unsigned long long) BVAL(inhdr, SMB2_HDR_MESSAGE_ID),
-		   credit_charge, needed_charge));
+		   credit_charge, needed_charge);
 
 	if (needed_charge > credit_charge) {
-		DEBUG(2, ("CreditCharge too low, given %d, needed %d\n",
-			  credit_charge, needed_charge));
+		DBGC_WARNING(DBGC_SMB2_CREDITS,
+			  "CreditCharge too low, given %d, needed %d\n",
+			  credit_charge, needed_charge);
 		return NT_STATUS_INVALID_PARAMETER;
 	}
 
@@ -2158,13 +2173,14 @@ static NTSTATUS smbd_smb2_request_dispat
 	struct smbXsrv_connection *xconn = req->xconn;
 	const uint8_t *inhdr;
 	uint16_t channel_sequence;
+	uint8_t generation_wrap = 0;
 	uint32_t flags;
 	int cmp;
 	struct smbXsrv_open *op;
 	bool update_open = false;
 	NTSTATUS status = NT_STATUS_OK;
 
-	req->request_counters_updated = false;
+	SMB_ASSERT(!req->request_counters_updated);
 
 	if (xconn->protocol < PROTOCOL_SMB2_22) {
 		return NT_STATUS_OK;
@@ -2184,6 +2200,14 @@ static NTSTATUS smbd_smb2_request_dispat
 	channel_sequence = SVAL(inhdr, SMB2_HDR_CHANNEL_SEQUENCE);
 
 	cmp = channel_sequence - op->global->channel_sequence;
+	if (cmp < 0) {
+		/*
+		 * csn wrap. We need to watch out for long-running
+		 * requests that are still sitting on a previously
+		 * used csn. SMB2_OP_NOTIFY can take VERY long.
+		 */
+		generation_wrap += 1;
+	}
 
 	if (abs(cmp) > INT16_MAX) {
 		/*
@@ -2220,7 +2244,7 @@ static NTSTATUS smbd_smb2_request_dispat
 		 * a 16 bit overflow of the client-submitted sequence
 		 * number:
 		 *
-		 * If the stored channel squence number is more than
+		 * If the stored channel sequence number is more than
 		 * 0x7FFF larger than the one from the request, then
 		 * the client-provided sequence number has likely
 		 * overflown. We treat this case as valid instead
@@ -2231,33 +2255,36 @@ static NTSTATUS smbd_smb2_request_dispat
 		cmp *= -1;
 	}
 
-	if (!(flags & SMB2_HDR_FLAG_REPLAY_OPERATION)) {
-		if (cmp == 0) {
+	if (flags & SMB2_HDR_FLAG_REPLAY_OPERATION) {
+		if (cmp == 0 && op->pre_request_count == 0) {
 			op->request_count += 1;
 			req->request_counters_updated = true;
-		} else if (cmp > 0) {
+		} else if (cmp > 0 && op->pre_request_count == 0) {
 			op->pre_request_count += op->request_count;
 			op->request_count = 1;
 			op->global->channel_sequence = channel_sequence;
+			op->global->channel_generation += generation_wrap;
 			update_open = true;
 			req->request_counters_updated = true;
 		} else if (modify_call) {
 			return NT_STATUS_FILE_NOT_AVAILABLE;
 		}
 	} else {
-		if (cmp == 0 && op->pre_request_count == 0) {
+		if (cmp == 0) {
 			op->request_count += 1;
 			req->request_counters_updated = true;
-		} else if (cmp > 0 && op->pre_request_count == 0) {
+		} else if (cmp > 0) {
 			op->pre_request_count += op->request_count;
 			op->request_count = 1;
 			op->global->channel_sequence = channel_sequence;
+			op->global->channel_generation += generation_wrap;
 			update_open = true;
 			req->request_counters_updated = true;
 		} else if (modify_call) {
 			return NT_STATUS_FILE_NOT_AVAILABLE;
 		}
 	}
+	req->channel_generation = op->global->channel_generation;
 
 	if (update_open) {
 		status = smbXsrv_open_update(op);
@@ -2288,6 +2315,8 @@ NTSTATUS smbd_smb2_request_dispatch(stru
 
 	DO_PROFILE_INC(request);
 
+	SMB_ASSERT(!req->request_counters_updated);
+
 	/* TODO: verify more things */
 
 	flags = IVAL(inhdr, SMB2_HDR_FLAGS);
@@ -2728,6 +2757,8 @@ static void smbd_smb2_request_reply_upda
 		return;
 	}
 
+	req->request_counters_updated = false;
+
 	if (xconn->protocol < PROTOCOL_SMB2_22) {
 		return;
 	}
@@ -2744,7 +2775,8 @@ static void smbd_smb2_request_reply_upda
 	inhdr = SMBD_SMB2_IN_HDR_PTR(req);
 	channel_sequence = SVAL(inhdr, SMB2_HDR_CHANNEL_SEQUENCE);
 
-	if (op->global->channel_sequence == channel_sequence) {
+	if ((op->global->channel_sequence == channel_sequence) &&
+	    (op->global->channel_generation == req->channel_generation)) {
 		SMB_ASSERT(op->request_count > 0);
 		op->request_count -= 1;
 	} else {
diff -Npur samba-4.7.6/source3/smbd/smb2_sesssetup.c samba-4.7.7/source3/smbd/smb2_sesssetup.c
--- samba-4.7.6/source3/smbd/smb2_sesssetup.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_sesssetup.c	2018-04-17 09:35:02.000000000 +0200
@@ -33,6 +33,9 @@
 #include "lib/crypto/aes_ccm_128.h"
 #include "lib/crypto/aes_gcm_128.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_session_setup_wrap_send(TALLOC_CTX *mem_ctx,
 					struct tevent_context *ev,
 					struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_setinfo.c samba-4.7.7/source3/smbd/smb2_setinfo.c
--- samba-4.7.6/source3/smbd/smb2_setinfo.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_setinfo.c	2018-04-17 09:35:02.000000000 +0200
@@ -29,6 +29,9 @@
 #include "source3/lib/dbwrap/dbwrap_watch.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_setinfo_send(TALLOC_CTX *mem_ctx,
 						 struct tevent_context *ev,
 						 struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_tcon.c samba-4.7.7/source3/smbd/smb2_tcon.c
--- samba-4.7.6/source3/smbd/smb2_tcon.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_tcon.c	2018-04-17 09:35:02.000000000 +0200
@@ -27,6 +27,9 @@
 #include "lib/param/loadparm.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_tree_connect_send(TALLOC_CTX *mem_ctx,
 					struct tevent_context *ev,
 					struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/smb2_write.c samba-4.7.7/source3/smbd/smb2_write.c
--- samba-4.7.6/source3/smbd/smb2_write.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.7/source3/smbd/smb2_write.c	2018-04-17 09:35:02.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "rpc_server/srv_pipe_hnd.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_write_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.7.6/source3/smbd/trans2.c samba-4.7.7/source3/smbd/trans2.c
--- samba-4.7.6/source3/smbd/trans2.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/smbd/trans2.c	2018-04-17 09:35:02.000000000 +0200
@@ -7783,10 +7783,10 @@ static NTSTATUS smb_set_file_unix_basic(
 
 		DEBUG(10,("smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC "
 			  "changing group %u for file %s\n",
-			  (unsigned int)set_owner,
+			  (unsigned int)set_grp,
 			  smb_fname_str_dbg(smb_fname)));
 		if (fsp && fsp->fh->fd != -1) {
-			ret = SMB_VFS_FCHOWN(fsp, set_owner, (gid_t)-1);
+			ret = SMB_VFS_FCHOWN(fsp, (uid_t)-1, set_grp);
 		} else {
 			/*
 			 * UNIX extensions calls must always operate
diff -Npur samba-4.7.6/source3/torture/proto.h samba-4.7.7/source3/torture/proto.h
--- samba-4.7.6/source3/torture/proto.h	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/torture/proto.h	2018-04-17 09:35:02.000000000 +0200
@@ -95,6 +95,7 @@ bool run_nttrans_create(int dummy);
 bool run_nttrans_fsctl(int dummy);
 bool run_smb2_basic(int dummy);
 bool run_smb2_negprot(int dummy);
+bool run_smb2_anonymous(int dummy);
 bool run_smb2_session_reconnect(int dummy);
 bool run_smb2_tcon_dependence(int dummy);
 bool run_smb2_multi_channel(int dummy);
diff -Npur samba-4.7.6/source3/torture/test_smb2.c samba-4.7.7/source3/torture/test_smb2.c
--- samba-4.7.6/source3/torture/test_smb2.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/torture/test_smb2.c	2018-04-17 09:35:02.000000000 +0200
@@ -24,6 +24,7 @@
 #include "../libcli/smb/smbXcli_base.h"
 #include "libcli/security/security.h"
 #include "libsmb/proto.h"
+#include "auth/credentials/credentials.h"
 #include "auth/gensec/gensec.h"
 #include "auth_generic.h"
 #include "../librpc/ndr/libndr.h"
@@ -271,6 +272,47 @@ bool run_smb2_negprot(int dummy)
 		return false;
 	}
 
+	return true;
+}
+
+bool run_smb2_anonymous(int dummy)
+{
+	struct cli_state *cli = NULL;
+	NTSTATUS status;
+	struct cli_credentials *anon_creds = NULL;
+	bool guest = false;
+
+	printf("Starting SMB2-ANONYMOUS\n");
+
+	if (!torture_init_connection(&cli)) {
+		return false;
+	}
+
+	status = smbXcli_negprot(cli->conn, cli->timeout,
+				 PROTOCOL_SMB2_02, PROTOCOL_LATEST);
+	if (!NT_STATUS_IS_OK(status)) {
+		printf("smbXcli_negprot returned %s\n", nt_errstr(status));
+		return false;
+	}
+
+	anon_creds = cli_credentials_init_anon(talloc_tos());
+	if (anon_creds == NULL) {
+		printf("cli_credentials_init_anon failed\n");
+		return false;
+	}
+
+	status = cli_session_setup_creds(cli, anon_creds);
+	if (!NT_STATUS_IS_OK(status)) {
+		printf("cli_session_setup returned %s\n", nt_errstr(status));
+		return false;
+	}
+
+	guest = smbXcli_session_is_guest(cli->smb2.session);
+	if (guest) {
+		printf("anonymous session should not have guest authentication\n");
+		return false;
+	}
+
 	return true;
 }
 
diff -Npur samba-4.7.6/source3/torture/torture.c samba-4.7.7/source3/torture/torture.c
--- samba-4.7.6/source3/torture/torture.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.7/source3/torture/torture.c	2018-04-17 09:35:02.000000000 +0200
@@ -11644,6 +11644,7 @@ static struct {
 	{ "NOTIFY-ONLINE", run_notify_online },
 	{ "SMB2-BASIC", run_smb2_basic },
 	{ "SMB2-NEGPROT", run_smb2_negprot },
+	{ "SMB2-ANONYMOUS", run_smb2_anonymous },
 	{ "SMB2-SESSION-RECONNECT", run_smb2_session_reconnect },
 	{ "SMB2-TCON-DEPENDENCE", run_smb2_tcon_dependence },
 	{ "SMB2-MULTI-CHANNEL", run_smb2_multi_channel },
diff -Npur samba-4.7.6/source3/winbindd/winbindd_lookupname.c samba-4.7.7/source3/winbindd/winbindd_lookupname.c
--- samba-4.7.6/source3/winbindd/winbindd_lookupname.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source3/winbindd/winbindd_lookupname.c	2018-04-17 09:35:02.000000000 +0200
@@ -35,7 +35,8 @@ struct tevent_req *winbindd_lookupname_s
 {
 	struct tevent_req *req, *subreq;
 	struct winbindd_lookupname_state *state;
-	char *domname, *name, *p;
+	const char *domname = NULL, *name = NULL;
+	char *p = NULL;
 
 	req = tevent_req_create(mem_ctx, &state,
 				struct winbindd_lookupname_state);
@@ -49,17 +50,25 @@ struct tevent_req *winbindd_lookupname_s
 		sizeof(request->data.name.dom_name)-1]='\0';
 	request->data.name.name[sizeof(request->data.name.name)-1]='\0';
 
-	/* cope with the name being a fully qualified name */
-	p = strstr(request->data.name.name, lp_winbind_separator());
-	if (p) {
-		*p = 0;
-		domname = request->data.name.name;
-		name = p+1;
-	} else if ((p = strchr(request->data.name.name, '@')) != NULL) {
-		/* upn */
-		domname = p + 1;
-		*p = 0;
-		name = request->data.name.name;
+	if (strlen(request->data.name.dom_name) == 0) {
+		/* cope with the name being a fully qualified name */
+		p = strstr(request->data.name.name, lp_winbind_separator());
+		if (p != NULL) {
+			*p = '\0';
+			domname = request->data.name.name;
+			name = p + 1;
+		} else {
+			p = strchr(request->data.name.name, '@');
+			if (p != NULL) {
+				/* upn */
+				domname = p + 1;
+				*p = '\0';
+				name = request->data.name.name;
+			} else {
+				domname = "";
+				name = request->data.name.name;
+			}
+		}
 	} else {
 		domname = request->data.name.dom_name;
 		name = request->data.name.name;
diff -Npur samba-4.7.6/source3/wscript samba-4.7.7/source3/wscript
--- samba-4.7.6/source3/wscript	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/source3/wscript	2018-04-17 09:35:02.000000000 +0200
@@ -1582,11 +1582,18 @@ main() {
     if Options.options.libcephfs_dir:
         conf.env['CPPPATH_CEPHFS'] = Options.options.libcephfs_dir + '/include'
         conf.env['LIBPATH_CEPHFS'] = Options.options.libcephfs_dir + '/lib'
+        conf.env['LIBPATH_CEPH-COMMON'] = Options.options.libcephfs_dir + '/lib/ceph'
+    else:
+        conf.env['LIBPATH_CEPH-COMMON'] = Options.options.LIBDIR + '/ceph'
 
-    if conf.CHECK_HEADERS('cephfs/libcephfs.h', False, False, 'cephfs') and conf.CHECK_LIB('cephfs', shlib=True) and Options.options.with_cephfs:
+    if (Options.options.with_cephfs and
+        conf.CHECK_HEADERS('cephfs/libcephfs.h', False, False, 'cephfs') and
+        conf.CHECK_LIB('cephfs', shlib=True)):
+        conf.CHECK_LIB('ceph-common', shlib=True)
         if Options.options.with_acl_support:
             conf.DEFINE('HAVE_CEPH', '1')
-            if conf.CHECK_FUNCS_IN('ceph_statx', 'cephfs', headers='cephfs/libcephfs.h'):
+            if conf.CHECK_FUNCS_IN('ceph_statx', 'cephfs ceph-common',
+                                   headers='cephfs/libcephfs.h'):
                 conf.DEFINE('HAVE_CEPH_STATX', '1')
         else:
             Logs.warn("ceph support disabled due to --without-acl-support")
diff -Npur samba-4.7.6/source4/auth/ntlm/auth_sam.c samba-4.7.7/source4/auth/ntlm/auth_sam.c
--- samba-4.7.6/source4/auth/ntlm/auth_sam.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source4/auth/ntlm/auth_sam.c	2018-04-17 09:35:02.000000000 +0200
@@ -739,6 +739,10 @@ static NTSTATUS authsam_want_check(struc
 		return NT_STATUS_NOT_IMPLEMENTED;
 	}
 
+	if (effective_domain == NULL) {
+		effective_domain = "";
+	}
+
 	is_local_name = lpcfg_is_myname(ctx->auth_ctx->lp_ctx,
 					effective_domain);
 
@@ -784,7 +788,7 @@ static NTSTATUS authsam_want_check(struc
 		return NT_STATUS_NOT_IMPLEMENTED;
 	}
 
-	if (effective_domain != NULL && !strequal(effective_domain, "")) {
+	if (!strequal(effective_domain, "")) {
 		DBG_DEBUG("%s is not one domain name (DC)\n",
 			  effective_domain);
 		return NT_STATUS_NOT_IMPLEMENTED;
@@ -792,11 +796,11 @@ static NTSTATUS authsam_want_check(struc
 
 	p = strchr_m(user_info->mapped.account_name, '@');
 	if (p == NULL) {
-		if (effective_domain == NULL) {
-			return NT_STATUS_OK;
-		}
-		DEBUG(6,("authsam_check_password: '' without upn not handled (DC)\n"));
-		return NT_STATUS_NOT_IMPLEMENTED;
+		/*
+		 * An empty to domain name should be handled
+		 * as the local domain name.
+		 */
+		return NT_STATUS_OK;
 	}
 
 	effective_domain = p + 1;
diff -Npur samba-4.7.6/source4/dsdb/samdb/ldb_modules/samldb.c samba-4.7.7/source4/dsdb/samdb/ldb_modules/samldb.c
--- samba-4.7.6/source4/dsdb/samdb/ldb_modules/samldb.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source4/dsdb/samdb/ldb_modules/samldb.c	2018-04-17 09:35:02.000000000 +0200
@@ -875,6 +875,7 @@ static int samldb_add_handle_msDS_IntId(
 		 * order to be sure.
 		 */
 		if (dsdb_attribute_by_attributeID_id(schema, msds_intid)) {
+			id_exists = true;
 			msds_intid = generate_random() % 0X3FFFFFFF;
 			msds_intid += 0x80000000;
 			continue;
@@ -3351,13 +3352,13 @@ static int verify_cidr(const char *cidr)
 }
 
 
-static int samldb_verify_subnet(struct samldb_ctx *ac)
+static int samldb_verify_subnet(struct samldb_ctx *ac, struct ldb_dn *dn)
 {
 	struct ldb_context *ldb = ldb_module_get_ctx(ac->module);
 	const char *cidr = NULL;
 	const struct ldb_val *rdn_value = NULL;
 
-	rdn_value = ldb_dn_get_rdn_val(ac->msg->dn);
+	rdn_value = ldb_dn_get_rdn_val(dn);
 	if (rdn_value == NULL) {
 		ldb_set_errstring(ldb, "samldb: ldb_dn_get_rdn_val "
 				  "failed");
@@ -3588,7 +3589,7 @@ static int samldb_add(struct ldb_module
 
 	if (samdb_find_attribute(ldb, ac->msg,
 				 "objectclass", "subnet") != NULL) {
-		ret = samldb_verify_subnet(ac);
+		ret = samldb_verify_subnet(ac, ac->msg->dn);
 		if (ret != LDB_SUCCESS) {
 			talloc_free(ac);
 			return ret;
@@ -3991,7 +3992,7 @@ static int check_rename_constraints(stru
 
 	/* subnet objects */
 	if (samdb_find_attribute(ldb, msg, "objectclass", "subnet") != NULL) {
-		ret = samldb_verify_subnet(ac);
+		ret = samldb_verify_subnet(ac, newdn);
 		if (ret != LDB_SUCCESS) {
 			talloc_free(ac);
 			return ret;
diff -Npur samba-4.7.6/source4/dsdb/tests/python/sites.py samba-4.7.7/source4/dsdb/tests/python/sites.py
--- samba-4.7.6/source4/dsdb/tests/python/sites.py	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source4/dsdb/tests/python/sites.py	2018-04-17 09:35:02.000000000 +0200
@@ -183,6 +183,51 @@ class SimpleSubnetTests(SitesBaseTests):
         self.assertRaises(subnets.SubnetNotFound,
                           subnets.delete_subnet, self.ldb, basedn, cidr)
 
+    def test_rename_good_subnet_to_good_subnet(self):
+        """Make sure that we can rename subnets"""
+        basedn = self.ldb.get_config_basedn()
+        cidr = "10.16.0.0/24"
+        new_cidr = "10.16.1.0/24"
+
+        subnets.create_subnet(self.ldb, basedn, cidr, self.sitename)
+
+        subnets.rename_subnet(self.ldb, basedn, cidr, new_cidr)
+
+        ret = self.ldb.search(base=basedn, scope=SCOPE_SUBTREE,
+                              expression='(&(objectclass=subnet)(cn=%s))' % new_cidr)
+
+        self.assertEqual(len(ret), 1, 'Failed to rename subnet %s' % cidr)
+
+        ret = self.ldb.search(base=basedn, scope=SCOPE_SUBTREE,
+                              expression='(&(objectclass=subnet)(cn=%s))' % cidr)
+
+        self.assertEqual(len(ret), 0, 'Failed to remove old subnet during rename %s' % cidr)
+
+        subnets.delete_subnet(self.ldb, basedn, new_cidr)
+
+    def test_rename_good_subnet_to_bad_subnet(self):
+        """Make sure that the CIDR checking runs during rename"""
+        basedn = self.ldb.get_config_basedn()
+        cidr = "10.17.0.0/24"
+        bad_cidr = "10.11.12.0/14"
+
+        subnets.create_subnet(self.ldb, basedn, cidr, self.sitename)
+
+        self.assertRaises(subnets.SubnetInvalid, subnets.rename_subnet,
+                          self.ldb, basedn, cidr, bad_cidr)
+
+        ret = self.ldb.search(base=basedn, scope=SCOPE_SUBTREE,
+                              expression='(&(objectclass=subnet)(cn=%s))' % bad_cidr)
+
+        self.assertEqual(len(ret), 0, 'Failed to rename subnet %s' % cidr)
+
+        ret = self.ldb.search(base=basedn, scope=SCOPE_SUBTREE,
+                              expression='(&(objectclass=subnet)(cn=%s))' % cidr)
+
+        self.assertEqual(len(ret), 1, 'Failed to remove old subnet during rename %s' % cidr)
+
+        subnets.delete_subnet(self.ldb, basedn, cidr)
+
     def test_create_bad_ranges(self):
         """These CIDR ranges all have something wrong with them, and they
         should all fail."""
diff -Npur samba-4.7.6/source4/torture/basic/delete.c samba-4.7.7/source4/torture/basic/delete.c
--- samba-4.7.6/source4/torture/basic/delete.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source4/torture/basic/delete.c	2018-04-17 09:35:02.000000000 +0200
@@ -476,24 +476,127 @@ static bool deltest8(struct torture_cont
 static bool deltest9(struct torture_context *tctx, struct smbcli_state *cli1, struct smbcli_state *cli2)
 {
 	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_SUPERSEDE,
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_CREATE,
+			NTCREATEX_DISP_OPEN_IF};
+	unsigned int i;
 
 	del_clean_area(cli1, cli2);
 
-	/* This should fail - we need to set DELETE_ACCESS. */
-	fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
-				      SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
-				      FILE_ATTRIBUTE_NORMAL, 
-				      NTCREATEX_SHARE_ACCESS_NONE, 
-				      NTCREATEX_DISP_OVERWRITE_IF, 
-				      NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
-	
-	torture_assert(tctx, fnum1 == -1, 
-				   talloc_asprintf(tctx, "open of %s succeeded should have failed!", 
-		       fname));
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		/* This should fail - we need to set DELETE_ACCESS. */
+
+		/*
+		 * A file or directory create with DELETE_ON_CLOSE but
+		 * without DELETE_ACCESS should fail with
+		 * NT_STATUS_INVALID_PARAMETER.
+		 */
+
+		fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
+				SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
+				FILE_ATTRIBUTE_NORMAL,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			fname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+
+		/* This should fail - the file should not have been created. */
+		status = smbcli_getatr(cli1->tree, fname, NULL, NULL, NULL);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_OBJECT_NAME_NOT_FOUND,
+			talloc_asprintf(tctx, "getattr of %s succeeded should "
+				"not have been created !",
+			fname));
+	}
 
 	return true;
 }
 
+/* Test 9a ... */
+static bool deltest9a(struct torture_context *tctx,
+			struct smbcli_state *cli1,
+			struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_OPEN,
+			NTCREATEX_DISP_OVERWRITE,
+			NTCREATEX_DISP_OPEN_IF};
+
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	/* Create the file, and try with open calls. */
+	fnum1 = smbcli_open(cli1->tree, fname, O_CREAT|O_RDWR, DENY_NONE);
+	torture_assert(tctx,
+			fnum1 != -1,
+			talloc_asprintf(tctx, "open of %s failed (%s)",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	status = smbcli_close(cli1->tree, fnum1);
+	torture_assert_ntstatus_ok(tctx,
+				status,
+				talloc_asprintf(tctx, "close failed"));
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
+				SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
+				FILE_ATTRIBUTE_NORMAL,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			fname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should succeed - the file should not have been deleted.
+		 */
+		status = smbcli_getatr(cli1->tree, fname, NULL, NULL, NULL);
+		torture_assert_ntstatus_ok(tctx,
+			status,
+			talloc_asprintf(tctx, "getattr of %s failed %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	}
+
+	del_clean_area(cli1, cli2);
+	return true;
+}
+
 /* Test 10 ... */
 static bool deltest10(struct torture_context *tctx, struct smbcli_state *cli1, struct smbcli_state *cli2)
 {
@@ -2201,6 +2304,135 @@ static bool deltest23(struct torture_con
 	return true;
 }
 
+/* Test 25 ... */
+static bool deltest25(struct torture_context *tctx,
+			struct smbcli_state *cli1,
+			struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_SUPERSEDE,
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_CREATE,
+			NTCREATEX_DISP_OPEN_IF};
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		/* This should fail - we need to set DELETE_ACCESS. */
+
+		/*
+		 * A file or directory create with DELETE_ON_CLOSE but
+		 * without DELETE_ACCESS should fail with
+		 * NT_STATUS_INVALID_PARAMETER.
+		 */
+
+		fnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				SEC_FILE_READ_DATA,
+				FILE_ATTRIBUTE_DIRECTORY,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DIRECTORY|
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			dname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			dname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should fail - the directory
+		 * should not have been created.
+		 */
+		status = smbcli_getatr(cli1->tree, dname, NULL, NULL, NULL);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_OBJECT_NAME_NOT_FOUND,
+			talloc_asprintf(tctx, "getattr of %s succeeded should "
+				"not have been created !",
+			dname));
+	}
+
+	return true;
+}
+
+/* Test 25a... */
+static bool deltest25a(struct torture_context *tctx,
+		struct smbcli_state *cli1,
+		struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_OPEN,
+			NTCREATEX_DISP_OVERWRITE,
+			NTCREATEX_DISP_OPEN_IF};
+
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	/* Create the directory, and try with open calls. */
+	status = smbcli_mkdir(cli1->tree, dname);
+	torture_assert_ntstatus_ok(tctx,
+		status,
+		talloc_asprintf(tctx, "mkdir of %s failed %s",
+		dname,
+		smbcli_errstr(cli1->tree)));
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		fnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				SEC_FILE_READ_DATA,
+				FILE_ATTRIBUTE_DIRECTORY,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DIRECTORY|
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			dname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			dname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should succeed - the directory
+		 * should not have been deleted.
+		 */
+		status = smbcli_getatr(cli1->tree, dname, NULL, NULL, NULL);
+		torture_assert_ntstatus_ok(tctx,
+			status,
+			talloc_asprintf(tctx, "getattr of %s failed %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	}
+
+	del_clean_area(cli1, cli2);
+	return true;
+}
+
 /*
   Test delete on close semantics.
  */
@@ -2218,6 +2450,7 @@ struct torture_suite *torture_test_delet
 	torture_suite_add_2smb_test(suite, "deltest7", deltest7);
 	torture_suite_add_2smb_test(suite, "deltest8", deltest8);
 	torture_suite_add_2smb_test(suite, "deltest9", deltest9);
+	torture_suite_add_2smb_test(suite, "deltest9a", deltest9a);
 	torture_suite_add_2smb_test(suite, "deltest10", deltest10);
 	torture_suite_add_2smb_test(suite, "deltest11", deltest11);
 	torture_suite_add_2smb_test(suite, "deltest12", deltest12);
@@ -2241,6 +2474,8 @@ struct torture_suite *torture_test_delet
 	torture_suite_add_simple_test(suite, "deltest21", deltest21);
 	torture_suite_add_simple_test(suite, "deltest22", deltest22);
 	torture_suite_add_2smb_test(suite, "deltest23", deltest23);
+	torture_suite_add_2smb_test(suite, "deltest25", deltest25);
+	torture_suite_add_2smb_test(suite, "deltest25a", deltest25a);
 
 	return suite;
 }
diff -Npur samba-4.7.6/source4/torture/smb2/compound.c samba-4.7.7/source4/torture/smb2/compound.c
--- samba-4.7.6/source4/torture/smb2/compound.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.7/source4/torture/smb2/compound.c	2018-04-17 09:35:02.000000000 +0200
@@ -1030,6 +1030,81 @@ done:
 	return ret;
 }
 
+static bool test_compound_invalid4(struct torture_context *tctx,
+				   struct smb2_tree *tree)
+{
+	struct smb2_create cr;
+	struct smb2_read rd;
+	NTSTATUS status;
+	const char *fname = "compound_invalid4.dat";
+	struct smb2_close cl;
+	bool ret = true;
+	bool ok;
+	struct smb2_request *req[2];
+
+	smb2_transport_credits_ask_num(tree->session->transport, 2);
+
+	smb2_util_unlink(tree, fname);
+
+	ZERO_STRUCT(cr);
+	cr.in.security_flags	  = 0x00;
+	cr.in.oplock_level	  = 0;
+	cr.in.impersonation_level = NTCREATEX_IMPERSONATION_IMPERSONATION;
+	cr.in.create_flags	  = 0x00000000;
+	cr.in.reserved		  = 0x00000000;
+	cr.in.desired_access	  = SEC_RIGHTS_FILE_ALL;
+	cr.in.file_attributes	  = FILE_ATTRIBUTE_NORMAL;
+	cr.in.share_access	  = NTCREATEX_SHARE_ACCESS_READ |
+				    NTCREATEX_SHARE_ACCESS_WRITE |
+				    NTCREATEX_SHARE_ACCESS_DELETE;
+	cr.in.create_disposition  = NTCREATEX_DISP_OPEN_IF;
+	cr.in.create_options	  = NTCREATEX_OPTIONS_SEQUENTIAL_ONLY |
+				    NTCREATEX_OPTIONS_ASYNC_ALERT	|
+				    NTCREATEX_OPTIONS_NON_DIRECTORY_FILE |
+				    0x00200000;
+	cr.in.fname		  = fname;
+
+	status = smb2_create(tree, tctx, &cr);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	smb2_transport_compound_start(tree->session->transport, 2);
+
+	ZERO_STRUCT(rd);
+	rd.in.file.handle = cr.out.file.handle;
+	rd.in.length      = 1;
+	rd.in.offset      = 0;
+	req[0] = smb2_read_send(tree, &rd);
+
+	smb2_transport_compound_set_related(tree->session->transport, true);
+
+	/*
+	 * Send a completely bogus request as second compound
+	 * element. This triggers smbd_smb2_request_error() in in
+	 * smbd_smb2_request_dispatch() before calling
+	 * smbd_smb2_request_dispatch_update_counts().
+	 */
+
+	req[1] = smb2_request_init_tree(tree, 0xff, 0x04, false, 0);
+	smb2_transport_send(req[1]);
+
+	status = smb2_read_recv(req[0], tctx, &rd);
+	CHECK_STATUS(status, NT_STATUS_END_OF_FILE);
+
+	ok = smb2_request_receive(req[1]);
+	torture_assert(tctx, ok, "Invalid request failed\n");
+	CHECK_STATUS(req[1]->status, NT_STATUS_INVALID_PARAMETER);
+
+	ZERO_STRUCT(cl);
+	cl.in.file.handle = cr.out.file.handle;
+
+	status = smb2_close(tree, &cl);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	smb2_util_unlink(tree, fname);
+done:
+	return ret;
+}
+
 /* Send a compound request where we expect the last request (Create, Notify)
  * to go asynchronous. This works against a Win7 server and the reply is
  * sent in two different packets. */
@@ -1297,6 +1372,8 @@ struct torture_suite *torture_smb2_compo
 	torture_suite_add_1smb2_test(suite, "invalid1", test_compound_invalid1);
 	torture_suite_add_1smb2_test(suite, "invalid2", test_compound_invalid2);
 	torture_suite_add_1smb2_test(suite, "invalid3", test_compound_invalid3);
+	torture_suite_add_1smb2_test(
+		suite, "invalid4", test_compound_invalid4);
 	torture_suite_add_1smb2_test(suite, "interim1",  test_compound_interim1);
 	torture_suite_add_1smb2_test(suite, "interim2",  test_compound_interim2);
 	torture_suite_add_1smb2_test(suite, "compound-break", test_compound_break);
diff -Npur samba-4.7.6/source4/torture/smb2/replay.c samba-4.7.7/source4/torture/smb2/replay.c
--- samba-4.7.6/source4/torture/smb2/replay.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.7/source4/torture/smb2/replay.c	2018-04-17 09:35:02.000000000 +0200
@@ -473,7 +473,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Create Replay Detection on Single Channel.
+ * Test Durability V2 Create Replay Detection on Single Channel.
  */
 static bool test_replay_dhv2_oplock1(struct torture_context *tctx,
 				     struct smb2_tree *tree)
@@ -560,7 +560,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Create Replay Detection on Single Channel.
+ * Test Durability V2 Create Replay Detection on Single Channel.
  * Hand in a different oplock level in the replay.
  * Server responds with the handed in oplock level and
  * corresponding durable status, but does not change the
@@ -697,7 +697,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Create Replay Detection on Single Channel.
+ * Test Durability V2 Create Replay Detection on Single Channel.
  * Replay with a different share mode. The share mode of
  * the opened file is not changed by this.
  */
@@ -823,7 +823,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Create Replay Detection on Single Channel.
+ * Test Durability V2 Create Replay Detection on Single Channel.
  * Create with an oplock, and replay with a lease.
  */
 static bool test_replay_dhv2_oplock_lease(struct torture_context *tctx,
@@ -927,7 +927,7 @@ done:
 
 
 /**
- * Test durablity v2 create replay detection on single channel.
+ * Test durability v2 create replay detection on single channel.
  * Variant with leases instead of oplocks:
  * - open a file with a rh lease
  * - upgrade to a rwh lease with a second create
@@ -1065,7 +1065,7 @@ done:
 }
 
 /**
- * Test durablity v2 create replay detection on single channel.
+ * Test durability v2 create replay detection on single channel.
  * Variant with leases instead of oplocks, where the
  * replay does not specify the original lease level but
  * just a "R" lease. This still gives the upgraded lease
@@ -1216,7 +1216,7 @@ done:
 }
 
 /**
- * Test durablity v2 create replay detection on single channel.
+ * Test durability v2 create replay detection on single channel.
  * create with a lease, and replay with a different lease key
  */
 static bool test_replay_dhv2_lease3(struct torture_context *tctx,
@@ -1349,7 +1349,7 @@ done:
 }
 
 /**
- * Test durablity v2 create replay detection on single channel.
+ * Test durability v2 create replay detection on single channel.
  * Do the original create with a lease, and do the replay
  * with an oplock.
  */
@@ -1758,7 +1758,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Create Replay Detection on Multi Channel
+ * Test Durability V2 Create Replay Detection on Multi Channel
  */
 static bool test_replay3(struct torture_context *tctx, struct smb2_tree *tree1)
 {
@@ -2162,7 +2162,7 @@ done:
 }
 
 /**
- * Test Durablity V2 Persistent Create Replay on a Single Channel
+ * Test Durability V2 Persistent Create Replay on a Single Channel
  */
 static bool test_replay5(struct torture_context *tctx, struct smb2_tree *tree)
 {
@@ -2425,6 +2425,102 @@ done:
 	return ret;
 }
 
+static bool test_replay7(struct torture_context *tctx, struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	struct smb2_transport *transport = tree->session->transport;
+	NTSTATUS status;
+	struct smb2_handle _dh;
+	struct smb2_handle *dh = NULL;
+	struct smb2_notify notify;
+	struct smb2_request *req;
+	union smb_fileinfo qfinfo;
+	bool ret = false;
+
+	if (smbXcli_conn_protocol(transport->conn) < PROTOCOL_SMB3_00) {
+		torture_skip(tctx, "SMB 3.X Dialect family required for "
+				   "replay tests\n");
+	}
+
+	torture_comment(tctx, "Notify across increment/decrement of csn\n");
+
+	smbXcli_conn_set_force_channel_sequence(transport->conn, true);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &_dh);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	dh = &_dh;
+
+	notify.in.recursive		= 0x0000;
+	notify.in.buffer_size	= 0xffff;
+	notify.in.file.handle	= _dh;
+	notify.in.completion_filter	= FILE_NOTIFY_CHANGE_FILE_NAME;
+	notify.in.unknown		= 0x00000000;
+
+	/*
+	 * This posts a long-running request with csn==0 to "dh". Now
+	 * op->request_count==1 in smb2_server.c.
+	 */
+	smb2cli_session_reset_channel_sequence(tree->session->smbXcli, 0);
+	req = smb2_notify_send(tree, &notify);
+
+	qfinfo = (union smb_fileinfo) {
+		.generic.level = RAW_FILEINFO_POSITION_INFORMATION,
+		.generic.in.file.handle = _dh
+	};
+
+	/*
+	 * This sequence of 2 dummy requests moves
+	 * op->request_count==1 to op->pre_request_count. The numbers
+	 * used avoid int16 overflow.
+	 */
+
+	smb2cli_session_reset_channel_sequence(tree->session->smbXcli, 30000);
+	status = smb2_getinfo_file(tree, mem_ctx, &qfinfo);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	smb2cli_session_reset_channel_sequence(tree->session->smbXcli, 60000);
+	status = smb2_getinfo_file(tree, mem_ctx, &qfinfo);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/*
+	 * This final request turns the op->global->channel_sequence
+	 * to the same as we had when sending the notify above. The
+	 * notify's request count has in the meantime moved to
+	 * op->pre_request_count.
+	 */
+
+	smb2cli_session_reset_channel_sequence(tree->session->smbXcli, 0);
+	status = smb2_getinfo_file(tree, mem_ctx, &qfinfo);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/*
+	 * At this point op->request_count==0.
+	 *
+	 * The next cancel makes us reply to the notify. Because the
+	 * csn we currently use is the same as we used when sending
+	 * the notify, smbd thinks it must decrement op->request_count
+	 * and not op->pre_request_count.
+	 */
+
+	status = smb2_cancel(req);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	status = smb2_notify_recv(req, mem_ctx, &notify);
+	CHECK_STATUS(status, NT_STATUS_CANCELLED);
+
+	ret = true;
+
+done:
+	if (dh != NULL) {
+		smb2_util_close(tree, _dh);
+	}
+	smb2_deltree(tree, BASEDIR);
+	talloc_free(tree);
+	talloc_free(mem_ctx);
+
+	return ret;
+}
+
 struct torture_suite *torture_smb2_replay_init(TALLOC_CTX *ctx)
 {
 	struct torture_suite *suite =
@@ -2445,6 +2541,7 @@ struct torture_suite *torture_smb2_repla
 	torture_suite_add_1smb2_test(suite, "replay4", test_replay4);
 	torture_suite_add_1smb2_test(suite, "replay5", test_replay5);
 	torture_suite_add_1smb2_test(suite, "replay6", test_replay6);
+	torture_suite_add_1smb2_test(suite, "replay7", test_replay7);
 
 	suite->description = talloc_strdup(suite, "SMB2 REPLAY tests");
 
diff -Npur samba-4.7.6/source4/torture/vfs/fruit.c samba-4.7.7/source4/torture/vfs/fruit.c
--- samba-4.7.6/source4/torture/vfs/fruit.c	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.7/source4/torture/vfs/fruit.c	2018-04-17 09:35:02.000000000 +0200
@@ -36,6 +36,10 @@
 #include "torture/smb2/proto.h"
 #include "torture/vfs/proto.h"
 #include "librpc/gen_ndr/ndr_ioctl.h"
+#include "libcli/security/dom_sid.h"
+#include "../librpc/gen_ndr/ndr_security.h"
+#include "libcli/security/secace.h"
+#include "libcli/security/security_descriptor.h"
 
 #define BASEDIR "vfs_fruit_dir"
 #define FNAME_CC_SRC "testfsctl.dat"
@@ -4426,6 +4430,172 @@ done:
 }
 
 /*
+ * Ensure this security descriptor has exactly one mode, uid
+ * and gid.
+ */
+
+static NTSTATUS check_nfs_sd(const struct security_descriptor *psd)
+{
+	uint32_t i;
+	bool got_one_mode = false;
+	bool got_one_uid = false;
+	bool got_one_gid = false;
+
+	if (psd->dacl == NULL) {
+		return NT_STATUS_INVALID_SECURITY_DESCR;
+	}
+
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Mode,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_mode == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_mode = true;
+		}
+	}
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Users,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_uid == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_uid = true;
+		}
+	}
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Groups,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_gid == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_gid = true;
+		}
+	}
+	/* Must have at least one of each. */
+	if (got_one_mode == false ||
+			got_one_uid == false ||
+			got_one_gid == false) {
+		return NT_STATUS_INVALID_SECURITY_DESCR;
+	}
+	return NT_STATUS_OK;
+}
+
+static bool test_nfs_aces(struct torture_context *tctx,
+			  struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	struct security_ace ace;
+	struct dom_sid sid;
+	const char *fname = BASEDIR "\\nfs_aces.txt";
+	struct smb2_handle h = {{0}};
+	union smb_fileinfo finfo2;
+	union smb_setfileinfo set;
+	struct security_descriptor *psd = NULL;
+	NTSTATUS status;
+	bool ret = true;
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed");
+
+	/* clean slate ...*/
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &h);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	smb2_util_close(tree, h);
+
+	/* Create a test file. */
+	status = torture_smb2_testfile_access(tree,
+				fname,
+				&h,
+				SEC_STD_READ_CONTROL |
+				SEC_STD_WRITE_DAC |
+				SEC_RIGHTS_FILE_ALL);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Get the ACL. */
+	finfo2.query_secdesc.in.secinfo_flags =
+		SECINFO_OWNER |
+		SECINFO_GROUP |
+		SECINFO_DACL;
+	finfo2.generic.level = RAW_FILEINFO_SEC_DESC;
+	finfo2.generic.in.file.handle = h;
+	status = smb2_getinfo_file(tree, tctx, &finfo2);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	psd = finfo2.query_secdesc.out.sd;
+
+	/* Ensure we have only single mode/uid/gid NFS entries. */
+	status = check_nfs_sd(psd);
+	if (!NT_STATUS_IS_OK(status)) {
+		NDR_PRINT_DEBUG(
+			security_descriptor,
+			discard_const_p(struct security_descriptor, psd));
+	}
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Add a couple of extra NFS uids and gids. */
+	sid_compose(&sid, &global_sid_Unix_NFS_Users, 27);
+	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	sid_compose(&sid, &global_sid_Unix_NFS_Groups, 300);
+	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Now set on the file handle. */
+	set.set_secdesc.level = RAW_SFILEINFO_SEC_DESC;
+	set.set_secdesc.in.file.handle = h;
+	set.set_secdesc.in.secinfo_flags = SECINFO_DACL;
+	set.set_secdesc.in.sd = psd;
+	status = smb2_setinfo_file(tree, &set);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Get the ACL again. */
+	finfo2.query_secdesc.in.secinfo_flags =
+		SECINFO_OWNER |
+		SECINFO_GROUP |
+		SECINFO_DACL;
+	finfo2.generic.level = RAW_FILEINFO_SEC_DESC;
+	finfo2.generic.in.file.handle = h;
+	status = smb2_getinfo_file(tree, tctx, &finfo2);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	psd = finfo2.query_secdesc.out.sd;
+
+	/* Ensure we have only single mode/uid/gid NFS entries. */
+	status = check_nfs_sd(psd);
+	if (!NT_STATUS_IS_OK(status)) {
+		NDR_PRINT_DEBUG(
+			security_descriptor,
+			discard_const_p(struct security_descriptor, psd));
+	}
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+done:
+	if (!smb2_util_handle_empty(h)) {
+		smb2_util_close(tree, h);
+	}
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+	talloc_free(mem_ctx);
+	return ret;
+}
+
+/*
  * Note: This test depends on "vfs objects = catia fruit streams_xattr".  For
  * some tests torture must be run on the host it tests and takes an additional
  * argument with the local path to the share:
@@ -4465,6 +4635,7 @@ struct torture_suite *torture_vfs_fruit(
 	torture_suite_add_1smb2_test(suite, "creating rsrc with read-only access", test_rfork_create_ro);
 	torture_suite_add_1smb2_test(suite, "copy-chunk streams", test_copy_chunk_streams);
 	torture_suite_add_1smb2_test(suite, "OS X AppleDouble file conversion", test_adouble_conversion);
+	torture_suite_add_1smb2_test(suite, "NFS ACE entries", test_nfs_aces);
 
 	return suite;
 }
