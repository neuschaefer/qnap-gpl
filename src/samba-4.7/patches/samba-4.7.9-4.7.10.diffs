diff -Npur samba-4.7.9/VERSION samba-4.7.10/VERSION
--- samba-4.7.9/VERSION	2018-08-11 22:02:51.000000000 +0200
+++ samba-4.7.10/VERSION	2018-08-27 09:54:35.000000000 +0200
@@ -25,7 +25,7 @@
 ########################################################
 SAMBA_VERSION_MAJOR=4
 SAMBA_VERSION_MINOR=7
-SAMBA_VERSION_RELEASE=9
+SAMBA_VERSION_RELEASE=10
 
 ########################################################
 # If a official release has a serious bug              #
diff -Npur samba-4.7.9/WHATSNEW.txt samba-4.7.10/WHATSNEW.txt
--- samba-4.7.9/WHATSNEW.txt	2018-08-11 22:01:40.000000000 +0200
+++ samba-4.7.10/WHATSNEW.txt	2018-08-27 09:54:35.000000000 +0200
@@ -1,3 +1,108 @@
+                   ==============================
+                   Release Notes for Samba 4.7.10
+                           August 27, 2018
+                   ==============================
+
+
+This is the latest stable release of the Samba 4.7 release series.
+
+
+Changes since 4.7.9:
+--------------------
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13474: python: pysmbd: Additional error path leak fix.
+   * BUG 13511: libsmbclient: Initialize written value before use.
+   * BUG 13527: s3: libsmbclient: Fix cli_splice() fallback when reading less
+     than a complete file.
+   * BUG 13537: Using "sendfile = yes" with SMB2 can cause CPU spin.
+
+o  Jeffrey Altman <jaltman@secure-endpoints.com>
+   * BUG 11573: heimdal: lib/krb5: Do not fail set_config_files due to parse
+     error.
+
+o  Andrew Bartlett <abartlet@samba.org>
+   * BUG 13519: ldb: Refuse to build Samba against a newer minor version of
+     ldb.
+
+o  Bailey Berro <baileyberro@chromium.org>
+   * BUG 13511: libsmbclient: Initialize written in cli_splice_fallback().
+
+o  Alexander Bokovoy <ab@samba.org>
+   * BUG 13538: samba-tool trust: Support discovery via netr_GetDcName.
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 13318: Durable Handles reconnect fails in a cluster when the cluster
+     fs uses different device ids.
+   * BUG 13351: s3: smbd: Always set vuid in check_user_ok().
+   * BUG 13505: lib: smb_threads: Fix access before init bug.
+   * BUG 13535: s3: smbd: Fix path check in
+     smbd_smb2_create_durable_lease_check().
+   * BUG 13451: Fail renaming file if that file has open streams.
+
+o  GÃ¼nther Deschner <gd@samba.org>
+   * BUG 13437: Fix building Samba with gcc 8.1.
+
+o  David Disseldorp <ddiss@samba.org>
+   * BUG 13506: vfs_ceph: Don't lie about flock support.
+   * BUG 13540: Fix deadlock with ctdb_mutex_ceph_rados_helper.
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13195: g_lock: Fix lock upgrades.
+   * BUG 13584: vfs_fruit: Fix a panic if fruit_access_check detects a locking
+     conflict.
+
+o  Gary Lockyer <gary@catalyst.net.nz>
+   * BUG 13536: The current position in the dns name was not advanced past the
+     '.' character.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13308: samba-tool domain trust: Fix trust compatibility to Windows
+     Server 1709 and FreeIPA.
+
+o  Christof Schmitt <cs@samba.org>
+   * BUG 13478: krb5_wrap: Fix keep_old_entries logic for older kerberos
+     libraries.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 13437: Fix building Samba with gcc 8.1.
+
+o  Martin Schwenke <martin@meltin.net>
+   * BUG 13499: Don't use CTDB_BROADCAST_VNNMAP.
+   * BUG 13500: ctdb-daemon: Only consider client ID for local database attach.
+
+o  Karolin Seeger <kseeger@samba.org>
+   * BUG 13499: s3/notifyd.c: Rename CTDB_BROADCAST_VNNMAP to
+     CTDB_BROADCAST_ACTIVE.
+
+o  Ralph Wuerthner <ralph.wuerthner@de.ibm.com>
+   * BUG 13568: vfs_time_audit: Fix handling of token_blob in
+     smb_time_audit_offload_read_recv().
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
                    =============================
                    Release Notes for Samba 4.7.9
                            August 14, 2018
@@ -74,8 +179,8 @@ database (https://bugzilla.samba.org/).
 ======================================================================
 
 
-Release notes for older releases follow:
-----------------------------------------
+----------------------------------------------------------------------
+
 
                    =============================
                    Release Notes for Samba 4.7.8
diff -Npur samba-4.7.9/auth/auth_log.c samba-4.7.10/auth/auth_log.c
--- samba-4.7.9/auth/auth_log.c	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.10/auth/auth_log.c	2018-08-27 09:54:35.000000000 +0200
@@ -350,7 +350,7 @@ static void add_version(struct json_cont
 static void add_timestamp(struct json_context *context)
 {
 	char buffer[40];	/* formatted time less usec and timezone */
-	char timestamp[50];	/* the formatted ISO 8601 time stamp	 */
+	char timestamp[65];	/* the formatted ISO 8601 time stamp	 */
 	char tz[10];		/* formatted time zone			 */
 	struct tm* tm_info;	/* current local time			 */
 	struct timeval tv;	/* current system time			 */
diff -Npur samba-4.7.9/ctdb/doc/ctdb-etcd.7 samba-4.7.10/ctdb/doc/ctdb-etcd.7
--- samba-4.7.9/ctdb/doc/ctdb-etcd.7	2018-08-11 22:04:01.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb-etcd.7	2018-08-27 10:03:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdb-statistics.7 samba-4.7.10/ctdb/doc/ctdb-statistics.7
--- samba-4.7.9/ctdb/doc/ctdb-statistics.7	2018-08-11 22:04:00.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb-statistics.7	2018-08-27 10:03:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdb-tunables.7 samba-4.7.10/ctdb/doc/ctdb-tunables.7
--- samba-4.7.9/ctdb/doc/ctdb-tunables.7	2018-08-11 22:04:00.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb-tunables.7	2018-08-27 10:03:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdb.1 samba-4.7.10/ctdb/doc/ctdb.1
--- samba-4.7.9/ctdb/doc/ctdb.1	2018-08-11 22:03:57.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb.1	2018-08-27 10:03:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -164,7 +164,7 @@ Sometimes this number will be shown as "
 \fBVirtual Node Number (VNN) map\fR
 .RS 4
 .PP
-Consists of the number of virtual nodes and mapping from virtual node numbers to physical node numbers\&. Virtual nodes host CTDB databases\&. Only nodes that are participating in the VNN map can become lmaster or dmaster for database records\&.
+Consists of the number of virtual nodes and mapping from virtual node numbers to physical node numbers\&. Only nodes that are participating in the VNN map can become lmaster for database records\&.
 .RE
 .sp
 .it 1 an-trap
diff -Npur samba-4.7.9/ctdb/doc/ctdb.1.html samba-4.7.10/ctdb/doc/ctdb.1.html
--- samba-4.7.9/ctdb/doc/ctdb.1.html	2018-08-11 22:03:57.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb.1.html	2018-08-27 10:03:39.000000000 +0200
@@ -96,10 +96,9 @@
 	  through a recovery.
 	</p></div><div class="refsect3"><a name="idm128"></a><h4>Virtual Node Number (VNN) map</h4><p>
 	  Consists of the number of virtual nodes and mapping from
-	  virtual node numbers to physical node numbers.  Virtual
-	  nodes host CTDB databases.  Only nodes that are
-	  participating in the VNN map can become lmaster or dmaster
-	  for database records.
+	  virtual node numbers to physical node numbers.  Only nodes
+	  that are participating in the VNN map can become lmaster for
+	  database records.
 	</p></div><div class="refsect3"><a name="idm131"></a><h4>Recovery mode</h4><p>
 	  This is the current recovery mode of the cluster. There are two possible modes:
 	</p><p>
diff -Npur samba-4.7.9/ctdb/doc/ctdb.1.xml samba-4.7.10/ctdb/doc/ctdb.1.xml
--- samba-4.7.9/ctdb/doc/ctdb.1.xml	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/doc/ctdb.1.xml	2018-08-27 09:54:35.000000000 +0200
@@ -292,10 +292,9 @@
 	<title>Virtual Node Number (VNN) map</title>
 	<para>
 	  Consists of the number of virtual nodes and mapping from
-	  virtual node numbers to physical node numbers.  Virtual
-	  nodes host CTDB databases.  Only nodes that are
-	  participating in the VNN map can become lmaster or dmaster
-	  for database records.
+	  virtual node numbers to physical node numbers.  Only nodes
+	  that are participating in the VNN map can become lmaster for
+	  database records.
 	</para>
       </refsect3>
 
diff -Npur samba-4.7.9/ctdb/doc/ctdb.7 samba-4.7.10/ctdb/doc/ctdb.7
--- samba-4.7.9/ctdb/doc/ctdb.7	2018-08-11 22:04:00.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb.7	2018-08-27 10:03:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdb_diagnostics.1 samba-4.7.10/ctdb/doc/ctdb_diagnostics.1
--- samba-4.7.9/ctdb/doc/ctdb_diagnostics.1	2018-08-11 22:03:58.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb_diagnostics.1	2018-08-27 10:03:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.7.10/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.7.9/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-08-11 22:04:01.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-08-27 10:03:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdbd.1 samba-4.7.10/ctdb/doc/ctdbd.1
--- samba-4.7.9/ctdb/doc/ctdbd.1	2018-08-11 22:03:57.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdbd.1	2018-08-27 10:03:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdbd.conf.5 samba-4.7.10/ctdb/doc/ctdbd.conf.5
--- samba-4.7.9/ctdb/doc/ctdbd.conf.5	2018-08-11 22:03:59.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdbd.conf.5	2018-08-27 10:03:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ctdbd_wrapper.1 samba-4.7.10/ctdb/doc/ctdbd_wrapper.1
--- samba-4.7.9/ctdb/doc/ctdbd_wrapper.1	2018-08-11 22:03:59.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ctdbd_wrapper.1	2018-08-27 10:03:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ltdbtool.1 samba-4.7.10/ctdb/doc/ltdbtool.1
--- samba-4.7.9/ctdb/doc/ltdbtool.1	2018-08-11 22:03:58.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ltdbtool.1	2018-08-27 10:03:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/onnode.1 samba-4.7.10/ctdb/doc/onnode.1
--- samba-4.7.9/ctdb/doc/onnode.1	2018-08-11 22:03:59.000000000 +0200
+++ samba-4.7.10/ctdb/doc/onnode.1	2018-08-27 10:03:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/doc/ping_pong.1 samba-4.7.10/ctdb/doc/ping_pong.1
--- samba-4.7.9/ctdb/doc/ping_pong.1	2018-08-11 22:03:58.000000000 +0200
+++ samba-4.7.10/ctdb/doc/ping_pong.1	2018-08-27 10:03:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "08/27/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/ctdb/include/ctdb_private.h samba-4.7.10/ctdb/include/ctdb_private.h
--- samba-4.7.9/ctdb/include/ctdb_private.h	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/include/ctdb_private.h	2018-08-27 09:54:35.000000000 +0200
@@ -724,9 +724,12 @@ int ctdb_set_db_readonly(struct ctdb_con
 
 int ctdb_process_deferred_attach(struct ctdb_context *ctdb);
 
-int32_t ctdb_control_db_attach(struct ctdb_context *ctdb, TDB_DATA indata,
+int32_t ctdb_control_db_attach(struct ctdb_context *ctdb,
+			       TDB_DATA indata,
 			       TDB_DATA *outdata,
-			       uint8_t db_flags, uint32_t client_id,
+			       uint8_t db_flags,
+			       uint32_t srcnode,
+			       uint32_t client_id,
 			       struct ctdb_req_control_old *c,
 			       bool *async_reply);
 int32_t ctdb_control_db_detach(struct ctdb_context *ctdb, TDB_DATA indata,
diff -Npur samba-4.7.9/ctdb/protocol/protocol.h samba-4.7.10/ctdb/protocol/protocol.h
--- samba-4.7.9/ctdb/protocol/protocol.h	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/protocol/protocol.h	2018-08-27 09:54:35.000000000 +0200
@@ -43,7 +43,7 @@ enum ctdb_operation {
 /* send a broadcast to all nodes in the cluster, active or not */
 #define CTDB_BROADCAST_ALL    0xF0000002
 /* send a broadcast to all nodes in the current vnn map */
-#define CTDB_BROADCAST_VNNMAP 0xF0000003
+#define CTDB_BROADCAST_ACTIVE 0xF0000003
 /* send a broadcast to all connected nodes */
 #define CTDB_BROADCAST_CONNECTED 0xF0000004
 /* send a broadcast to selected connected nodes */
diff -Npur samba-4.7.9/ctdb/protocol/protocol_debug.c samba-4.7.10/ctdb/protocol/protocol_debug.c
--- samba-4.7.9/ctdb/protocol/protocol_debug.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/protocol/protocol_debug.c	2018-08-27 09:54:35.000000000 +0200
@@ -262,8 +262,8 @@ static void ctdb_pnn_print(uint32_t pnn,
 		fprintf(fp, "CURRENT");
 	} else if (pnn == CTDB_BROADCAST_ALL) {
 		fprintf(fp, "ALL");
-	} else if (pnn == CTDB_BROADCAST_VNNMAP) {
-		fprintf(fp, "VNNMAP");
+	} else if (pnn == CTDB_BROADCAST_ACTIVE) {
+		fprintf(fp, "ACTIVE");
 	} else  if (pnn == CTDB_BROADCAST_CONNECTED) {
 		fprintf(fp, "CONNECTED");
 	} else if (pnn == CTDB_MULTICAST) {
diff -Npur samba-4.7.9/ctdb/server/ctdb_control.c samba-4.7.10/ctdb/server/ctdb_control.c
--- samba-4.7.9/ctdb/server/ctdb_control.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/server/ctdb_control.c	2018-08-27 09:54:35.000000000 +0200
@@ -267,18 +267,34 @@ static int32_t ctdb_control_dispatch(str
 	}
 
 	case CTDB_CONTROL_DB_ATTACH:
-	  return ctdb_control_db_attach(ctdb, indata, outdata, 0, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					0,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_DB_ATTACH_PERSISTENT:
-	  return ctdb_control_db_attach(ctdb, indata, outdata,
-					CTDB_DB_FLAGS_PERSISTENT, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					CTDB_DB_FLAGS_PERSISTENT,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
-	  return ctdb_control_db_attach(ctdb, indata, outdata,
-					CTDB_DB_FLAGS_REPLICATED, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					CTDB_DB_FLAGS_REPLICATED,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_SET_CALL:
 		return control_not_implemented("SET_CALL", NULL);
@@ -859,7 +875,7 @@ int ctdb_daemon_send_control(struct ctdb
 		return -1;
 	}
 
-	if (((destnode == CTDB_BROADCAST_VNNMAP) || 
+	if (((destnode == CTDB_BROADCAST_ACTIVE) ||
 	     (destnode == CTDB_BROADCAST_ALL) ||
 	     (destnode == CTDB_BROADCAST_CONNECTED)) && 
 	    !(flags & CTDB_CTRL_FLAG_NOREPLY)) {
@@ -867,7 +883,7 @@ int ctdb_daemon_send_control(struct ctdb
 		return -1;
 	}
 
-	if (destnode != CTDB_BROADCAST_VNNMAP && 
+	if (destnode != CTDB_BROADCAST_ACTIVE &&
 	    destnode != CTDB_BROADCAST_ALL && 
 	    destnode != CTDB_BROADCAST_CONNECTED && 
 	    (!ctdb_validate_pnn(ctdb, destnode) || 
diff -Npur samba-4.7.9/ctdb/server/ctdb_ltdb_server.c samba-4.7.10/ctdb/server/ctdb_ltdb_server.c
--- samba-4.7.9/ctdb/server/ctdb_ltdb_server.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/server/ctdb_ltdb_server.c	2018-08-27 09:54:35.000000000 +0200
@@ -1105,9 +1105,12 @@ int ctdb_process_deferred_attach(struct
 /*
   a client has asked to attach a new database
  */
-int32_t ctdb_control_db_attach(struct ctdb_context *ctdb, TDB_DATA indata,
+int32_t ctdb_control_db_attach(struct ctdb_context *ctdb,
+			       TDB_DATA indata,
 			       TDB_DATA *outdata,
-			       uint8_t db_flags, uint32_t client_id,
+			       uint8_t db_flags,
+			       uint32_t srcnode,
+			       uint32_t client_id,
 			       struct ctdb_req_control_old *c,
 			       bool *async_reply)
 {
@@ -1128,7 +1131,7 @@ int32_t ctdb_control_db_attach(struct ct
 	 * allow all attach from the network since these are always from remote
 	 * recovery daemons.
 	 */
-	if (client_id != 0) {
+	if (srcnode == ctdb->pnn && client_id != 0) {
 		client = reqid_find(ctdb->idr, client_id, struct ctdb_client);
 	}
 	if (client != NULL) {
@@ -1535,9 +1538,15 @@ static void ctdb_ltdb_seqnum_check(struc
 		TDB_DATA data;
 		data.dptr = (uint8_t *)&ctdb_db->db_id;
 		data.dsize = sizeof(uint32_t);
-		ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0,
-					 CTDB_CONTROL_UPDATE_SEQNUM, 0, CTDB_CTRL_FLAG_NOREPLY,
-					 data, NULL, NULL);		
+		ctdb_daemon_send_control(ctdb,
+					 CTDB_BROADCAST_ACTIVE,
+					 0,
+					 CTDB_CONTROL_UPDATE_SEQNUM,
+					 0,
+					 CTDB_CTRL_FLAG_NOREPLY,
+					 data,
+					 NULL,
+					 NULL);
 	}
 	ctdb_db->seqnum = new_seqnum;
 
diff -Npur samba-4.7.9/ctdb/server/ctdb_server.c samba-4.7.10/ctdb/server/ctdb_server.c
--- samba-4.7.9/ctdb/server/ctdb_server.c	2017-07-04 21:22:39.000000000 +0200
+++ samba-4.7.10/ctdb/server/ctdb_server.c	2018-08-27 09:54:35.000000000 +0200
@@ -389,14 +389,18 @@ static void ctdb_broadcast_packet_all(st
 }
 
 /*
-  broadcast a packet to all nodes in the current vnnmap
+  broadcast a packet to all active nodes
 */
-static void ctdb_broadcast_packet_vnnmap(struct ctdb_context *ctdb, 
+static void ctdb_broadcast_packet_active(struct ctdb_context *ctdb,
 					 struct ctdb_req_header *hdr)
 {
 	int i;
-	for (i=0;i<ctdb->vnn_map->size;i++) {
-		hdr->destnode = ctdb->vnn_map->map[i];
+	for (i = 0; i < ctdb->num_nodes; i++) {
+		if (ctdb->nodes[i]->flags & NODE_FLAGS_INACTIVE) {
+			continue;
+		}
+
+		hdr->destnode = ctdb->nodes[i]->pnn;
 		ctdb_queue_packet(ctdb, hdr);
 	}
 }
@@ -430,8 +434,8 @@ void ctdb_queue_packet(struct ctdb_conte
 	case CTDB_BROADCAST_ALL:
 		ctdb_broadcast_packet_all(ctdb, hdr);
 		return;
-	case CTDB_BROADCAST_VNNMAP:
-		ctdb_broadcast_packet_vnnmap(ctdb, hdr);
+	case CTDB_BROADCAST_ACTIVE:
+		ctdb_broadcast_packet_active(ctdb, hdr);
 		return;
 	case CTDB_BROADCAST_CONNECTED:
 		ctdb_broadcast_packet_connected(ctdb, hdr);
diff -Npur samba-4.7.9/ctdb/server/ctdb_traverse.c samba-4.7.10/ctdb/server/ctdb_traverse.c
--- samba-4.7.9/ctdb/server/ctdb_traverse.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/server/ctdb_traverse.c	2018-08-27 09:54:35.000000000 +0200
@@ -387,8 +387,8 @@ static struct ctdb_traverse_all_handle *
 	}
 
 	if (ctdb_db_volatile(ctdb_db)) {
-		/* normal database, traverse all nodes */	  
-		destination = CTDB_BROADCAST_VNNMAP;
+		/* volatile database, traverse all active nodes */
+		destination = CTDB_BROADCAST_ACTIVE;
 	} else {
 		int i;
 		/* persistent database, traverse one node, preferably
diff -Npur samba-4.7.9/ctdb/tests/scripts/integration.bash samba-4.7.10/ctdb/tests/scripts/integration.bash
--- samba-4.7.9/ctdb/tests/scripts/integration.bash	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/ctdb/tests/scripts/integration.bash	2018-08-27 09:54:35.000000000 +0200
@@ -338,6 +338,7 @@ node_has_status ()
 	(monon)        mpat='^Monitoring mode:ACTIVE \(0\)$' ;;
 	(monoff)       mpat='^Monitoring mode:DISABLED \(1\)$' ;;
 	(recovered)    rpat='^Recovery mode:RECOVERY \(1\)$' ;;
+	(notlmaster)   rpat="^hash:.* lmaster:${pnn}\$" ;;
 	*)
 	    echo "node_has_status: unknown status \"$status\""
 	    return 1
diff -Npur samba-4.7.9/ctdb/tests/simple/79_volatile_db_traverse.sh samba-4.7.10/ctdb/tests/simple/79_volatile_db_traverse.sh
--- samba-4.7.9/ctdb/tests/simple/79_volatile_db_traverse.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.10/ctdb/tests/simple/79_volatile_db_traverse.sh	2018-08-27 09:54:35.000000000 +0200
@@ -0,0 +1,94 @@
+#!/bin/bash
+
+test_info()
+{
+    cat <<EOF
+Confirm that traverses of volatile databases work as expected
+
+This is a very simple example.  It writes a single record, updates it
+on another node and then confirms that the correct value is found when
+traversing.  It then repeats this after removing the LMASTER role from
+the node where the value is updated.
+
+Expected results:
+
+* The expected records should be found
+
+EOF
+}
+
+. "${TEST_SCRIPTS_DIR}/integration.bash"
+
+ctdb_test_init "$@"
+
+set -e
+
+cluster_is_healthy
+
+# Reset configuration
+ctdb_restart_when_done
+
+#
+# Main test
+#
+TESTDB="traverse_db.tdb"
+
+echo "create volatile test database $TESTDB"
+try_command_on_node 0 $CTDB attach "$TESTDB"
+
+echo "wipe test database $TESTDB"
+try_command_on_node 0 $CTDB wipedb "$TESTDB"
+
+echo "write foo=bar0 on node 0"
+try_command_on_node 0 $CTDB writekey "$TESTDB" "foo" "bar0"
+
+echo "write foo=bar1 on node 1"
+try_command_on_node 1 $CTDB writekey "$TESTDB" "foo" "bar1"
+
+echo "do traverse on node 0"
+try_command_on_node -v 0 $CTDB catdb "$TESTDB"
+
+echo "do traverse on node 1"
+try_command_on_node -v 1 $CTDB catdb "$TESTDB"
+
+cat <<EOF
+
+Again, this time with lmaster role off on node 1
+
+EOF
+
+echo "wipe test database $TESTDB"
+try_command_on_node 0 $CTDB wipedb "$TESTDB"
+
+echo "switching off lmaster role on node 1"
+try_command_on_node 1 $CTDB setlmasterrole off
+
+try_command_on_node -v 1 $CTDB getcapabilities
+
+wait_until_node_has_status 1 notlmaster 10 0
+# Wait for recovery and new VNN map to be pushed
+#sleep_for 10
+
+echo "write foo=bar0 on node 0"
+try_command_on_node 0 $CTDB writekey "$TESTDB" "foo" "bar0"
+
+echo "write foo=bar1 on node 1"
+try_command_on_node 1 $CTDB writekey "$TESTDB" "foo" "bar1"
+
+echo "do traverse on node 0"
+try_command_on_node -v 0 $CTDB catdb "$TESTDB"
+
+num=$(echo "$out" | sed -n -e 's|^Dumped \(.*\) records$|\1|p')
+if [ "$num" = 1 ] ; then
+	echo "OK: There was 1 record"
+else
+	echo "BAD: There were ${num} (!= 1) records"
+	exit 1
+fi
+
+if echo "$out" | grep -q "^data(4) = \"bar1\"\$" ; then
+	echo "OK: Data from node 1 was returned"
+else
+	echo "BAD: Data from node 1 was not returned"
+	exit 1
+fi
diff -Npur samba-4.7.9/ctdb/tests/src/ctdb_takeover_tests.c samba-4.7.10/ctdb/tests/src/ctdb_takeover_tests.c
--- samba-4.7.9/ctdb/tests/src/ctdb_takeover_tests.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/ctdb_takeover_tests.c	2018-08-27 09:54:35.000000000 +0200
@@ -254,6 +254,8 @@ int main(int argc, const char *argv[])
 	int loglevel;
 	const char *debuglevelstr = getenv("CTDB_TEST_LOGLEVEL");
 
+	setup_logging("ctdb_takeover_tests", DEBUG_STDERR);
+
 	if (! debug_level_parse(debuglevelstr, &loglevel)) {
                 loglevel = DEBUG_DEBUG;
         }
diff -Npur samba-4.7.9/ctdb/tests/src/fetch_loop.c samba-4.7.10/ctdb/tests/src/fetch_loop.c
--- samba-4.7.9/ctdb/tests/src/fetch_loop.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/fetch_loop.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -230,6 +231,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/fetch_loop_key.c samba-4.7.10/ctdb/tests/src/fetch_loop_key.c
--- samba-4.7.9/ctdb/tests/src/fetch_loop_key.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/fetch_loop_key.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -155,6 +156,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_loop_key", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/fetch_readonly.c samba-4.7.10/ctdb/tests/src/fetch_readonly.c
--- samba-4.7.9/ctdb/tests/src/fetch_readonly.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/fetch_readonly.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -107,6 +108,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_readonly", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/fetch_readonly_loop.c samba-4.7.10/ctdb/tests/src/fetch_readonly_loop.c
--- samba-4.7.9/ctdb/tests/src/fetch_readonly_loop.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/fetch_readonly_loop.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -214,6 +215,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_readonly_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/fetch_ring.c samba-4.7.10/ctdb/tests/src/fetch_ring.c
--- samba-4.7.9/ctdb/tests/src/fetch_ring.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/fetch_ring.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/time.h"
 #include "lib/util/tevent_unix.h"
 
@@ -331,6 +332,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_ring", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/g_lock_loop.c samba-4.7.10/ctdb/tests/src/g_lock_loop.c
--- samba-4.7.9/ctdb/tests/src/g_lock_loop.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/g_lock_loop.c	2018-08-27 09:54:35.000000000 +0200
@@ -213,6 +213,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("glock_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
@@ -230,8 +232,6 @@ int main(int argc, const char *argv[])
 		exit(1);
 	}
 
-	setup_logging("glock_loop", DEBUG_STDERR);
-
 	ret = ctdb_client_init(mem_ctx, ev, opts->socket, &client);
 	if (ret != 0) {
 		fprintf(stderr, "Failed to initialize client, ret=%d\n", ret);
diff -Npur samba-4.7.9/ctdb/tests/src/message_ring.c samba-4.7.10/ctdb/tests/src/message_ring.c
--- samba-4.7.9/ctdb/tests/src/message_ring.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/message_ring.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/time.h"
 #include "lib/util/tevent_unix.h"
 
@@ -317,6 +318,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("message_ring", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/transaction_loop.c samba-4.7.10/ctdb/tests/src/transaction_loop.c
--- samba-4.7.9/ctdb/tests/src/transaction_loop.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/transaction_loop.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -342,6 +343,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("transaction_loop", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/update_record.c samba-4.7.10/ctdb/tests/src/update_record.c
--- samba-4.7.9/ctdb/tests/src/update_record.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/update_record.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "protocol/protocol_api.h"
@@ -177,6 +178,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("update_record", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/tests/src/update_record_persistent.c samba-4.7.10/ctdb/tests/src/update_record_persistent.c
--- samba-4.7.9/ctdb/tests/src/update_record_persistent.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/tests/src/update_record_persistent.c	2018-08-27 09:54:35.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "protocol/protocol_api.h"
@@ -153,6 +154,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("update_record_persistene", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.7.9/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c samba-4.7.10/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c
--- samba-4.7.9/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c	2018-08-27 09:54:35.000000000 +0200
@@ -1,7 +1,7 @@
 /*
    CTDB mutex helper using Ceph librados locks
 
-   Copyright (C) David Disseldorp 2016
+   Copyright (C) David Disseldorp 2016-2018
 
    Based on ctdb_mutex_fcntl_helper.c, which is:
    Copyright (C) Martin Schwenke 2015
@@ -29,6 +29,11 @@
 #define CTDB_MUTEX_CEPH_LOCK_NAME	"ctdb_reclock_mutex"
 #define CTDB_MUTEX_CEPH_LOCK_COOKIE	CTDB_MUTEX_CEPH_LOCK_NAME
 #define CTDB_MUTEX_CEPH_LOCK_DESC	"CTDB recovery lock"
+/*
+ * During failover it may take up to <lock duration> seconds before the
+ * newly elected recovery master can obtain the lock.
+ */
+#define CTDB_MUTEX_CEPH_LOCK_DURATION_SECS_DEFAULT	10
 
 #define CTDB_MUTEX_STATUS_HOLDING "0"
 #define CTDB_MUTEX_STATUS_CONTENDED "1"
@@ -88,24 +93,20 @@ static int ctdb_mutex_rados_ctx_create(c
 	return 0;
 }
 
-static void ctdb_mutex_rados_ctx_destroy(rados_t ceph_cluster,
-					 rados_ioctx_t ioctx)
-{
-	rados_ioctx_destroy(ioctx);
-	rados_shutdown(ceph_cluster);
-}
-
 static int ctdb_mutex_rados_lock(rados_ioctx_t *ioctx,
-				 const char *oid)
+				 const char *oid,
+				 uint64_t lock_duration_s,
+				 uint8_t flags)
 {
 	int ret;
+	struct timeval tv = { lock_duration_s, 0 };
 
 	ret = rados_lock_exclusive(ioctx, oid,
-                                   CTDB_MUTEX_CEPH_LOCK_NAME,
+				   CTDB_MUTEX_CEPH_LOCK_NAME,
 				   CTDB_MUTEX_CEPH_LOCK_COOKIE,
 				   CTDB_MUTEX_CEPH_LOCK_DESC,
-                                   NULL, /* infinite duration */
-                                   0);
+				   lock_duration_s == 0 ? NULL : &tv,
+				   flags);
 	if ((ret == -EEXIST) || (ret == -EBUSY)) {
 		/* lock contention */
 		return ret;
@@ -145,10 +146,13 @@ struct ctdb_mutex_rados_state {
 	const char *ceph_auth_name;
 	const char *pool_name;
 	const char *object;
+	uint64_t lock_duration_s;
 	int ppid;
 	struct tevent_context *ev;
-	struct tevent_signal *sig_ev;
-	struct tevent_timer *timer_ev;
+	struct tevent_signal *sigterm_ev;
+	struct tevent_signal *sigint_ev;
+	struct tevent_timer *ppid_timer_ev;
+	struct tevent_timer *renew_timer_ev;
 	rados_t ceph_cluster;
 	rados_ioctx_t ioctx;
 };
@@ -161,29 +165,24 @@ static void ctdb_mutex_rados_sigterm_cb(
 					void *private_data)
 {
 	struct ctdb_mutex_rados_state *cmr_state = private_data;
-	int ret;
+	int ret = 0;
 
 	if (!cmr_state->holding_mutex) {
 		fprintf(stderr, "Sigterm callback invoked without mutex!\n");
 		ret = -EINVAL;
-		goto err_ctx_cleanup;
 	}
 
-	ret = ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
-err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
 	talloc_free(cmr_state);
 	exit(ret ? 1 : 0);
 }
 
-static void ctdb_mutex_rados_timer_cb(struct tevent_context *ev,
-				      struct tevent_timer *te,
-				      struct timeval current_time,
-				      void *private_data)
+static void ctdb_mutex_rados_ppid_timer_cb(struct tevent_context *ev,
+					   struct tevent_timer *te,
+					   struct timeval current_time,
+					   void *private_data)
 {
 	struct ctdb_mutex_rados_state *cmr_state = private_data;
-	int ret;
+	int ret = 0;
 
 	if (!cmr_state->holding_mutex) {
 		fprintf(stderr, "Timer callback invoked without mutex!\n");
@@ -193,26 +192,81 @@ static void ctdb_mutex_rados_timer_cb(st
 
 	if ((kill(cmr_state->ppid, 0) == 0) || (errno != ESRCH)) {
 		/* parent still around, keep waiting */
-		cmr_state->timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
+		cmr_state->ppid_timer_ev = tevent_add_timer(cmr_state->ev,
+							    cmr_state,
 					       tevent_timeval_current_ofs(5, 0),
-						      ctdb_mutex_rados_timer_cb,
-						       cmr_state);
-		if (cmr_state->timer_ev == NULL) {
+						ctdb_mutex_rados_ppid_timer_cb,
+							    cmr_state);
+		if (cmr_state->ppid_timer_ev == NULL) {
 			fprintf(stderr, "Failed to create timer event\n");
 			/* rely on signal cb */
 		}
 		return;
 	}
 
-	/* parent ended, drop lock and exit */
-	ret = ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
+	/* parent ended, drop lock (via destructor) and exit */
 err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
 	talloc_free(cmr_state);
 	exit(ret ? 1 : 0);
 }
 
+#define USECS_IN_SEC 1000000
+
+static void ctdb_mutex_rados_lock_renew_timer_cb(struct tevent_context *ev,
+						 struct tevent_timer *te,
+						 struct timeval current_time,
+						 void *private_data)
+{
+	struct ctdb_mutex_rados_state *cmr_state = private_data;
+	struct timeval tv;
+	int ret;
+
+	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object,
+				    cmr_state->lock_duration_s,
+				    LIBRADOS_LOCK_FLAG_RENEW);
+	if (ret == -EBUSY) {
+		/* should never get -EEXIST on renewal */
+		fprintf(stderr, "Lock contention during renew: %d\n", ret);
+		goto err_ctx_cleanup;
+	} else if (ret < 0) {
+		fprintf(stderr, "Lock renew failed\n");
+		goto err_ctx_cleanup;
+	}
+
+	tv = tevent_timeval_current_ofs(0,
+			    cmr_state->lock_duration_s * (USECS_IN_SEC / 2));
+	cmr_state->renew_timer_ev = tevent_add_timer(cmr_state->ev,
+						       cmr_state,
+						       tv,
+					ctdb_mutex_rados_lock_renew_timer_cb,
+						       cmr_state);
+	if (cmr_state->renew_timer_ev == NULL) {
+		fprintf(stderr, "Failed to create timer event\n");
+		goto err_ctx_cleanup;
+	}
+
+	return;
+
+err_ctx_cleanup:
+	/* drop lock (via destructor) and exit */
+	talloc_free(cmr_state);
+	exit(1);
+}
+
+static int ctdb_mutex_rados_state_destroy(struct ctdb_mutex_rados_state *cmr_state)
+{
+	if (cmr_state->holding_mutex) {
+		ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
+	}
+	if (cmr_state->ioctx != NULL) {
+		rados_ioctx_destroy(cmr_state->ioctx);
+	}
+	if (cmr_state->ceph_cluster != NULL) {
+		rados_shutdown(cmr_state->ceph_cluster);
+	}
+	return 0;
+}
+
 int main(int argc, char *argv[])
 {
 	int ret;
@@ -220,9 +274,10 @@ int main(int argc, char *argv[])
 
 	progname = argv[0];
 
-	if (argc != 5) {
+	if ((argc != 5) && (argc != 6)) {
 		fprintf(stderr, "Usage: %s <Ceph Cluster> <Ceph user> "
-				"<RADOS pool> <RADOS object>\n",
+				"<RADOS pool> <RADOS object> "
+				"[lock duration secs]\n",
 			progname);
 		ret = -EINVAL;
 		goto err_out;
@@ -240,10 +295,24 @@ int main(int argc, char *argv[])
 		goto err_out;
 	}
 
+	talloc_set_destructor(cmr_state, ctdb_mutex_rados_state_destroy);
 	cmr_state->ceph_cluster_name = argv[1];
 	cmr_state->ceph_auth_name = argv[2];
 	cmr_state->pool_name = argv[3];
 	cmr_state->object = argv[4];
+	if (argc == 6) {
+		/* optional lock duration provided */
+		char *endptr = NULL;
+		cmr_state->lock_duration_s = strtoull(argv[5], &endptr, 0);
+		if ((endptr == argv[5]) || (*endptr != '\0')) {
+			fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+			ret = -EINVAL;
+			goto err_ctx_cleanup;
+		}
+	} else {
+		cmr_state->lock_duration_s
+			= CTDB_MUTEX_CEPH_LOCK_DURATION_SECS_DEFAULT;
+	}
 
 	cmr_state->ppid = getppid();
 	if (cmr_state->ppid == 1) {
@@ -257,7 +326,7 @@ int main(int argc, char *argv[])
 		 */
 		fprintf(stderr, "%s: PPID == 1\n", progname);
 		ret = -EPIPE;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	cmr_state->ev = tevent_context_init(cmr_state);
@@ -265,30 +334,40 @@ int main(int argc, char *argv[])
 		fprintf(stderr, "tevent_context_init failed\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	/* wait for sigterm */
-	cmr_state->sig_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGTERM, 0,
+	cmr_state->sigterm_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGTERM, 0,
 					      ctdb_mutex_rados_sigterm_cb,
 					      cmr_state);
-	if (cmr_state->sig_ev == NULL) {
-		fprintf(stderr, "Failed to create signal event\n");
+	if (cmr_state->sigterm_ev == NULL) {
+		fprintf(stderr, "Failed to create term signal event\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
+	}
+
+	cmr_state->sigint_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGINT, 0,
+					      ctdb_mutex_rados_sigterm_cb,
+					      cmr_state);
+	if (cmr_state->sigint_ev == NULL) {
+		fprintf(stderr, "Failed to create int signal event\n");
+		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+		ret = -ENOMEM;
+		goto err_ctx_cleanup;
 	}
 
 	/* periodically check parent */
-	cmr_state->timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
+	cmr_state->ppid_timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
 					       tevent_timeval_current_ofs(5, 0),
-					       ctdb_mutex_rados_timer_cb,
+					       ctdb_mutex_rados_ppid_timer_cb,
 					       cmr_state);
-	if (cmr_state->timer_ev == NULL) {
+	if (cmr_state->ppid_timer_ev == NULL) {
 		fprintf(stderr, "Failed to create timer event\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	ret = ctdb_mutex_rados_ctx_create(cmr_state->ceph_cluster_name,
@@ -298,10 +377,12 @@ int main(int argc, char *argv[])
 					  &cmr_state->ioctx);
 	if (ret < 0) {
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
-	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object);
+	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object,
+				    cmr_state->lock_duration_s,
+				    0);
 	if ((ret == -EEXIST) || (ret == -EBUSY)) {
 		fprintf(stdout, CTDB_MUTEX_STATUS_CONTENDED);
 		goto err_ctx_cleanup;
@@ -309,8 +390,28 @@ int main(int argc, char *argv[])
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		goto err_ctx_cleanup;
 	}
-
 	cmr_state->holding_mutex = true;
+
+	if (cmr_state->lock_duration_s != 0) {
+		/*
+		 * renew (reobtain) the lock, using a period of half the lock
+		 * duration. Convert to usecs to avoid rounding.
+		 */
+		struct timeval tv = tevent_timeval_current_ofs(0,
+			       cmr_state->lock_duration_s * (USECS_IN_SEC / 2));
+		cmr_state->renew_timer_ev = tevent_add_timer(cmr_state->ev,
+							       cmr_state,
+							       tv,
+					ctdb_mutex_rados_lock_renew_timer_cb,
+							       cmr_state);
+		if (cmr_state->renew_timer_ev == NULL) {
+			fprintf(stderr, "Failed to create timer event\n");
+			fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+			ret = -ENOMEM;
+			goto err_ctx_cleanup;
+		}
+	}
+
 	fprintf(stdout, CTDB_MUTEX_STATUS_HOLDING);
 
 	/* wait for the signal / timer events to do their work */
@@ -319,9 +420,6 @@ int main(int argc, char *argv[])
 		goto err_ctx_cleanup;
 	}
 err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
-err_state_free:
 	talloc_free(cmr_state);
 err_out:
 	return ret ? 1 : 0;
diff -Npur samba-4.7.9/ctdb/utils/ceph/test_ceph_rados_reclock.sh samba-4.7.10/ctdb/utils/ceph/test_ceph_rados_reclock.sh
--- samba-4.7.9/ctdb/utils/ceph/test_ceph_rados_reclock.sh	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/utils/ceph/test_ceph_rados_reclock.sh	2018-08-27 09:54:35.000000000 +0200
@@ -46,7 +46,9 @@ which ctdb_mutex_ceph_rados_helper || ex
 TMP_DIR="$(mktemp --directory)" || exit 1
 rados -p "$POOL" rm "$OBJECT"
 
-(ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" \
+# explicitly disable lock expiry (duration=0), to ensure that we don't get
+# intermittent failures (due to renewal) from the lock state diff further down
+(ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" 0 \
 							> ${TMP_DIR}/first) &
 locker_pid=$!
 
@@ -78,6 +80,9 @@ LOCKER_COOKIE="$(jq -r '.lockers[0].cook
 LOCKER_DESC="$(jq -r '.lockers[0].description' ${TMP_DIR}/lock_state_first)"
 [ "$LOCKER_DESC" == "CTDB recovery lock" ] \
 	|| _fail "unexpected locker description: $LOCKER_DESC"
+LOCKER_EXP="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_first)"
+[ "$LOCKER_EXP" == "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP"
 
 # second attempt while first is still holding the lock - expect failure
 ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" \
@@ -145,6 +150,56 @@ third_out=$(cat ${TMP_DIR}/third)
 [ "$third_out" == "0" ] \
 	|| _fail "expected lock acquisition (0), but got $third_out"
 
+# test renew / expire behaviour using a 1s expiry (update period = 500ms)
+exec >${TMP_DIR}/forth -- ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" \
+							"$POOL" "$OBJECT" 1 &
+locker_pid=$!
+
+sleep 1
+
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_fifth_a
+#echo "with lock fifth: `cat ${TMP_DIR}/lock_state_fifth_a`"
+
+LOCK_NAME="$(jq -r '.name' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCK_NAME" == "ctdb_reclock_mutex" ] \
+	|| _fail "unexpected lock name: $LOCK_NAME"
+LOCK_TYPE="$(jq -r '.type' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCK_TYPE" == "exclusive" ] \
+	|| _fail "unexpected lock type: $LOCK_TYPE"
+LOCK_COUNT="$(jq -r '.lockers | length' ${TMP_DIR}/lock_state_fifth_a)"
+[ $LOCK_COUNT -eq 1 ] || _fail "expected 1 lock in rados state, got $LOCK_COUNT"
+LOCKER_EXP_A="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCKER_EXP_A" != "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP_A"
+sleep 1 # sleep until renewal
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_fifth_b
+LOCKER_EXP_B="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_fifth_b)"
+[ "$LOCKER_EXP_B" != "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP_B"
+#echo "lock expiration before renewal $LOCKER_EXP_A, after renewal $LOCKER_EXP_B"
+[ "$LOCKER_EXP_B" != "$LOCKER_EXP_A" ] \
+	|| _fail "locker expiration matches: $LOCKER_EXP_B"
+
+# no chance to drop the lock, rely on expiry
+kill -KILL $locker_pid || exit 1
+wait $locker_pid &> /dev/null
+sleep 1	# sleep until lock expiry
+
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_sixth
+#echo "lock expiry sixth: `cat ${TMP_DIR}/lock_state_sixth`"
+
+LOCK_NAME="$(jq -r '.name' ${TMP_DIR}/lock_state_sixth)"
+[ "$LOCK_NAME" == "ctdb_reclock_mutex" ] \
+	|| _fail "unexpected lock name: $LOCK_NAME"
+LOCK_TYPE="$(jq -r '.type' ${TMP_DIR}/lock_state_sixth)"
+[ "$LOCK_TYPE" == "exclusive" ] \
+	|| _fail "unexpected lock type: $LOCK_TYPE"
+LOCK_COUNT="$(jq -r '.lockers | length' ${TMP_DIR}/lock_state_sixth)"
+[ $LOCK_COUNT -eq 0 ] || _fail "expected 0 locks in rados state, got $LOCK_COUNT"
+
 rm ${TMP_DIR}/*
 rmdir $TMP_DIR
 
diff -Npur samba-4.7.9/ctdb/utils/pmda/pmda_ctdb.c samba-4.7.10/ctdb/utils/pmda/pmda_ctdb.c
--- samba-4.7.9/ctdb/utils/pmda/pmda_ctdb.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/ctdb/utils/pmda/pmda_ctdb.c	2018-08-27 09:54:35.000000000 +0200
@@ -33,9 +33,17 @@
 #include "client/client_sync.h"
 
 #include <pcp/pmapi.h>
-#include <pcp/impl.h>
 #include <pcp/pmda.h>
 
+#ifdef HAVE___PMID_INT
+#include <pcp/impl.h>
+
+#define pmID_cluster(id)	id->cluster
+#define pmID_item(id)		id->item
+#define pmGetProgname()		pmProgname
+#define pmSetProgname(a)	__pmSetProgname(a)
+#endif
+
 #include "domain.h"
 
 /*
@@ -386,7 +394,11 @@ static int
 pmda_ctdb_fetch_cb(pmdaMetric *mdesc, unsigned int inst, pmAtomValue *atom)
 {
 	int ret;
+#ifdef HAVE___PMID_INT
 	__pmID_int *id = (__pmID_int *)&(mdesc->m_desc.pmid);
+#else
+	pmID id = *(pmID *)&(mdesc->m_desc.pmid);
+#endif
 
 	if (inst != PM_IN_NULL) {
 		return PM_ERR_INST;
@@ -399,27 +411,27 @@ pmda_ctdb_fetch_cb(pmdaMetric *mdesc, un
 	}
 
 
-	switch (id->cluster) {
+	switch (pmID_cluster(id)) {
 	case 0:
-		ret = fill_base(id->item, atom);
+		ret = fill_base(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 1:
-		ret = fill_node(id->item, atom);
+		ret = fill_node(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 2:
-		ret = fill_client(id->item, atom);
+		ret = fill_client(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 3:
-		ret = fill_timeout(id->item, atom);
+		ret = fill_timeout(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
@@ -502,7 +514,7 @@ helpfile(void)
 static void
 usage(void)
 {
-	fprintf(stderr, "Usage: %s [options]\n\n", pmProgname);
+	fprintf(stderr, "Usage: %s [options]\n\n", pmGetProgname());
 	fputs("Options:\n"
 	  "  -d domain        use domain (numeric) for metrics domain of PMDA\n"
 	  "  -l logfile       write log into logfile rather than using default log name\n"
@@ -524,9 +536,9 @@ main(int argc, char **argv)
 	char log_file[] = "pmda_ctdb.log";
 	pmdaInterface dispatch;
 
-	__pmSetProgname(argv[0]);
+	pmSetProgname(argv[0]);
 
-	pmdaDaemon(&dispatch, PMDA_INTERFACE_2, pmProgname, CTDB,
+	pmdaDaemon(&dispatch, PMDA_INTERFACE_2, argv[0], CTDB,
 		   log_file, helpfile());
 
 	if (pmdaGetOpt(argc, argv, "d:i:l:pu:?", &dispatch, &err) != EOF) {
diff -Npur samba-4.7.9/ctdb/wscript samba-4.7.10/ctdb/wscript
--- samba-4.7.9/ctdb/wscript	2018-02-07 09:37:51.000000000 +0100
+++ samba-4.7.10/ctdb/wscript	2018-08-27 09:54:35.000000000 +0200
@@ -83,6 +83,10 @@ def set_options(opt):
     opt.add_option('--enable-etcd-reclock',
                    help=("Enable etcd recovery lock helper (default=no)"),
                    action="store_true", dest='ctdb_etcd_reclock', default=False)
+
+    opt.add_option('--with-libcephfs',
+                   help=("Directory under which libcephfs is installed"),
+                   action="store", dest='libcephfs_dir', default=None)
     opt.add_option('--enable-ceph-reclock',
                    help=("Enable Ceph CTDB recovery lock helper (default=no)"),
                    action="store_true", dest='ctdb_ceph_reclock', default=False)
@@ -166,6 +170,7 @@ def configure(conf):
         if not conf.CHECK_FUNCS_IN('pmdaDaemon', 'pcp_pmda'):
             pmda_support = False
         if pmda_support:
+            conf.CHECK_TYPE_IN('__pmID_int', 'pcp/pmapi.h pcp/impl.h')
             have_pmda = True
         else:
             Logs.error("PMDA support not available")
@@ -209,8 +214,16 @@ def configure(conf):
     conf.env.etcd_reclock = have_etcd_reclock
 
     if Options.options.ctdb_ceph_reclock:
+        # Use custom libcephfs library path if provided. XXX The top level build
+        # explicitly sets LIBPATH_CEPH-COMMON when libcephfs_dir isn't provided.
+        if Options.options.libcephfs_dir:
+            conf.env['CPPPATH_RADOS'] = Options.options.libcephfs_dir + '/include'
+            conf.env['LIBPATH_RADOS'] = Options.options.libcephfs_dir + '/lib'
+            conf.env['LIBPATH_CEPH-COMMON'] = conf.env['LIBPATH_RADOS'] + '/ceph'
+
         if (conf.CHECK_HEADERS('rados/librados.h', False, False, 'rados') and
 					conf.CHECK_LIB('rados', shlib=True)):
+            conf.CHECK_LIB('ceph-common', shlib=True)
             Logs.info('Building with Ceph librados recovery lock support')
             conf.define('HAVE_LIBRADOS', 1)
         else:
@@ -573,7 +586,7 @@ def build(bld):
     if bld.env.HAVE_LIBRADOS:
         bld.SAMBA_BINARY('ctdb_mutex_ceph_rados_helper',
                          source='utils/ceph/ctdb_mutex_ceph_rados_helper.c',
-			 deps='talloc tevent rados',
+			 deps='talloc tevent rados ceph-common',
 			 includes='include',
 			 install_path='${CTDB_HELPER_BINDIR}')
 
@@ -771,7 +784,7 @@ def build(bld):
                         source=bld.SUBDIR('tests/src',
                                           'cluster_wait.c test_options.c'),
                         includes='include',
-                        deps='replace popt talloc tevent tdb')
+                        deps='samba-util replace popt talloc tevent tdb')
 
     bld.SAMBA_BINARY('protocol_util_test',
                      source='tests/src/protocol_util_test.c',
diff -Npur samba-4.7.9/docs/manpages/cifsdd.8 samba-4.7.10/docs/manpages/cifsdd.8
--- samba-4.7.9/docs/manpages/cifsdd.8	2018-08-11 22:04:03.000000000 +0200
+++ samba-4.7.10/docs/manpages/cifsdd.8	2018-08-27 10:03:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "CIFSDD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/dbwrap_tool.1 samba-4.7.10/docs/manpages/dbwrap_tool.1
--- samba-4.7.9/docs/manpages/dbwrap_tool.1	2018-08-11 22:04:03.000000000 +0200
+++ samba-4.7.10/docs/manpages/dbwrap_tool.1	2018-08-27 10:03:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/eventlogadm.8 samba-4.7.10/docs/manpages/eventlogadm.8
--- samba-4.7.9/docs/manpages/eventlogadm.8	2018-08-11 22:04:03.000000000 +0200
+++ samba-4.7.10/docs/manpages/eventlogadm.8	2018-08-27 10:03:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "EVENTLOGADM" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/findsmb.1 samba-4.7.10/docs/manpages/findsmb.1
--- samba-4.7.9/docs/manpages/findsmb.1	2018-08-11 22:04:03.000000000 +0200
+++ samba-4.7.10/docs/manpages/findsmb.1	2018-08-27 10:03:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "FINDSMB" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_ad.8 samba-4.7.10/docs/manpages/idmap_ad.8
--- samba-4.7.9/docs/manpages/idmap_ad.8	2018-08-11 22:04:03.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_ad.8	2018-08-27 10:03:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_autorid.8 samba-4.7.10/docs/manpages/idmap_autorid.8
--- samba-4.7.9/docs/manpages/idmap_autorid.8	2018-08-11 22:04:04.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_autorid.8	2018-08-27 10:03:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_hash.8 samba-4.7.10/docs/manpages/idmap_hash.8
--- samba-4.7.9/docs/manpages/idmap_hash.8	2018-08-11 22:04:04.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_hash.8	2018-08-27 10:03:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_HASH" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_ldap.8 samba-4.7.10/docs/manpages/idmap_ldap.8
--- samba-4.7.9/docs/manpages/idmap_ldap.8	2018-08-11 22:04:04.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_ldap.8	2018-08-27 10:03:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_nss.8 samba-4.7.10/docs/manpages/idmap_nss.8
--- samba-4.7.9/docs/manpages/idmap_nss.8	2018-08-11 22:04:04.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_nss.8	2018-08-27 10:03:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_NSS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_rfc2307.8 samba-4.7.10/docs/manpages/idmap_rfc2307.8
--- samba-4.7.9/docs/manpages/idmap_rfc2307.8	2018-08-11 22:04:04.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_rfc2307.8	2018-08-27 10:03:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_rid.8 samba-4.7.10/docs/manpages/idmap_rid.8
--- samba-4.7.9/docs/manpages/idmap_rid.8	2018-08-11 22:04:05.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_rid.8	2018-08-27 10:03:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_RID" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_script.8 samba-4.7.10/docs/manpages/idmap_script.8
--- samba-4.7.9/docs/manpages/idmap_script.8	2018-08-11 22:04:05.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_script.8	2018-08-27 10:03:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_tdb.8 samba-4.7.10/docs/manpages/idmap_tdb.8
--- samba-4.7.9/docs/manpages/idmap_tdb.8	2018-08-11 22:04:05.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_tdb.8	2018-08-27 10:03:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/idmap_tdb2.8 samba-4.7.10/docs/manpages/idmap_tdb2.8
--- samba-4.7.9/docs/manpages/idmap_tdb2.8	2018-08-11 22:04:05.000000000 +0200
+++ samba-4.7.10/docs/manpages/idmap_tdb2.8	2018-08-27 10:03:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/libsmbclient.7 samba-4.7.10/docs/manpages/libsmbclient.7
--- samba-4.7.9/docs/manpages/libsmbclient.7	2018-08-11 22:04:06.000000000 +0200
+++ samba-4.7.10/docs/manpages/libsmbclient.7	2018-08-27 10:03:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "08/11/2018" "Samba 4\&.7" "7"
+.TH "LIBSMBCLIENT" "7" "08/27/2018" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/lmhosts.5 samba-4.7.10/docs/manpages/lmhosts.5
--- samba-4.7.9/docs/manpages/lmhosts.5	2018-08-11 22:04:06.000000000 +0200
+++ samba-4.7.10/docs/manpages/lmhosts.5	2018-08-27 10:03:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "08/11/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "08/27/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/log2pcap.1 samba-4.7.10/docs/manpages/log2pcap.1
--- samba-4.7.9/docs/manpages/log2pcap.1	2018-08-11 22:04:06.000000000 +0200
+++ samba-4.7.10/docs/manpages/log2pcap.1	2018-08-27 10:03:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "LOG2PCAP" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/mvxattr.1 samba-4.7.10/docs/manpages/mvxattr.1
--- samba-4.7.9/docs/manpages/mvxattr.1	2018-08-11 22:04:06.000000000 +0200
+++ samba-4.7.10/docs/manpages/mvxattr.1	2018-08-27 10:03:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "MVXATTR" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/net.8 samba-4.7.10/docs/manpages/net.8
--- samba-4.7.9/docs/manpages/net.8	2018-08-11 22:04:07.000000000 +0200
+++ samba-4.7.10/docs/manpages/net.8	2018-08-27 10:03:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NET" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "NET" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/nmbd.8 samba-4.7.10/docs/manpages/nmbd.8
--- samba-4.7.9/docs/manpages/nmbd.8	2018-08-11 22:04:07.000000000 +0200
+++ samba-4.7.10/docs/manpages/nmbd.8	2018-08-27 10:03:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "NMBD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/nmblookup.1 samba-4.7.10/docs/manpages/nmblookup.1
--- samba-4.7.9/docs/manpages/nmblookup.1	2018-08-11 22:04:07.000000000 +0200
+++ samba-4.7.10/docs/manpages/nmblookup.1	2018-08-27 10:03:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "NMBLOOKUP" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/ntlm_auth.1 samba-4.7.10/docs/manpages/ntlm_auth.1
--- samba-4.7.9/docs/manpages/ntlm_auth.1	2018-08-11 22:04:07.000000000 +0200
+++ samba-4.7.10/docs/manpages/ntlm_auth.1	2018-08-27 10:03:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "NTLM_AUTH" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/pam_winbind.8 samba-4.7.10/docs/manpages/pam_winbind.8
--- samba-4.7.9/docs/manpages/pam_winbind.8	2018-08-11 22:04:07.000000000 +0200
+++ samba-4.7.10/docs/manpages/pam_winbind.8	2018-08-27 10:03:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: 8
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "08/11/2018" "Samba 4\&.7" "8"
+.TH "PAM_WINBIND" "8" "08/27/2018" "Samba 4\&.7" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/pam_winbind.conf.5 samba-4.7.10/docs/manpages/pam_winbind.conf.5
--- samba-4.7.9/docs/manpages/pam_winbind.conf.5	2018-08-11 22:04:08.000000000 +0200
+++ samba-4.7.10/docs/manpages/pam_winbind.conf.5	2018-08-27 10:03:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: 5
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "08/11/2018" "Samba 4\&.7" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "08/27/2018" "Samba 4\&.7" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/pdbedit.8 samba-4.7.10/docs/manpages/pdbedit.8
--- samba-4.7.9/docs/manpages/pdbedit.8	2018-08-11 22:04:08.000000000 +0200
+++ samba-4.7.10/docs/manpages/pdbedit.8	2018-08-27 10:03:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "PDBEDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/profiles.1 samba-4.7.10/docs/manpages/profiles.1
--- samba-4.7.9/docs/manpages/profiles.1	2018-08-11 22:04:08.000000000 +0200
+++ samba-4.7.10/docs/manpages/profiles.1	2018-08-27 10:03:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "PROFILES" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/rpcclient.1 samba-4.7.10/docs/manpages/rpcclient.1
--- samba-4.7.9/docs/manpages/rpcclient.1	2018-08-11 22:04:08.000000000 +0200
+++ samba-4.7.10/docs/manpages/rpcclient.1	2018-08-27 10:03:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "RPCCLIENT" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/samba-regedit.8 samba-4.7.10/docs/manpages/samba-regedit.8
--- samba-4.7.9/docs/manpages/samba-regedit.8	2018-08-11 22:04:09.000000000 +0200
+++ samba-4.7.10/docs/manpages/samba-regedit.8	2018-08-27 10:03:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/samba-tool.8 samba-4.7.10/docs/manpages/samba-tool.8
--- samba-4.7.9/docs/manpages/samba-tool.8	2018-08-11 22:04:09.000000000 +0200
+++ samba-4.7.10/docs/manpages/samba-tool.8	2018-08-27 10:03:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/samba.7 samba-4.7.10/docs/manpages/samba.7
--- samba-4.7.9/docs/manpages/samba.7	2018-08-11 22:04:09.000000000 +0200
+++ samba-4.7.10/docs/manpages/samba.7	2018-08-27 10:03:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: Miscellanea
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "08/11/2018" "Samba 4\&.7" "Miscellanea"
+.TH "SAMBA" "7" "08/27/2018" "Samba 4\&.7" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/samba.8 samba-4.7.10/docs/manpages/samba.8
--- samba-4.7.9/docs/manpages/samba.8	2018-08-11 22:04:09.000000000 +0200
+++ samba-4.7.10/docs/manpages/samba.8	2018-08-27 10:03:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SAMBA" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/sharesec.1 samba-4.7.10/docs/manpages/sharesec.1
--- samba-4.7.9/docs/manpages/sharesec.1	2018-08-11 22:04:09.000000000 +0200
+++ samba-4.7.10/docs/manpages/sharesec.1	2018-08-27 10:03:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SHARESEC" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smb.conf.5 samba-4.7.10/docs/manpages/smb.conf.5
--- samba-4.7.9/docs/manpages/smb.conf.5	2018-08-11 22:04:11.000000000 +0200
+++ samba-4.7.10/docs/manpages/smb.conf.5	2018-08-27 10:03:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "08/11/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "08/27/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbcacls.1 samba-4.7.10/docs/manpages/smbcacls.1
--- samba-4.7.9/docs/manpages/smbcacls.1	2018-08-11 22:04:11.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbcacls.1	2018-08-27 10:03:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCACLS" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbclient.1 samba-4.7.10/docs/manpages/smbclient.1
--- samba-4.7.9/docs/manpages/smbclient.1	2018-08-11 22:04:11.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbclient.1	2018-08-27 10:03:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCLIENT" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbcontrol.1 samba-4.7.10/docs/manpages/smbcontrol.1
--- samba-4.7.9/docs/manpages/smbcontrol.1	2018-08-11 22:04:12.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbcontrol.1	2018-08-27 10:03:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCONTROL" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbcquotas.1 samba-4.7.10/docs/manpages/smbcquotas.1
--- samba-4.7.9/docs/manpages/smbcquotas.1	2018-08-11 22:04:12.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbcquotas.1	2018-08-27 10:03:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBCQUOTAS" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbd.8 samba-4.7.10/docs/manpages/smbd.8
--- samba-4.7.9/docs/manpages/smbd.8	2018-08-11 22:04:12.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbd.8	2018-08-27 10:03:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbget.1 samba-4.7.10/docs/manpages/smbget.1
--- samba-4.7.9/docs/manpages/smbget.1	2018-08-11 22:04:12.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbget.1	2018-08-27 10:03:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBGET" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbgetrc.5 samba-4.7.10/docs/manpages/smbgetrc.5
--- samba-4.7.9/docs/manpages/smbgetrc.5	2018-08-11 22:04:13.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbgetrc.5	2018-08-27 10:03:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "08/11/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "08/27/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbpasswd.5 samba-4.7.10/docs/manpages/smbpasswd.5
--- samba-4.7.9/docs/manpages/smbpasswd.5	2018-08-11 22:04:13.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbpasswd.5	2018-08-27 10:03:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: File Formats and Conventions
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "08/11/2018" "Samba 4\&.7" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "08/27/2018" "Samba 4\&.7" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbpasswd.8 samba-4.7.10/docs/manpages/smbpasswd.8
--- samba-4.7.9/docs/manpages/smbpasswd.8	2018-08-11 22:04:13.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbpasswd.8	2018-08-27 10:03:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBPASSWD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbspool.8 samba-4.7.10/docs/manpages/smbspool.8
--- samba-4.7.9/docs/manpages/smbspool.8	2018-08-11 22:04:13.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbspool.8	2018-08-27 10:03:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbspool_krb5_wrapper.8 samba-4.7.10/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.7.9/docs/manpages/smbspool_krb5_wrapper.8	2018-08-11 22:04:13.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbspool_krb5_wrapper.8	2018-08-27 10:03:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbstatus.1 samba-4.7.10/docs/manpages/smbstatus.1
--- samba-4.7.9/docs/manpages/smbstatus.1	2018-08-11 22:04:14.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbstatus.1	2018-08-27 10:03:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBSTATUS" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbtar.1 samba-4.7.10/docs/manpages/smbtar.1
--- samba-4.7.9/docs/manpages/smbtar.1	2018-08-11 22:04:14.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbtar.1	2018-08-27 10:03:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBTAR" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/smbtree.1 samba-4.7.10/docs/manpages/smbtree.1
--- samba-4.7.9/docs/manpages/smbtree.1	2018-08-11 22:04:14.000000000 +0200
+++ samba-4.7.10/docs/manpages/smbtree.1	2018-08-27 10:03:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "SMBTREE" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/testparm.1 samba-4.7.10/docs/manpages/testparm.1
--- samba-4.7.9/docs/manpages/testparm.1	2018-08-11 22:04:14.000000000 +0200
+++ samba-4.7.10/docs/manpages/testparm.1	2018-08-27 10:03:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "TESTPARM" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_acl_tdb.8 samba-4.7.10/docs/manpages/vfs_acl_tdb.8
--- samba-4.7.9/docs/manpages/vfs_acl_tdb.8	2018-08-11 22:04:14.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_acl_tdb.8	2018-08-27 10:03:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_acl_xattr.8 samba-4.7.10/docs/manpages/vfs_acl_xattr.8
--- samba-4.7.9/docs/manpages/vfs_acl_xattr.8	2018-08-11 22:04:15.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_acl_xattr.8	2018-08-27 10:03:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_aio_fork.8 samba-4.7.10/docs/manpages/vfs_aio_fork.8
--- samba-4.7.9/docs/manpages/vfs_aio_fork.8	2018-08-11 22:04:15.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_aio_fork.8	2018-08-27 10:03:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_aio_linux.8 samba-4.7.10/docs/manpages/vfs_aio_linux.8
--- samba-4.7.9/docs/manpages/vfs_aio_linux.8	2018-08-11 22:04:15.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_aio_linux.8	2018-08-27 10:03:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_linux
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_LINUX" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_LINUX" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_aio_pthread.8 samba-4.7.10/docs/manpages/vfs_aio_pthread.8
--- samba-4.7.9/docs/manpages/vfs_aio_pthread.8	2018-08-11 22:04:15.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_aio_pthread.8	2018-08-27 10:03:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_audit.8 samba-4.7.10/docs/manpages/vfs_audit.8
--- samba-4.7.9/docs/manpages/vfs_audit.8	2018-08-11 22:04:16.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_audit.8	2018-08-27 10:03:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_AUDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_btrfs.8 samba-4.7.10/docs/manpages/vfs_btrfs.8
--- samba-4.7.9/docs/manpages/vfs_btrfs.8	2018-08-11 22:04:16.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_btrfs.8	2018-08-27 10:03:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_BTRFS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_cacheprime.8 samba-4.7.10/docs/manpages/vfs_cacheprime.8
--- samba-4.7.9/docs/manpages/vfs_cacheprime.8	2018-08-11 22:04:16.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_cacheprime.8	2018-08-27 10:03:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_cap.8 samba-4.7.10/docs/manpages/vfs_cap.8
--- samba-4.7.9/docs/manpages/vfs_cap.8	2018-08-11 22:04:16.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_cap.8	2018-08-27 10:03:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CAP" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_catia.8 samba-4.7.10/docs/manpages/vfs_catia.8
--- samba-4.7.9/docs/manpages/vfs_catia.8	2018-08-11 22:04:16.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_catia.8	2018-08-27 10:03:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CATIA" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_ceph.8 samba-4.7.10/docs/manpages/vfs_ceph.8
--- samba-4.7.9/docs/manpages/vfs_ceph.8	2018-08-11 22:04:17.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_ceph.8	2018-08-27 10:03:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CEPH" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -58,11 +58,25 @@ requires that the underlying share path
 .nf
 		\fI[share]\fR
 		\m[blue]\fBvfs objects = ceph\fR\m[]
+		\m[blue]\fBpath = /non\-mounted/cephfs/path\fR\m[]
+		\m[blue]\fBkernel share modes = no\fR\m[]
 	
 .fi
 .if n \{\
 .RE
 .\}
+.PP
+Since
+vfs_ceph
+does not require a filesystem mount, the share
+path
+is treated differently: it is interpreted as an absolute path within the Ceph filesystem on the attached Ceph cluster\&. In a ctdb cluster environment where ctdb manages Samba,
+CTDB_SAMBA_SKIP_SHARE_CHECK=yes
+must be configured to disable local share path checks, otherwise ctdb will not reach a healthy state\&.
+.PP
+Note that currently
+kernel share modes
+have to be disabled in a share running with the CephFS vfs module for file serving to work properly\&.
 .SH "OPTIONS"
 .PP
 ceph:config_file = path
diff -Npur samba-4.7.9/docs/manpages/vfs_commit.8 samba-4.7.10/docs/manpages/vfs_commit.8
--- samba-4.7.9/docs/manpages/vfs_commit.8	2018-08-11 22:04:17.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_commit.8	2018-08-27 10:04:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_COMMIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_crossrename.8 samba-4.7.10/docs/manpages/vfs_crossrename.8
--- samba-4.7.9/docs/manpages/vfs_crossrename.8	2018-08-11 22:04:17.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_crossrename.8	2018-08-27 10:04:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_default_quota.8 samba-4.7.10/docs/manpages/vfs_default_quota.8
--- samba-4.7.9/docs/manpages/vfs_default_quota.8	2018-08-11 22:04:17.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_default_quota.8	2018-08-27 10:04:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_dirsort.8 samba-4.7.10/docs/manpages/vfs_dirsort.8
--- samba-4.7.9/docs/manpages/vfs_dirsort.8	2018-08-11 22:04:17.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_dirsort.8	2018-08-27 10:04:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_extd_audit.8 samba-4.7.10/docs/manpages/vfs_extd_audit.8
--- samba-4.7.9/docs/manpages/vfs_extd_audit.8	2018-08-11 22:04:18.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_extd_audit.8	2018-08-27 10:04:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_fake_perms.8 samba-4.7.10/docs/manpages/vfs_fake_perms.8
--- samba-4.7.9/docs/manpages/vfs_fake_perms.8	2018-08-11 22:04:18.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_fake_perms.8	2018-08-27 10:04:01.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_fileid.8 samba-4.7.10/docs/manpages/vfs_fileid.8
--- samba-4.7.9/docs/manpages/vfs_fileid.8	2018-08-11 22:04:18.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_fileid.8	2018-08-27 10:04:01.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FILEID" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_fruit.8 samba-4.7.10/docs/manpages/vfs_fruit.8
--- samba-4.7.9/docs/manpages/vfs_fruit.8	2018-08-11 22:04:18.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_fruit.8	2018-08-27 10:04:01.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FRUIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_full_audit.8 samba-4.7.10/docs/manpages/vfs_full_audit.8
--- samba-4.7.9/docs/manpages/vfs_full_audit.8	2018-08-11 22:04:19.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_full_audit.8	2018-08-27 10:04:01.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_glusterfs.8 samba-4.7.10/docs/manpages/vfs_glusterfs.8
--- samba-4.7.9/docs/manpages/vfs_glusterfs.8	2018-08-11 22:04:19.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_glusterfs.8	2018-08-27 10:04:02.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_gpfs.8 samba-4.7.10/docs/manpages/vfs_gpfs.8
--- samba-4.7.9/docs/manpages/vfs_gpfs.8	2018-08-11 22:04:19.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_gpfs.8	2018-08-27 10:04:02.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_GPFS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.7.10/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.7.9/docs/manpages/vfs_linux_xfs_sgid.8	2018-08-11 22:04:19.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_linux_xfs_sgid.8	2018-08-27 10:04:02.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_media_harmony.8 samba-4.7.10/docs/manpages/vfs_media_harmony.8
--- samba-4.7.9/docs/manpages/vfs_media_harmony.8	2018-08-11 22:04:19.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_media_harmony.8	2018-08-27 10:04:02.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_netatalk.8 samba-4.7.10/docs/manpages/vfs_netatalk.8
--- samba-4.7.9/docs/manpages/vfs_netatalk.8	2018-08-11 22:04:20.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_netatalk.8	2018-08-27 10:04:02.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_NETATALK" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_offline.8 samba-4.7.10/docs/manpages/vfs_offline.8
--- samba-4.7.9/docs/manpages/vfs_offline.8	2018-08-11 22:04:20.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_offline.8	2018-08-27 10:04:03.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_prealloc.8 samba-4.7.10/docs/manpages/vfs_prealloc.8
--- samba-4.7.9/docs/manpages/vfs_prealloc.8	2018-08-11 22:04:20.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_prealloc.8	2018-08-27 10:04:03.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_preopen.8 samba-4.7.10/docs/manpages/vfs_preopen.8
--- samba-4.7.9/docs/manpages/vfs_preopen.8	2018-08-11 22:04:20.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_preopen.8	2018-08-27 10:04:03.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_readahead.8 samba-4.7.10/docs/manpages/vfs_readahead.8
--- samba-4.7.9/docs/manpages/vfs_readahead.8	2018-08-11 22:04:20.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_readahead.8	2018-08-27 10:04:03.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_readonly.8 samba-4.7.10/docs/manpages/vfs_readonly.8
--- samba-4.7.9/docs/manpages/vfs_readonly.8	2018-08-11 22:04:21.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_readonly.8	2018-08-27 10:04:03.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_READONLY" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_recycle.8 samba-4.7.10/docs/manpages/vfs_recycle.8
--- samba-4.7.9/docs/manpages/vfs_recycle.8	2018-08-11 22:04:21.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_recycle.8	2018-08-27 10:04:04.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_shadow_copy.8 samba-4.7.10/docs/manpages/vfs_shadow_copy.8
--- samba-4.7.9/docs/manpages/vfs_shadow_copy.8	2018-08-11 22:04:21.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_shadow_copy.8	2018-08-27 10:04:04.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_shadow_copy2.8 samba-4.7.10/docs/manpages/vfs_shadow_copy2.8
--- samba-4.7.9/docs/manpages/vfs_shadow_copy2.8	2018-08-11 22:04:21.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_shadow_copy2.8	2018-08-27 10:04:04.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_shell_snap.8 samba-4.7.10/docs/manpages/vfs_shell_snap.8
--- samba-4.7.9/docs/manpages/vfs_shell_snap.8	2018-08-11 22:04:21.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_shell_snap.8	2018-08-27 10:04:04.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_snapper.8 samba-4.7.10/docs/manpages/vfs_snapper.8
--- samba-4.7.9/docs/manpages/vfs_snapper.8	2018-08-11 22:04:22.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_snapper.8	2018-08-27 10:04:04.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_streams_depot.8 samba-4.7.10/docs/manpages/vfs_streams_depot.8
--- samba-4.7.9/docs/manpages/vfs_streams_depot.8	2018-08-11 22:04:22.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_streams_depot.8	2018-08-27 10:04:05.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_streams_xattr.8 samba-4.7.10/docs/manpages/vfs_streams_xattr.8
--- samba-4.7.9/docs/manpages/vfs_streams_xattr.8	2018-08-11 22:04:22.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_streams_xattr.8	2018-08-27 10:04:05.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_syncops.8 samba-4.7.10/docs/manpages/vfs_syncops.8
--- samba-4.7.9/docs/manpages/vfs_syncops.8	2018-08-11 22:04:22.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_syncops.8	2018-08-27 10:04:05.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_time_audit.8 samba-4.7.10/docs/manpages/vfs_time_audit.8
--- samba-4.7.9/docs/manpages/vfs_time_audit.8	2018-08-11 22:04:23.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_time_audit.8	2018-08-27 10:04:05.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_tsmsm.8 samba-4.7.10/docs/manpages/vfs_tsmsm.8
--- samba-4.7.9/docs/manpages/vfs_tsmsm.8	2018-08-11 22:04:23.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_tsmsm.8	2018-08-27 10:04:05.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_TSMSM" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_unityed_media.8 samba-4.7.10/docs/manpages/vfs_unityed_media.8
--- samba-4.7.9/docs/manpages/vfs_unityed_media.8	2018-08-11 22:04:23.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_unityed_media.8	2018-08-27 10:04:06.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_worm.8 samba-4.7.10/docs/manpages/vfs_worm.8
--- samba-4.7.9/docs/manpages/vfs_worm.8	2018-08-11 22:04:23.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_worm.8	2018-08-27 10:04:06.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_WORM" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_xattr_tdb.8 samba-4.7.10/docs/manpages/vfs_xattr_tdb.8
--- samba-4.7.9/docs/manpages/vfs_xattr_tdb.8	2018-08-11 22:04:23.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_xattr_tdb.8	2018-08-27 10:04:06.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfs_zfsacl.8 samba-4.7.10/docs/manpages/vfs_zfsacl.8
--- samba-4.7.9/docs/manpages/vfs_zfsacl.8	2018-08-11 22:04:24.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfs_zfsacl.8	2018-08-27 10:04:06.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/vfstest.1 samba-4.7.10/docs/manpages/vfstest.1
--- samba-4.7.9/docs/manpages/vfstest.1	2018-08-11 22:04:24.000000000 +0200
+++ samba-4.7.10/docs/manpages/vfstest.1	2018-08-27 10:04:07.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "VFSTEST" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/wbinfo.1 samba-4.7.10/docs/manpages/wbinfo.1
--- samba-4.7.9/docs/manpages/wbinfo.1	2018-08-11 22:04:24.000000000 +0200
+++ samba-4.7.10/docs/manpages/wbinfo.1	2018-08-27 10:04:07.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: User Commands
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "08/11/2018" "Samba 4\&.7" "User Commands"
+.TH "WBINFO" "1" "08/27/2018" "Samba 4\&.7" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/winbind_krb5_locator.7 samba-4.7.10/docs/manpages/winbind_krb5_locator.7
--- samba-4.7.9/docs/manpages/winbind_krb5_locator.7	2018-08-11 22:04:24.000000000 +0200
+++ samba-4.7.10/docs/manpages/winbind_krb5_locator.7	2018-08-27 10:04:07.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_locator
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: 7
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCATOR" "7" "08/11/2018" "Samba 4\&.7" "7"
+.TH "WINBIND_KRB5_LOCATOR" "7" "08/27/2018" "Samba 4\&.7" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs/manpages/winbindd.8 samba-4.7.10/docs/manpages/winbindd.8
--- samba-4.7.9/docs/manpages/winbindd.8	2018-08-11 22:04:24.000000000 +0200
+++ samba-4.7.10/docs/manpages/winbindd.8	2018-08-27 10:04:07.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/27/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.7
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "08/11/2018" "Samba 4\&.7" "System Administration tools"
+.TH "WINBINDD" "8" "08/27/2018" "Samba 4\&.7" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.7.9/docs-xml/manpages/vfs_ceph.8.xml samba-4.7.10/docs-xml/manpages/vfs_ceph.8.xml
--- samba-4.7.9/docs-xml/manpages/vfs_ceph.8.xml	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/docs-xml/manpages/vfs_ceph.8.xml	2018-08-27 09:54:35.000000000 +0200
@@ -62,7 +62,26 @@
 	<programlisting>
 		<smbconfsection name="[share]"/>
 		<smbconfoption name="vfs objects">ceph</smbconfoption>
+		<smbconfoption name="path">/non-mounted/cephfs/path</smbconfoption>
+		<smbconfoption name="kernel share modes">no</smbconfoption>
 	</programlisting>
+
+	<para>
+		Since <command>vfs_ceph</command> does not require a filesystem
+		mount, the share <command>path</command> is treated differently:
+		it is interpreted as an absolute path within the Ceph filesystem
+		on the attached Ceph cluster.
+		In a ctdb cluster environment where ctdb manages Samba,
+		<command>CTDB_SAMBA_SKIP_SHARE_CHECK=yes</command> must be
+		configured to disable local share path checks, otherwise ctdb
+		will not reach a healthy state.
+	</para>
+
+	<para>
+		Note that currently <command>kernel share modes</command> have
+		to be disabled in a share running with the CephFS vfs module for
+		file serving to work properly.
+	</para>
 </refsect1>
 
 <refsect1>
diff -Npur samba-4.7.9/lib/krb5_wrap/krb5_samba.c samba-4.7.10/lib/krb5_wrap/krb5_samba.c
--- samba-4.7.9/lib/krb5_wrap/krb5_samba.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/lib/krb5_wrap/krb5_samba.c	2018-08-27 09:54:35.000000000 +0200
@@ -1549,7 +1549,7 @@ krb5_error_code smb_krb5_kt_seek_and_del
 		}
 
 		if (!flush &&
-		    (kt_entry.vno == kvno) &&
+		    ((kt_entry.vno & 0xff) == (kvno & 0xff)) &&
 		    (kt_entry_enctype != enctype))
 		{
 			DEBUG(5, (__location__ ": Saving entry with kvno [%d] "
diff -Npur samba-4.7.9/lib/ldb/wscript samba-4.7.10/lib/ldb/wscript
--- samba-4.7.9/lib/ldb/wscript	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/lib/ldb/wscript	2018-08-27 09:54:35.000000000 +0200
@@ -62,23 +62,33 @@ def configure(conf):
     conf.env.standalone_ldb = conf.IN_LAUNCH_DIR()
 
     if not conf.env.standalone_ldb:
+        max_ldb_version = [int(x) for x in VERSION.split(".")]
+        max_ldb_version[2] = 999
+        max_ldb_version_dots = "%d.%d.%d" % tuple(max_ldb_version)
+
         if conf.env.disable_python:
-            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb', minversion=VERSION,
-                                         onlyif='talloc tdb tevent',
-                                         implied_deps='replace talloc tdb tevent'):
+            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb',
+                                             minversion=VERSION,
+                                             maxversion=max_ldb_version_dots,
+                                             onlyif='talloc tdb tevent',
+                                             implied_deps='replace talloc tdb tevent'):
                 conf.define('USING_SYSTEM_LDB', 1)
         else:
             using_system_pyldb_util = True
-            if not conf.CHECK_BUNDLED_SYSTEM_PKG('pyldb-util', minversion=VERSION,
-                                             onlyif='talloc tdb tevent',
-                                             implied_deps='replace talloc tdb tevent ldb'):
+            if not conf.CHECK_BUNDLED_SYSTEM_PKG('pyldb-util',
+                                                 minversion=VERSION,
+                                                 maxversion=max_ldb_version_dots,
+                                                 onlyif='talloc tdb tevent',
+                                                 implied_deps='replace talloc tdb tevent ldb'):
                 using_system_pyldb_util = False
 
             # We need to get a pyldb-util for all the python versions
             # we are building for
             if conf.env['EXTRA_PYTHON']:
                 name = 'pyldb-util' + conf.all_envs['extrapython']['PYTHON_SO_ABI_FLAG']
-                if not conf.CHECK_BUNDLED_SYSTEM_PKG(name, minversion=VERSION,
+                if not conf.CHECK_BUNDLED_SYSTEM_PKG(name,
+                                                     minversion=VERSION,
+                                                     maxversion=max_ldb_version_dots,
                                                      onlyif='talloc tdb tevent',
                                                      implied_deps='replace talloc tdb tevent ldb'):
                     using_system_pyldb_util = False
@@ -86,9 +96,11 @@ def configure(conf):
             if using_system_pyldb_util:
                 conf.define('USING_SYSTEM_PYLDB_UTIL', 1)
 
-            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb', minversion=VERSION,
-                                         onlyif='talloc tdb tevent pyldb-util',
-                                         implied_deps='replace talloc tdb tevent'):
+            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb',
+                                             minversion=VERSION,
+                                             maxversion=max_ldb_version_dots,
+                                             onlyif='talloc tdb tevent pyldb-util',
+                                             implied_deps='replace talloc tdb tevent'):
                 conf.define('USING_SYSTEM_LDB', 1)
 
     if conf.CONFIG_SET('USING_SYSTEM_LDB'):
diff -Npur samba-4.7.9/lib/socket_wrapper/wscript samba-4.7.10/lib/socket_wrapper/wscript
--- samba-4.7.9/lib/socket_wrapper/wscript	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/lib/socket_wrapper/wscript	2018-08-27 09:54:35.000000000 +0200
@@ -109,6 +109,6 @@ def build(bld):
         # breaks preloading!
         bld.SAMBA_LIBRARY('socket_wrapper',
                           source='socket_wrapper.c',
-                          deps='dl',
+                          deps='dl tirpc',
                           install=False,
                           realname='libsocket-wrapper.so')
diff -Npur samba-4.7.9/lib/util/smb_threads.h samba-4.7.10/lib/util/smb_threads.h
--- samba-4.7.9/lib/util/smb_threads.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/lib/util/smb_threads.h	2018-08-27 09:54:35.000000000 +0200
@@ -119,6 +119,9 @@ static int smb_set_tls_pthread(void *pke
  \
 static void *smb_get_tls_pthread(void *pkey, const char *location) \
 { \
+	if (pkey == NULL) { \
+		return NULL; \
+	} \
         return pthread_getspecific(*(pthread_key_t *)pkey); \
 } \
  \
diff -Npur samba-4.7.9/lib/util/tests/tfork.c samba-4.7.10/lib/util/tests/tfork.c
--- samba-4.7.9/lib/util/tests/tfork.c	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/lib/util/tests/tfork.c	2018-08-27 09:54:35.000000000 +0200
@@ -417,8 +417,7 @@ static void *tfork_thread(void *p)
 	struct tfork *t = NULL;
 	int status;
 	pid_t child;
-	pthread_t *ptid = (pthread_t *)p;
-	uint64_t tid;
+	uint64_t tid = (uint64_t)pthread_self();
 	uint64_t *result = NULL;
 	int up[2];
 	ssize_t nread;
@@ -429,8 +428,6 @@ static void *tfork_thread(void *p)
 		pthread_exit(NULL);
 	}
 
-	tid = (uint64_t)*ptid;
-
 	t = tfork_create();
 	if (t == NULL) {
 		pthread_exit(NULL);
@@ -480,7 +477,7 @@ static bool test_tfork_threads(struct to
 #endif
 
 	for (i = 0; i < num_threads; i++) {
-		ret = pthread_create(&threads[i], NULL, tfork_thread, &threads[i]);
+		ret = pthread_create(&threads[i], NULL, tfork_thread, NULL);
 		torture_assert_goto(tctx, ret == 0, ok, done,
 				    "pthread_create failed\n");
 	}
diff -Npur samba-4.7.9/librpc/rpc/binding.c samba-4.7.10/librpc/rpc/binding.c
--- samba-4.7.9/librpc/rpc/binding.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/librpc/rpc/binding.c	2018-08-27 09:54:35.000000000 +0200
@@ -103,6 +103,7 @@ static const struct ncacn_option {
 	{"print", DCERPC_DEBUG_PRINT_BOTH},
 	{"padcheck", DCERPC_DEBUG_PAD_CHECK},
 	{"bigendian", DCERPC_PUSH_BIGENDIAN},
+	{"smb1", DCERPC_SMB1},
 	{"smb2", DCERPC_SMB2},
 	{"ndr64", DCERPC_NDR64},
 	{"packet", DCERPC_PACKET},
diff -Npur samba-4.7.9/librpc/rpc/rpc_common.h samba-4.7.10/librpc/rpc/rpc_common.h
--- samba-4.7.9/librpc/rpc/rpc_common.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/librpc/rpc/rpc_common.h	2018-08-27 09:54:35.000000000 +0200
@@ -108,6 +108,8 @@ struct dcerpc_binding;
 
 #define DCERPC_PACKET			(1<<26)
 
+#define DCERPC_SMB1                    (1<<27)
+
 /* The following definitions come from ../librpc/rpc/dcerpc_error.c  */
 
 const char *dcerpc_errstr(TALLOC_CTX *mem_ctx, uint32_t fault_code);
diff -Npur samba-4.7.9/python/samba/netcmd/domain.py samba-4.7.10/python/samba/netcmd/domain.py
--- samba-4.7.9/python/samba/netcmd/domain.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/python/samba/netcmd/domain.py	2018-08-27 09:54:35.000000000 +0200
@@ -1774,6 +1774,15 @@ class DomainTrustCommand(Command):
 
         return (policy, info)
 
+    def get_netlogon_dc_unc(self, conn, server, domain):
+        try:
+            info = conn.netr_DsRGetDCNameEx2(server,
+                                             None, 0, None, None, None,
+                                             netlogon.DS_RETURN_DNS_NAME)
+            return info.dc_unc
+        except RuntimeError:
+            return conn.netr_GetDcName(server, domain)
+
     def get_netlogon_dc_info(self, conn, server):
         info = conn.netr_DsRGetDCNameEx2(server,
                                          None, 0, None, None, None,
@@ -2408,7 +2417,8 @@ class cmd_domain_trust_create(DomainTrus
                 raise self.RemoteRuntimeError(self, error, "failed to connect netlogon server")
 
             try:
-                remote_netlogon_info = self.get_netlogon_dc_info(remote_netlogon, remote_server)
+                remote_netlogon_dc_unc = self.get_netlogon_dc_unc(remote_netlogon,
+                                                                  remote_server, domain)
             except RuntimeError as error:
                 raise self.RemoteRuntimeError(self, error, "failed to get netlogon dc info")
 
@@ -2558,9 +2568,9 @@ class cmd_domain_trust_create(DomainTrus
                         # this triggers netr_GetForestTrustInformation to our domain.
                         # and lsaRSetForestTrustInformation() remotely, but new top level
                         # names are disabled by default.
-                        remote_forest_info = remote_netlogon.netr_DsRGetForestTrustInformation(remote_netlogon_info.dc_unc,
-                                                                      local_lsa_info.dns_domain.string,
-                                                                      netlogon.DS_GFTI_UPDATE_TDO)
+                        remote_forest_info = remote_netlogon.netr_DsRGetForestTrustInformation(remote_netlogon_dc_unc,
+                                                                                               local_lsa_info.dns_domain.string,
+                                                                                               netlogon.DS_GFTI_UPDATE_TDO)
                     except RuntimeError as error:
                         raise self.RemoteRuntimeError(self, error, "netr_DsRGetForestTrustInformation() failed")
 
@@ -2611,10 +2621,10 @@ class cmd_domain_trust_create(DomainTrus
                 if remote_trust_info.trust_direction & lsa.LSA_TRUST_DIRECTION_OUTBOUND:
                     self.outf.write("Validating incoming trust...\n")
                     try:
-                        remote_trust_verify = remote_netlogon.netr_LogonControl2Ex(remote_netlogon_info.dc_unc,
-                                                                      netlogon.NETLOGON_CONTROL_TC_VERIFY,
-                                                                      2,
-                                                                      local_lsa_info.dns_domain.string)
+                        remote_trust_verify = remote_netlogon.netr_LogonControl2Ex(remote_netlogon_dc_unc,
+                                                                                   netlogon.NETLOGON_CONTROL_TC_VERIFY,
+                                                                                   2,
+                                                                                   local_lsa_info.dns_domain.string)
                     except RuntimeError as error:
                         raise self.RemoteRuntimeError(self, error, "NETLOGON_CONTROL_TC_VERIFY failed")
 
diff -Npur samba-4.7.9/python/samba/tests/auth_log.py samba-4.7.10/python/samba/tests/auth_log.py
--- samba-4.7.9/python/samba/tests/auth_log.py	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.10/python/samba/tests/auth_log.py	2018-08-27 09:54:35.000000000 +0200
@@ -33,6 +33,7 @@ from samba.credentials import Credential
 from samba import NTSTATUSError
 from subprocess import call
 from ldb import LdbError
+import re
 
 class AuthLogTests(samba.tests.auth_log_base.AuthLogTestBase):
 
@@ -71,6 +72,20 @@ class AuthLogTests(samba.tests.auth_log_
         messages = self.waitForMessages(isLastExpectedMessage, x)
         checkFunction(messages, authTypes, service, binding, protection)
 
+    def _assert_ncacn_np_serviceDescription(self, binding, serviceDescription):
+        # Turn "[foo,bar]" into a list ("foo", "bar") to test
+        # lambda x: x removes anything that evaluates to False,
+        # including empty strings, so we handle "" as well
+        binding_list = filter(lambda x: x, re.compile('[\[,\]]').split(binding))
+
+        # Handle explicit smb2, smb1 or auto negotiation
+        if "smb2" in binding_list:
+            self.assertEquals(serviceDescription, "SMB2")
+        elif "smb1" in binding_list:
+            self.assertEquals(serviceDescription, "SMB")
+        else:
+            self.assertIn(serviceDescription, ["SMB", "SMB2"])
+
     def rpc_ncacn_np_ntlm_check(self, messages, authTypes, service,
                                 binding, protection):
 
@@ -83,14 +98,14 @@ class AuthLogTests(samba.tests.auth_log_
         msg = messages[0]
         self.assertEquals("Authentication", msg["type"])
         self.assertEquals("NT_STATUS_OK", msg["Authentication"]["status"])
-        self.assertEquals("SMB",
-                           msg["Authentication"]["serviceDescription"])
+        self._assert_ncacn_np_serviceDescription(binding,
+                          msg["Authentication"]["serviceDescription"])
         self.assertEquals(authTypes[1], msg["Authentication"]["authDescription"])
 
         # Check the second message it should be an Authorization
         msg = messages[1]
         self.assertEquals("Authorization", msg["type"])
-        self.assertEquals("SMB",
+        self._assert_ncacn_np_serviceDescription(binding,
                           msg["Authorization"]["serviceDescription"])
         self.assertEquals(authTypes[2], msg["Authorization"]["authType"])
         self.assertEquals("SMB", msg["Authorization"]["transportProtection"])
@@ -139,12 +154,7 @@ class AuthLogTests(samba.tests.auth_log_
         # Check the third message it should be an Authorization
         msg = messages[2]
         self.assertEquals("Authorization", msg["type"])
-        serviceDescription = "SMB"
-        print "binding %s" % binding
-        if binding == "[smb2]":
-            serviceDescription = "SMB2"
-
-        self.assertEquals(serviceDescription,
+        self._assert_ncacn_np_serviceDescription(binding,
                           msg["Authorization"]["serviceDescription"])
         self.assertEquals(authTypes[3], msg["Authorization"]["authType"])
         self.assertEquals("SMB", msg["Authorization"]["transportProtection"])
diff -Npur samba-4.7.9/python/samba/tests/dns_wildcard.py samba-4.7.10/python/samba/tests/dns_wildcard.py
--- samba-4.7.9/python/samba/tests/dns_wildcard.py	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/python/samba/tests/dns_wildcard.py	2018-08-27 09:54:35.000000000 +0200
@@ -172,6 +172,30 @@ class TestWildCardQueries(DNSTest):
         self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
         self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
 
+    def test_one_a_query_match_wildcard_2_labels(self):
+        """ Query an A record, should match the wild card entry
+            have two labels to the left of the wild card target.
+        """
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "label2.label1.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
+
     def test_one_a_query_wildcard_entry(self):
         "Query the wildcard entry"
 
@@ -228,6 +252,30 @@ class TestWildCardQueries(DNSTest):
         q = self.make_name_question(name,
                                     dns.DNS_QTYPE_A,
                                     dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, LEVEL2_WILDCARD_IP)
+
+    def test_one_a_query_match_wildcard_l2_2_labels(self):
+        """Query an A record, should match the level 2 wild card entry
+           have two labels to the left of the wild card target
+        """
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "label1.label2.level2.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
         questions.append(q)
 
         self.finish_name_packet(p, questions)
diff -Npur samba-4.7.9/python/samba/tests/net_join_no_spnego.py samba-4.7.10/python/samba/tests/net_join_no_spnego.py
--- samba-4.7.9/python/samba/tests/net_join_no_spnego.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/python/samba/tests/net_join_no_spnego.py	2018-08-27 09:54:35.000000000 +0200
@@ -42,6 +42,7 @@ class NetJoinNoSpnegoTests(samba.tests.T
         super(NetJoinNoSpnegoTests, self).tearDown()
 
     def test_net_join_no_spnego(self):
+        self.lp.set("client ipc max protocol", "NT1")
         self.lp.set("client use spnego", "no")
         netbios_name = "NetJoinNoSpnego"
         machinepass  = "abcdefghij"
@@ -65,6 +66,7 @@ class NetJoinNoSpnegoTests(samba.tests.T
         self.fail("Shoud have rejected NTLMv2 without SPNEGO")
 
     def test_net_join_no_spnego_ntlmv1(self):
+        self.lp.set("client ipc max protocol", "NT1")
         self.lp.set("client use spnego", "no")
         self.lp.set("client ntlmv2 auth", "no")
         netbios_name = "NetJoinNoSpnego"
diff -Npur samba-4.7.9/selftest/knownfail samba-4.7.10/selftest/knownfail
--- samba-4.7.9/selftest/knownfail	2018-08-11 21:56:43.000000000 +0200
+++ samba-4.7.10/selftest/knownfail	2018-08-27 09:54:35.000000000 +0200
@@ -167,6 +167,9 @@
 ^samba3.smb2.streams.rename
 ^samba3.smb2.streams.rename2
 ^samba3.smb2.streams.attributes
+^samba3.smb2.streams streams_xattr.rename\(nt4_dc\)
+^samba3.smb2.streams streams_xattr.rename2\(nt4_dc\)
+^samba3.smb2.streams streams_xattr.attributes\(nt4_dc\)
 ^samba3.smb2.getinfo.complex
 ^samba3.smb2.getinfo.fsinfo # quotas don't work yet
 ^samba3.smb2.setinfo.setinfo
diff -Npur samba-4.7.9/selftest/subunithelper.py samba-4.7.10/selftest/subunithelper.py
--- samba-4.7.9/selftest/subunithelper.py	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/selftest/subunithelper.py	2018-08-27 09:54:35.000000000 +0200
@@ -82,7 +82,8 @@ def parse_results(msg_ops, statistics, f
                     if l == "":
                         break
                     msg_ops.control_msg(l)
-                    if l == "]\n":
+                    if l[-2:] == "]\n":
+                        reason += l[:-2]
                         terminated = True
                         break
                     else:
diff -Npur samba-4.7.9/selftest/target/Samba3.pm samba-4.7.10/selftest/target/Samba3.pm
--- samba-4.7.9/selftest/target/Samba3.pm	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/selftest/target/Samba3.pm	2018-08-27 09:54:35.000000000 +0200
@@ -700,14 +700,10 @@ sub setup_simpleserver($$)
 	my $simpleserver_options = "
 	lanman auth = yes
 	ntlm auth = yes
-	vfs objects = xattr_tdb streams_depot time_audit full_audit
+	vfs objects = xattr_tdb streams_depot
 	change notify = no
 	smb encrypt = off
 
-	full_audit:syslog = no
-	full_audit:success = none
-	full_audit:failure = none
-
 [vfs_aio_fork]
 	path = $prefix_abs/share
         vfs objects = aio_fork
@@ -1641,7 +1637,11 @@ sub provision($$$$$$$$$)
 	dos filemode = yes
 	strict rename = yes
 	strict sync = yes
-	vfs objects = acl_xattr fake_acls xattr_tdb streams_depot
+	vfs objects = acl_xattr fake_acls xattr_tdb streams_depot time_audit full_audit
+
+	full_audit:syslog = no
+	full_audit:success = none
+	full_audit:failure = none
 
 	printing = vlp
 	print command = $bindir_abs/vlp tdbfile=$lockdir/vlp.tdb print %p %s
diff -Npur samba-4.7.9/source3/include/smb.h samba-4.7.10/source3/include/smb.h
--- samba-4.7.9/source3/include/smb.h	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/include/smb.h	2018-08-27 09:54:35.000000000 +0200
@@ -420,6 +420,9 @@ Offset  Data			length.
 /* Private options for printer support */
 #define NTCREATEX_OPTIONS_PRIVATE_DELETE_ON_CLOSE 0x0008
 
+/* Private option for streams support */
+#define NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN 0x0010
+
 /* Flag for NT transact rename call. */
 #define RENAME_REPLACE_IF_EXISTS 1
 
diff -Npur samba-4.7.9/source3/lib/g_lock.c samba-4.7.10/source3/lib/g_lock.c
--- samba-4.7.9/source3/lib/g_lock.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/source3/lib/g_lock.c	2018-08-27 09:54:35.000000000 +0200
@@ -329,6 +329,10 @@ static NTSTATUS g_lock_trylock(struct db
 			 * Delete stale conflicting entry
 			 */
 			locks[i] = locks[num_locks-1];
+			if (my_lock == num_locks-1) {
+				/* We just moved */
+				my_lock = i;
+			}
 			num_locks -= 1;
 			modified = true;
 			continue;
diff -Npur samba-4.7.9/source3/lib/ldap_escape.c samba-4.7.10/source3/lib/ldap_escape.c
--- samba-4.7.9/source3/lib/ldap_escape.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/lib/ldap_escape.c	2018-08-27 09:54:35.000000000 +0200
@@ -76,7 +76,7 @@ char *escape_ldap_string(TALLOC_CTX *mem
 			output = tmp;
 
 			p = &output[i];
-			strncpy (p, sub, 3);
+			memcpy(p, sub, 3);
 			p += 3;
 			i += 3;
 
diff -Npur samba-4.7.9/source3/lib/sendfile.c samba-4.7.10/source3/lib/sendfile.c
--- samba-4.7.9/source3/lib/sendfile.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/lib/sendfile.c	2018-08-27 09:54:35.000000000 +0200
@@ -24,6 +24,7 @@
  */
 
 #include "includes.h"
+#include "system/filesys.h"
 
 #if defined(LINUX_SENDFILE_API)
 
@@ -36,8 +37,10 @@
 ssize_t sys_sendfile(int tofd, int fromfd, const DATA_BLOB *header, off_t offset, size_t count)
 {
 	size_t total=0;
-	ssize_t ret;
+	ssize_t ret = -1;
 	size_t hdr_len = 0;
+	int old_flags = 0;
+	bool socket_flags_changed = false;
 
 	/*
 	 * Send the header first.
@@ -48,8 +51,25 @@ ssize_t sys_sendfile(int tofd, int fromf
 		hdr_len = header->length;
 		while (total < hdr_len) {
 			ret = sys_send(tofd, header->data + total,hdr_len - total, MSG_MORE);
-			if (ret == -1)
-				return -1;
+			if (ret == -1) {
+				if (errno == EAGAIN || errno == EWOULDBLOCK) {
+					/*
+					 * send() must complete before we can
+					 * send any other outgoing data on the
+					 * socket. Ensure socket is in blocking
+					 * mode. For SMB2 by default the socket
+					 * is in non-blocking mode.
+					 */
+					old_flags = fcntl(tofd, F_GETFL, 0);
+					ret = set_blocking(tofd, true);
+					if (ret == -1) {
+						goto out;
+					}
+					socket_flags_changed = true;
+					continue;
+				}
+				goto out;
+			}
 			total += ret;
 		}
 	}
@@ -59,8 +79,34 @@ ssize_t sys_sendfile(int tofd, int fromf
 		ssize_t nwritten;
 		do {
 			nwritten = sendfile(tofd, fromfd, &offset, total);
-		} while (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK));
+		} while (nwritten == -1 && errno == EINTR);
 		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				if (socket_flags_changed) {
+					/*
+					 * We're already in blocking
+					 * mode. This is an error.
+					 */
+					ret = -1;
+					goto out;
+				}
+
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+
 			if (errno == ENOSYS || errno == EINVAL) {
 				/* Ok - we're in a world of pain here. We just sent
 				 * the header, but the sendfile failed. We have to
@@ -72,17 +118,41 @@ ssize_t sys_sendfile(int tofd, int fromf
 				 */
 				errno = EINTR; /* Normally we can never return this. */
 			}
-			return -1;
+			ret = -1;
+			goto out;
 		}
 		if (nwritten == 0) {
 			/*
 			 * EOF, return a short read
 			 */
-			return hdr_len + (count - total);
+			ret = hdr_len + (count - total);
+			goto out;
 		}
 		total -= nwritten;
 	}
-	return count + hdr_len;
+
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(SOLARIS_SENDFILE_API)
@@ -99,6 +169,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 	size_t total, xferred;
 	struct sendfilevec vec[2];
 	ssize_t hdr_len = 0;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		sfvcnt = 2;
@@ -135,17 +208,37 @@ ssize_t sys_sendfile(int tofd, int fromf
 		xferred = 0;
 
 			nwritten = sendfilev(tofd, vec, sfvcnt, &xferred);
-		if  (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK)) {
+		if  (nwritten == -1 && errno == EINTR) {
 			if (xferred == 0)
 				continue; /* Nothing written yet. */
 			else
 				nwritten = xferred;
 		}
 
-		if (nwritten == -1)
-			return -1;
-		if (nwritten == 0)
-			return -1; /* I think we're at EOF here... */
+		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			ret = -1;
+			goto out;
+		}
+		if (nwritten == 0) {
+			ret = -1;
+			goto out; /* I think we're at EOF here... */
+		}
 
 		/*
 		 * If this was a short (signal interrupted) write we may need
@@ -167,7 +260,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		}
 		total -= nwritten;
 	}
-	return count + hdr_len;
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(HPUX_SENDFILE_API)
@@ -180,6 +294,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 	size_t total=0;
 	struct iovec hdtrl[2];
 	size_t hdr_len = 0;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		/* Set up the header/trailer iovec. */
@@ -205,11 +322,31 @@ ssize_t sys_sendfile(int tofd, int fromf
 
 		do {
 			nwritten = sendfile(tofd, fromfd, offset, total, &hdtrl[0], 0);
-		} while (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK));
-		if (nwritten == -1)
-			return -1;
-		if (nwritten == 0)
-			return -1; /* I think we're at EOF here... */
+		} while (nwritten == -1 && errno == EINTR);
+		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			ret = -1;
+			goto out;
+		}
+		if (nwritten == 0) {
+			ret = -1; /* I think we're at EOF here... */
+			goto out;
+		}
 
 		/*
 		 * If this was a short (signal interrupted) write we may need
@@ -233,7 +370,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		total -= nwritten;
 		offset += nwritten;
 	}
-	return count + hdr_len;
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(FREEBSD_SENDFILE_API) || defined(DARWIN_SENDFILE_API)
@@ -247,9 +405,11 @@ ssize_t sys_sendfile(int tofd, int fromf
 {
 	struct sf_hdtr	sf_header = {0};
 	struct iovec	io_header = {0};
+	int old_flags = 0;
 
 	off_t	nwritten;
-	int	ret;
+	ssize_t	ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		sf_header.headers = &io_header;
@@ -270,9 +430,26 @@ ssize_t sys_sendfile(int tofd, int fromf
 #else
 		ret = sendfile(fromfd, tofd, offset, count, &sf_header, &nwritten, 0);
 #endif
-		if (ret == -1 && errno != EINTR && errno != EAGAIN && errno != EWOULDBLOCK) {
+		if (ret == -1 && errno != EINTR) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
 			/* Send failed, we are toast. */
-			return -1;
+			ret = -1;
+			goto out;
 		}
 
 		if (nwritten == 0) {
@@ -299,7 +476,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		count -= nwritten;
 	}
 
-	return nwritten;
+	ret = nwritten;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(AIX_SENDFILE_API)
@@ -312,6 +510,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 ssize_t sys_sendfile(int tofd, int fromfd, const DATA_BLOB *header, off_t offset, size_t count)
 {
 	struct sf_parms hdtrl;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	/* Set up the header/trailer struct params. */
 	if (header) {
@@ -329,8 +530,6 @@ ssize_t sys_sendfile(int tofd, int fromf
 	hdtrl.file_bytes = count;
 
 	while ( hdtrl.file_bytes + hdtrl.header_length ) {
-		ssize_t ret;
-
 		/*
 		 Return Value
 
@@ -348,12 +547,50 @@ ssize_t sys_sendfile(int tofd, int fromf
 		*/
 		do {
 			ret = send_file(&tofd, &hdtrl, 0);
-		} while ((ret == 1) || (ret == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK)));
-		if ( ret == -1 )
+		} while ((ret == 1) || (ret == -1 && errno == EINTR));
+		if ( ret == -1 ) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			goto out;
+		}
+	}
+
+	ret = count + header->length;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
 			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
 	}
 
-	return count + header->length;
+	return ret;
 }
 /* END AIX SEND_FILE */
 
diff -Npur samba-4.7.9/source3/libnet/libnet_samsync_ldif.c samba-4.7.10/source3/libnet/libnet_samsync_ldif.c
--- samba-4.7.9/source3/libnet/libnet_samsync_ldif.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/libnet/libnet_samsync_ldif.c	2018-08-27 09:54:35.000000000 +0200
@@ -646,7 +646,8 @@ static NTSTATUS fetch_account_info_to_ld
 					   const char *suffix,
 					   int alloced)
 {
-	fstring username, logonscript, homedrive, homepath = "", homedir = "";
+	fstring username, logonscript, homedrive, homepath = "";
+	char homedir[262] = {0};
 	fstring hex_nt_passwd, hex_lm_passwd;
 	fstring description, profilepath, fullname, sambaSID;
 	char *flags, *user_rdn;
diff -Npur samba-4.7.9/source3/libsmb/clireadwrite.c samba-4.7.10/source3/libsmb/clireadwrite.c
--- samba-4.7.9/source3/libsmb/clireadwrite.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/libsmb/clireadwrite.c	2018-08-27 09:54:35.000000000 +0200
@@ -1459,10 +1459,13 @@ static NTSTATUS cli_splice_fallback(TALL
 	uint8_t *buf = talloc_size(frame, SPLICE_BLOCK_SIZE);
 	size_t nread;
 	off_t remaining = initial_size;
+	*written = 0;
 
 	while (remaining) {
+		size_t to_read = MIN(remaining, SPLICE_BLOCK_SIZE);
+
 		status = cli_read(srccli, src_fnum,
-				  (char *)buf, src_offset, SPLICE_BLOCK_SIZE,
+				  (char *)buf, src_offset, to_read,
 				  &nread);
 		if (!NT_STATUS_IS_OK(status)) {
 			return status;
@@ -1480,6 +1483,7 @@ static NTSTATUS cli_splice_fallback(TALL
 		}
 		src_offset += nread;
 		dst_offset += nread;
+		*written += nread;
 		if (remaining < nread) {
 			return NT_STATUS_INTERNAL_ERROR;
 		}
diff -Npur samba-4.7.9/source3/libsmb/libsmb_file.c samba-4.7.10/source3/libsmb/libsmb_file.c
--- samba-4.7.9/source3/libsmb/libsmb_file.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/libsmb/libsmb_file.c	2018-08-27 09:54:35.000000000 +0200
@@ -298,7 +298,7 @@ SMBC_splice_ctx(SMBCCTX *context,
                 int (*splice_cb)(off_t n, void *priv),
                 void *priv)
 {
-	off_t written;
+	off_t written = 0;
 	TALLOC_CTX *frame = talloc_stackframe();
 	NTSTATUS status;
 
diff -Npur samba-4.7.9/source3/locking/locking.c samba-4.7.10/source3/locking/locking.c
--- samba-4.7.9/source3/locking/locking.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.10/source3/locking/locking.c	2018-08-27 09:54:35.000000000 +0200
@@ -1318,3 +1318,34 @@ struct timespec get_share_mode_write_tim
 	}
 	return d->old_write_time;
 }
+
+bool file_has_open_streams(files_struct *fsp)
+{
+	struct share_mode_lock *lock = NULL;
+	struct share_mode_data *d = NULL;
+	uint32_t i;
+
+	lock = get_existing_share_mode_lock(talloc_tos(), fsp->file_id);
+	if (lock == NULL) {
+		return false;
+	}
+	d = lock->data;
+
+	for (i = 0; i < d->num_share_modes; i++) {
+		struct share_mode_entry *e = &d->share_modes[i];
+
+		if (share_mode_stale_pid(d, i)) {
+			continue;
+		}
+
+		if (e->private_options &
+		    NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN)
+		{
+			TALLOC_FREE(lock);
+			return true;
+		}
+	}
+
+	TALLOC_FREE(lock);
+	return false;
+}
diff -Npur samba-4.7.9/source3/locking/proto.h samba-4.7.10/source3/locking/proto.h
--- samba-4.7.9/source3/locking/proto.h	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.10/source3/locking/proto.h	2018-08-27 09:54:35.000000000 +0200
@@ -205,6 +205,7 @@ bool is_delete_on_close_set(struct share
 bool set_sticky_write_time(struct file_id fileid, struct timespec write_time);
 bool set_write_time(struct file_id fileid, struct timespec write_time);
 struct timespec get_share_mode_write_time(struct share_mode_lock *lck);
+bool file_has_open_streams(files_struct *fsp);
 int share_mode_forall(int (*fn)(struct file_id fid,
 				const struct share_mode_data *data,
 				void *private_data),
diff -Npur samba-4.7.9/source3/modules/vfs_ceph.c samba-4.7.10/source3/modules/vfs_ceph.c
--- samba-4.7.9/source3/modules/vfs_ceph.c	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/modules/vfs_ceph.c	2018-08-27 09:54:35.000000000 +0200
@@ -1261,12 +1261,11 @@ static bool cephwrap_lock(struct vfs_han
 static int cephwrap_kernel_flock(struct vfs_handle_struct *handle, files_struct *fsp,
 				uint32_t share_mode, uint32_t access_mask)
 {
-	DBG_DEBUG("[CEPH] kernel_flock\n");
-	/*
-	 * We must return zero here and pretend all is good.
-	 * One day we might have this in CEPH.
-	 */
-	return 0;
+	DBG_ERR("[CEPH] flock unsupported! Consider setting "
+		"\"kernel share modes = no\"\n");
+
+	errno = ENOSYS;
+	return -1;
 }
 
 static bool cephwrap_getlock(struct vfs_handle_struct *handle, files_struct *fsp, off_t *poffset, off_t *pcount, int *ptype, pid_t *ppid)
diff -Npur samba-4.7.9/source3/modules/vfs_fruit.c samba-4.7.10/source3/modules/vfs_fruit.c
--- samba-4.7.9/source3/modules/vfs_fruit.c	2018-04-17 09:35:02.000000000 +0200
+++ samba-4.7.10/source3/modules/vfs_fruit.c	2018-08-27 09:54:35.000000000 +0200
@@ -2372,7 +2372,6 @@ static NTSTATUS fruit_check_access(vfs_h
 				   uint32_t deny_mode)
 {
 	NTSTATUS status = NT_STATUS_OK;
-	struct byte_range_lock *br_lck = NULL;
 	bool open_for_reading, open_for_writing, deny_read, deny_write;
 	off_t off;
 	bool have_read = false;
@@ -2430,6 +2429,8 @@ static NTSTATUS fruit_check_access(vfs_h
 
 		/* Set locks */
 		if ((access_mask & FILE_READ_DATA) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = access_to_netatalk_brl(fork_type, FILE_READ_DATA);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2437,13 +2438,16 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status))  {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 
 		if ((deny_mode & DENY_READ) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = denymode_to_netatalk_brl(fork_type, DENY_READ);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2451,10 +2455,11 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 	}
 
@@ -2480,6 +2485,8 @@ static NTSTATUS fruit_check_access(vfs_h
 
 		/* Set locks */
 		if ((access_mask & FILE_WRITE_DATA) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = access_to_netatalk_brl(fork_type, FILE_WRITE_DATA);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2487,13 +2494,15 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
-
 		}
 		if ((deny_mode & DENY_WRITE) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = denymode_to_netatalk_brl(fork_type, DENY_WRITE);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2501,15 +2510,14 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 	}
 
-	TALLOC_FREE(br_lck);
-
 	return status;
 }
 
@@ -5506,6 +5514,9 @@ static int fruit_ftruncate(struct vfs_ha
 		  (intmax_t)offset);
 
 	if (fio == NULL) {
+		if (offset == 0 && global_fruit_config.nego_aapl) {
+			return SMB_VFS_NEXT_UNLINK(handle, fsp->fsp_name);
+		}
 		return SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset);
 	}
 
diff -Npur samba-4.7.9/source3/modules/vfs_time_audit.c samba-4.7.10/source3/modules/vfs_time_audit.c
--- samba-4.7.9/source3/modules/vfs_time_audit.c	2017-07-25 11:09:58.000000000 +0200
+++ samba-4.7.10/source3/modules/vfs_time_audit.c	2018-08-27 09:54:35.000000000 +0200
@@ -1946,13 +1946,12 @@ static NTSTATUS smb_time_audit_offload_r
 	struct tevent_req *req,
 	struct vfs_handle_struct *handle,
 	TALLOC_CTX *mem_ctx,
-	DATA_BLOB *_token_blob)
+	DATA_BLOB *token_blob)
 {
 	struct time_audit_offload_read_state *state = tevent_req_data(
 		req, struct time_audit_offload_read_state);
 	struct timespec ts_recv;
 	double timediff;
-	DATA_BLOB token_blob;
 	NTSTATUS status;
 
 	clock_gettime_mono(&ts_recv);
@@ -1966,13 +1965,8 @@ static NTSTATUS smb_time_audit_offload_r
 		return status;
 	}
 
-	token_blob = data_blob_talloc(mem_ctx,
-				      state->token_blob.data,
-				      state->token_blob.length);
-	if (token_blob.data == NULL) {
-		tevent_req_received(req);
-		return NT_STATUS_NO_MEMORY;
-	}
+	token_blob->length = state->token_blob.length;
+	token_blob->data = talloc_move(mem_ctx, &state->token_blob.data);
 
 	tevent_req_received(req);
 	return NT_STATUS_OK;
diff -Npur samba-4.7.9/source3/passdb/pdb_smbpasswd.c samba-4.7.10/source3/passdb/pdb_smbpasswd.c
--- samba-4.7.9/source3/passdb/pdb_smbpasswd.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/passdb/pdb_smbpasswd.c	2018-08-27 09:54:35.000000000 +0200
@@ -741,7 +741,7 @@ static bool mod_smbfilepwd_entry(struct
 	char linebuf[LINEBUF_SIZE + 1];
 	char readbuf[1024];
 	int c;
-	fstring ascii_p16;
+	char ascii_p16[FSTRING_LEN + 20];
 	fstring encode_bits;
 	unsigned char *p = NULL;
 	size_t linebuf_len = 0;
diff -Npur samba-4.7.9/source3/printing/printing.c samba-4.7.10/source3/printing/printing.c
--- samba-4.7.9/source3/printing/printing.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/printing/printing.c	2018-08-27 09:54:35.000000000 +0200
@@ -1694,7 +1694,7 @@ extern pid_t background_lpq_updater_pid;
 static void print_queue_update(struct messaging_context *msg_ctx,
 			       int snum, bool force)
 {
-	fstring key;
+	char key[268];
 	fstring sharename;
 	char *lpqcommand = NULL;
 	char *lprmcommand = NULL;
diff -Npur samba-4.7.9/source3/registry/reg_perfcount.c samba-4.7.10/source3/registry/reg_perfcount.c
--- samba-4.7.9/source3/registry/reg_perfcount.c	2017-07-04 12:05:25.000000000 +0200
+++ samba-4.7.10/source3/registry/reg_perfcount.c	2018-08-27 09:54:35.000000000 +0200
@@ -166,13 +166,12 @@ static uint32_t _reg_perfcount_multi_sz_
 					       uint32_t buffer_size)
 {
 	TDB_DATA kbuf, dbuf;
-	char temp[256];
+	char temp[PERFCOUNT_MAX_LEN] = {0};
 	char *buf1 = *retbuf;
 	uint32_t working_size = 0;
 	DATA_BLOB name_index, name;
 	bool ok;
 
-	memset(temp, 0, sizeof(temp));
 	snprintf(temp, sizeof(temp), "%d", keyval);
 	kbuf = string_tdb_data(temp);
 	dbuf = tdb_fetch(tdb, kbuf);
@@ -709,13 +708,13 @@ static bool _reg_perfcount_get_instance_
 					     TDB_CONTEXT *names)
 {
 	TDB_DATA key, data;
-	char buf[PERFCOUNT_MAX_LEN], temp[PERFCOUNT_MAX_LEN];
+	char buf[PERFCOUNT_MAX_LEN] = {0};
+	char temp[32] = {0};
 	smb_ucs2_t *name = NULL;
 	int pad;
 
 	/* First grab the instance data from the data file */
-	memset(temp, 0, PERFCOUNT_MAX_LEN);
-	snprintf(temp, PERFCOUNT_MAX_LEN, "i%d", instId);
+	snprintf(temp, sizeof(temp), "i%d", instId);
 	_reg_perfcount_make_key(&key, buf, PERFCOUNT_MAX_LEN, obj->ObjectNameTitleIndex, temp);
 	if (!_reg_perfcount_get_counter_data(key, &data)) {
 		DEBUG(3, ("_reg_perfcount_get_counter_data failed\n"));
@@ -739,8 +738,7 @@ static bool _reg_perfcount_get_instance_
 	SAFE_FREE(data.dptr);
 
 	/* Fetch instance name */
-	memset(temp, 0, PERFCOUNT_MAX_LEN);
-	snprintf(temp, PERFCOUNT_MAX_LEN, "i%dname", instId);
+	snprintf(temp, sizeof(temp), "i%dname", instId);
 	_reg_perfcount_make_key(&key, buf, PERFCOUNT_MAX_LEN, obj->ObjectNameTitleIndex, temp);
 	data = tdb_fetch(names, key);
 	if(data.dptr == NULL)
diff -Npur samba-4.7.9/source3/selftest/tests.py samba-4.7.10/source3/selftest/tests.py
--- samba-4.7.9/source3/selftest/tests.py	2018-08-11 21:56:42.000000000 +0200
+++ samba-4.7.10/source3/selftest/tests.py	2018-08-27 09:54:35.000000000 +0200
@@ -74,7 +74,7 @@ tests = ["FDPASS", "LOCK1", "LOCK2", "LO
         "DIR", "DIR1", "DIR-CREATETIME", "TCON", "TCONDEV", "RW1", "RW2", "RW3", "LARGE_READX", "RW-SIGNING",
         "OPEN", "XCOPY", "RENAME", "DELETE", "DELETE-LN", "WILDDELETE", "PROPERTIES", "W2K",
         "TCON2", "IOCTL", "CHKPATH", "FDSESS", "CHAIN1", "CHAIN2", "OWNER-RIGHTS",
-        "CHAIN3", "PIDHIGH",
+        "CHAIN3", "PIDHIGH", "CLI_SPLICE",
         "GETADDRINFO", "UID-REGRESSION-TEST", "SHORTNAME-TEST",
         "CASE-INSENSITIVE-CREATE", "SMB2-BASIC", "NTTRANS-FSCTL", "SMB2-NEGPROT",
         "SMB2-SESSION-REAUTH", "SMB2-SESSION-RECONNECT", "SMB2-FTRUNCATE",
@@ -91,6 +91,9 @@ for t in tests:
         # this is a negative test to verify that the server rejects
         # access without encryption
         plantestsuite("samba3.smbtorture_s3.crypt_server(nt4_dc).%s" % t, "nt4_dc", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmpenc', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH"])
+    if t == "CLI_SPLICE":
+        # We must test this against the SMB1 fallback.
+        plantestsuite("samba3.smbtorture_s3.plain(fileserver).%s" % t, "fileserver", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmp', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH", "-mNT1"])
     plantestsuite("samba3.smbtorture_s3.plain(ad_dc_ntvfs).%s" % t, "ad_dc_ntvfs", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmp', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH"])
 
 #
@@ -158,6 +161,7 @@ local_tests = [
     "LOCAL-G-LOCK3",
     "LOCAL-G-LOCK4",
     "LOCAL-G-LOCK5",
+    "LOCAL-G-LOCK6",
     "LOCAL-hex_encode_buf",
     "LOCAL-remove_duplicate_addrs2"]
 
@@ -540,13 +544,17 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/aio -U$USERNAME%$PASSWORD', 'aio')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
+    elif t == "smb2.streams":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/streams_xattr -U$USERNAME%$PASSWORD', 'streams_xattr')
     else:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
 
 
 test = 'rpc.lsa.lookupsids'
-auth_options = ["", "ntlm", "spnego", "spnego,ntlm" ]
+auth_options = ["", "ntlm", "spnego", "spnego,ntlm", "spnego,smb1", "spnego,smb2"]
 signseal_options = ["", ",connect", ",packet", ",sign", ",seal"]
 endianness_options = ["", ",bigendian"]
 for s in signseal_options:
diff -Npur samba-4.7.9/source3/smbd/durable.c samba-4.7.10/source3/smbd/durable.c
--- samba-4.7.9/source3/smbd/durable.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/smbd/durable.c	2018-08-27 09:54:35.000000000 +0200
@@ -305,30 +305,6 @@ static bool vfs_default_durable_reconnec
 {
 	int ret;
 
-	if (cookie_st->st_ex_dev != fsp_st->st_ex_dev) {
-		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
-			  "stat_ex.%s differs: "
-			  "cookie:%llu != stat:%llu, "
-			  "denying durable reconnect\n",
-			  name,
-			  "st_ex_dev",
-			  (unsigned long long)cookie_st->st_ex_dev,
-			  (unsigned long long)fsp_st->st_ex_dev));
-		return false;
-	}
-
-	if (cookie_st->st_ex_ino != fsp_st->st_ex_ino) {
-		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
-			  "stat_ex.%s differs: "
-			  "cookie:%llu != stat:%llu, "
-			  "denying durable reconnect\n",
-			  name,
-			  "st_ex_ino",
-			  (unsigned long long)cookie_st->st_ex_ino,
-			  (unsigned long long)fsp_st->st_ex_ino));
-		return false;
-	}
-
 	if (cookie_st->st_ex_mode != fsp_st->st_ex_mode) {
 		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
 			  "stat_ex.%s differs: "
diff -Npur samba-4.7.9/source3/smbd/notifyd/notifyd.c samba-4.7.10/source3/smbd/notifyd/notifyd.c
--- samba-4.7.9/source3/smbd/notifyd/notifyd.c	2017-11-02 12:38:36.000000000 +0100
+++ samba-4.7.10/source3/smbd/notifyd/notifyd.c	2018-08-27 09:54:35.000000000 +0200
@@ -81,7 +81,7 @@ struct notifyd_state {
 	 * broadcasts its messaging_reclog to every other notifyd in
 	 * the cluster. This is done by making ctdb send a message to
 	 * srvid CTDB_SRVID_SAMBA_NOTIFY_PROXY with destination node
-	 * number CTDB_BROADCAST_VNNMAP. Everybody in the cluster who
+	 * number CTDB_BROADCAST_ACTIVE. Everybody in the cluster who
 	 * had called register_with_ctdbd this srvid will receive the
 	 * broadcasts.
 	 *
@@ -998,7 +998,7 @@ static void notifyd_broadcast_reclog(str
 				  .iov_len = blob.length };
 
 	ret = ctdbd_messaging_send_iov(
-		ctdbd_conn, CTDB_BROADCAST_VNNMAP,
+		ctdbd_conn, CTDB_BROADCAST_ACTIVE,
 		CTDB_SRVID_SAMBA_NOTIFY_PROXY, iov, ARRAY_SIZE(iov));
 	TALLOC_FREE(blob.data);
 	if (ret != 0) {
diff -Npur samba-4.7.9/source3/smbd/open.c samba-4.7.10/source3/smbd/open.c
--- samba-4.7.9/source3/smbd/open.c	2018-04-17 09:35:02.000000000 +0200
+++ samba-4.7.10/source3/smbd/open.c	2018-08-27 09:54:35.000000000 +0200
@@ -5092,6 +5092,7 @@ static NTSTATUS create_file_unixpath(con
 	    && (!(private_flags & NTCREATEX_OPTIONS_PRIVATE_STREAM_DELETE))) {
 		uint32_t base_create_disposition;
 		struct smb_filename *smb_fname_base = NULL;
+		uint32_t base_privflags;
 
 		if (create_options & FILE_DIRECTORY_FILE) {
 			status = NT_STATUS_NOT_A_DIRECTORY;
@@ -5142,13 +5143,17 @@ static NTSTATUS create_file_unixpath(con
 			}
 		}
 
+		base_privflags = NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN;
+
 		/* Open the base file. */
 		status = create_file_unixpath(conn, NULL, smb_fname_base, 0,
 					      FILE_SHARE_READ
 					      | FILE_SHARE_WRITE
 					      | FILE_SHARE_DELETE,
 					      base_create_disposition,
-					      0, 0, 0, NULL, 0, 0, NULL, NULL,
+					      0, 0, 0, NULL, 0,
+					      base_privflags,
+					      NULL, NULL,
 					      &base_fsp, NULL);
 		TALLOC_FREE(smb_fname_base);
 
diff -Npur samba-4.7.9/source3/smbd/pysmbd.c samba-4.7.10/source3/smbd/pysmbd.c
--- samba-4.7.9/source3/smbd/pysmbd.c	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/smbd/pysmbd.c	2018-08-27 09:54:35.000000000 +0200
@@ -396,6 +396,7 @@ static PyObject *py_smbd_set_simple_acl(
 
 	conn = get_conn(frame, service);
 	if (!conn) {
+		TALLOC_FREE(frame);
 		return NULL;
 	}
 
diff -Npur samba-4.7.9/source3/smbd/reply.c samba-4.7.10/source3/smbd/reply.c
--- samba-4.7.9/source3/smbd/reply.c	2017-11-20 11:56:00.000000000 +0100
+++ samba-4.7.10/source3/smbd/reply.c	2018-08-27 09:54:35.000000000 +0200
@@ -6645,6 +6645,10 @@ NTSTATUS rename_internals_fsp(connection
 		return status;
 	}
 
+	if (file_has_open_streams(fsp)) {
+		return NT_STATUS_ACCESS_DENIED;
+	}
+
 	/* Make a copy of the dst smb_fname structs */
 
 	smb_fname_dst = cp_smb_filename(ctx, smb_fname_dst_in);
diff -Npur samba-4.7.9/source3/smbd/smb2_create.c samba-4.7.10/source3/smbd/smb2_create.c
--- samba-4.7.9/source3/smbd/smb2_create.c	2018-04-17 09:35:02.000000000 +0200
+++ samba-4.7.10/source3/smbd/smb2_create.c	2018-08-27 09:54:35.000000000 +0200
@@ -381,6 +381,7 @@ static NTSTATUS smbd_smb2_create_durable
 	const char *requested_filename, const struct files_struct *fsp,
 	const struct smb2_lease *lease_ptr)
 {
+	char *filename = NULL;
 	struct smb_filename *smb_fname = NULL;
 	uint32_t ucf_flags;
 	NTSTATUS status;
@@ -407,10 +408,23 @@ static NTSTATUS smbd_smb2_create_durable
 		return NT_STATUS_OBJECT_NAME_NOT_FOUND;
 	}
 
+	filename = talloc_strdup(talloc_tos(), requested_filename);
+	if (filename == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* This also converts '\' to '/' */
+	status = check_path_syntax(filename);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(filename);
+		return status;
+	}
+
 	ucf_flags = filename_create_ucf_flags(smb1req, FILE_OPEN);
 	status = filename_convert(talloc_tos(), fsp->conn,
-				  requested_filename, ucf_flags,
+				  filename, ucf_flags,
 				  NULL, &smb_fname);
+	TALLOC_FREE(filename);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(10, ("filename_convert returned %s\n",
 			   nt_errstr(status)));
diff -Npur samba-4.7.9/source3/smbd/uid.c samba-4.7.10/source3/smbd/uid.c
--- samba-4.7.9/source3/smbd/uid.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/smbd/uid.c	2018-08-27 09:54:35.000000000 +0200
@@ -202,6 +202,7 @@ static bool check_user_ok(connection_str
 			conn->session_info = ent->session_info;
 			conn->read_only = ent->read_only;
 			conn->share_access = ent->share_access;
+			conn->vuid = ent->vuid;
 			return(True);
 		}
 	}
@@ -250,6 +251,7 @@ static bool check_user_ok(connection_str
 	ent->share_access = share_access;
 	free_conn_session_info_if_unused(conn);
 	conn->session_info = ent->session_info;
+	conn->vuid = ent->vuid;
 	if (vuid == UID_FIELD_INVALID) {
 		/*
 		 * Not strictly needed, just make it really
diff -Npur samba-4.7.9/source3/torture/proto.h samba-4.7.10/source3/torture/proto.h
--- samba-4.7.9/source3/torture/proto.h	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/torture/proto.h	2018-08-27 09:54:35.000000000 +0200
@@ -132,5 +132,6 @@ bool run_g_lock2(int dummy);
 bool run_g_lock3(int dummy);
 bool run_g_lock4(int dummy);
 bool run_g_lock5(int dummy);
+bool run_g_lock6(int dummy);
 
 #endif /* __TORTURE_H__ */
diff -Npur samba-4.7.9/source3/torture/test_g_lock.c samba-4.7.10/source3/torture/test_g_lock.c
--- samba-4.7.9/source3/torture/test_g_lock.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/torture/test_g_lock.c	2018-08-27 09:54:35.000000000 +0200
@@ -642,3 +642,171 @@ bool run_g_lock5(int dummy)
 
 	return true;
 }
+
+struct lock6_parser_state {
+	size_t num_locks;
+};
+
+static void lock6_parser(const struct g_lock_rec *locks,
+			 size_t num_locks,
+			 const uint8_t *data,
+			 size_t datalen,
+			 void *private_data)
+{
+	struct lock6_parser_state *state = private_data;
+	state->num_locks = num_locks;
+}
+
+/*
+ * Test cleanup with contention and stale locks
+ */
+
+bool run_g_lock6(int dummy)
+{
+	struct tevent_context *ev = NULL;
+	struct messaging_context *msg = NULL;
+	struct g_lock_ctx *ctx = NULL;
+	const char *lockname = "lock6";
+	pid_t child;
+	int exit_pipe[2], ready_pipe[2];
+	NTSTATUS status;
+	size_t i, nprocs;
+	int ret;
+	bool ok;
+	ssize_t nread;
+	char c;
+
+	if ((pipe(exit_pipe) != 0) || (pipe(ready_pipe) != 0)) {
+		perror("pipe failed");
+		return false;
+	}
+
+	ok = get_g_lock_ctx(talloc_tos(), &ev, &msg, &ctx);
+	if (!ok) {
+		fprintf(stderr, "get_g_lock_ctx failed");
+		return false;
+	}
+
+	nprocs = 2;
+	for (i=0; i<nprocs; i++) {
+
+		child = fork();
+
+		if (child == -1) {
+			perror("fork failed");
+			return false;
+		}
+
+		if (child == 0) {
+			TALLOC_FREE(ctx);
+
+			status = reinit_after_fork(msg, ev, false, "");
+			if (!NT_STATUS_IS_OK(status)) {
+				fprintf(stderr, "reinit_after_fork failed: %s\n",
+					nt_errstr(status));
+				exit(1);
+			}
+
+			close(ready_pipe[0]);
+			close(exit_pipe[1]);
+
+			ok = get_g_lock_ctx(talloc_tos(), &ev, &msg, &ctx);
+			if (!ok) {
+				fprintf(stderr, "get_g_lock_ctx failed");
+				exit(1);
+			}
+			status = g_lock_lock(ctx, lockname, G_LOCK_READ,
+					     (struct timeval) { .tv_sec = 1 });
+			if (!NT_STATUS_IS_OK(status)) {
+				fprintf(stderr,
+					"child g_lock_lock failed %s\n",
+					nt_errstr(status));
+				exit(1);
+			}
+			if (i == 0) {
+				exit(0);
+			}
+			close(ready_pipe[1]);
+			nread = sys_read(exit_pipe[0], &c, sizeof(c));
+			if (nread != 0) {
+				fprintf(stderr, "sys_read returned %zu (%s)\n",
+					nread, strerror(errno));
+				exit(1);
+			}
+			exit(0);
+		}
+	}
+
+	close(ready_pipe[1]);
+
+	nread = sys_read(ready_pipe[0], &c, sizeof(c));
+	if (nread != 0) {
+		fprintf(stderr, "sys_read returned %zd (%s)\n",
+			nread, strerror(errno));
+		return false;
+	}
+
+	{
+		int child_status;
+		ret = waitpid(-1, &child_status, 0);
+		if (ret == -1) {
+			perror("waitpid failed");
+			return false;
+		}
+	}
+
+	{
+		struct lock6_parser_state state;
+
+		status = g_lock_dump(ctx, lockname, lock6_parser, &state);
+		if (!NT_STATUS_IS_OK(status)) {
+			fprintf(stderr, "g_lock_dump returned %s\n",
+				nt_errstr(status));
+			return false;
+		}
+
+		if (state.num_locks != nprocs) {
+			fprintf(stderr, "nlocks=%zu, expected %zu\n",
+				state.num_locks, nprocs);
+			return false;
+		}
+
+		status = g_lock_lock(ctx, lockname, G_LOCK_WRITE,
+				     (struct timeval) { .tv_sec = 1 });
+		if (!NT_STATUS_EQUAL(status, NT_STATUS_IO_TIMEOUT)) {
+			fprintf(stderr, "g_lock_lock should have failed with %s - %s\n",
+				nt_errstr(NT_STATUS_IO_TIMEOUT),
+				nt_errstr(status));
+			return false;
+		}
+
+		status = g_lock_lock(ctx, lockname, G_LOCK_READ,
+				     (struct timeval) { .tv_sec = 1 });
+		if (!NT_STATUS_IS_OK(status)) {
+			fprintf(stderr, "g_lock_lock failed: %s\n",
+				nt_errstr(status));
+			return false;
+		}
+	}
+
+	close(exit_pipe[1]);
+
+	{
+		int child_status;
+		ret = waitpid(-1, &child_status, 0);
+		if (ret == -1) {
+			perror("waitpid failed");
+			return false;
+		}
+	}
+
+	status = g_lock_lock(ctx, lockname, G_LOCK_WRITE,
+			     (struct timeval) { .tv_sec = 1 });
+	if (!NT_STATUS_IS_OK(status)) {
+		fprintf(stderr, "g_lock_lock failed: %s\n",
+			nt_errstr(status));
+		return false;
+	}
+
+	return true;
+}
diff -Npur samba-4.7.9/source3/torture/torture.c samba-4.7.10/source3/torture/torture.c
--- samba-4.7.9/source3/torture/torture.c	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/torture/torture.c	2018-08-27 09:54:35.000000000 +0200
@@ -43,6 +43,7 @@
 #include "../libcli/smb/smbXcli_base.h"
 #include "lib/util/sys_rw_data.h"
 #include "lib/util/base64.h"
+#include "lib/crypto/md5.h"
 
 extern char *optarg;
 extern int optind;
@@ -9166,6 +9167,157 @@ static bool run_cli_echo(int dummy)
 	return NT_STATUS_IS_OK(status);
 }
 
+static int splice_status(off_t written, void *priv)
+{
+        return true;
+}
+
+static bool run_cli_splice(int dummy)
+{
+	uint8_t *buf = NULL;
+	struct cli_state *cli1 = NULL;
+	bool correct = false;
+	const char *fname_src = "\\splice_src.dat";
+	const char *fname_dst = "\\splice_dst.dat";
+	NTSTATUS status;
+	uint16_t fnum1 = UINT16_MAX;
+	uint16_t fnum2 = UINT16_MAX;
+	size_t file_size = 2*1024*1024;
+	size_t splice_size = 1*1024*1024 + 713;
+	MD5_CTX md5_ctx;
+	uint8_t digest1[16], digest2[16];
+	off_t written = 0;
+	size_t nread = 0;
+	TALLOC_CTX *frame = talloc_stackframe();
+
+	printf("starting cli_splice test\n");
+
+	if (!torture_open_connection(&cli1, 0)) {
+		goto out;
+	}
+
+	cli_unlink(cli1, fname_src,
+		FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+	cli_unlink(cli1, fname_dst,
+		FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+
+	/* Create a file */
+	status = cli_ntcreate(cli1, fname_src, 0, GENERIC_ALL_ACCESS,
+			FILE_ATTRIBUTE_NORMAL, 0, FILE_OVERWRITE_IF,
+			0, 0, &fnum1, NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("open %s failed: %s\n", fname_src, nt_errstr(status));
+		goto out;
+	}
+
+	/* Write file_size bytes - must be bigger than splice_size. */
+	buf = talloc_zero_array(frame, uint8_t, file_size);
+	if (buf == NULL) {
+		d_printf("talloc_fail\n");
+		goto out;
+	}
+
+	/* Fill it with random numbers. */
+	generate_random_buffer(buf, file_size);
+
+	/* MD5 the first 1MB + 713 bytes. */
+	MD5Init(&md5_ctx);
+	MD5Update(&md5_ctx, buf, splice_size);
+	MD5Final(digest1, &md5_ctx);
+
+	status = cli_writeall(cli1,
+			      fnum1,
+			      0,
+			      buf,
+			      0,
+			      file_size,
+			      NULL);
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_writeall failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+
+	status = cli_ntcreate(cli1, fname_dst, 0, GENERIC_ALL_ACCESS,
+			FILE_ATTRIBUTE_NORMAL, 0, FILE_OVERWRITE_IF,
+			0, 0, &fnum2, NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("open %s failed: %s\n", fname_dst, nt_errstr(status));
+		goto out;
+	}
+
+	/* Now splice 1MB + 713 bytes. */
+	status = cli_splice(cli1,
+				cli1,
+				fnum1,
+				fnum2,
+				splice_size,
+				0,
+				0,
+				&written,
+				splice_status,
+				NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_splice failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+
+	/* Clear the old buffer. */
+	memset(buf, '\0', file_size);
+
+	/* Read the new file. */
+	status = cli_read(cli1, fnum2, (char *)buf, 0, splice_size, &nread);
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_read failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+	if (nread != splice_size) {
+		d_printf("bad read of 0x%x, should be 0x%x\n",
+			(unsigned int)nread,
+			(unsigned int)splice_size);
+		goto out;
+	}
+
+	/* MD5 the first 1MB + 713 bytes. */
+	MD5Init(&md5_ctx);
+	MD5Update(&md5_ctx, buf, splice_size);
+	MD5Final(digest2, &md5_ctx);
+
+	/* Must be the same. */
+	if (memcmp(digest1, digest2, 16) != 0) {
+		d_printf("bad MD5 compare\n");
+		goto out;
+	}
+
+	correct = true;
+	printf("Success on cli_splice test\n");
+
+  out:
+
+	if (cli1) {
+		if (fnum1 != UINT16_MAX) {
+			cli_close(cli1, fnum1);
+		}
+		if (fnum2 != UINT16_MAX) {
+			cli_close(cli1, fnum2);
+		}
+
+		cli_unlink(cli1, fname_src,
+			FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+		cli_unlink(cli1, fname_dst,
+			FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+
+		if (!torture_close_connection(cli1)) {
+			correct = false;
+		}
+	}
+
+	TALLOC_FREE(frame);
+	return correct;
+}
+
 static bool run_uid_regression_test(int dummy)
 {
 	static struct cli_state *cli;
@@ -11632,6 +11784,7 @@ static struct {
 	{ "NTTRANS-CREATE", run_nttrans_create, 0},
 	{ "NTTRANS-FSCTL", run_nttrans_fsctl, 0},
 	{ "CLI_ECHO", run_cli_echo, 0},
+	{ "CLI_SPLICE", run_cli_splice, 0},
 	{ "GETADDRINFO", run_getaddrinfo_send, 0},
 	{ "TLDAP", run_tldap },
 	{ "STREAMERROR", run_streamerror },
@@ -11695,6 +11848,7 @@ static struct {
 	{ "LOCAL-G-LOCK3", run_g_lock3, 0 },
 	{ "LOCAL-G-LOCK4", run_g_lock4, 0 },
 	{ "LOCAL-G-LOCK5", run_g_lock5, 0 },
+	{ "LOCAL-G-LOCK6", run_g_lock6, 0 },
 	{ "LOCAL-CANONICALIZE-PATH", run_local_canonicalize_path, 0 },
 	{ "qpathinfo-bufsize", run_qpathinfo_bufsize, 0 },
 	{NULL, NULL, 0}};
diff -Npur samba-4.7.9/source3/utils/smbget.c samba-4.7.10/source3/utils/smbget.c
--- samba-4.7.9/source3/utils/smbget.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/utils/smbget.c	2018-08-27 09:54:35.000000000 +0200
@@ -288,7 +288,7 @@ static void print_progress(const char *n
 	double avg = 0.0;
 	long eta = -1;
 	double prcnt = 0.0;
-	char hpos[20], htotal[20], havg[20];
+	char hpos[22], htotal[22], havg[22];
 	char *status, *filename;
 	int len;
 	if (now - start) {
diff -Npur samba-4.7.9/source3/utils/smbpasswd.c samba-4.7.10/source3/utils/smbpasswd.c
--- samba-4.7.9/source3/utils/smbpasswd.c	2017-08-29 06:12:36.000000000 +0200
+++ samba-4.7.10/source3/utils/smbpasswd.c	2018-08-27 09:54:35.000000000 +0200
@@ -368,36 +368,44 @@ static int process_root(int local_flags)
 
 	if (local_flags & LOCAL_TRUST_ACCOUNT) {
 		/* add the $ automatically */
-		static fstring buf;
+		size_t user_name_len = strlen(user_name);
 
-		/*
-		 * Remove any trailing '$' before we
-		 * generate the initial machine password.
-		 */
-
-		if (user_name[strlen(user_name)-1] == '$') {
-			user_name[strlen(user_name)-1] = 0;
+		if (user_name[user_name_len - 1] == '$') {
+			user_name_len--;
+		} else {
+			if (user_name_len + 2 > sizeof(user_name)) {
+				fprintf(stderr, "machine name too long\n");
+				exit(1);
+			}
+			user_name[user_name_len] = '$';
+			user_name[user_name_len + 1] = '\0';
 		}
 
 		if (local_flags & LOCAL_ADD_USER) {
 		        SAFE_FREE(new_passwd);
-			new_passwd = smb_xstrdup(user_name);
+
+			/*
+			 * Remove any trailing '$' before we
+			 * generate the initial machine password.
+			 */
+			new_passwd = smb_xstrndup(user_name, user_name_len);
 			if (!strlower_m(new_passwd)) {
 				fprintf(stderr, "strlower_m %s failed\n",
 					new_passwd);
 				exit(1);
 			}
 		}
-
-		/*
-		 * Now ensure the username ends in '$' for
-		 * the machine add.
-		 */
-
-		slprintf(buf, sizeof(buf)-1, "%s$", user_name);
-		strlcpy(user_name, buf, sizeof(user_name));
 	} else if (local_flags & LOCAL_INTERDOM_ACCOUNT) {
-		static fstring buf;
+		size_t user_name_len = strlen(user_name);
+
+		if (user_name[user_name_len - 1] != '$') {
+			if (user_name_len + 2 > sizeof(user_name)) {
+				fprintf(stderr, "machine name too long\n");
+				exit(1);
+			}
+			user_name[user_name_len] = '$';
+			user_name[user_name_len + 1] = '\0';
+		}
 
 		if ((local_flags & LOCAL_ADD_USER) && (new_passwd == NULL)) {
 			/*
@@ -409,11 +417,6 @@ static int process_root(int local_flags)
 				exit(1);
 			}
 		}
-
-		/* prepare uppercased and '$' terminated username */
-		slprintf(buf, sizeof(buf) - 1, "%s$", user_name);
-		strlcpy(user_name, buf, sizeof(user_name));
-
 	} else {
 
 		if (remote_machine != NULL) {
diff -Npur samba-4.7.9/source3/winbindd/wb_getpwsid.c samba-4.7.10/source3/winbindd/wb_getpwsid.c
--- samba-4.7.9/source3/winbindd/wb_getpwsid.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/source3/winbindd/wb_getpwsid.c	2018-08-27 09:54:35.000000000 +0200
@@ -63,7 +63,8 @@ static void wb_getpwsid_queryuser_done(s
 		req, struct wb_getpwsid_state);
 	struct winbindd_pw *pw = state->pw;
 	struct wbint_userinfo *info;
-	fstring acct_name, output_username;
+	fstring acct_name;
+	const char *output_username = NULL;
 	char *mapped_name = NULL;
 	char *tmp;
 	NTSTATUS status;
@@ -95,16 +96,24 @@ static void wb_getpwsid_queryuser_done(s
 				    acct_name,
 				    &mapped_name);
 	if (NT_STATUS_IS_OK(status)) {
-		fill_domain_username(output_username,
+		output_username = fill_domain_username_talloc(state,
 				     info->domain_name,
 				     mapped_name, true);
+		if (output_username == NULL) {
+			tevent_req_nterror(req, NT_STATUS_NO_MEMORY);
+			return;
+		}
 		fstrcpy(acct_name, mapped_name);
 	} else if (NT_STATUS_EQUAL(status, NT_STATUS_FILE_RENAMED)) {
 		fstrcpy(acct_name, mapped_name);
 	} else {
-		fill_domain_username(output_username,
+		output_username = fill_domain_username_talloc(state,
 				     info->domain_name,
 				     acct_name, true);
+		if (output_username == NULL) {
+			tevent_req_nterror(req, NT_STATUS_NO_MEMORY);
+			return;
+		}
 	}
 
 	strlcpy(pw->pw_name, output_username, sizeof(pw->pw_name));
diff -Npur samba-4.7.9/source3/winbindd/wb_query_user_list.c samba-4.7.10/source3/winbindd/wb_query_user_list.c
--- samba-4.7.9/source3/winbindd/wb_query_user_list.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/winbindd/wb_query_user_list.c	2018-08-27 09:54:35.000000000 +0200
@@ -104,11 +104,14 @@ static void wb_query_user_list_done(stru
 
 	for (i=0; i<state->names.num_principals; i++) {
 		struct wbint_Principal *p = &state->names.principals[i];
-		fstring name;
+		const char *name;
 		int ret;
 
-		fill_domain_username(name, state->domain_name, p->name, true);
-
+		name = fill_domain_username_talloc(state, state->domain_name, p->name, true);
+		if (name == NULL) {
+			tevent_req_nterror(req, NT_STATUS_NO_MEMORY);
+			return;
+		}
 		ret = strv_add(state, &state->users, name);
 		if (ret != 0) {
 			tevent_req_nterror(req, map_nt_error_from_unix(ret));
diff -Npur samba-4.7.9/source3/winbindd/winbindd_group.c samba-4.7.10/source3/winbindd/winbindd_group.c
--- samba-4.7.9/source3/winbindd/winbindd_group.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/source3/winbindd/winbindd_group.c	2018-08-27 09:54:35.000000000 +0200
@@ -33,7 +33,7 @@
 bool fill_grent(TALLOC_CTX *mem_ctx, struct winbindd_gr *gr,
 		const char *dom_name, const char *gr_name, gid_t unix_gid)
 {
-	fstring full_group_name;
+	const char *full_group_name;
 	char *mapped_name = NULL;
 	NTSTATUS nt_status = NT_STATUS_UNSUCCESSFUL;
 
@@ -42,19 +42,23 @@ bool fill_grent(TALLOC_CTX *mem_ctx, str
 
 	/* Basic whitespace replacement */
 	if (NT_STATUS_IS_OK(nt_status)) {
-		fill_domain_username(full_group_name, dom_name,
+		full_group_name = fill_domain_username_talloc(mem_ctx, dom_name,
 				     mapped_name, true);
 	}
 	/* Mapped to an aliase */
 	else if (NT_STATUS_EQUAL(nt_status, NT_STATUS_FILE_RENAMED)) {
-		fstrcpy(full_group_name, mapped_name);
+		full_group_name = mapped_name;
 	}
 	/* no change */
 	else {
-		fill_domain_username( full_group_name, dom_name,
+		full_group_name = fill_domain_username_talloc(mem_ctx, dom_name,
 				      gr_name, True );
 	}
 
+	if (full_group_name == NULL) {
+		return false;
+	}
+
 	gr->gr_gid = unix_gid;
 
 	/* Group name and password */
diff -Npur samba-4.7.9/source3/winbindd/winbindd_list_groups.c samba-4.7.10/source3/winbindd/winbindd_list_groups.c
--- samba-4.7.9/source3/winbindd/winbindd_list_groups.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/winbindd/winbindd_list_groups.c	2018-08-27 09:54:35.000000000 +0200
@@ -166,10 +166,13 @@ NTSTATUS winbindd_list_groups_recv(struc
 		struct winbindd_list_groups_domstate *d = &state->domains[i];
 
 		for (j=0; j<d->groups.num_principals; j++) {
-			fstring name;
-			fill_domain_username(name, d->domain->name,
+			const char *name;
+			name = fill_domain_username_talloc(response, d->domain->name,
 					     d->groups.principals[j].name,
 					     True);
+			if (name == NULL) {
+				return NT_STATUS_NO_MEMORY;
+			}
 			len += strlen(name)+1;
 		}
 		response->data.num_entries += d->groups.num_principals;
@@ -185,11 +188,14 @@ NTSTATUS winbindd_list_groups_recv(struc
 		struct winbindd_list_groups_domstate *d = &state->domains[i];
 
 		for (j=0; j<d->groups.num_principals; j++) {
-			fstring name;
+			const char *name;
 			size_t this_len;
-			fill_domain_username(name, d->domain->name,
+			name = fill_domain_username_talloc(response, d->domain->name,
 					     d->groups.principals[j].name,
 					     True);
+			if (name == NULL) {
+				return NT_STATUS_NO_MEMORY;
+			}
 			this_len = strlen(name);
 			memcpy(result+len, name, this_len);
 			len += this_len;
diff -Npur samba-4.7.9/source3/winbindd/winbindd_pam.c samba-4.7.10/source3/winbindd/winbindd_pam.c
--- samba-4.7.9/source3/winbindd/winbindd_pam.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source3/winbindd/winbindd_pam.c	2018-08-27 09:54:35.000000000 +0200
@@ -159,7 +159,7 @@ static NTSTATUS append_unix_username(TAL
 	/* We've been asked to return the unix username, per
 	   'winbind use default domain' settings and the like */
 
-	const char *nt_username, *nt_domain;
+	const char *nt_username, *nt_domain, *unix_username;
 
 	nt_domain = talloc_strdup(mem_ctx, info3->base.logon_domain.string);
 	if (!nt_domain) {
@@ -175,8 +175,15 @@ static NTSTATUS append_unix_username(TAL
 		nt_username = name_user;
 	}
 
-	fill_domain_username(resp->data.auth.unix_username,
-			     nt_domain, nt_username, true);
+	unix_username = fill_domain_username_talloc(mem_ctx,
+						    nt_domain,
+						    nt_username,
+						    true);
+	if (unix_username == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	fstrcpy(resp->data.auth.unix_username, unix_username);
 
 	DEBUG(5, ("Setting unix username to [%s]\n",
 		  resp->data.auth.unix_username));
diff -Npur samba-4.7.9/source3/winbindd/winbindd_proto.h samba-4.7.10/source3/winbindd/winbindd_proto.h
--- samba-4.7.9/source3/winbindd/winbindd_proto.h	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/winbindd/winbindd_proto.h	2018-08-27 09:54:35.000000000 +0200
@@ -488,7 +488,6 @@ bool parse_domain_user(const char *domus
 bool parse_domain_user_talloc(TALLOC_CTX *mem_ctx, const char *domuser,
 			      char **domain, char **user);
 bool canonicalize_username(fstring username_inout, fstring domain, fstring user);
-void fill_domain_username(fstring name, const char *domain, const char *user, bool can_assume);
 char *fill_domain_username_talloc(TALLOC_CTX *ctx,
 				  const char *domain,
 				  const char *user,
diff -Npur samba-4.7.9/source3/winbindd/winbindd_util.c samba-4.7.10/source3/winbindd/winbindd_util.c
--- samba-4.7.9/source3/winbindd/winbindd_util.c	2018-08-11 21:50:02.000000000 +0200
+++ samba-4.7.10/source3/winbindd/winbindd_util.c	2018-08-27 09:54:35.000000000 +0200
@@ -1190,26 +1190,6 @@ bool canonicalize_username(fstring usern
 
     We always canonicalize as UPPERCASE DOMAIN, lowercase username.
 */
-void fill_domain_username(fstring name, const char *domain, const char *user, bool can_assume)
-{
-	fstring tmp_user;
-
-	if (lp_server_role() == ROLE_ACTIVE_DIRECTORY_DC) {
-		can_assume = false;
-	}
-
-	fstrcpy(tmp_user, user);
-	(void)strlower_m(tmp_user);
-
-	if (can_assume && assume_domain(domain)) {
-		strlcpy(name, tmp_user, sizeof(fstring));
-	} else {
-		slprintf(name, sizeof(fstring) - 1, "%s%c%s",
-			 domain, *lp_winbind_separator(),
-			 tmp_user);
-	}
-}
-
 /**
  * talloc version of fill_domain_username()
  * return NULL on talloc failure.
diff -Npur samba-4.7.9/source4/dns_server/dnsserver_common.c samba-4.7.10/source4/dns_server/dnsserver_common.c
--- samba-4.7.9/source4/dns_server/dnsserver_common.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/source4/dns_server/dnsserver_common.c	2018-08-27 09:54:35.000000000 +0200
@@ -379,6 +379,7 @@ static struct ldb_parse_tree *build_wild
 			wildcard_query->u.list.elements[l] = el;
 
 			/* skip to the start of the next label */
+			x++;
 			for (;x < name->length && name->data[x] != '.'; x++);
 		}
 
diff -Npur samba-4.7.9/source4/dsdb/kcc/kcc_topology.c samba-4.7.10/source4/dsdb/kcc/kcc_topology.c
--- samba-4.7.9/source4/dsdb/kcc/kcc_topology.c	2017-08-15 09:16:59.000000000 +0200
+++ samba-4.7.10/source4/dsdb/kcc/kcc_topology.c	2018-08-27 09:54:35.000000000 +0200
@@ -1327,6 +1327,11 @@ static NTSTATUS kcctpl_get_all_bridgehea
 	}
 
 	if (site_opts & NTDSSETTINGS_OPT_IS_RAND_BH_SELECTION_DISABLED) {
+		if (bridgeheads.data == NULL || bridgeheads.count == 0) {
+			talloc_free(tmp_ctx);
+			return NT_STATUS_INVALID_PARAMETER;
+		}
+
 		qsort(bridgeheads.data, bridgeheads.count,
 		      sizeof(struct ldb_message), kcctpl_sort_bridgeheads);
 	} else {
diff -Npur samba-4.7.9/source4/dsdb/samdb/ldb_modules/samldb.c samba-4.7.10/source4/dsdb/samdb/ldb_modules/samldb.c
--- samba-4.7.9/source4/dsdb/samdb/ldb_modules/samldb.c	2018-04-17 09:35:02.000000000 +0200
+++ samba-4.7.10/source4/dsdb/samdb/ldb_modules/samldb.c	2018-08-27 09:54:35.000000000 +0200
@@ -345,7 +345,7 @@ static int samldb_generate_next_linkid(s
 static int samldb_schema_add_handle_linkid(struct samldb_ctx *ac)
 {
 	int ret;
-	bool ok, found;
+	bool ok, found = false;
 	struct ldb_message_element *el;
 	const char *enc_str;
 	const struct dsdb_attribute *attr;
diff -Npur samba-4.7.9/source4/heimdal/lib/krb5/config_file.c samba-4.7.10/source4/heimdal/lib/krb5/config_file.c
--- samba-4.7.9/source4/heimdal/lib/krb5/config_file.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/heimdal/lib/krb5/config_file.c	2018-08-27 09:54:35.000000000 +0200
@@ -370,11 +370,11 @@ krb5_config_parse_debug (struct fileptr
 	    b = NULL;
 	} else if (*p == '}') {
 	    *err_message = "unmatched }";
-	    return EINVAL;	/* XXX */
+	    return KRB5_CONFIG_BADFORMAT;
 	} else if(*p != '\0') {
 	    if (s == NULL) {
 		*err_message = "binding before section";
-		return EINVAL;
+		return KRB5_CONFIG_BADFORMAT;
 	    }
 	    ret = parse_binding(f, lineno, p, &b, &s->u.list, err_message);
 	    if (ret)
diff -Npur samba-4.7.9/source4/heimdal/lib/krb5/context.c samba-4.7.10/source4/heimdal/lib/krb5/context.c
--- samba-4.7.9/source4/heimdal/lib/krb5/context.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/heimdal/lib/krb5/context.c	2018-08-27 09:54:35.000000000 +0200
@@ -646,7 +646,8 @@ krb5_set_config_files(krb5_context conte
     krb5_config_binding *tmp = NULL;
     while(filenames != NULL && *filenames != NULL && **filenames != '\0') {
 	ret = krb5_config_parse_file_multi(context, *filenames, &tmp);
-	if(ret != 0 && ret != ENOENT && ret != EACCES && ret != EPERM) {
+	if (ret != 0 && ret != ENOENT && ret != EACCES && ret != EPERM
+	    && ret != KRB5_CONFIG_BADFORMAT) {
 	    krb5_config_file_free(context, tmp);
 	    return ret;
 	}
diff -Npur samba-4.7.9/source4/libcli/raw/clitransport.c samba-4.7.10/source4/libcli/raw/clitransport.c
--- samba-4.7.9/source4/libcli/raw/clitransport.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/raw/clitransport.c	2018-08-27 09:54:35.000000000 +0200
@@ -114,6 +114,50 @@ struct smbcli_transport *smbcli_transpor
 }
 
 /*
+  create a transport structure based on an established socket
+*/
+NTSTATUS smbcli_transport_raw_init(TALLOC_CTX *mem_ctx,
+				   struct tevent_context *ev,
+				   struct smbXcli_conn **_conn,
+				   const struct smbcli_options *options,
+				   struct smbcli_transport **_transport)
+{
+	struct smbcli_transport *transport = NULL;
+	NTSTATUS status;
+
+	if (*_conn == NULL) {
+		return NT_STATUS_INVALID_PARAMETER;
+	}
+
+	transport = talloc_zero(mem_ctx, struct smbcli_transport);
+	if (transport == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	transport->ev = ev;
+	transport->options = *options;
+
+	/*
+	 * First only set the pointer without move.
+	 */
+	transport->conn = *_conn;
+	status = smb_raw_negotiate_fill_transport(transport);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(transport);
+		return status;
+	}
+
+	talloc_set_destructor(transport, transport_destructor);
+
+	/*
+	 * Now move it away from the caller...
+	 */
+	transport->conn = talloc_move(transport, _conn);
+	*_transport = transport;
+	return NT_STATUS_OK;
+}
+
+/*
   mark the transport as dead
 */
 void smbcli_transport_dead(struct smbcli_transport *transport, NTSTATUS status)
diff -Npur samba-4.7.9/source4/libcli/raw/clitree.c samba-4.7.10/source4/libcli/raw/clitree.c
--- samba-4.7.9/source4/libcli/raw/clitree.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/raw/clitree.c	2018-08-27 09:54:35.000000000 +0200
@@ -207,6 +207,7 @@ NTSTATUS smbcli_tree_full_connection(TAL
 	io.in.called_name = strupper_talloc(tmp_ctx, dest_host);
 	io.in.service = service;
 	io.in.service_type = service_type;
+	io.in.existing_conn = NULL;
 	io.in.credentials = credentials;
 	io.in.gensec_settings = gensec_settings;
 	io.in.fallback_to_anonymous = false;
diff -Npur samba-4.7.9/source4/libcli/raw/rawnegotiate.c samba-4.7.10/source4/libcli/raw/rawnegotiate.c
--- samba-4.7.9/source4/libcli/raw/rawnegotiate.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/raw/rawnegotiate.c	2018-08-27 09:54:35.000000000 +0200
@@ -28,6 +28,47 @@
 #include "../libcli/smb/smbXcli_base.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+NTSTATUS smb_raw_negotiate_fill_transport(struct smbcli_transport *transport)
+{
+	struct smbcli_negotiate *n = &transport->negotiate;
+	struct smbXcli_conn *c = transport->conn;
+	NTTIME ntt;
+
+	n->protocol = smbXcli_conn_protocol(c);
+	if (n->protocol > PROTOCOL_NT1) {
+		return NT_STATUS_REVISION_MISMATCH;
+	}
+
+	n->sec_mode = smb1cli_conn_server_security_mode(c);
+	n->max_mux  = smbXcli_conn_max_requests(c);
+	n->max_xmit = smb1cli_conn_max_xmit(c);
+	n->sesskey  = smb1cli_conn_server_session_key(c);
+	n->capabilities = smb1cli_conn_capabilities(c);;
+
+	/* this time arrives in real GMT */
+	ntt = smbXcli_conn_server_system_time(c);
+	n->server_time = nt_time_to_unix(ntt);
+	n->server_zone = smb1cli_conn_server_time_zone(c);
+
+	if (n->capabilities & CAP_EXTENDED_SECURITY) {
+		const DATA_BLOB *b = smbXcli_conn_server_gss_blob(c);
+		if (b) {
+			n->secblob = *b;
+		}
+	} else {
+		const uint8_t *p = smb1cli_conn_server_challenge(c);
+		if (p) {
+			n->secblob = data_blob_const(p, 8);
+		}
+	}
+
+	n->readbraw_supported = smb1cli_conn_server_readbraw(c);
+	n->readbraw_supported = smb1cli_conn_server_writebraw(c);
+	n->lockread_supported = smb1cli_conn_server_lockread(c);
+
+	return NT_STATUS_OK;
+}
+
 struct smb_raw_negotiate_state {
 	struct smbcli_transport *transport;
 };
@@ -78,10 +119,7 @@ static void smb_raw_negotiate_done(struc
 	struct smb_raw_negotiate_state *state =
 		tevent_req_data(req,
 		struct smb_raw_negotiate_state);
-	struct smbcli_negotiate *n = &state->transport->negotiate;
-	struct smbXcli_conn *c = state->transport->conn;
 	NTSTATUS status;
-	NTTIME ntt;
 
 	status = smbXcli_negprot_recv(subreq);
 	TALLOC_FREE(subreq);
@@ -89,35 +127,11 @@ static void smb_raw_negotiate_done(struc
 		return;
 	}
 
-	n->protocol = smbXcli_conn_protocol(c);
-
-	n->sec_mode = smb1cli_conn_server_security_mode(c);
-	n->max_mux  = smbXcli_conn_max_requests(c);
-	n->max_xmit = smb1cli_conn_max_xmit(c);
-	n->sesskey  = smb1cli_conn_server_session_key(c);
-	n->capabilities = smb1cli_conn_capabilities(c);;
-
-	/* this time arrives in real GMT */
-	ntt = smbXcli_conn_server_system_time(c);
-	n->server_time = nt_time_to_unix(ntt);
-	n->server_zone = smb1cli_conn_server_time_zone(c);
-
-	if (n->capabilities & CAP_EXTENDED_SECURITY) {
-		const DATA_BLOB *b = smbXcli_conn_server_gss_blob(c);
-		if (b) {
-			n->secblob = *b;
-		}
-	} else {
-		const uint8_t *p = smb1cli_conn_server_challenge(c);
-		if (p) {
-			n->secblob = data_blob_const(p, 8);
-		}
+	status = smb_raw_negotiate_fill_transport(state->transport);
+	if (tevent_req_nterror(req, status)) {
+		return;
 	}
 
-	n->readbraw_supported = smb1cli_conn_server_readbraw(c);
-	n->readbraw_supported = smb1cli_conn_server_writebraw(c);
-	n->lockread_supported = smb1cli_conn_server_lockread(c);
-
 	tevent_req_done(req);
 }
 
diff -Npur samba-4.7.9/source4/libcli/smb2/connect.c samba-4.7.10/source4/libcli/smb2/connect.c
--- samba-4.7.9/source4/libcli/smb2/connect.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb2/connect.c	2018-08-27 09:54:35.000000000 +0200
@@ -35,6 +35,7 @@
 struct smb2_connect_state {
 	struct tevent_context *ev;
 	struct cli_credentials *credentials;
+	bool fallback_to_anonymous;
 	uint64_t previous_session_id;
 	struct resolve_context *resolve_ctx;
 	const char *host;
@@ -50,6 +51,7 @@ struct smb2_connect_state {
 	struct smb2_tree *tree;
 };
 
+static void smb2_connect_session_start(struct tevent_req *req);
 static void smb2_connect_socket_done(struct composite_context *creq);
 
 /*
@@ -63,6 +65,8 @@ struct tevent_req *smb2_connect_send(TAL
 				     const char *share,
 				     struct resolve_context *resolve_ctx,
 				     struct cli_credentials *credentials,
+				     bool fallback_to_anonymous,
+				     struct smbXcli_conn **existing_conn,
 				     uint64_t previous_session_id,
 				     const struct smbcli_options *options,
 				     const char *socket_options,
@@ -81,6 +85,7 @@ struct tevent_req *smb2_connect_send(TAL
 
 	state->ev = ev;
 	state->credentials = credentials;
+	state->fallback_to_anonymous = fallback_to_anonymous;
 	state->previous_session_id = previous_session_id;
 	state->options = *options;
 	state->host = host;
@@ -106,6 +111,25 @@ struct tevent_req *smb2_connect_send(TAL
 		return tevent_req_post(req, ev);
 	}
 
+	if (existing_conn != NULL) {
+		NTSTATUS status;
+
+		status = smb2_transport_raw_init(state, ev,
+						 existing_conn,
+						 options,
+						 &state->transport);
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
+
+		smb2_connect_session_start(req);
+		if (!tevent_req_is_in_progress(req)) {
+			return tevent_req_post(req, ev);
+		}
+
+		return req;
+	}
+
 	creq = smbcli_sock_connect_send(state, NULL, state->ports,
 					state->host, state->resolve_ctx,
 					state->ev, state->socket_options,
@@ -170,10 +194,6 @@ static void smb2_connect_negprot_done(st
 	struct tevent_req *req =
 		tevent_req_callback_data(subreq,
 		struct tevent_req);
-	struct smb2_connect_state *state =
-		tevent_req_data(req,
-		struct smb2_connect_state);
-	struct smb2_transport *transport = state->transport;
 	NTSTATUS status;
 
 	status = smbXcli_negprot_recv(subreq);
@@ -182,6 +202,17 @@ static void smb2_connect_negprot_done(st
 		return;
 	}
 
+	smb2_connect_session_start(req);
+}
+
+static void smb2_connect_session_start(struct tevent_req *req)
+{
+	struct smb2_connect_state *state =
+		tevent_req_data(req,
+		struct smb2_connect_state);
+	struct smb2_transport *transport = state->transport;
+	struct tevent_req *subreq = NULL;
+
 	state->session = smb2_session_init(transport, state->gensec_settings, state);
 	if (tevent_req_nomem(state->session, req)) {
 		return;
@@ -212,6 +243,34 @@ static void smb2_connect_session_done(st
 
 	status = smb2_session_setup_spnego_recv(subreq);
 	TALLOC_FREE(subreq);
+	if (!NT_STATUS_IS_OK(status) &&
+	    !cli_credentials_is_anonymous(state->credentials) &&
+	    state->fallback_to_anonymous) {
+		struct cli_credentials *anon_creds = NULL;
+
+		/*
+		 * The transport was moved to session,
+		 * we need to revert that before removing
+		 * the old broken session.
+		 */
+		state->transport = talloc_move(state, &state->session->transport);
+		TALLOC_FREE(state->session);
+
+		anon_creds = cli_credentials_init_anon(state);
+		if (tevent_req_nomem(anon_creds, req)) {
+			return;
+		}
+		cli_credentials_set_workstation(anon_creds,
+		   cli_credentials_get_workstation(state->credentials),
+		   CRED_SPECIFIED);
+
+		/*
+		 * retry with anonymous credentials
+		 */
+		state->credentials = anon_creds;
+		smb2_connect_session_start(req);
+		return;
+	}
 	if (tevent_req_nterror(req, status)) {
 		return;
 	}
@@ -303,6 +362,8 @@ NTSTATUS smb2_connect_ext(TALLOC_CTX *me
 				   share,
 				   resolve_ctx,
 				   credentials,
+				   false, /* fallback_to_anonymous */
+				   NULL, /* existing_conn */
 				   previous_session_id,
 				   options,
 				   socket_options,
diff -Npur samba-4.7.9/source4/libcli/smb2/session.c samba-4.7.10/source4/libcli/smb2/session.c
--- samba-4.7.9/source4/libcli/smb2/session.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb2/session.c	2018-08-27 09:54:35.000000000 +0200
@@ -196,13 +196,38 @@ struct tevent_req *smb2_session_setup_sp
 
 	if (state->out_secblob.length > 0) {
 		chosen_oid = GENSEC_OID_SPNEGO;
+		status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(1, ("Failed to start set GENSEC client mechanism %s: %s\n",
+				  gensec_get_name_by_oid(session->gensec,
+							 chosen_oid),
+				  nt_errstr(status)));
+			state->out_secblob = data_blob_null;
+			chosen_oid = GENSEC_OID_NTLMSSP;
+			status = gensec_start_mech_by_oid(session->gensec,
+							  chosen_oid);
+			if (!NT_STATUS_IS_OK(status)) {
+				DEBUG(1, ("Failed to start set (fallback) GENSEC client mechanism %s: %s\n",
+					  gensec_get_name_by_oid(session->gensec,
+								 chosen_oid),
+					  nt_errstr(status)));
+			}
+		}
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 	} else {
 		chosen_oid = GENSEC_OID_NTLMSSP;
-	}
-
-	status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
-	if (tevent_req_nterror(req, status)) {
-		return tevent_req_post(req, ev);
+		status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(1, ("Failed to start set GENSEC client mechanism %s: %s\n",
+				  gensec_get_name_by_oid(session->gensec,
+							 chosen_oid),
+				  nt_errstr(status)));
+		}
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 	}
 
 	smb2_session_setup_spnego_gensec_next(req);
diff -Npur samba-4.7.9/source4/libcli/smb2/transport.c samba-4.7.10/source4/libcli/smb2/transport.c
--- samba-4.7.9/source4/libcli/smb2/transport.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb2/transport.c	2018-08-27 09:54:35.000000000 +0200
@@ -86,6 +86,41 @@ struct smb2_transport *smb2_transport_in
 }
 
 /*
+  create a transport structure based on an established socket
+*/
+NTSTATUS smb2_transport_raw_init(TALLOC_CTX *mem_ctx,
+				 struct tevent_context *ev,
+				 struct smbXcli_conn **_conn,
+				 const struct smbcli_options *options,
+				 struct smb2_transport **_transport)
+{
+	struct smb2_transport *transport = NULL;
+	enum protocol_types protocol;
+
+	if (*_conn == NULL) {
+		return NT_STATUS_INVALID_PARAMETER;
+	}
+
+	protocol = smbXcli_conn_protocol(*_conn);
+	if (protocol < PROTOCOL_SMB2_02) {
+		return NT_STATUS_REVISION_MISMATCH;
+	}
+
+	transport = talloc_zero(mem_ctx, struct smb2_transport);
+	if (transport == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	transport->ev = ev;
+	transport->options = *options;
+	transport->conn = talloc_move(transport, _conn);
+
+	talloc_set_destructor(transport, transport_destructor);
+	*_transport = transport;
+	return NT_STATUS_OK;
+}
+
+/*
   mark the transport as dead
 */
 void smb2_transport_dead(struct smb2_transport *transport, NTSTATUS status)
diff -Npur samba-4.7.9/source4/libcli/smb_composite/connect.c samba-4.7.10/source4/libcli/smb_composite/connect.c
--- samba-4.7.9/source4/libcli/smb_composite/connect.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb_composite/connect.c	2018-08-27 09:54:35.000000000 +0200
@@ -228,18 +228,10 @@ static NTSTATUS connect_session_setup(st
 	return NT_STATUS_OK;
 }
 
-/*
-  a negprot request has completed
-*/
-static NTSTATUS connect_negprot(struct composite_context *c, 
-				struct smb_composite_connect *io)
+static NTSTATUS connect_send_session(struct composite_context *c,
+				     struct smb_composite_connect *io)
 {
 	struct connect_state *state = talloc_get_type(c->private_data, struct connect_state);
-	NTSTATUS status;
-
-	status = smb_raw_negotiate_recv(state->subreq);
-	TALLOC_FREE(state->subreq);
-	NT_STATUS_NOT_OK_RETURN(status);
 
 	/* next step is a session setup */
 	state->session = smbcli_session_init(state->transport, state, true, io->in.session_options);
@@ -282,6 +274,22 @@ static NTSTATUS connect_negprot(struct c
 }
 
 /*
+  a negprot request has completed
+*/
+static NTSTATUS connect_negprot(struct composite_context *c,
+				struct smb_composite_connect *io)
+{
+	struct connect_state *state = talloc_get_type(c->private_data, struct connect_state);
+	NTSTATUS status;
+
+	status = smb_raw_negotiate_recv(state->subreq);
+	TALLOC_FREE(state->subreq);
+	NT_STATUS_NOT_OK_RETURN(status);
+
+	return connect_send_session(c, io);
+}
+
+/*
   setup a negprot send 
 */
 static NTSTATUS connect_send_negprot(struct composite_context *c, 
@@ -432,6 +440,26 @@ struct composite_context *smb_composite_
 	nbt_choose_called_name(state, &state->called,
 			       io->in.called_name, NBT_NAME_SERVER);
 
+	if (io->in.existing_conn != NULL) {
+		NTSTATUS status;
+
+		status = smbcli_transport_raw_init(state,
+						   c->event_ctx,
+						   &io->in.existing_conn,
+						   &io->in.options,
+						   &state->transport);
+		if (!NT_STATUS_IS_OK(status)) {
+			goto failed;
+		}
+
+		status = connect_send_session(c, io);
+		if (!NT_STATUS_IS_OK(status)) {
+			goto failed;
+		}
+
+		return c;
+	}
+
 	state->creq = smbcli_sock_connect_send(state, 
 					       NULL,
 					       io->in.dest_ports,
diff -Npur samba-4.7.9/source4/libcli/smb_composite/connect_nego.c samba-4.7.10/source4/libcli/smb_composite/connect_nego.c
--- samba-4.7.9/source4/libcli/smb_composite/connect_nego.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.7.10/source4/libcli/smb_composite/connect_nego.c	2018-08-27 09:54:35.000000000 +0200
@@ -0,0 +1,209 @@
+/*
+   Unix SMB/CIFS implementation.
+
+   Copyright (C) Stefan Metzmacher 2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "includes.h"
+#include "lib/util/tevent_ntstatus.h"
+#include "libcli/composite/composite.h"
+#include "libcli/raw/libcliraw.h"
+#include "libcli/raw/raw_proto.h"
+#include "libcli/smb_composite/smb_composite.h"
+#include "lib/socket/socket.h"
+#include "libcli/resolve/resolve.h"
+#include "librpc/gen_ndr/ndr_nbt.h"
+#include "libcli/smb/smbXcli_base.h"
+
+struct smb_connect_nego_state {
+	struct tevent_context *ev;
+	struct resolve_context *resolve_ctx;
+	const char *socket_options;
+	struct smbcli_options options;
+	const char *dest_hostname;
+	const char *dest_address;
+	const char **dest_ports;
+	const char *target_hostname;
+	struct nbt_name calling, called;
+	struct smbXcli_conn *conn;
+};
+
+static void smb_connect_nego_connect_done(struct composite_context *creq);
+static void smb_connect_nego_nego_done(struct tevent_req *subreq);
+
+struct tevent_req *smb_connect_nego_send(TALLOC_CTX *mem_ctx,
+					 struct tevent_context *ev,
+					 struct resolve_context *resolve_ctx,
+					 const struct smbcli_options *options,
+					 const char *socket_options,
+					 const char *dest_hostname,
+					 const char *dest_address, /* optional */
+					 const char **dest_ports,
+					 const char *target_hostname,
+					 const char *called_name,
+					 const char *calling_name)
+{
+	struct tevent_req *req = NULL;
+	struct smb_connect_nego_state *state = NULL;
+	struct composite_context *creq = NULL;
+
+	req = tevent_req_create(mem_ctx, &state,
+				struct smb_connect_nego_state);
+	if (req == NULL) {
+		return NULL;
+	}
+	state->ev = ev;
+	state->resolve_ctx= resolve_ctx;
+	state->options = *options;
+	state->socket_options = socket_options;
+	state->dest_hostname = dest_hostname;
+	state->dest_address = dest_address;
+	state->dest_ports = dest_ports;
+	state->target_hostname = target_hostname;
+
+	make_nbt_name_client(&state->calling, calling_name);
+
+	nbt_choose_called_name(state, &state->called,
+			       called_name, NBT_NAME_SERVER);
+	if (tevent_req_nomem(state->called.name, req)) {
+		return tevent_req_post(req, ev);
+	}
+
+	creq = smbcli_sock_connect_send(state,
+					state->dest_address,
+					state->dest_ports,
+					state->dest_hostname,
+					state->resolve_ctx,
+					state->ev,
+					state->socket_options,
+					&state->calling,
+					&state->called);
+	if (tevent_req_nomem(creq, req)) {
+		return tevent_req_post(req, ev);
+	}
+	creq->async.private_data = req;
+	creq->async.fn = smb_connect_nego_connect_done;
+
+	return req;
+}
+
+static void smb_connect_nego_connect_done(struct composite_context *creq)
+{
+	struct tevent_req *req =
+		talloc_get_type_abort(creq->async.private_data,
+		struct tevent_req);
+	struct smb_connect_nego_state *state =
+		tevent_req_data(req,
+		struct smb_connect_nego_state);
+	struct tevent_req *subreq = NULL;
+	struct smbcli_socket *sock = NULL;
+	uint32_t smb1_capabilities;
+	uint32_t timeout_msec = state->options.request_timeout * 1000;
+	NTSTATUS status;
+
+	status = smbcli_sock_connect_recv(creq, state, &sock);
+	creq = NULL;
+	if (tevent_req_nterror(req, status)) {
+		return;
+	}
+
+	TALLOC_FREE(sock->event.fde);
+	TALLOC_FREE(sock->event.te);
+
+	smb1_capabilities = 0;
+	smb1_capabilities |= CAP_LARGE_FILES;
+	smb1_capabilities |= CAP_NT_SMBS | CAP_RPC_REMOTE_APIS;
+	smb1_capabilities |= CAP_LOCK_AND_READ | CAP_NT_FIND;
+	smb1_capabilities |= CAP_DFS | CAP_W2K_SMBS;
+	smb1_capabilities |= CAP_LARGE_READX|CAP_LARGE_WRITEX;
+	smb1_capabilities |= CAP_LWIO;
+
+	if (state->options.ntstatus_support) {
+		smb1_capabilities |= CAP_STATUS32;
+	}
+
+	if (state->options.unicode) {
+		smb1_capabilities |= CAP_UNICODE;
+	}
+
+	if (state->options.use_spnego) {
+		smb1_capabilities |= CAP_EXTENDED_SECURITY;
+	}
+
+	if (state->options.use_level2_oplocks) {
+		smb1_capabilities |= CAP_LEVEL_II_OPLOCKS;
+	}
+
+	state->conn = smbXcli_conn_create(state,
+					  sock->sock->fd,
+					  state->target_hostname,
+					  state->options.signing,
+					  smb1_capabilities,
+					  &state->options.client_guid,
+					  state->options.smb2_capabilities);
+	if (tevent_req_nomem(state->conn, req)) {
+		return;
+	}
+	sock->sock->fd = -1;
+	TALLOC_FREE(sock);
+
+	subreq = smbXcli_negprot_send(state,
+				      state->ev,
+				      state->conn,
+				      timeout_msec,
+				      state->options.min_protocol,
+				      state->options.max_protocol,
+				      state->options.max_credits);
+	if (tevent_req_nomem(subreq, req)) {
+		return;
+	}
+	tevent_req_set_callback(subreq, smb_connect_nego_nego_done, req);
+}
+
+static void smb_connect_nego_nego_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req =
+		tevent_req_callback_data(subreq,
+		struct tevent_req);
+	NTSTATUS status;
+
+	status = smbXcli_negprot_recv(subreq);
+	TALLOC_FREE(subreq);
+	if (tevent_req_nterror(req, status)) {
+		return;
+	}
+
+	tevent_req_done(req);
+}
+
+NTSTATUS smb_connect_nego_recv(struct tevent_req *req,
+			       TALLOC_CTX *mem_ctx,
+			       struct smbXcli_conn **_conn)
+{
+	struct smb_connect_nego_state *state =
+		tevent_req_data(req,
+		struct smb_connect_nego_state);
+	NTSTATUS status;
+
+	if (tevent_req_is_nterror(req, &status)) {
+		tevent_req_received(req);
+		return status;
+	}
+
+	*_conn = talloc_move(mem_ctx, &state->conn);
+	tevent_req_received(req);
+	return NT_STATUS_OK;
+}
diff -Npur samba-4.7.9/source4/libcli/smb_composite/fetchfile.c samba-4.7.10/source4/libcli/smb_composite/fetchfile.c
--- samba-4.7.9/source4/libcli/smb_composite/fetchfile.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb_composite/fetchfile.c	2018-08-27 09:54:35.000000000 +0200
@@ -131,7 +131,7 @@ struct composite_context *smb_composite_
 	state = talloc(c, struct fetchfile_state);
 	if (state == NULL) goto failed;
 
-	state->connect = talloc(state, struct smb_composite_connect);
+	state->connect = talloc_zero(state, struct smb_composite_connect);
 	if (state->connect == NULL) goto failed;
 
 	state->io = io;
diff -Npur samba-4.7.9/source4/libcli/smb_composite/smb_composite.h samba-4.7.10/source4/libcli/smb_composite/smb_composite.h
--- samba-4.7.9/source4/libcli/smb_composite/smb_composite.h	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/smb_composite/smb_composite.h	2018-08-27 09:54:35.000000000 +0200
@@ -102,6 +102,28 @@ NTSTATUS smb_composite_savefile(struct s
 				struct smb_composite_savefile *io);
 
 /*
+  a composite request for a low level connection to a remote server. Includes
+
+    - socket establishment
+    - session request
+    - negprot
+*/
+struct tevent_req *smb_connect_nego_send(TALLOC_CTX *mem_ctx,
+					 struct tevent_context *ev,
+					 struct resolve_context *resolve_ctx,
+					 const struct smbcli_options *options,
+					 const char *socket_options,
+					 const char *dest_hostname,
+					 const char *dest_address, /* optional */
+					 const char **dest_ports,
+					 const char *target_hostname,
+					 const char *called_name,
+					 const char *calling_name);
+NTSTATUS smb_connect_nego_recv(struct tevent_req *req,
+			       TALLOC_CTX *mem_ctx,
+			       struct smbXcli_conn **_conn);
+
+/*
   a composite request for a full connection to a remote server. Includes
 
     - socket establishment
@@ -118,6 +140,7 @@ struct smb_composite_connect {
 		const char *called_name;
 		const char *service;
 		const char *service_type;
+		struct smbXcli_conn *existing_conn; /* optional */
 		struct cli_credentials *credentials;
 		bool fallback_to_anonymous;
 		const char *workgroup;
diff -Npur samba-4.7.9/source4/libcli/wscript_build samba-4.7.10/source4/libcli/wscript_build
--- samba-4.7.9/source4/libcli/wscript_build	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/libcli/wscript_build	2018-08-27 09:54:35.000000000 +0200
@@ -25,11 +25,21 @@ bld.SAMBA_SUBSYSTEM('cli_composite',
 
 
 bld.SAMBA_SUBSYSTEM('LIBCLI_SMB_COMPOSITE',
-	source='smb_composite/loadfile.c smb_composite/savefile.c smb_composite/connect.c smb_composite/sesssetup.c smb_composite/fetchfile.c smb_composite/appendacl.c smb_composite/fsinfo.c smb_composite/smb2.c',
-	deps='LIBCLI_SMB2 tevent-util',
-	public_deps='cli_composite samba-credentials gensec LIBCLI_RESOLVE tevent',
-	private_headers='smb_composite/smb_composite.h',
-	)
+    source='''
+       smb_composite/loadfile.c
+       smb_composite/savefile.c
+       smb_composite/connect_nego.c
+       smb_composite/connect.c
+       smb_composite/sesssetup.c
+       smb_composite/fetchfile.c
+       smb_composite/appendacl.c
+       smb_composite/fsinfo.c
+       smb_composite/smb2.c
+    ''',
+    deps='LIBCLI_SMB2 tevent-util',
+    public_deps='cli_composite samba-credentials gensec LIBCLI_RESOLVE tevent',
+    private_headers='smb_composite/smb_composite.h',
+    )
 
 bld.SAMBA_PYTHON('pysmb',
     source='pysmb.c',
diff -Npur samba-4.7.9/source4/librpc/rpc/dcerpc_connect.c samba-4.7.10/source4/librpc/rpc/dcerpc_connect.c
--- samba-4.7.9/source4/librpc/rpc/dcerpc_connect.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/librpc/rpc/dcerpc_connect.c	2018-08-27 09:54:35.000000000 +0200
@@ -35,6 +35,7 @@
 #include "auth/credentials/credentials.h"
 #include "param/param.h"
 #include "libcli/resolve/resolve.h"
+#include "lib/util/util_net.h"
 
 struct dcerpc_pipe_connect {
 	struct dcecli_connection *conn;
@@ -75,6 +76,8 @@ static void continue_pipe_open_smb(struc
 }
 
 static void continue_smb_open(struct composite_context *c);
+static void continue_smb2_connect(struct tevent_req *subreq);
+static void continue_smbXcli_connect(struct tevent_req *subreq);
 
 /*
   Stage 2 of ncacn_np_smb: Open a named pipe after successful smb connection
@@ -131,9 +134,12 @@ static struct composite_context *dcerpc_
 {
 	struct composite_context *c;
 	struct pipe_np_smb_state *s;
-	struct composite_context *conn_req;
+	struct tevent_req *subreq = NULL;
 	struct smb_composite_connect *conn;
 	uint32_t flags;
+	const char *target_hostname = NULL;
+	const char *dest_address = NULL;
+	const char *calling_name = NULL;
 
 	/* composite context allocation and setup */
 	c = composite_create(mem_ctx, io->conn->event_ctx);
@@ -151,12 +157,17 @@ static struct composite_context *dcerpc_
 		return c;
 	}
 
+	if (s->io.creds == NULL) {
+		composite_error(c, NT_STATUS_INVALID_PARAMETER_MIX);
+		return c;
+	}
+
 	/* prepare smb connection parameters: we're connecting to IPC$ share on
 	   remote rpc server */
+	target_hostname = dcerpc_binding_get_string_option(s->io.binding, "target_hostname");
 	conn->in.dest_host = dcerpc_binding_get_string_option(s->io.binding, "host");
 	conn->in.dest_ports = lpcfg_smb_ports(lp_ctx);
-	conn->in.called_name =
-		dcerpc_binding_get_string_option(s->io.binding, "target_hostname");
+	conn->in.called_name = target_hostname;
 	if (conn->in.called_name == NULL) {
 		conn->in.called_name = "*SMBSERVER";
 	}
@@ -183,21 +194,113 @@ static struct composite_context *dcerpc_
 		conn->in.fallback_to_anonymous  = false;
 	}
 
-	conn->in.options.min_protocol = PROTOCOL_NT1;
-	conn->in.options.max_protocol = PROTOCOL_NT1;
+	conn->in.options.min_protocol = lpcfg_client_ipc_min_protocol(lp_ctx);
+	conn->in.options.max_protocol = lpcfg_client_ipc_max_protocol(lp_ctx);
+	if ((flags & DCERPC_SMB1) && (flags & DCERPC_SMB2)) {
+		/* auto */
+	} else if (flags & DCERPC_SMB2) {
+		if (conn->in.options.min_protocol < PROTOCOL_SMB2_02) {
+			conn->in.options.min_protocol = PROTOCOL_SMB2_02;
+		}
+		if (conn->in.options.max_protocol < PROTOCOL_SMB2_02) {
+			conn->in.options.max_protocol = PROTOCOL_LATEST;
+		}
+	} else if (flags & DCERPC_SMB1) {
+		conn->in.options.min_protocol = PROTOCOL_NT1;
+		conn->in.options.max_protocol = PROTOCOL_NT1;
+	} else {
+		/* auto */
+	}
 
 	conn->in.options.signing = lpcfg_client_ipc_signing(lp_ctx);
 
-	/* send smb connect request */
-	conn_req = smb_composite_connect_send(conn, s->io.conn,
-					      s->io.resolve_ctx,
-					      c->event_ctx);
-	if (composite_nomem(conn_req, c)) return c;
+	if (s->conn.in.credentials != NULL) {
+		calling_name = cli_credentials_get_workstation(s->conn.in.credentials);
+	}
+	if (calling_name == NULL) {
+		calling_name = "SMBCLIENT";
+	}
+
+	if (target_hostname == NULL) {
+		target_hostname = conn->in.dest_host;
+	}
+
+	if (is_ipaddress(conn->in.dest_host)) {
+		dest_address = conn->in.dest_host;
+	}
+
+	subreq = smb_connect_nego_send(s,
+				       c->event_ctx,
+				       s->io.resolve_ctx,
+				       &conn->in.options,
+				       conn->in.socket_options,
+				       conn->in.dest_host,
+				       dest_address,
+				       conn->in.dest_ports,
+				       target_hostname,
+				       conn->in.called_name,
+				       calling_name);
+	if (composite_nomem(subreq, c)) return c;
+	tevent_req_set_callback(subreq,
+				continue_smbXcli_connect,
+				c);
 
-	composite_continue(c, conn_req, continue_smb_connect, c);
 	return c;
 }
 
+static void continue_smbXcli_connect(struct tevent_req *subreq)
+{
+	struct composite_context *c =
+		tevent_req_callback_data(subreq,
+		struct composite_context);
+	struct pipe_np_smb_state *s =
+		talloc_get_type_abort(c->private_data,
+		struct pipe_np_smb_state);
+	struct smb_composite_connect *conn = &s->conn;
+	struct composite_context *creq = NULL;
+	enum protocol_types protocol;
+
+	c->status = smb_connect_nego_recv(subreq, s,
+					  &conn->in.existing_conn);
+	TALLOC_FREE(subreq);
+	if (!composite_is_ok(c)) return;
+
+	protocol = smbXcli_conn_protocol(conn->in.existing_conn);
+	if (protocol >= PROTOCOL_SMB2_02) {
+		/*
+		 * continue with smb2 session setup/tree connect
+		 * on the established connection.
+		 */
+		subreq = smb2_connect_send(s, c->event_ctx,
+				conn->in.dest_host,
+				conn->in.dest_ports,
+				conn->in.service,
+				s->io.resolve_ctx,
+				conn->in.credentials,
+				conn->in.fallback_to_anonymous,
+				&conn->in.existing_conn,
+				0, /* previous_session_id */
+				&conn->in.options,
+				conn->in.socket_options,
+				conn->in.gensec_settings);
+		if (composite_nomem(subreq, c)) return;
+		tevent_req_set_callback(subreq, continue_smb2_connect, c);
+		return;
+	}
+
+	/*
+	 * continue with smb1 session setup/tree connect
+	 * on the established connection.
+	 */
+	creq = smb_composite_connect_send(conn, s->io.conn,
+					  s->io.resolve_ctx,
+					  c->event_ctx);
+	if (composite_nomem(creq, c)) return;
+
+	composite_continue(c, creq, continue_smb_connect, c);
+	return;
+}
+
 
 /*
   Receive result of a rpc connection to a rpc pipe on SMB
@@ -237,91 +340,6 @@ static void continue_smb2_connect(struct
 }
 
 
-/* 
-   Initiate async open of a rpc connection request on SMB2 using
-   the binding structure to determine the endpoint and options
-*/
-static struct composite_context *dcerpc_pipe_connect_ncacn_np_smb2_send(
-					TALLOC_CTX *mem_ctx,
-					struct dcerpc_pipe_connect *io,
-					struct loadparm_context *lp_ctx)
-{
-	struct composite_context *c;
-	struct pipe_np_smb_state *s;
-	struct tevent_req *subreq;
-	struct smbcli_options options;
-	const char *host;
-	uint32_t flags;
-
-	/* composite context allocation and setup */
-	c = composite_create(mem_ctx, io->conn->event_ctx);
-	if (c == NULL) return NULL;
-
-	s = talloc_zero(c, struct pipe_np_smb_state);
-	if (composite_nomem(s, c)) return c;
-	c->private_data = s;
-
-	s->io = *io;
-
-	if (smbXcli_conn_is_connected(s->io.smb.conn)) {
-		continue_smb_open(c);
-		return c;
-	}
-
-	host = dcerpc_binding_get_string_option(s->io.binding, "host");
-	flags = dcerpc_binding_get_flags(s->io.binding);
-
-	/*
-	 * provide proper credentials - user supplied or anonymous in case this is
-	 * schannel connection
-	 */
-	if (flags & DCERPC_SCHANNEL) {
-		s->io.creds = cli_credentials_init_anon(mem_ctx);
-		if (composite_nomem(s->io.creds, c)) return c;
-	}
-
-	lpcfg_smbcli_options(lp_ctx, &options);
-
-	options.min_protocol = lpcfg_client_ipc_min_protocol(lp_ctx);
-	if (options.min_protocol < PROTOCOL_SMB2_02) {
-		options.min_protocol = PROTOCOL_SMB2_02;
-	}
-	options.max_protocol = lpcfg_client_ipc_max_protocol(lp_ctx);
-	if (options.max_protocol < PROTOCOL_SMB2_02) {
-		options.max_protocol = PROTOCOL_SMB2_02;
-	}
-
-	options.signing = lpcfg_client_ipc_signing(lp_ctx);
-
-	/* send smb2 connect request */
-	subreq = smb2_connect_send(s, c->event_ctx,
-			host,
-			lpcfg_parm_string_list(mem_ctx, lp_ctx, NULL, "smb2", "ports", NULL),
-			"IPC$",
-			s->io.resolve_ctx,
-			s->io.creds,
-			0, /* previous_session_id */
-			&options,
-			lpcfg_socket_options(lp_ctx),
-			lpcfg_gensec_settings(mem_ctx, lp_ctx));
-	if (composite_nomem(subreq, c)) return c;
-	tevent_req_set_callback(subreq, continue_smb2_connect, c);
-	return c;
-}
-
-
-/*
-  Receive result of a rpc connection to a rpc pipe on SMB2
-*/
-static NTSTATUS dcerpc_pipe_connect_ncacn_np_smb2_recv(struct composite_context *c)
-{
-	NTSTATUS status = composite_wait(c);
-	
-	talloc_free(c);
-	return status;
-}
-
-
 struct pipe_ip_tcp_state {
 	struct dcerpc_pipe_connect io;
 	const char *localaddr;
@@ -743,7 +761,6 @@ struct pipe_connect_state {
 
 static void continue_map_binding(struct composite_context *ctx);
 static void continue_connect(struct composite_context *c, struct pipe_connect_state *s);
-static void continue_pipe_connect_ncacn_np_smb2(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_np_smb(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_ip_tcp(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_http(struct composite_context *ctx);
@@ -782,15 +799,12 @@ static void continue_connect(struct comp
 	struct dcerpc_pipe_connect pc;
 
 	/* potential exits to another stage by sending an async request */
-	struct composite_context *ncacn_np_smb2_req;
 	struct composite_context *ncacn_np_smb_req;
 	struct composite_context *ncacn_ip_tcp_req;
 	struct composite_context *ncacn_http_req;
 	struct composite_context *ncacn_unix_req;
 	struct composite_context *ncalrpc_req;
 	enum dcerpc_transport_t transport;
-	enum protocol_types min_ipc_protocol;
-	uint32_t flags;
 
 	/* dcerpc pipe connect input parameters */
 	ZERO_STRUCT(pc);
@@ -801,29 +815,16 @@ static void continue_connect(struct comp
 	pc.resolve_ctx  = lpcfg_resolve_context(s->lp_ctx);
 
 	transport = dcerpc_binding_get_transport(s->binding);
-	flags = dcerpc_binding_get_flags(s->binding);
-
-	min_ipc_protocol = lpcfg_client_ipc_min_protocol(s->lp_ctx);
-	if (min_ipc_protocol >= PROTOCOL_SMB2_02) {
-		flags |= DCERPC_SMB2;
-	}
 
 	/* connect dcerpc pipe depending on required transport */
 	switch (transport) {
 	case NCACN_NP:
-		if (flags & DCERPC_SMB2) {
-			/* new varient of SMB a.k.a. SMB2 */
-			ncacn_np_smb2_req = dcerpc_pipe_connect_ncacn_np_smb2_send(c, &pc, s->lp_ctx);
-			composite_continue(c, ncacn_np_smb2_req, continue_pipe_connect_ncacn_np_smb2, c);
-			return;
-
-		} else {
-			/* good old ordinary SMB */
-			ncacn_np_smb_req = dcerpc_pipe_connect_ncacn_np_smb_send(c, &pc, s->lp_ctx);
-			composite_continue(c, ncacn_np_smb_req, continue_pipe_connect_ncacn_np_smb, c);
-			return;
-		}
-		break;
+		/*
+		 * SMB1/2/3...
+		 */
+		ncacn_np_smb_req = dcerpc_pipe_connect_ncacn_np_smb_send(c, &pc, s->lp_ctx);
+		composite_continue(c, ncacn_np_smb_req, continue_pipe_connect_ncacn_np_smb, c);
+		return;
 
 	case NCACN_IP_TCP:
 		ncacn_ip_tcp_req = dcerpc_pipe_connect_ncacn_ip_tcp_send(c, &pc);
@@ -856,24 +857,6 @@ static void continue_connect(struct comp
 }
 
 
-/*
-  Stage 3 of pipe_connect_b: Receive result of pipe connect request on
-  named pipe on smb2
-*/
-static void continue_pipe_connect_ncacn_np_smb2(struct composite_context *ctx)
-{
-	struct composite_context *c = talloc_get_type(ctx->async.private_data,
-						      struct composite_context);
-	struct pipe_connect_state *s = talloc_get_type(c->private_data,
-						       struct pipe_connect_state);
-
-	c->status = dcerpc_pipe_connect_ncacn_np_smb2_recv(ctx);
-	if (!composite_is_ok(c)) return;
-
-	continue_pipe_connect(c, s);
-}
-
-
 /*
   Stage 3 of pipe_connect_b: Receive result of pipe connect request on
   named pipe on smb
diff -Npur samba-4.7.9/source4/ntvfs/cifs/vfs_cifs.c samba-4.7.10/source4/ntvfs/cifs/vfs_cifs.c
--- samba-4.7.9/source4/ntvfs/cifs/vfs_cifs.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/ntvfs/cifs/vfs_cifs.c	2018-08-27 09:54:35.000000000 +0200
@@ -296,6 +296,7 @@ static NTSTATUS cvfs_connect(struct ntvf
 	io.in.dest_ports = lpcfg_smb_ports(ntvfs->ctx->lp_ctx);
 	io.in.socket_options = lpcfg_socket_options(ntvfs->ctx->lp_ctx);
 	io.in.called_name = host;
+	io.in.existing_conn = NULL;
 	io.in.credentials = credentials;
 	io.in.fallback_to_anonymous = false;
 	io.in.workgroup = lpcfg_workgroup(ntvfs->ctx->lp_ctx);
diff -Npur samba-4.7.9/source4/ntvfs/ipc/rap_server.c samba-4.7.10/source4/ntvfs/ipc/rap_server.c
--- samba-4.7.9/source4/ntvfs/ipc/rap_server.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/ntvfs/ipc/rap_server.c	2018-08-27 09:54:35.000000000 +0200
@@ -63,13 +63,18 @@ NTSTATUS rap_netshareenum(TALLOC_CTX *me
 				   union rap_share_info, r->out.available);
 
 	for (i = 0, j = 0; i < r->out.available; i++) {
+		size_t sname_len;
+
 		if (!NT_STATUS_IS_OK(share_get_config(mem_ctx, sctx, snames[i], &scfg))) {
 			DEBUG(3, ("WARNING: Service [%s] disappeared after enumeration!\n", snames[i]));
 			continue;
 		}
-		strncpy((char *)r->out.info[j].info1.share_name,
+		/* Make sure we have NUL-termination */
+		sname_len = MIN(strlen(snames[i]),
+				sizeof(r->out.info[j].info1.share_name));
+		strlcpy((char *)r->out.info[j].info1.share_name,
 			snames[i],
-			sizeof(r->out.info[0].info1.share_name));
+			sname_len);
 		r->out.info[i].info1.reserved1 = 0;
 		r->out.info[i].info1.share_type = dcesrv_common_get_share_type(mem_ctx, NULL, scfg);
 		r->out.info[i].info1.comment = share_string_option(mem_ctx, scfg, SHARE_COMMENT, "");
diff -Npur samba-4.7.9/source4/torture/basic/mangle_test.c samba-4.7.10/source4/torture/basic/mangle_test.c
--- samba-4.7.9/source4/torture/basic/mangle_test.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/torture/basic/mangle_test.c	2018-08-27 09:54:35.000000000 +0200
@@ -145,7 +145,7 @@ static char *gen_name(TALLOC_CTX *mem_ct
 
 	/* and a medium probability of a common lead string */
 	if ((len > 5) && (random() % 10 == 0)) {
-		strncpy(p, "ABCDE", 5);
+		strlcpy(p, "ABCDE", 6);
 	}
 
 	/* and a high probability of a good extension length */
diff -Npur samba-4.7.9/source4/torture/smb2/durable_v2_open.c samba-4.7.10/source4/torture/smb2/durable_v2_open.c
--- samba-4.7.9/source4/torture/smb2/durable_v2_open.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/torture/smb2/durable_v2_open.c	2018-08-27 09:54:35.000000000 +0200
@@ -1518,9 +1518,15 @@ bool test_durable_v2_open_reopen2_lease_
 
 	options = tree->session->transport->options;
 
+	smb2_deltree(tree, __func__);
+	status = torture_smb2_testdir(tree, __func__, &_h);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir failed\n");
+	smb2_util_close(tree, _h);
+
 	/* Choose a random name in case the state is left a little funky. */
-	snprintf(fname, 256, "durable_v2_open_reopen2_%s.dat",
-		 generate_random_str(tctx, 8));
+	snprintf(fname, 256, "%s\\durable_v2_open_reopen2_%s.dat",
+		 __func__, generate_random_str(tctx, 8));
 
 	smb2_util_unlink(tree, fname);
 
@@ -1726,6 +1732,7 @@ done:
 	}
 
 	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, __func__);
 
 	talloc_free(tree);
 
diff -Npur samba-4.7.9/source4/torture/smb2/session.c samba-4.7.10/source4/torture/smb2/session.c
--- samba-4.7.9/source4/torture/smb2/session.c	2017-12-22 21:40:58.000000000 +0100
+++ samba-4.7.10/source4/torture/smb2/session.c	2018-08-27 09:54:35.000000000 +0200
@@ -616,7 +616,7 @@ bool test_session_reauth5(struct torture
 {
 	NTSTATUS status;
 	TALLOC_CTX *mem_ctx = talloc_new(tctx);
-	char dname[256];
+	char dname[128];
 	char fname[256];
 	char fname2[256];
 	struct smb2_handle _dh1;
diff -Npur samba-4.7.9/source4/torture/smb2/streams.c samba-4.7.10/source4/torture/smb2/streams.c
--- samba-4.7.9/source4/torture/smb2/streams.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/source4/torture/smb2/streams.c	2018-08-27 09:54:35.000000000 +0200
@@ -1830,6 +1830,86 @@ done:
 	return ret;
 }
 
+static bool test_basefile_rename_with_open_stream(struct torture_context *tctx,
+						  struct smb2_tree *tree)
+{
+	bool ret = true;
+	NTSTATUS status;
+	struct smb2_tree *tree2 = NULL;
+	struct smb2_create create, create2;
+	struct smb2_handle h1 = {{0}}, h2 = {{0}};
+	const char *fname = "test_rename_openfile";
+	const char *sname = "test_rename_openfile:foo";
+	const char *fname_renamed = "test_rename_openfile_renamed";
+	union smb_setfileinfo sinfo;
+	const char *data = "test data";
+
+	ret = torture_smb2_connection(tctx, &tree2);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_smb2_connection failed\n");
+
+	torture_comment(tctx, "Creating file with stream\n");
+
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_ALL;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN_IF;
+	create.in.impersonation_level = SMB2_IMPERSONATION_IMPERSONATION;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	h1 = create.out.file.handle;
+
+	torture_comment(tctx, "Writing to stream\n");
+
+	status = smb2_util_write(tree, h1, data, 0, strlen(data));
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
+	torture_comment(tctx, "Renaming base file\n");
+
+	ZERO_STRUCT(create2);
+	create2.in.desired_access = SEC_FILE_ALL;
+	create2.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create2.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create2.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create2.in.impersonation_level = SMB2_IMPERSONATION_IMPERSONATION;
+	create2.in.fname = fname;
+
+	status = smb2_create(tree2, tctx, &create2);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	h2 = create2.out.file.handle;
+
+	ZERO_STRUCT(sinfo);
+	sinfo.rename_information.level = RAW_SFILEINFO_RENAME_INFORMATION;
+	sinfo.rename_information.in.file.handle = h2;
+	sinfo.rename_information.in.new_name = fname_renamed;
+
+	status = smb2_setinfo_file(tree2, &sinfo);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_ACCESS_DENIED, ret, done,
+		"smb2_setinfo_file didn't return NT_STATUS_ACCESS_DENIED\n");
+
+	smb2_util_close(tree2, h2);
+
+done:
+	if (!smb2_util_handle_empty(h1)) {
+		smb2_util_close(tree, h1);
+	}
+	if (!smb2_util_handle_empty(h2)) {
+		smb2_util_close(tree2, h2);
+	}
+	smb2_util_unlink(tree, fname);
+	smb2_util_unlink(tree, fname_renamed);
+
+	return ret;
+}
 
 /*
    basic testing of streams calls SMB2
@@ -1850,6 +1930,8 @@ struct torture_suite *torture_smb2_strea
 	torture_suite_add_1smb2_test(suite, "attributes", test_stream_attributes);
 	torture_suite_add_1smb2_test(suite, "delete", test_stream_delete);
 	torture_suite_add_1smb2_test(suite, "zero-byte", test_zero_byte_stream);
+	torture_suite_add_1smb2_test(suite, "basefile-rename-with-open-stream",
+					test_basefile_rename_with_open_stream);
 
 	suite->description = talloc_strdup(suite, "SMB2-STREAM tests");
 
diff -Npur samba-4.7.9/source4/torture/vfs/fruit.c samba-4.7.10/source4/torture/vfs/fruit.c
--- samba-4.7.9/source4/torture/vfs/fruit.c	2018-04-17 09:35:02.000000000 +0200
+++ samba-4.7.10/source4/torture/vfs/fruit.c	2018-08-27 09:54:35.000000000 +0200
@@ -1594,11 +1594,11 @@ static bool test_write_atalk_rfork_io(st
 
 	ret &= write_stream(tree, __location__, tctx, mem_ctx,
 			    fname, AFPRESOURCE_STREAM_NAME,
-			    (off_t)1<<32, 10, rfork_content);
+			    (off_t)64*1024*1024, 10, rfork_content);
 
 	ret &= check_stream(tree, __location__, tctx, mem_ctx,
 			    fname, AFPRESOURCE_STREAM_NAME,
-			    (off_t)1<<32, 10, 0, 10, rfork_content);
+			    (off_t)64*1024*1024, 10, 0, 10, rfork_content);
 
 	/* Truncate back to size of 1 byte */
 
@@ -3897,7 +3897,6 @@ static bool test_rename_and_read_rsrc(st
 	const char *fname_renamed = "test_rename_openfile_renamed";
 	const char *data = "1234567890";
 	union smb_setfileinfo sinfo;
-	struct smb2_read r;
 
 	ret = enable_aapl(tctx, tree);
 	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
@@ -3949,28 +3948,12 @@ static bool test_rename_and_read_rsrc(st
 	sinfo.rename_information.in.new_name = fname_renamed;
 
 	status = smb2_setinfo_file(tree, &sinfo);
-	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_setinfo_file failed");
-
-	smb2_util_close(tree, h2);
-
-	ZERO_STRUCT(r);
-	r.in.file.handle = h1;
-	r.in.length      = 10;
-	r.in.offset      = 0;
-
-	torture_comment(tctx, "Read resource fork of renamed file\n");
-
-	status = smb2_read(tree, tree, &r);
-	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_read failed");
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_ACCESS_DENIED, ret, done,
+		"smb2_setinfo_file failed");
 
 	smb2_util_close(tree, h1);
-
-	torture_assert_goto(tctx, r.out.data.length == 10, ret, done,
-			    talloc_asprintf(tctx, "smb2_read returned %jd bytes, expected 10\n",
-					    (intmax_t)r.out.data.length));
-
-	torture_assert_goto(tctx, memcmp(r.out.data.data, data, 10) == 0, ret, done,
-			    talloc_asprintf(tctx, "Bad data in stream\n"));
+	smb2_util_close(tree, h2);
 
 done:
 	smb2_util_unlink(tree, fname);
@@ -4595,6 +4578,202 @@ done:
 	return ret;
 }
 
+static bool test_setinfo_stream_eof(struct torture_context *tctx,
+				    struct smb2_tree *tree)
+{
+	bool ret = true;
+	NTSTATUS status;
+	struct smb2_create create;
+	union smb_setfileinfo sfinfo;
+	union smb_fileinfo finfo;
+	struct smb2_handle h1;
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	const char *fname = BASEDIR "\\file";
+	const char *sname = BASEDIR "\\file:foo";
+
+	torture_assert_goto(tctx, mem_ctx != NULL, ret, done,
+			    "talloc_new failed\n");
+
+	torture_comment(tctx, "Test setting EOF on a stream\n");
+
+	smb2_deltree(tree, BASEDIR);
+	status = torture_smb2_testdir(tree, BASEDIR, &h1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir\n");
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile(tree, fname, &h1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	status = smb2_util_write(tree, h1, "1234567890", 0, 10);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+	smb2_util_close(tree, h1);
+
+	/*
+	 * Test setting EOF to 21
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 21\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 21;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status,
+					ret, done, "set EOF 21 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 21,
+			    ret, done, "size != 21\n");
+
+	/*
+	 * Test setting EOF to 0
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 0\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 0;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed\n");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 0,
+			    ret, done, "size != 0\n");
+
+	/*
+	 * Test setinfo end-of-file info to 1
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 1\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 1;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set EOF 1 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed\n");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 1,
+			    ret, done, "size != 1\n");
+
+	/*
+	 * Test setting EOF to 0 with AAPL enabled, should delete stream
+	 */
+
+	torture_comment(tctx, "Enabling AAPL extensions\n");
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed\n");
+
+	torture_comment(tctx, "Setting stream EOF to 0\n");
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 0;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_READ_ATTRIBUTE;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND, ret, done,
+		"Unexpected status\n");
+
+done:
+	smb2_util_unlink(tree, fname);
+	smb2_util_rmdir(tree, BASEDIR);
+	return ret;
+}
+
 /*
  * Note: This test depends on "vfs objects = catia fruit streams_xattr".  For
  * some tests torture must be run on the host it tests and takes an additional
@@ -4627,6 +4806,7 @@ struct torture_suite *torture_vfs_fruit(
 	torture_suite_add_1smb2_test(suite, "create delete-on-close AFP_AfpResource", test_create_delete_on_close_resource);
 	torture_suite_add_1smb2_test(suite, "setinfo delete-on-close AFP_AfpResource", test_setinfo_delete_on_close_resource);
 	torture_suite_add_1smb2_test(suite, "setinfo eof AFP_AfpResource", test_setinfo_eof_resource);
+	torture_suite_add_1smb2_test(suite, "setinfo eof stream", test_setinfo_stream_eof);
 	torture_suite_add_1smb2_test(suite, "null afpinfo", test_null_afpinfo);
 	torture_suite_add_1smb2_test(suite, "delete", test_delete_file_with_rfork);
 	torture_suite_add_1smb2_test(suite, "read open rsrc after rename", test_rename_and_read_rsrc);
@@ -4706,6 +4886,93 @@ done:
 	return ret;
 }
 
+static bool test_fruit_locking_conflict(struct torture_context *tctx,
+					struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx;
+	struct smb2_create create;
+	struct smb2_handle h;
+	struct smb2_lock lck;
+	struct smb2_lock_element el;
+	const char *fname = BASEDIR "\\locking_conflict.txt";
+	NTSTATUS status;
+	bool ret = false;
+
+	mem_ctx = talloc_new(tctx);
+	torture_assert_not_null(tctx, mem_ctx, "talloc_new failed");
+
+	/* clean slate ...*/
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &h);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	smb2_util_close(tree, h);
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_FILE_READ,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.share_access =
+		NTCREATEX_SHARE_ACCESS_READ|
+		NTCREATEX_SHARE_ACCESS_WRITE,
+		.in.create_disposition = NTCREATEX_DISP_CREATE,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = fname,
+	};
+
+	status = smb2_create(tree, mem_ctx, &create);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	h = create.out.file.handle;
+
+	el = (struct smb2_lock_element) {
+		.offset = 0xfffffffffffffffc,
+		.length = 1,
+		.flags = SMB2_LOCK_FLAG_EXCLUSIVE,
+	};
+	lck = (struct smb2_lock) {
+		.in.lock_count = 1,
+		.in.file.handle = h,
+		.in.locks = &el,
+	};
+
+	status = smb2_lock(tree, &lck);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	el = (struct smb2_lock_element) {
+		.offset = 0,
+		.length = 0x7fffffffffffffff,
+		.flags = SMB2_LOCK_FLAG_EXCLUSIVE,
+	};
+	status = smb2_lock(tree, &lck);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	create = (struct smb2_create) {
+		.in.desired_access =
+		SEC_RIGHTS_FILE_READ|SEC_RIGHTS_FILE_WRITE,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = fname,
+	};
+
+	status = smb2_create(tree, mem_ctx, &create);
+	CHECK_STATUS(status, NT_STATUS_FILE_LOCK_CONFLICT);
+
+	{
+		struct smb2_close cl = {
+			.level = RAW_CLOSE_SMB2,
+			.in.file.handle = h,
+		};
+		smb2_close(tree, &cl);
+	}
+
+	ret = true;
+done:
+	return ret;
+}
+
 struct torture_suite *torture_vfs_fruit_netatalk(TALLOC_CTX *ctx)
 {
 	struct torture_suite *suite = torture_suite_create(
@@ -4715,6 +4982,8 @@ struct torture_suite *torture_vfs_fruit_
 
 	torture_suite_add_1smb2_test(suite, "read netatalk metadata", test_read_netatalk_metadata);
 	torture_suite_add_1smb2_test(suite, "stream names with locally created xattr", test_stream_names_local);
+	torture_suite_add_1smb2_test(
+		suite, "locking conflict", test_fruit_locking_conflict);
 
 	return suite;
 }
diff -Npur samba-4.7.9/testsuite/unittests/test_lib_util_modules.c samba-4.7.10/testsuite/unittests/test_lib_util_modules.c
--- samba-4.7.9/testsuite/unittests/test_lib_util_modules.c	2017-07-04 12:05:26.000000000 +0200
+++ samba-4.7.10/testsuite/unittests/test_lib_util_modules.c	2018-08-27 09:54:35.000000000 +0200
@@ -26,7 +26,7 @@ static void test_samba_module_probe(void
 {
 	NTSTATUS status;
 
-	status = smb_probe_module("auth", "unix");
+	status = smb_probe_module("auth", "skel");
 	assert_true(NT_STATUS_IS_OK(status));
 }
 
